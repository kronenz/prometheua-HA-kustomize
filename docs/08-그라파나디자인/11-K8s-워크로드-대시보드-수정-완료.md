# K8s ì›Œí¬ë¡œë“œ í˜„í™© ëŒ€ì‹œë³´ë“œ ìˆ˜ì • ì™„ë£Œ

## ğŸ“Š ê°œìš”
ì¿ ë²„ë„¤í‹°ìŠ¤-05-ì¸í”„ë¼-ì›Œí¬ë¡œë“œ í˜„í™© ëŒ€ì‹œë³´ë“œì˜ ì‹œê°í™” ë°ì´í„°ê°€ í‘œì‹œë˜ì§€ ì•Šë˜ ë¬¸ì œ í•´ê²°

**Dashboard UID**: `k8s-workload-status-v1`
**ì‘ì—… ì¼ì**: 2025-11-11
**ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ” ë¬¸ì œ ë¶„ì„

### 1. ì´ˆê¸° ì¦ìƒ
- ëª¨ë“  íŒ¨ë„ì— "No Data" í‘œì‹œ
- Pod ìƒíƒœ, Deployment, StatefulSet ì •ë³´ ë¯¸í‘œì‹œ
- Container ì¬ì‹œì‘ ë° ì—ëŸ¬ ìƒíƒœ í™•ì¸ ë¶ˆê°€

### 2. ê·¼ë³¸ ì›ì¸
#### ì›ì¸ 1: kube-state-metrics ë¹„í™œì„±í™”
```bash
$ kubectl get deployment -n monitoring kube-prometheus-stack-kube-state-metrics
NAME                                       READY   UP-TO-DATE   AVAILABLE   AGE
kube-prometheus-stack-kube-state-metrics   0/0     0            0           16d
```
- Replica ìˆ˜ê°€ 0ìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì¤‘ë‹¨
- kube-state-metricsëŠ” Kubernetes ë¦¬ì†ŒìŠ¤ ìƒíƒœë¥¼ Prometheus ë©”íŠ¸ë¦­ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•µì‹¬ ì»´í¬ë„ŒíŠ¸

#### ì›ì¸ 2: ì˜ëª»ëœ PromQL ì¿¼ë¦¬
kube-state-metricsëŠ” ê° Podì— ëŒ€í•´ **ëª¨ë“  phase ê°’**(Running, Pending, Failed, Succeeded, Unknown)ì„ ë©”íŠ¸ë¦­ìœ¼ë¡œ ìƒì„±í•˜ë©°, í˜„ì¬ ìƒíƒœì— í•´ë‹¹í•˜ëŠ” phaseë§Œ ê°’ì´ 1, ë‚˜ë¨¸ì§€ëŠ” 0

**ì˜ëª»ëœ ì¿¼ë¦¬ ì˜ˆì‹œ:**
```promql
# âŒ ì˜ëª»ëœ ì¿¼ë¦¬: ëª¨ë“  phase ë©”íŠ¸ë¦­ì„ ì¹´ìš´íŠ¸ (Pod ìˆ˜ Ã— 5)
count(kube_pod_status_phase{phase="Running"})

# ê²°ê³¼: 59ê°œ Running Pod Ã— 5 phase = 295ê°œ (ì˜ëª»ëœ ê°’)
```

**ì‹¤ì œ ë©”íŠ¸ë¦­ êµ¬ì¡°:**
```promql
kube_pod_status_phase{pod="my-pod", phase="Running"} = 1
kube_pod_status_phase{pod="my-pod", phase="Pending"} = 0
kube_pod_status_phase{pod="my-pod", phase="Failed"} = 0
kube_pod_status_phase{pod="my-pod", phase="Succeeded"} = 0
kube_pod_status_phase{pod="my-pod", phase="Unknown"} = 0
```

---

## ğŸ”§ í•´ê²° ë°©ë²•

### 1. kube-state-metrics í™œì„±í™”
```bash
# Deployment replicaë¥¼ 1ë¡œ ìŠ¤ì¼€ì¼
kubectl scale deployment -n monitoring kube-prometheus-stack-kube-state-metrics --replicas=1

# ì •ìƒ ì‹¤í–‰ í™•ì¸
kubectl wait --for=condition=available --timeout=60s \
  deployment/kube-prometheus-stack-kube-state-metrics -n monitoring
```

**ê²°ê³¼:**
```bash
$ kubectl get pods -n monitoring | grep kube-state-metrics
kube-prometheus-stack-kube-state-metrics-6cbcfff9b8-996wb   1/1     Running   0          2m
```

### 2. PromQL ì¿¼ë¦¬ ìˆ˜ì •

#### ìˆ˜ì • ì „ (âŒ)
```promql
# Running Pods
count(kube_pod_status_phase{phase="Running"})

# Pending Pods
count(kube_pod_status_phase{phase="Pending"}) or vector(0)

# Failed Pods
count(kube_pod_status_phase{phase="Failed"}) or vector(0)
```

#### ìˆ˜ì • í›„ (âœ…)
```promql
# Running Pods: value==1ì¸ ë©”íŠ¸ë¦­ë§Œ í•©ì‚°
sum(kube_pod_status_phase{phase="Running"} == 1) or vector(0)

# Pending Pods
sum(kube_pod_status_phase{phase="Pending"} == 1) or vector(0)

# Failed Pods
sum(kube_pod_status_phase{phase="Failed"} == 1) or vector(0)
```

### 3. ìˆ˜ì •ëœ íŒ¨ë„ ëª©ë¡
1. **1ï¸âƒ£ Running Pods** (Stat)
2. **2ï¸âƒ£ Pending Pods** (Stat)
3. **3ï¸âƒ£ Failed Pods** (Stat)
4. **ğŸ“ˆ Pod Phase ì¶”ì´** (Time Series) - 3ê°œ ì¿¼ë¦¬ ëª¨ë‘ ìˆ˜ì •

ì´ **6ê°œ ì¿¼ë¦¬** ìˆ˜ì • ì™„ë£Œ

---

## ğŸ“Š ê²€ì¦ ê²°ê³¼

### 1. ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í˜„í™©
```yaml
Running Pods: 59
Pending Pods: 1
Failed Pods: 5
Container Restarts (5m): 0
CrashLoopBackOff: 1
ImagePullBackOff: 0

Deployments: 23
StatefulSets: 12
```

### 2. ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ìƒíƒœì™€ ë¹„êµ
```bash
# ì‹¤ì œ Running Pods
$ kubectl get pods --all-namespaces --field-selector=status.phase=Running | wc -l
60  # (í—¤ë” í¬í•¨, ì‹¤ì œ 59ê°œ)

# ì‹¤ì œ Pending Pods
$ kubectl get pods --all-namespaces --field-selector=status.phase=Pending | wc -l
2   # (í—¤ë” í¬í•¨, ì‹¤ì œ 1ê°œ)
```

âœ… **ë©”íŠ¸ë¦­ê³¼ ì‹¤ì œ ìƒíƒœ ì¼ì¹˜ í™•ì¸**

### 3. íŒ¨ë„ë³„ ë°ì´í„° í‘œì‹œ ìƒíƒœ

| íŒ¨ë„ | ìƒíƒœ | ê°’ | ë¹„ê³  |
|------|------|-----|------|
| ğŸ“‹ ì›Œí¬ë¡œë“œ í˜„í™© | âœ… | - | í…ìŠ¤íŠ¸ íŒ¨ë„ |
| 1ï¸âƒ£ Running Pods | âœ… | 59 | ì •ìƒ í‘œì‹œ |
| 2ï¸âƒ£ Pending Pods | âœ… | 1 | ì •ìƒ í‘œì‹œ |
| 3ï¸âƒ£ Failed Pods | âœ… | 5 | ì •ìƒ í‘œì‹œ |
| 4ï¸âƒ£ Container ì¬ì‹œì‘ | âœ… | 0 | ì •ìƒ í‘œì‹œ |
| 5ï¸âƒ£ CrashLoopBackOff | âœ… | 1 | ì •ìƒ í‘œì‹œ |
| 6ï¸âƒ£ ImagePullBackOff | âœ… | 0 | ì •ìƒ í‘œì‹œ |
| ğŸ“Š Deployment ìƒíƒœ | âœ… | 23 | í…Œì´ë¸” í‘œì‹œ |
| ğŸ—‚ï¸ StatefulSet ìƒíƒœ | âœ… | 12 | í…Œì´ë¸” í‘œì‹œ |
| ğŸ“ˆ Pod Phase ì¶”ì´ | âœ… | - | ê·¸ë˜í”„ í‘œì‹œ |
| ğŸ”„ Container ì¬ì‹œì‘ ì¶”ì´ | âœ… | - | ê·¸ë˜í”„ í‘œì‹œ |
| âš ï¸ ë¬¸ì œ ìˆëŠ” Pods | âœ… | 6 | í…Œì´ë¸” í‘œì‹œ |

---

## ğŸ” ë°œê²¬ëœ ì´ìŠˆ

### 1. CrashLoopBackOff Pod (1ê°œ)
```bash
$ kubectl get pods --all-namespaces -o wide | grep CrashLoop
```
- **ê¶Œì¥ì‚¬í•­**: Pod ë¡œê·¸ í™•ì¸ ë° ì›ì¸ ë¶„ì„ í•„ìš”

### 2. Failed Pods (5ê°œ)
```bash
$ kubectl get pods --all-namespaces --field-selector=status.phase=Failed
```
- **ê¶Œì¥ì‚¬í•­**: Completed Jobì˜ ì‹¤íŒ¨í•œ Podì¸ì§€ í™•ì¸
- í•„ìš”ì‹œ ì •ë¦¬: `kubectl delete pod <pod-name> -n <namespace>`

### 3. Pending Pod (1ê°œ)
```bash
$ kubectl get pods --all-namespaces --field-selector=status.phase=Pending
```
- **ê¶Œì¥ì‚¬í•­**: Resource ë¶€ì¡± ë˜ëŠ” Node Selector ë¬¸ì œ í™•ì¸

---

## ğŸ“ˆ ì£¼ìš” ë©”íŠ¸ë¦­ ì´í•´

### kube_pod_status_phase
Podì˜ í˜„ì¬ lifecycle phaseë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë©”íŠ¸ë¦­

**ê°€ëŠ¥í•œ Phase ê°’:**
- `Running`: Podê°€ ì‹¤í–‰ ì¤‘
- `Pending`: ìŠ¤ì¼€ì¤„ë§ ëŒ€ê¸° ë˜ëŠ” ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘
- `Succeeded`: ëª¨ë“  ì»¨í…Œì´ë„ˆê°€ ì„±ê³µì ìœ¼ë¡œ ì¢…ë£Œ (Job/CronJob)
- `Failed`: í•˜ë‚˜ ì´ìƒì˜ ì»¨í…Œì´ë„ˆê°€ ì‹¤íŒ¨ë¡œ ì¢…ë£Œ
- `Unknown`: Pod ìƒíƒœë¥¼ ì•Œ ìˆ˜ ì—†ìŒ (ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ ë“±)

**ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•:**
```promql
# ê° phaseë³„ Pod ìˆ˜ ì§‘ê³„
sum(kube_pod_status_phase{phase="Running"} == 1) by (namespace)

# íŠ¹ì • namespaceì˜ Running Pods
sum(kube_pod_status_phase{namespace="monitoring", phase="Running"} == 1)

# ì‹œê°„ì— ë”°ë¥¸ Pod Phase ì¶”ì´
sum(kube_pod_status_phase == 1) by (phase)
```

### kube_deployment_spec_replicas
Deploymentì˜ desired replica ìˆ˜

```promql
# Deployment replica í˜„í™©
kube_deployment_spec_replicas{namespace="monitoring"}

# Available replica ë¹„ìœ¨
kube_deployment_status_replicas_available / kube_deployment_spec_replicas
```

### kube_pod_container_status_restarts_total
Containerì˜ ëˆ„ì  ì¬ì‹œì‘ íšŸìˆ˜ (Counter)

```promql
# 5ë¶„ê°„ ì¬ì‹œì‘ ë¹„ìœ¨
rate(kube_pod_container_status_restarts_total[5m])

# ê°€ì¥ ë§ì´ ì¬ì‹œì‘ëœ ìƒìœ„ 10ê°œ Pod
topk(10, rate(kube_pod_container_status_restarts_total[5m]) > 0)
```

### kube_pod_container_status_waiting_reason
Containerê°€ ëŒ€ê¸° ì¤‘ì¸ ì´ìœ 

**ì£¼ìš” ì´ìœ :**
- `CrashLoopBackOff`: ë°˜ë³µì ìœ¼ë¡œ í¬ë˜ì‹œ ë°œìƒ
- `ImagePullBackOff`: ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨
- `ErrImagePull`: ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ
- `CreateContainerConfigError`: ì„¤ì • ì˜¤ë¥˜

```promql
# CrashLoopBackOff Pod ìˆ˜
count(kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff"})

# ì´ìœ ë³„ ëŒ€ê¸° ì¤‘ì¸ Container ìˆ˜
count by (reason) (kube_pod_container_status_waiting_reason)
```

---

## ğŸ¯ ê¶Œì¥ ì•ŒëŒ ì„¤ì •

### Critical
```yaml
# CrashLoopBackOff ë°œìƒ
count(kube_pod_container_status_waiting_reason{reason="CrashLoopBackOff"}) > 0

# Deployment replica ë¶ˆì¼ì¹˜
(kube_deployment_status_replicas_available / kube_deployment_spec_replicas) < 0.8

# Failed Pod 5ê°œ ì´ìƒ
sum(kube_pod_status_phase{phase="Failed"} == 1) > 5
```

### Warning
```yaml
# Pending Pod 5ë¶„ ì´ìƒ
sum(kube_pod_status_phase{phase="Pending"} == 1) > 0

# Container ì¬ì‹œì‘ ë¹ˆë„ ì¦ê°€
rate(kube_pod_container_status_restarts_total[15m]) > 0.1

# ImagePullBackOff ë°œìƒ
count(kube_pod_container_status_waiting_reason{reason=~"ImagePullBackOff|ErrImagePull"}) > 0
```

---

## ğŸ“ ë³€ê²½ íŒŒì¼

### Dashboard JSON
- **ì›ë³¸**: `/tmp/k8s-workload-status-v1.json`
- **ìˆ˜ì •ë³¸**: `/tmp/k8s-workload-status-v1-fixed.json`
- **ConfigMap**: `grafana-dashboard-k8s-workload-status-v1`

### ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸
- `/tmp/fix_workload_dashboard_v2.py`: ì¿¼ë¦¬ ìë™ ìˆ˜ì • ìŠ¤í¬ë¦½íŠ¸
- `/tmp/test_all_metrics.sh`: ë©”íŠ¸ë¦­ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸

---

## âœ… ìµœì¢… ì²´í¬ë¦¬ìŠ¤íŠ¸

- [x] kube-state-metrics í™œì„±í™” (Replica: 0 â†’ 1)
- [x] Pod Phase ì¿¼ë¦¬ 6ê°œ ìˆ˜ì •
- [x] Dashboard ConfigMap ì—…ë°ì´íŠ¸
- [x] Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™•ì¸
- [x] ëª¨ë“  íŒ¨ë„ ë°ì´í„° í‘œì‹œ í™•ì¸
- [x] ì‹¤ì œ í´ëŸ¬ìŠ¤í„° ìƒíƒœì™€ ë¹„êµ ê²€ì¦
- [x] ë¬¸ì œ Pod ì‹ë³„ ë° ë¦¬í¬íŒ…
- [x] ë¬¸ì„œí™” ì™„ë£Œ

---

## ğŸ”„ í–¥í›„ ì‘ì—…

### 1. kube-state-metrics Replica ì˜êµ¬ ì„¤ì •
í˜„ì¬ `kubectl scale` ëª…ë ¹ìœ¼ë¡œ ì„ì‹œ ì ìš©ëœ ìƒíƒœ. Helm values ë˜ëŠ” Kustomize patchë¡œ ì˜êµ¬ ì„¤ì • ê¶Œì¥:

```yaml
# values.yaml ë˜ëŠ” patch
kube-state-metrics:
  enabled: true
  replicas: 1
```

### 2. ì¶”ê°€ ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ
- [ ] DaemonSet ìƒíƒœ íŒ¨ë„ ì¶”ê°€
- [ ] Job/CronJob ì‹¤í–‰ í˜„í™©
- [ ] PVC (PersistentVolumeClaim) ìƒíƒœ
- [ ] Node ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ ê³¼ Pod ë°°ì¹˜ ìƒê´€ê´€ê³„

### 3. ì•ŒëŒ í†µí•©
- [ ] Alertmanager ì—°ë™
- [ ] Slack/Email ì•Œë¦¼ ì„¤ì •
- [ ] PagerDuty í†µí•© (Critical ì•ŒëŒ)

---

## ğŸ“ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### kube-state-metrics Podê°€ ì‹¤í–‰ë˜ì§€ ì•Šì„ ë•Œ
```bash
# 1. Deployment ìƒíƒœ í™•ì¸
kubectl get deployment -n monitoring kube-prometheus-stack-kube-state-metrics -o yaml

# 2. Pod ì´ë²¤íŠ¸ í™•ì¸
kubectl describe pod -n monitoring -l app.kubernetes.io/name=kube-state-metrics

# 3. ë¡œê·¸ í™•ì¸
kubectl logs -n monitoring -l app.kubernetes.io/name=kube-state-metrics
```

### ë©”íŠ¸ë¦­ì´ ìˆ˜ì§‘ë˜ì§€ ì•Šì„ ë•Œ
```bash
# 1. ServiceMonitor í™•ì¸
kubectl get servicemonitor -n monitoring kube-prometheus-stack-kube-state-metrics

# 2. Prometheus Target í™•ì¸
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-stack-prometheus 9090:9090
# http://localhost:9090/targets ì ‘ì†

# 3. ë©”íŠ¸ë¦­ ì§ì ‘ ì¿¼ë¦¬
kubectl exec -n monitoring prometheus-kube-prometheus-stack-prometheus-0 -- \
  wget -qO- 'http://localhost:9090/api/v1/query?query=kube_pod_info'
```

### Dashboardê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•Šì„ ë•Œ
```bash
# 1. ConfigMap ë¼ë²¨ í™•ì¸
kubectl get cm -n monitoring grafana-dashboard-k8s-workload-status-v1 \
  -o jsonpath='{.metadata.labels}'

# 2. Grafana Pod ì¬ì‹œì‘ (ê°•ì œ ë¦¬ë¡œë“œ)
kubectl rollout restart deployment -n monitoring grafana

# 3. Grafana ë¡œê·¸ í™•ì¸
kubectl logs -n monitoring -l app.kubernetes.io/name=grafana --tail=50
```

---

## ğŸ“ ì°¸ê³  ìë£Œ

- [kube-state-metrics ê³µì‹ ë¬¸ì„œ](https://github.com/kubernetes/kube-state-metrics)
- [Prometheus Kubernetes ëª¨ë‹ˆí„°ë§](https://prometheus.io/docs/guides/node-exporter/)
- [kube-state-metrics ë©”íŠ¸ë¦­ ëª©ë¡](https://github.com/kubernetes/kube-state-metrics/tree/main/docs)

---

**ì‘ì—… ì™„ë£Œ ì‹œê°**: 2025-11-11 14:12 UTC
**ì‘ì—…ì**: Claude (Anthropic)
**ê²€ì¦ ìƒíƒœ**: âœ… ì™„ë£Œ
