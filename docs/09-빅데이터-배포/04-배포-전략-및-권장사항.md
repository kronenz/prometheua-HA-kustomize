# BigData ì• í”Œë¦¬ì¼€ì´ì…˜ ë°°í¬ ì „ëžµ ë° ê¶Œìž¥ì‚¬í•­

## ðŸ“‹ ë°°í¬ ì‹œë„ ê²°ê³¼ ìš”ì•½

**ë‚ ì§œ**: 2025-11-07
**í™˜ê²½**: ë‹¨ì¼ ë…¸ë“œ Kubernetes í´ëŸ¬ìŠ¤í„° (192.168.101.194)
**ë¦¬ì†ŒìŠ¤**: 8 CPU, 16GB RAM (87% CPU, 84% Memory ì´ë¯¸ í• ë‹¹ë¨)

---

## âœ… ì„±ê³µí•œ ë°°í¬

### Apache Spark

**ìƒíƒœ**: âœ… ë°°í¬ ì™„ë£Œ ë° ì•ˆì • ìš´ì˜ ì¤‘

**êµ¬ì„±**:
- Master: 1 replica
- Worker: 2 replicas
- ì´ë¯¸ì§€: `public.ecr.aws/bitnami/spark:3.5.3`
- ë¦¬ì†ŒìŠ¤:
  - Master: 250m CPU, 512Mi Memory
  - Worker: 250m CPU Ã— 2, 512Mi Memory Ã— 2

**ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: âœ… Prometheus ì •ìƒ ìˆ˜ì§‘
- `metrics_master_aliveWorkers_Value = 2`
- `metrics_master_apps_Value`
- Kubernetes ê¸°ë³¸ ë©”íŠ¸ë¦­

**ê²€ì¦**:
- Spark Pi ì˜ˆì œ ì„±ê³µ ì‹¤í–‰
- 38ë¶„ ì´ìƒ ì•ˆì •ì  ìš´ì˜
- Prometheus Target ì •ìƒ (1/1 UP)

---

## âŒ ì‹¤íŒ¨í•œ ë°°í¬

### 1. Apache Kafka

**ì‹œë„ íšŸìˆ˜**: 6íšŒ
**ìµœì¢… ìƒíƒœ**: âŒ ë°°í¬ ì‹¤íŒ¨

#### ì‹¤íŒ¨ ì›ì¸

1. **KRaft ëª¨ë“œ êµ¬ì„± ë³µìž¡ì„±**
   ```
   ERROR: controller.quorum.voters is not set
   Must specify: --standalone, --initial-controllers, or --no-initial-controllers
   ```
   - Bitnami Helm Chartê°€ KRaft ë‹¨ì¼ ë…¸ë“œ ëª¨ë“œë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŒ
   - `extraEnvVars`ë¡œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •í•´ë„ ì ìš© ì•ˆ ë¨
   - Chart ë‚´ë¶€ ë¡œì§ì´ `controller.quorum.voters` ìžë™ ì„¤ì •ì„ ëª» í•¨

2. **Zookeeper ëª¨ë“œ êµ¬ì„± ë¬¸ì œ**
   ```
   ERROR: Missing required configuration `zookeeper.connect`
   ```
   - `kraft.enabled: false` ì„¤ì •ì—ë„ Zookeeper ì—°ê²° ì •ë³´ ë¯¸ì„¤ì •
   - ë³„ë„ Zookeeper StatefulSet ë°°í¬ í•„ìš”

3. **ë¦¬ì†ŒìŠ¤ ë¶€ì¡±**
   - ê¸°ë³¸ 3-replica êµ¬ì„± ì‹œ CPU ë¶€ì¡± (Insufficient CPU)
   - ê° replicaë‹¹ ìµœì†Œ 500m CPU + 2GB Memory í•„ìš”
   - ë‹¨ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ì—ì„œ 3ê°œ Pod ìŠ¤ì¼€ì¤„ë§ ë¶ˆê°€

4. **ì´ë¯¸ì§€ ê°€ìš©ì„± ë¬¸ì œ**
   - JMX Exporter ì´ë¯¸ì§€ `docker.io/bitnami/jmx-exporter:1.4.0` ì—†ìŒ
   - ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë¹„í™œì„±í™”í•´ë„ ë‹¤ë¥¸ ë¬¸ì œ ë°œìƒ

#### ì‹œë„í•œ í•´ê²°ì±…

- âœ— KRaft combined mode + extraEnvVars
- âœ— Zookeeper ëª¨ë“œ ì „í™˜
- âœ— ë‹¨ì¼ replicaë¡œ ê°ì†Œ
- âœ— ë¦¬ì†ŒìŠ¤ ìµœì†Œí™” (150m CPU, 512Mi Memory)
- âœ— ë©”íŠ¸ë¦­ ë¹„í™œì„±í™”
- âœ— Persistence ë¹„í™œì„±í™”

### 2. Apache Airflow

**ì‹œë„ íšŸìˆ˜**: 3íšŒ
**ìµœì¢… ìƒíƒœ**: âŒ ë°°í¬ ì‹¤íŒ¨

#### ì‹¤íŒ¨ ì›ì¸

1. **PostgreSQL ì´ë¯¸ì§€ ë¬¸ì œ**
   ```
   Failed to pull image "docker.io/bitnami/postgresql:16.1.0-debian-11-r15": not found
   ```
   - Docker Hub Bitnami ì´ë¯¸ì§€ 2025ë…„ ì •ì±… ë³€ê²½
   - ECR Public Galleryë¡œ ì „í™˜ í›„ í•´ê²°

2. **Scheduler PVC Attach ì‹¤íŒ¨**
   ```
   AttachVolume.Attach failed for volume pvc-xxx: volume is not ready for workloads
   ```
   - Longhorn volumeì´ ì¤€ë¹„ë˜ì§€ ì•ŠìŒ
   - ë¡œê·¸ persistence ë¹„í™œì„±í™”í•´ë„ ë¬¸ì œ ë°œìƒ

3. **API Server CrashLoopBackOff**
   - Database ë§ˆì´ê·¸ë ˆì´ì…˜ ëŒ€ê¸° ì¤‘ ë°˜ë³µ ì‹¤íŒ¨
   - Init containerê°€ migrations ì™„ë£Œë¥¼ ê°ì§€ ëª» í•¨

4. **ë¦¬ì†ŒìŠ¤ ê²½í•©**
   - PostgreSQL: 100m CPU, 256Mi Memory
   - Webserver: 100m CPU, 256Mi Memory
   - Scheduler: 100m CPU, 256Mi Memory
   - DAG Processor: ì¶”ê°€ ë¦¬ì†ŒìŠ¤ í•„ìš”
   - ì´ 400m+ CPU ì¶”ê°€ í•„ìš” (í˜„ìž¬ 87% í• ë‹¹ ìƒíƒœ)

---

## ðŸŽ¯ ë°°í¬ ì „ëžµ ê¶Œìž¥ì‚¬í•­

### ë‹¨ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„° (í…ŒìŠ¤íŠ¸ í™˜ê²½)

**ê¶Œìž¥ ì• í”Œë¦¬ì¼€ì´ì…˜**: Apache Sparkë§Œ ë°°í¬

**ì´ìœ **:
- SparkëŠ” Stateless êµ¬ì¡°ë¡œ ë‹¨ìˆœí•¨
- LocalExecutor ëª¨ë“œë¡œ ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì 
- ì™¸ë¶€ ì˜ì¡´ì„± ìµœì†Œ (PostgreSQL/Zookeeper ë¶ˆí•„ìš”)
- ë©”íŠ¸ë¦­ ìˆ˜ì§‘ êµ¬ì„± ê°„ë‹¨

**ëŒ€ì‹œë³´ë“œ êµ¬ì„±**:
- Kubernetes ê¸°ë³¸ ë©”íŠ¸ë¦­ í™œìš©
- Spark í´ëŸ¬ìŠ¤í„° ë©”íŠ¸ë¦­ ì¶”ê°€
- Kafka/Airflow íŒ¨ë„ì€ ë¹„í™œì„±í™” ë˜ëŠ” ì œê±°

### 3-Node í´ëŸ¬ìŠ¤í„° (í”„ë¡œë•ì…˜ í™˜ê²½)

**ê¶Œìž¥ êµ¬ì„±**:

#### 1. Apache Spark
```yaml
master:
  replicaCount: 1
  resources:
    requests:
      cpu: 500m
      memory: 1Gi

worker:
  replicaCount: 3
  resources:
    requests:
      cpu: 1000m
      memory: 4Gi
```

#### 2. Apache Kafka
```yaml
kraft:
  enabled: false  # Zookeeper ëª¨ë“œ ê¶Œìž¥

zookeeper:
  enabled: true
  replicaCount: 3

controller:
  replicaCount: 3
  resources:
    requests:
      cpu: 500m
      memory: 2Gi

persistence:
  enabled: true
  storageClass: longhorn
  size: 20Gi
```

#### 3. Apache Airflow
```yaml
executor: "CeleryExecutor"

postgresql:
  enabled: true
  replicaCount: 1
  persistence:
    enabled: true
    size: 10Gi

webserver:
  replicas: 2

scheduler:
  replicas: 2

workers:
  replicas: 3
```

---

## ðŸ“Š ë¦¬ì†ŒìŠ¤ ìš”êµ¬ì‚¬í•­ ë¹„êµ

### ë‹¨ì¼ ë…¸ë“œ (í˜„ìž¬)

| ì• í”Œë¦¬ì¼€ì´ì…˜ | CPU ìš”ì²­ | Memory ìš”ì²­ | ìƒíƒœ |
|------------|---------|------------|------|
| Spark Master | 250m | 512Mi | âœ… ì‹¤í–‰ ì¤‘ |
| Spark Worker Ã— 2 | 500m | 1Gi | âœ… ì‹¤í–‰ ì¤‘ |
| **ì´ê³„** | **750m** | **1.5Gi** | **87% CPU ì‚¬ìš©** |

### 3-Node í”„ë¡œë•ì…˜

| ì• í”Œë¦¬ì¼€ì´ì…˜ | CPU ìš”ì²­ | Memory ìš”ì²­ | í•„ìˆ˜ ë…¸ë“œ ìˆ˜ |
|------------|---------|------------|-------------|
| Spark (Master + 3 Workers) | 3.5 CPU | 13Gi | 3 |
| Kafka (3 brokers + ZK) | 3 CPU | 12Gi | 3 |
| Airflow (ì „ì²´ êµ¬ì„±) | 2 CPU | 6Gi | 2 |
| Monitoring Stack | 2 CPU | 4Gi | 1 |
| **ì´ê³„** | **10.5 CPU** | **35Gi** | **3+ ë…¸ë“œ** |

---

## ðŸ”§ ëŒ€ì•ˆ ì†”ë£¨ì…˜

### ì˜µì…˜ 1: ê´€ë¦¬í˜• ì„œë¹„ìŠ¤ ì‚¬ìš©

**Kafka ëŒ€ì‹ **: Apache Pulsar (ê²½ëŸ‰í™” ê°€ëŠ¥) ë˜ëŠ” AWS MSK/Confluent Cloud

**Airflow ëŒ€ì‹ **: Argo Workflows (Kubernetes ë„¤ì´í‹°ë¸Œ, ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì )

**Trino ëŒ€ì‹ **: Presto (ë” ê°€ë²¼ìš´ ì„¤ì • ê°€ëŠ¥)

### ì˜µì…˜ 2: ë‹¨ê³„ì  ë°°í¬

1. **ë‹¨ê³„ 1 (í˜„ìž¬)**: Sparkë§Œ ë°°í¬
   - Kubernetes + Spark ë©”íŠ¸ë¦­ ëŒ€ì‹œë³´ë“œ
   - ê¸°ë³¸ DataOps ì‹œê°í™”

2. **ë‹¨ê³„ 2**: 2-Node ì¶”ê°€ ì‹œ Kafka ë°°í¬
   - ìµœì†Œ 3-node êµ¬ì„± ì™„ë£Œ
   - Kafka ë©”íŠ¸ë¦­ ëŒ€ì‹œë³´ë“œ ì¶”ê°€

3. **ë‹¨ê³„ 3**: ë¦¬ì†ŒìŠ¤ í™•ìž¥ í›„ Airflow ë°°í¬
   - ì›Œí¬í”Œë¡œìš° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜
   - ì „ì²´ DataOps íŒŒì´í”„ë¼ì¸ ì™„ì„±

### ì˜µì…˜ 3: Edge Computing íŒ¨í„´

**ì¤‘ì•™ í´ëŸ¬ìŠ¤í„° (cluster-01)**:
- Kafka (3 brokers)
- Airflow (ì „ì²´ êµ¬ì„±)
- Thanos Query + Store

**ì—£ì§€ í´ëŸ¬ìŠ¤í„° (cluster-02/03/04)**:
- Sparkë§Œ ë°°í¬
- Prometheus Agent
- ë¡œì»¬ ì²˜ë¦¬ í›„ ì¤‘ì•™ìœ¼ë¡œ ë©”íŠ¸ë¦­ ì „ì†¡

---

## ðŸ“š Kafka ë°°í¬ ê°€ì´ë“œ (3-Node ì´ìƒ)

### ì¤€ë¹„ì‚¬í•­

1. **ìµœì†Œ 3-Node í´ëŸ¬ìŠ¤í„°**
   - ê° ë…¸ë“œ: 4 CPU, 8GB RAM ì´ìƒ
   - Longhorn ë˜ëŠ” Ceph ë¶„ì‚° ìŠ¤í† ë¦¬ì§€

2. **ë„¤íŠ¸ì›Œí¬ ì„¤ì •**
   - Inter-broker í†µì‹ : 9092
   - Controller í†µì‹ : 9093
   - JMX ë©”íŠ¸ë¦­: 9999

### Helm ë°°í¬ (Zookeeper ëª¨ë“œ)

```bash
# 1. Kafka + Zookeeper ë°°í¬
helm repo add bitnami https://charts.bitnami.com/bitnami
helm repo update

# 2. Values íŒŒì¼ ìƒì„±
cat > kafka-production.yaml <<EOF
global:
  security:
    allowInsecureImages: true

image:
  registry: public.ecr.aws
  repository: bitnami/kafka
  tag: 3.9.0

kraft:
  enabled: false

zookeeper:
  enabled: true
  replicaCount: 3
  persistence:
    enabled: true
    storageClass: longhorn
    size: 10Gi
  resources:
    requests:
      cpu: 200m
      memory: 512Mi

controller:
  replicaCount: 3
  persistence:
    enabled: true
    storageClass: longhorn
    size: 20Gi
  resources:
    requests:
      cpu: 500m
      memory: 2Gi

metrics:
  kafka:
    enabled: false  # JMX ì´ë¯¸ì§€ ë¬¸ì œë¡œ ë¹„í™œì„±í™”
  serviceMonitor:
    enabled: false

extraConfig: |
  num.partitions=3
  default.replication.factor=2
  min.insync.replicas=2
  log.retention.hours=168
EOF

# 3. ë°°í¬
kubectl create namespace kafka
helm install kafka bitnami/kafka \
  --namespace kafka \
  --values kafka-production.yaml \
  --timeout 15m

# 4. ê²€ì¦
kubectl get pods -n kafka
kubectl get svc -n kafka
```

### í…ŒìŠ¤íŠ¸

```bash
# Producer í…ŒìŠ¤íŠ¸
kubectl run kafka-producer --rm -it \
  --image public.ecr.aws/bitnami/kafka:3.9.0 \
  --namespace kafka \
  --command -- kafka-console-producer.sh \
    --bootstrap-server kafka.kafka.svc.cluster.local:9092 \
    --topic test

# Consumer í…ŒìŠ¤íŠ¸
kubectl run kafka-consumer --rm -it \
  --image public.ecr.aws/bitnami/kafka:3.9.0 \
  --namespace kafka \
  --command -- kafka-console-consumer.sh \
    --bootstrap-server kafka.kafka.svc.cluster.local:9092 \
    --topic test \
    --from-beginning
```

---

## ðŸ“š Airflow ë°°í¬ ê°€ì´ë“œ (3-Node ì´ìƒ)

### ì¤€ë¹„ì‚¬í•­

1. **PostgreSQL ì™¸ë¶€ êµ¬ì„± ê¶Œìž¥**
   - AWS RDS ë˜ëŠ” ë³„ë„ PostgreSQL í´ëŸ¬ìŠ¤í„°
   - ë‚´ìž¥ PostgreSQLì€ í”„ë¡œë•ì…˜ ë¹„ê¶Œìž¥

2. **DAG ì €ìž¥ì†Œ**
   - Git Repository (GitSync ì‚¬ìš©)
   - ë˜ëŠ” PVC ê³µìœ  ìŠ¤í† ë¦¬ì§€

### Helm ë°°í¬

```bash
# 1. Helm Repo ì¶”ê°€
helm repo add apache-airflow https://airflow.apache.org
helm repo update

# 2. Values íŒŒì¼
cat > airflow-production.yaml <<EOF
executor: "CeleryExecutor"

images:
  airflow:
    repository: apache/airflow
    tag: 2.10.4-python3.11

postgresql:
  enabled: true
  image:
    registry: public.ecr.aws
    repository: bitnami/postgresql
    tag: "16.1.0"
  primary:
    persistence:
      enabled: true
      storageClass: longhorn
      size: 10Gi

redis:
  enabled: true
  master:
    persistence:
      enabled: true
      storageClass: longhorn
      size: 5Gi

webserver:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi

scheduler:
  replicas: 2
  resources:
    requests:
      cpu: 200m
      memory: 512Mi

workers:
  replicas: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi

dags:
  persistence:
    enabled: true
    storageClass: longhorn
    size: 5Gi
EOF

# 3. ë°°í¬
kubectl create namespace airflow
helm install airflow apache-airflow/airflow \
  --namespace airflow \
  --values airflow-production.yaml \
  --timeout 15m

# 4. ì›¹ UI ì ‘ì†
kubectl port-forward -n airflow svc/airflow-webserver 8080:8080
# http://localhost:8080
```

---

## ðŸŽ¯ ìµœì¢… ê¶Œìž¥ì‚¬í•­

### í˜„ìž¬ í™˜ê²½ (ë‹¨ì¼ ë…¸ë“œ)

**ê¶Œìž¥**: Sparkë§Œ ìœ ì§€

**ì´ìœ **:
- ë¦¬ì†ŒìŠ¤ ì œì•½ (CPU 87% í• ë‹¹)
- Kafka/Airflow ë°°í¬ ë³µìž¡ë„ ë†’ìŒ
- Spark ë©”íŠ¸ë¦­ë§Œìœ¼ë¡œë„ ì¶©ë¶„í•œ ëŒ€ì‹œë³´ë“œ êµ¬ì„± ê°€ëŠ¥

**ë‹¤ìŒ ë‹¨ê³„**:
1. Grafanaì—ì„œ Spark + Kubernetes ë©”íŠ¸ë¦­ ëŒ€ì‹œë³´ë“œ ì™„ì„±
2. PromQL ì¿¼ë¦¬ ìµœì í™”
3. ì‹¤ì œ Spark Jobìœ¼ë¡œ ë©”íŠ¸ë¦­ ìƒì„± ë° ê²€ì¦

### í”„ë¡œë•ì…˜ í™˜ê²½ (3+ ë…¸ë“œ)

**ë°°í¬ ìˆœì„œ**:
1. Spark (ë°ì´í„° ì²˜ë¦¬)
2. Kafka (ì´ë²¤íŠ¸ ìŠ¤íŠ¸ë¦¬ë°)
3. Airflow (ì›Œí¬í”Œë¡œìš°)
4. Trino (ë¶„ì‚° SQL)

**í•„ìˆ˜ ì‚¬í•­**:
- ë¶„ì‚° ìŠ¤í† ë¦¬ì§€ (Longhorn/Ceph)
- LoadBalancer (MetalLB/Cilium L2)
- Ingress Controller (Nginx/Traefik)
- ëª¨ë‹ˆí„°ë§ ìŠ¤íƒ (Prometheus/Thanos/Grafana)

---

## ðŸ“– ì°¸ê³  ìžë£Œ

### Kafka
- [Apache Kafka Documentation](https://kafka.apache.org/documentation/)
- [Bitnami Kafka Helm Chart](https://github.com/bitnami/charts/tree/main/bitnami/kafka)
- [Kafka on Kubernetes Best Practices](https://www.confluent.io/blog/kafka-kubernetes/)

### Airflow
- [Apache Airflow Documentation](https://airflow.apache.org/docs/)
- [Airflow Helm Chart](https://airflow.apache.org/docs/helm-chart/)
- [Airflow on Kubernetes Guide](https://airflow.apache.org/docs/apache-airflow/stable/kubernetes.html)

### Spark
- [Apache Spark on Kubernetes](https://spark.apache.org/docs/latest/running-on-kubernetes.html)
- [Bitnami Spark Helm Chart](https://github.com/bitnami/charts/tree/main/bitnami/spark)
