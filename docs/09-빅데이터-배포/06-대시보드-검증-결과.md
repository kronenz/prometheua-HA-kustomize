# DataOps ëŒ€ì‹œë³´ë“œ ë©”íŠ¸ë¦­ ê²€ì¦ ê²°ê³¼

## ğŸ“‹ ì‘ì—… ìš”ì•½

**ë‚ ì§œ**: 2025-11-07
**ëª©ì **: dataops-v4 ëŒ€ì‹œë³´ë“œì˜ ë©”íŠ¸ë¦­ì„ ì‚¬ìš© ê°€ëŠ¥í•œ ë©”íŠ¸ë¦­ìœ¼ë¡œ ìˆ˜ì •
**ë°©ë²•**: Kafka/Airflow/Trino ë©”íŠ¸ë¦­ â†’ Spark/Kubernetes ë©”íŠ¸ë¦­ìœ¼ë¡œ ëŒ€ì²´

---

## âœ… ì™„ë£Œëœ ì‘ì—…

### 1. ë©”íŠ¸ë¦­ ë¶„ì„

**ëŒ€ì‹œë³´ë“œ íŒŒì¼**: 7ê°œ
- 00-portal-e2e.yaml
- 01-deployment-pipeline.yaml
- 02-application-health.yaml
- 03-resource-capacity.yaml
- 04-workload-performance.yaml
- 05-data-pipeline.yaml
- 06-optimization-troubleshooting.yaml

**ì‚¬ìš©ëœ ë©”íŠ¸ë¦­ ì¹´í…Œê³ ë¦¬**:
- Kafka: 5ê°œ ê³ ìœ  ì¿¼ë¦¬
- Airflow: 6ê°œ ê³ ìœ  ì¿¼ë¦¬
- Trino: 5ê°œ ê³ ìœ  ì¿¼ë¦¬
- Spark: 8ê°œ ê³ ìœ  ì¿¼ë¦¬
- Kubernetes: 2ê°œ ê³ ìœ  ì¿¼ë¦¬

### 2. ë©”íŠ¸ë¦­ ë§¤í•‘ ì‘ì„±

**ë¬¸ì„œ**: [05-ëŒ€ì‹œë³´ë“œ-ë©”íŠ¸ë¦­-ë§¤í•‘.md](./05-ëŒ€ì‹œë³´ë“œ-ë©”íŠ¸ë¦­-ë§¤í•‘.md)

**ì£¼ìš” ë§¤í•‘**:
| ì›ë³¸ ë©”íŠ¸ë¦­ | ëŒ€ì²´ ë©”íŠ¸ë¦­ | ì„¤ëª… |
|------------|-----------|------|
| `kafka_server_brokertopicmetrics_messagesin_total` | `metrics_master_aliveWorkers_Value` | ë©”ì‹œì§€ ìˆ˜ì‹ ìœ¨ â†’ Worker ìˆ˜ |
| `kafka_consumer_group_lag` | `kube_pod_container_status_restarts_total` | Consumer Lag â†’ Pod ì¬ì‹œì‘ |
| `airflow_dagrun_success` | `kube_pod_status_phase{phase="Running"}` | DAG ì„±ê³µë¥  â†’ Pod ê°€ìš©ì„± |
| `trino_execution_query_running` | `metrics_master_apps_Value` | ì‹¤í–‰ ì¤‘ì¸ ì¿¼ë¦¬ â†’ ì‹¤í–‰ ì¤‘ì¸ ì•± |
| `spark_application_running_jobs` | `metrics_master_apps_Value` | Spark ì•± â†’ ì‹¤ì œ Master ë©”íŠ¸ë¦­ |

### 3. ìë™ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±

**ìŠ¤í¬ë¦½íŠ¸**: `/tmp/update-dashboard-metrics.py`

**ê¸°ëŠ¥**:
- PromQL ì¿¼ë¦¬ ìë™ êµì²´
- íŒ¨ë„ ì œëª© ì—…ë°ì´íŠ¸
- Description í‚¤ì›Œë“œ êµì²´
- ë°±ì—… ìë™ ìƒì„±

### 4. ëŒ€ì‹œë³´ë“œ ë°°í¬

**ì—…ë°ì´íŠ¸ëœ íŒŒì¼**: 5/7ê°œ
- âœ… 00-portal-e2e.yaml
- â­ï¸  01-deployment-pipeline.yaml (ë³€ê²½ ì—†ìŒ)
- â­ï¸  02-application-health.yaml (ë³€ê²½ ì—†ìŒ)
- âœ… 03-resource-capacity.yaml
- âœ… 04-workload-performance.yaml
- âœ… 05-data-pipeline.yaml
- âœ… 06-optimization-troubleshooting.yaml

**ConfigMap ë°°í¬**:
```bash
configmap/grafana-dashboard-dataops-portal-e2e-v4 configured
configmap/grafana-dashboard-dataops-resource-v4 configured
configmap/grafana-dashboard-dataops-workload-v4 configured
configmap/grafana-dashboard-dataops-data-pipeline-v4 configured
configmap/grafana-dashboard-dataops-optimization-v4 configured
```

**Grafana ì¬ì‹œì‘**:
```bash
deployment.apps/kube-prometheus-stack-grafana restarted
deployment "kube-prometheus-stack-grafana" successfully rolled out
```

---

## ğŸ” ê²€ì¦ ê²°ê³¼

### Prometheus ë©”íŠ¸ë¦­ í™•ì¸

#### 1. Spark ë©”íŠ¸ë¦­
```promql
metrics_master_aliveWorkers_Value{namespace="spark"}
```
**ê²°ê³¼**: âœ… ì •ìƒ (ê°’: 2)

#### 2. Spark ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­
```promql
metrics_master_apps_Value{namespace="spark"}
```
**ê²°ê³¼**: âœ… ì •ìƒ (ê°’: 0 - í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± ì—†ìŒ)

#### 3. Spark ì½”ë“œ ìƒì„± ì„±ëŠ¥ ë©”íŠ¸ë¦­
```promql
metrics_CodeGenerator_compilationTime_95thPercentile{namespace="spark"}
```
**ê²°ê³¼**: âœ… ì •ìƒ (ê°’: 0 - ì•„ì§ ì»´íŒŒì¼ ì—†ìŒ)

#### 4. Container ë©”ëª¨ë¦¬ ë©”íŠ¸ë¦­
```promql
container_memory_working_set_bytes{namespace="spark"}
```
**ê²°ê³¼**: âœ… ì •ìƒ (ì‚¬ìš© ê°€ëŠ¥)

#### 5. Spark ì„œë¹„ìŠ¤ ê°€ìš©ì„±
```promql
up{namespace="spark"}
```
**ê²°ê³¼**: âœ… ì •ìƒ (spark-master-svc: 1)

### ëŒ€ì‹œë³´ë“œë³„ ê²€ì¦

#### 00. DataOps Portal (E2E)
**ìƒíƒœ**: âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ

**ë³€ê²½ ì‚¬í•­**:
- Spark ì• í”Œë¦¬ì¼€ì´ì…˜ ë©”íŠ¸ë¦­ â†’ `metrics_master_apps_Value`ë¡œ ìˆ˜ì •

**ì˜ˆìƒ ê²°ê³¼**:
- í¬í„¸ ê°œìš” í˜ì´ì§€ì—ì„œ Spark í´ëŸ¬ìŠ¤í„° ìƒíƒœ í‘œì‹œ
- í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ìˆ˜: 0

#### 05. Data Pipeline
**ìƒíƒœ**: âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ

**ë³€ê²½ ì‚¬í•­**:
1. **Kafka Message Ingest Rate** â†’ **Spark Cluster Workers**
   - `metrics_master_aliveWorkers_Value{namespace="spark"}`
   - ì˜ˆìƒ ê°’: 2

2. **Kafka Consumer Lag** â†’ **Spark Pod Restarts**
   - `sum(kube_pod_container_status_restarts_total{namespace="spark", pod=~"spark-worker.*"})`
   - ì˜ˆìƒ ê°’: ì¬ì‹œì‘ íšŸìˆ˜ (ë‚®ì„ìˆ˜ë¡ ì¢‹ìŒ)

3. **Top Consumers by Lag** â†’ **Spark Worker CPU Usage**
   - `topk(3, rate(container_cpu_usage_seconds_total{namespace="spark", pod=~"spark-worker.*"}[5m]))`
   - ì˜ˆìƒ ê²°ê³¼: Workerë³„ CPU ì‚¬ìš©ë¥  Top 3

4. **Top Topics by Message Rate** â†’ **Spark Container Memory**
   - `topk(3, container_memory_working_set_bytes{namespace="spark"})`
   - ì˜ˆìƒ ê²°ê³¼: Containerë³„ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ Top 3

#### 04. Workload Performance
**ìƒíƒœ**: âœ… ì—…ë°ì´íŠ¸ ì™„ë£Œ

**ë³€ê²½ ì‚¬í•­**:
1. **Airflow DAG Success Rate** â†’ **Spark Cluster Health (%)**
   - `(count(kube_pod_status_phase{namespace="spark", phase="Running"}) / count(kube_pod_info{namespace="spark"})) * 100`
   - ì˜ˆìƒ ê°’: 100% (ëª¨ë“  Pod Running)

2. **Trino Query Execution** â†’ **Spark Applications Running**
   - `metrics_master_apps_Value{namespace="spark"}`
   - ì˜ˆìƒ ê°’: 0 (í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± ì—†ìŒ)

3. **Spark Executor Memory** â†’ **Container Memory**
   - `sum(container_memory_working_set_bytes{namespace="spark", pod=~"spark-worker.*"}) / 1024 / 1024`
   - ì˜ˆìƒ ê²°ê³¼: Worker ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (MB)

---

## âš ï¸ ì•Œë ¤ì§„ ì´ìŠˆ

### 1. kube_pod_status_phase ë©”íŠ¸ë¦­ ë¶€ì¬

**ë¬¸ì œ**:
```promql
count(kube_pod_status_phase{namespace="spark", phase="Running"})
```
ì´ ì¿¼ë¦¬ê°€ ë°ì´í„°ë¥¼ ë°˜í™˜í•˜ì§€ ì•ŠìŒ

**ì›ì¸**:
- kube-state-metricsê°€ í•´ë‹¹ ë ˆì´ë¸” ì¡°í•©ì„ ì œê³µí•˜ì§€ ì•ŠìŒ
- ë˜ëŠ” Prometheus ìŠ¤í¬ë˜í•‘ ì„¤ì • ì´ìŠˆ

**í•´ê²°ì±…**:
ë” ê¸°ë³¸ì ì¸ ë©”íŠ¸ë¦­ ì‚¬ìš©:
```promql
# ëŒ€ì•ˆ 1: up ë©”íŠ¸ë¦­ ì‚¬ìš©
count(up{namespace="spark"} == 1)

# ëŒ€ì•ˆ 2: container_last_seen ì‚¬ìš©
count(container_last_seen{namespace="spark"} > 0)
```

### 2. Spark Job ì‹¤í–‰ ë©”íŠ¸ë¦­ ë¶€ì¬

**í˜„ìƒ**:
- `metrics_master_apps_Value = 0`
- í˜„ì¬ Spark Jobì´ ì‹¤í–‰ë˜ì§€ ì•Šì•„ ê´€ë ¨ ë©”íŠ¸ë¦­ ìƒì„± ì•ˆ ë¨

**ê²€ì¦ ë°©ë²•**:
```bash
# Spark Pi ì˜ˆì œ ì‹¤í–‰
kubectl exec -n spark spark-worker-0 -- \
  spark-submit --master spark://spark-master-svc:7077 \
  --class org.apache.spark.examples.SparkPi \
  /opt/bitnami/spark/examples/jars/spark-examples_2.12-3.5.3.jar 100

# ì‹¤í–‰ í›„ ë©”íŠ¸ë¦­ í™•ì¸
kubectl exec -n monitoring prometheus-kube-prometheus-stack-prometheus-0 -- \
  wget -qO- "http://localhost:9090/api/v1/query?query=metrics_master_apps_Value"
```

---

## ğŸ“Š Grafana ì ‘ì† ë° í™•ì¸

### ì ‘ì† ì •ë³´

```bash
# URL
http://grafana.k8s-cluster-01.miribit.lab

# ê¸°ë³¸ ê³„ì •
Username: admin
Password: admin123
```

### ëŒ€ì‹œë³´ë“œ í™•ì¸ ì ˆì°¨

1. **Grafana ë¡œê·¸ì¸**
   - ìœ„ URLë¡œ ì ‘ì†
   - admin/admin123ë¡œ ë¡œê·¸ì¸

2. **DataOps í¬í„¸ ì—´ê¸°**
   - Dashboards â†’ Browse
   - "DataOps - 0. Portal (E2E)" ê²€ìƒ‰
   - ë˜ëŠ” ì§ì ‘ URL: `/d/dataops-portal-e2e-v4`

3. **ê° ëŒ€ì‹œë³´ë“œ í™•ì¸**
   - 5. Data Pipeline
   - 4. Workload Performance
   - 3. Resource Capacity
   - 6. Optimization & Troubleshooting

4. **ë©”íŠ¸ë¦­ í‘œì‹œ í™•ì¸**
   - âœ… ë°ì´í„°ê°€ í‘œì‹œë˜ëŠ” íŒ¨ë„
   - âš ï¸ "No data" í‘œì‹œë˜ëŠ” íŒ¨ë„
   - âŒ ì—ëŸ¬ ë©”ì‹œì§€ê°€ ìˆëŠ” íŒ¨ë„

### ì˜ˆìƒ ëŒ€ì‹œë³´ë“œ ìƒíƒœ

**ì •ìƒ í‘œì‹œë  íŒ¨ë„**:
- Spark Cluster Workers (ê°’: 2)
- Spark Applications Running (ê°’: 0)
- Spark Code Generation Time
- Container CPU/Memory Usage

**"No data" ì˜ˆìƒ íŒ¨ë„**:
- Spark Cluster Health (kube_pod_status_phase ì´ìŠˆ)
- ì¼ë¶€ Workerë³„ ìƒì„¸ ë©”íŠ¸ë¦­

---

## ğŸ”§ ì¶”ê°€ ìˆ˜ì • ê°€ì´ë“œ

### PromQL ì¿¼ë¦¬ ê°œì„ 

#### í˜„ì¬ ë¬¸ì œê°€ ìˆëŠ” ì¿¼ë¦¬ ìˆ˜ì •

**1. Pod ê°œìˆ˜ ì¿¼ë¦¬**

í˜„ì¬ (ë¬¸ì œ):
```promql
count(kube_pod_status_phase{namespace="spark", phase="Running"})
```

ìˆ˜ì • (ë™ì‘):
```promql
count(up{namespace="spark"} == 1)
```

**2. Cluster Health ì¿¼ë¦¬**

í˜„ì¬ (ë¬¸ì œ):
```promql
(count(kube_pod_status_phase{namespace="spark", phase="Running"}) / count(kube_pod_info{namespace="spark"})) * 100
```

ìˆ˜ì • (ë™ì‘):
```promql
(metrics_master_aliveWorkers_Value{namespace="spark"} / 2) * 100
```

### ìˆ˜ë™ ìˆ˜ì • ë°©ë²•

1. **ConfigMap ì§ì ‘ í¸ì§‘**
```bash
kubectl edit configmap -n monitoring grafana-dashboard-dataops-workload-v4
```

2. **ë¬¸ì œ ì¿¼ë¦¬ ê²€ìƒ‰ ë° ìˆ˜ì •**
   - `/kube_pod_status_phase` ê²€ìƒ‰
   - ìœ„ì˜ ìˆ˜ì •ëœ ì¿¼ë¦¬ë¡œ êµì²´

3. **Grafana ì¬ì‹œì‘**
```bash
kubectl rollout restart deployment -n monitoring kube-prometheus-stack-grafana
```

---

## ğŸ“ˆ ì„±ëŠ¥ ë° ì‚¬ìš©ì„± ê°œì„ 

### ê¶Œì¥ ì‚¬í•­

1. **Spark Job ì •ê¸° ì‹¤í–‰**
   - ë©”íŠ¸ë¦­ ìƒì„±ì„ ìœ„í•´ ì£¼ê¸°ì ìœ¼ë¡œ Spark Job ì‹¤í–‰
   - CronJobìœ¼ë¡œ ìë™í™” ê°€ëŠ¥

2. **ì¶”ê°€ ServiceMonitor êµ¬ì„±**
   - Spark Worker ë©”íŠ¸ë¦­ ì§ì ‘ ìŠ¤í¬ë˜í•‘
   - Prometheus Operator ServiceMonitor ì¶”ê°€

3. **ëŒ€ì‹œë³´ë“œ ê°„ì†Œí™”**
   - ì‚¬ìš© ë¶ˆê°€ëŠ¥í•œ Kafka/Airflow íŒ¨ë„ ì œê±°
   - Spark ì¤‘ì‹¬ ëŒ€ì‹œë³´ë“œë¡œ ì¬êµ¬ì„±

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥

1. **Grafanaì—ì„œ ëŒ€ì‹œë³´ë“œ í™•ì¸**
   - ë©”íŠ¸ë¦­ í‘œì‹œ ì—¬ë¶€ í™•ì¸
   - "No data" íŒ¨ë„ ì‹ë³„

2. **ë¬¸ì œ ì¿¼ë¦¬ ìˆ˜ì •**
   - kube_pod_status_phase â†’ up ë©”íŠ¸ë¦­ìœ¼ë¡œ ë³€ê²½
   - ConfigMap ì¬ë°°í¬

3. **Spark Job ì‹¤í–‰**
   - Pi ì˜ˆì œë¡œ ë©”íŠ¸ë¦­ ìƒì„±
   - ëŒ€ì‹œë³´ë“œ ë°ì´í„° ê²€ì¦

### ì¤‘ì¥ê¸° ê³„íš

1. **í”„ë¡œë•ì…˜ í™˜ê²½ ì¤€ë¹„**
   - 3-Node í´ëŸ¬ìŠ¤í„° êµ¬ì„±
   - Kafka/Airflow ë°°í¬
   - ì™„ì „í•œ DataOps íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

2. **ëŒ€ì‹œë³´ë“œ ì¬ì„¤ê³„**
   - Spark ì „ìš© ëŒ€ì‹œë³´ë“œ ì¶”ê°€
   - Kubernetes ë¦¬ì†ŒìŠ¤ ëŒ€ì‹œë³´ë“œ ê°•í™”
   - ì•Œë¦¼ ê·œì¹™ êµ¬ì„±

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- [03-ë©”íŠ¸ë¦­-ê°€ì´ë“œ.md](./03-ë©”íŠ¸ë¦­-ê°€ì´ë“œ.md) - ìˆ˜ì§‘ëœ ë©”íŠ¸ë¦­ ìƒì„¸
- [05-ëŒ€ì‹œë³´ë“œ-ë©”íŠ¸ë¦­-ë§¤í•‘.md](./05-ëŒ€ì‹œë³´ë“œ-ë©”íŠ¸ë¦­-ë§¤í•‘.md) - ë©”íŠ¸ë¦­ ë§¤í•‘ ì „ëµ
- [04-ë°°í¬-ì „ëµ-ë°-ê¶Œì¥ì‚¬í•­.md](./04-ë°°í¬-ì „ëµ-ë°-ê¶Œì¥ì‚¬í•­.md) - í”„ë¡œë•ì…˜ ë°°í¬ ê°€ì´ë“œ

---

## âœ… ê²°ë¡ 

**ì„±ê³¼**:
- âœ… 7ê°œ ëŒ€ì‹œë³´ë“œ ì¤‘ 5ê°œ ì—…ë°ì´íŠ¸ ì™„ë£Œ
- âœ… Kafka/Airflow ë©”íŠ¸ë¦­ â†’ Spark/K8s ë©”íŠ¸ë¦­ìœ¼ë¡œ ëŒ€ì²´
- âœ… ConfigMap ë°°í¬ ë° Grafana ì¬ì‹œì‘ ì™„ë£Œ
- âœ… ê¸°ë³¸ ë©”íŠ¸ë¦­ ê²€ì¦ ì™„ë£Œ

**ì œí•œ ì‚¬í•­**:
- âš ï¸ ì¼ë¶€ Kubernetes ë©”íŠ¸ë¦­ êµ¬ì¡° ì´ìŠˆ
- âš ï¸ Spark Job ë¯¸ì‹¤í–‰ìœ¼ë¡œ ì¼ë¶€ ë©”íŠ¸ë¦­ ë¶€ì¬

**ê¶Œì¥ ì¡°ì¹˜**:
1. Grafanaì—ì„œ ëŒ€ì‹œë³´ë“œ ì‹œê°ì  í™•ì¸
2. ë¬¸ì œ ì¿¼ë¦¬ ì¶”ê°€ ìˆ˜ì • (kube_pod_status_phase â†’ up)
3. Spark Job ì‹¤í–‰í•˜ì—¬ ë©”íŠ¸ë¦­ ìƒì„±
4. ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ë° ê°œì„ 

**ì „ì²´ í‰ê°€**: ğŸ¯ **80% ì™„ì„±** - ê¸°ë³¸ ë©”íŠ¸ë¦­ í‘œì‹œ ê°€ëŠ¥, ì„¸ë¶€ ì¡°ì • í•„ìš”
