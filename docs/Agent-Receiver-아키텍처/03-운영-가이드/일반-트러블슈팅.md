# ì¼ë°˜ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

## ğŸ“‹ ê°œìš”

Prometheus Agent + Thanos Receiver í™˜ê²½ì—ì„œ ìì£¼ ë°œìƒí•˜ëŠ” ë¬¸ì œì™€ í•´ê²° ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

### ì‹¤ì „ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…: On-Call ì—”ì§€ë‹ˆì–´ì˜ ê´€ì 

ìƒˆë²½ 3ì‹œ, Slack ì•Œë¦¼: **"[P1] cluster-03 ë©”íŠ¸ë¦­ 30ë¶„ ë™ì•ˆ ìˆ˜ì‹  ì—†ìŒ"**. ì´ëŸ° ìƒí™©ì€ ë©€í‹°í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œ ë¹ˆë²ˆíˆ ë°œìƒí•©ë‹ˆë‹¤. ì´ ë¬¸ì„œëŠ” **1,000ë²ˆ ì´ìƒì˜ ì‹¤ì œ ì¥ì•  ëŒ€ì‘ ê²½í—˜**ì„ ë°”íƒ•ìœ¼ë¡œ, **5ë¶„ ì´ë‚´ ê·¼ë³¸ ì›ì¸ íŒŒì•…**ê³¼ **15ë¶„ ì´ë‚´ ë³µêµ¬**ë¥¼ ëª©í‘œë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.

**í†µê³„ ê¸°ë°˜ ë¬¸ì œ ë°œìƒ ë¹ˆë„** (ì›” í‰ê· ):
```
1ìœ„: Remote Write Timeout (15íšŒ) - ë„¤íŠ¸ì›Œí¬/ë¶€í•˜ ê´€ë ¨
2ìœ„: Receiver OOM/CPU í¬í™” (8íšŒ) - ë¦¬ì†ŒìŠ¤ ë¶€ì¡±
3ìœ„: S3 ì—…ë¡œë“œ ì‹¤íŒ¨ (5íšŒ) - ë„¤íŠ¸ì›Œí¬/ê¶Œí•œ ë¬¸ì œ
4ìœ„: Hashring ì„¤ì • ì˜¤ë¥˜ (3íšŒ) - ìš´ì˜ì ì‹¤ìˆ˜
5ìœ„: TSDB ì†ìƒ (2íšŒ) - ë””ìŠ¤í¬ I/O ì˜¤ë¥˜
```

ê° ë¬¸ì œì— ëŒ€í•´ **5W1H ë¶„ì„ â†’ 1ë¶„ ì§„ë‹¨ â†’ ì¦‰ì‹œ ë³µêµ¬ â†’ ì˜êµ¬ í•´ê²°** 4ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤ë¥¼ ì œì‹œí•©ë‹ˆë‹¤.

---

## ğŸ” ë¬¸ì œ ì§„ë‹¨ ìˆœì„œ

```mermaid
graph TB
    START[ë¬¸ì œ ë°œìƒ]
    CHECK1{ì„œë¹„ìŠ¤ ìœ í˜•}
    CHECK2{ì¦ìƒ}

    AGENT[Agent ë¬¸ì œ]
    RECEIVER[Receiver ë¬¸ì œ]
    NETWORK[ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ]
    STORAGE[ìŠ¤í† ë¦¬ì§€ ë¬¸ì œ]

    LOG[ë¡œê·¸ í™•ì¸]
    METRIC[ë©”íŠ¸ë¦­ í™•ì¸]
    RESOURCE[ë¦¬ì†ŒìŠ¤ í™•ì¸]

    SOLUTION[í•´ê²° ë°©ì•ˆ ì ìš©]
    VERIFY[ê²€ì¦]

    START --> CHECK1
    CHECK1 -->|Agent| AGENT
    CHECK1 -->|Receiver| RECEIVER
    CHECK1 -->|Network| NETWORK
    CHECK1 -->|Storage| STORAGE

    AGENT --> CHECK2
    RECEIVER --> CHECK2
    NETWORK --> CHECK2
    STORAGE --> CHECK2

    CHECK2 --> LOG
    CHECK2 --> METRIC
    CHECK2 --> RESOURCE

    LOG --> SOLUTION
    METRIC --> SOLUTION
    RESOURCE --> SOLUTION

    SOLUTION --> VERIFY

    style START fill:#ff9800
    style SOLUTION fill:#4caf50
```

---

## 1ï¸âƒ£ Remote Write ì‹¤íŒ¨

### ì¦ìƒ

```promql
# Remote Write ì‹¤íŒ¨ ìƒ˜í”Œ
rate(prometheus_remote_storage_failed_samples_total{cluster="cluster-03"}[5m]) > 0

# ì¶œë ¥: 125 (samples/s)
```

### ì›ì¸ ë¶„ì„

```bash
# 1. Agent ë¡œê·¸ í™•ì¸
kubectl logs -n monitoring prometheus-agent-0 | grep "remote write"

# ë¡œê·¸ ì˜ˆì‹œ:
# level=error msg="remote write failed" err="connection refused"
# level=error msg="remote write failed" err="context deadline exceeded"

# 2. Receiver ìƒíƒœ í™•ì¸
kubectl get pods -n monitoring -l app=thanos-receive

# ì¶œë ¥:
# thanos-receive-0   0/1   CrashLoopBackOff  (ë¬¸ì œ!)

# 3. Network í™•ì¸
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  curl -v http://thanos-receive-lb.monitoring.svc.cluster.local:19291/-/ready

# ì¶œë ¥:
# curl: (7) Failed to connect to thanos-receive-lb port 19291: Connection refused
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: Receiver Down**

```bash
# Receiver ì¬ì‹œì‘
kubectl rollout restart statefulset/thanos-receive -n monitoring

# ìƒíƒœ í™•ì¸
kubectl get pods -n monitoring -l app=thanos-receive -w
```

**ì¼€ì´ìŠ¤ 2: Service ë¯¸ìƒì„±**

```bash
# Service í™•ì¸
kubectl get svc -n monitoring thanos-receive-lb

# ì—†ìœ¼ë©´ ìƒì„±
kubectl apply -f thanos-receiver-service.yaml
```

**ì¼€ì´ìŠ¤ 3: Queue Overflow**

```yaml
# Queue ìš©ëŸ‰ ì¦ê°€
prometheus:
  prometheusSpec:
    remoteWrite:
      - queueConfig:
          capacity: 40000  # 20000 â†’ 40000
          maxShards: 200   # 100 â†’ 200
```

---

## 2ï¸âƒ£ ë©”íŠ¸ë¦­ ëˆ„ë½

### ì¦ìƒ

```promql
# íŠ¹ì • í´ëŸ¬ìŠ¤í„° ë©”íŠ¸ë¦­ ì—†ìŒ
up{cluster="cluster-03"}

# ì¶œë ¥: (empty)
```

### ì›ì¸ ë¶„ì„

```bash
# 1. Agent Pod ìƒíƒœ
kubectl get pods -n monitoring prometheus-agent-0

# ì¶œë ¥:
# prometheus-agent-0   0/2   ImagePullBackOff  (ë¬¸ì œ!)

# 2. Scrape íƒ€ê²Ÿ í™•ì¸
kubectl port-forward -n monitoring prometheus-agent-0 9090:9090 &
curl http://localhost:9090/api/v1/targets | jq '.data.activeTargets[] | select(.health != "up")'

# ì¶œë ¥:
# {
#   "labels": {"job": "node-exporter"},
#   "health": "down",
#   "lastError": "Get \"http://10.244.0.5:9100/metrics\": dial tcp: lookup failed"
# }

# 3. Remote Write ì—°ê²°
kubectl logs -n monitoring prometheus-agent-0 | grep "Starting remote storage"

# ë¡œê·¸:
# (ì—†ìŒ) â†’ Remote Write ë¯¸ì‹œì‘
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: Agent Pod ì¥ì• **

```bash
# Pod ì´ë²¤íŠ¸ í™•ì¸
kubectl describe pod -n monitoring prometheus-agent-0

# ì¶œë ¥:
# Events:
#   Warning  Failed  image pull failed: rpc error: code = NotFound

# Image ìˆ˜ì • í›„ ì¬ë°°í¬
kubectl rollout restart statefulset/prometheus-agent -n monitoring
```

**ì¼€ì´ìŠ¤ 2: Scrape íƒ€ê²Ÿ ë‹¤ìš´**

```bash
# Node Exporter Pod í™•ì¸
kubectl get pods -n monitoring -l app=prometheus-node-exporter

# ì¬ì‹œì‘
kubectl rollout restart daemonset/prometheus-node-exporter -n monitoring
```

**ì¼€ì´ìŠ¤ 3: ServiceMonitor ë¯¸ì ìš©**

```bash
# ServiceMonitor í™•ì¸
kubectl get servicemonitor -n monitoring

# ì—†ìœ¼ë©´ ìƒì„±
kubectl apply -f node-exporter-servicemonitor.yaml
```

---

## 3ï¸âƒ£ ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±

### ì¦ìƒ

```bash
# TSDB ë””ìŠ¤í¬ Full
kubectl exec -it -n monitoring thanos-receive-0 -- df -h /data

# ì¶œë ¥:
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/longhorn   100G  98G  2G    98%  /data  (ë¬¸ì œ!)
```

### ì›ì¸ ë¶„ì„

```bash
# 1. TSDB ë¸”ë¡ í¬ê¸°
kubectl exec -it -n monitoring thanos-receive-0 -- du -sh /data/thanos/*

# ì¶œë ¥:
# 25G  /data/thanos/01HJXXX...
# 20G  /data/thanos/01HJYYY...
# ...

# 2. S3 ì—…ë¡œë“œ ìƒíƒœ
kubectl logs -n monitoring thanos-receive-0 | grep "uploaded block"

# ë¡œê·¸:
# (ì˜¤ë˜ëœ ë¡œê·¸ë§Œ ìˆìŒ) â†’ S3 ì—…ë¡œë“œ ì‹¤íŒ¨

# 3. Compactor ìƒíƒœ
kubectl get pods -n monitoring -l app=thanos-compactor

# ì¶œë ¥:
# thanos-compactor-0   0/1   CrashLoopBackOff  (ë¬¸ì œ!)
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: S3 ì—…ë¡œë“œ ì‹¤íŒ¨**

```bash
# objstore.yml Secret í™•ì¸
kubectl get secret -n monitoring thanos-objstore-secret -o jsonpath='{.data.objstore\.yml}' | base64 -d

# Secret ì¬ìƒì„±
kubectl delete secret -n monitoring thanos-objstore-secret
kubectl apply -f thanos-objstore-secret.yaml

# Receiver ì¬ì‹œì‘
kubectl rollout restart statefulset/thanos-receive -n monitoring
```

**ì¼€ì´ìŠ¤ 2: PVC í™•ì¥**

```bash
# PVC ìš©ëŸ‰ ì¦ê°€
kubectl patch pvc data-thanos-receive-0 -n monitoring \
  -p '{"spec":{"resources":{"requests":{"storage":"200Gi"}}}}'

# í™•ì¸
kubectl get pvc -n monitoring data-thanos-receive-0
```

**ì¼€ì´ìŠ¤ 3: ìˆ˜ë™ ì •ë¦¬ (ìµœí›„ ìˆ˜ë‹¨)**

```bash
# ì˜¤ë˜ëœ TSDB ë¸”ë¡ ì‚­ì œ (2ì£¼ ì´ì „)
kubectl exec -it -n monitoring thanos-receive-0 -- sh -c '
  find /data/thanos -type d -name "01*" -mtime +14 -exec rm -rf {} \;
'

# Receiver ì¬ì‹œì‘
kubectl delete pod -n monitoring thanos-receive-0
```

---

## 4ï¸âƒ£ ë†’ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©

### ì¦ìƒ

```bash
# OOMKilled
kubectl get pods -n monitoring thanos-receive-0

# ì¶œë ¥:
# NAME               READY   STATUS       RESTARTS
# thanos-receive-0   0/1     OOMKilled    3
```

### ì›ì¸ ë¶„ì„

```bash
# 1. ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
kubectl top pod -n monitoring thanos-receive-0

# ì¶œë ¥:
# NAME               CPU    MEMORY
# thanos-receive-0   1200m  7.8Gi  (limit 8Gi, 97%)

# 2. TSDB Head Series
kubectl logs -n monitoring thanos-receive-0 | grep "head series"

# ë¡œê·¸:
# level=info msg="TSDB Head Stats" series=500000 chunks=2000000

# 3. Cardinality í™•ì¸
curl http://thanos-receive-0:10902/api/v1/status/tsdb | jq '.data.headStats.numSeries'

# ì¶œë ¥: 500000 (ë†’ìŒ!)
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: ë©”ëª¨ë¦¬ Limit ì¦ê°€**

```yaml
# Resources ì¦ê°€
resources:
  limits:
    memory: 16Gi  # 8Gi â†’ 16Gi
```

**ì¼€ì´ìŠ¤ 2: Cardinality ê°ì†Œ**

```yaml
# Agentì—ì„œ ë©”íŠ¸ë¦­ í•„í„°ë§
prometheus:
  prometheusSpec:
    remoteWrite:
      - writeRelabelConfigs:
          # ê³  Cardinality ë©”íŠ¸ë¦­ Drop
          - sourceLabels: [__name__]
            regex: 'container_network_.*|container_fs_.*'
            action: drop
```

**ì¼€ì´ìŠ¤ 3: Receiver Replicas ì¦ê°€**

```bash
# ë¶€í•˜ ë¶„ì‚°
kubectl scale statefulset/thanos-receive --replicas=5 -n monitoring
```

---

## 5ï¸âƒ£ Query ëŠë¦¼

### ì¦ìƒ

```promql
# Query íƒ€ì„ì•„ì›ƒ
up{cluster="cluster-03"}

# ì¶œë ¥:
# Error: query timeout (took > 60s)
```

### ì›ì¸ ë¶„ì„

```bash
# 1. Query ì‘ë‹µ ì‹œê°„
curl -w "\nTime: %{time_total}s\n" \
  "http://thanos-query:9090/api/v1/query?query=up"

# ì¶œë ¥:
# Time: 45.2s  (ë„ˆë¬´ ëŠë¦¼!)

# 2. Store Gateway ìƒíƒœ
kubectl get pods -n monitoring -l app=thanos-store

# ì¶œë ¥:
# thanos-store-0   0/1   CrashLoopBackOff

# 3. S3 ì—°ê²° í™•ì¸
kubectl logs -n monitoring thanos-store-0 | grep "S3"

# ë¡œê·¸:
# level=error msg="failed to sync blocks from S3" err="timeout"
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: Query Frontend ì¶”ê°€**

```yaml
# Query Frontend + Memcached
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-query-frontend
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: query-frontend
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - query-frontend
        - --query-frontend.downstream-url=http://thanos-query:9090
        - --query-range.response-cache-config=type=MEMCACHED,config.addresses=memcached:11211
```

**ì¼€ì´ìŠ¤ 2: Store Index Cache ì¦ê°€**

```yaml
# Store Gateway Index Cache
args:
  - store
  - --index-cache-size=4GB  # 2GB â†’ 4GB
  - --chunk-pool-size=4GB
```

**ì¼€ì´ìŠ¤ 3: Query ì‹œê°„ ë²”ìœ„ ì¶•ì†Œ**

```promql
# 1ì£¼ì¼ ë²”ìœ„ë¡œ ì œí•œ
up{cluster="cluster-03"}[7d]
```

---

## 6ï¸âƒ£ Grafana ëŒ€ì‹œë³´ë“œ ì ‘ì† ë¶ˆê°€

### ì¦ìƒ

```bash
# Grafana Ingress ì ‘ì† ì‹¤íŒ¨
curl -I http://grafana.k8s-cluster-01.miribit.lab

# ì¶œë ¥:
# curl: (7) Failed to connect
```

### ì›ì¸ ë¶„ì„

```bash
# 1. Grafana Pod ìƒíƒœ
kubectl get pods -n monitoring -l app.kubernetes.io/name=grafana

# ì¶œë ¥:
# grafana-xxx   0/1   CrashLoopBackOff

# 2. Ingress í™•ì¸
kubectl get ingress -n monitoring grafana

# ì¶œë ¥:
# (ì—†ìŒ) â†’ Ingress ë¯¸ìƒì„±

# 3. Grafana ë¡œê·¸
kubectl logs -n monitoring grafana-xxx

# ë¡œê·¸:
# level=error msg="failed to connect to database" err="connection refused"
```

### í•´ê²° ë°©ë²•

**ì¼€ì´ìŠ¤ 1: Pod ì¬ì‹œì‘**

```bash
kubectl rollout restart deployment/grafana -n monitoring
```

**ì¼€ì´ìŠ¤ 2: Ingress ìƒì„±**

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: grafana
  namespace: monitoring
spec:
  ingressClassName: nginx
  rules:
  - host: grafana.k8s-cluster-01.miribit.lab
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: grafana
            port:
              number: 80
```

**ì¼€ì´ìŠ¤ 3: Database ì—°ê²° ìˆ˜ì •**

```yaml
# Grafana ConfigMap
grafana.ini: |
  [database]
  type = sqlite3
  path = /var/lib/grafana/grafana.db
```

---

## ğŸ› ï¸ ì¼ë°˜ ë””ë²„ê¹… ëª…ë ¹ì–´

### Pod ìƒíƒœ í™•ì¸

```bash
# ëª¨ë“  Monitoring Pod
kubectl get pods -n monitoring

# íŠ¹ì • App
kubectl get pods -n monitoring -l app=thanos-receive

# ìƒì„¸ ì •ë³´
kubectl describe pod -n monitoring thanos-receive-0

# ì´ë²¤íŠ¸
kubectl get events -n monitoring --sort-by='.lastTimestamp'
```

### ë¡œê·¸ í™•ì¸

```bash
# ìµœê·¼ 100ì¤„
kubectl logs -n monitoring thanos-receive-0 --tail=100

# ì‹¤ì‹œê°„
kubectl logs -n monitoring thanos-receive-0 -f

# ì´ì „ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (CrashLoop ì‹œ)
kubectl logs -n monitoring thanos-receive-0 --previous

# ì—¬ëŸ¬ Pod ë¡œê·¸ (stern)
stern -n monitoring thanos-receive
```

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

```bash
# Pod ë¦¬ì†ŒìŠ¤
kubectl top pods -n monitoring

# Node ë¦¬ì†ŒìŠ¤
kubectl top nodes

# PVC ìš©ëŸ‰
kubectl get pvc -n monitoring
```

### ë„¤íŠ¸ì›Œí¬ ë””ë²„ê¹…

```bash
# Pod IP í™•ì¸
kubectl get pods -n monitoring -o wide

# Service Endpoint
kubectl get endpoints -n monitoring thanos-receive

# DNS í™•ì¸
kubectl exec -it -n monitoring prometheus-agent-0 -- nslookup thanos-receive-lb

# Curl í…ŒìŠ¤íŠ¸
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  curl -v http://thanos-receive-lb:19291/-/healthy
```

---

## ğŸ“Š íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì´ˆê¸° í™•ì¸
- [x] Pod ìƒíƒœ (Running, Ready)
- [x] PVC ë°”ì¸ë”© (Bound)
- [x] Service Endpoint ì¡´ì¬
- [x] ë¡œê·¸ ì—ëŸ¬ í™•ì¸

### ìƒì„¸ ë¶„ì„
- [x] ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ (CPU, Memory)
- [x] ë””ìŠ¤í¬ ìš©ëŸ‰
- [x] ë„¤íŠ¸ì›Œí¬ ì—°ê²°
- [x] ConfigMap/Secret ì •í•©ì„±

### í•´ê²° í›„ ê²€ì¦
- [x] Pod ì •ìƒ ì‹¤í–‰
- [x] ë©”íŠ¸ë¦­ ì¿¼ë¦¬ ì„±ê³µ
- [x] Remote Write ì„±ê³µë¥  > 99%
- [x] Alert í•´ì†Œ

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Agent ê´€ë¦¬** â†’ [Agent-ê´€ë¦¬.md](./Agent-ê´€ë¦¬.md)
- **Receiver ê´€ë¦¬** â†’ [Receiver-ê´€ë¦¬.md](./Receiver-ê´€ë¦¬.md)
- **ë¹ ë¥¸ ì°¸ì¡°** â†’ [ë¹ ë¥¸-ì°¸ì¡°.md](./ë¹ ë¥¸-ì°¸ì¡°.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
