# ìŠ¤ì¼€ì¼ë§

## ğŸ“‹ ê°œìš”

Prometheus Agent + Thanos Receiver í™˜ê²½ì˜ ìˆ˜í‰/ìˆ˜ì§ ìŠ¤ì¼€ì¼ë§ ì „ëµê³¼ ì‹¤í–‰ ë°©ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

## ğŸ¯ ìŠ¤ì¼€ì¼ë§ ëª©í‘œ

- **ì„±ëŠ¥**: ìƒ˜í”Œ ì²˜ë¦¬ëŸ‰ 2ë°° ì¦ê°€ ì‹œ 1ì‹œê°„ ë‚´ ìŠ¤ì¼€ì¼ ì•„ì›ƒ
- **ë¹„ìš©**: ë¦¬ì†ŒìŠ¤ í™œìš©ë¥  70-80% ìœ ì§€
- **ê°€ìš©ì„±**: ìŠ¤ì¼€ì¼ë§ ì¤‘ ì„œë¹„ìŠ¤ ë¬´ì¤‘ë‹¨
- **ìë™í™”**: HPA/VPAë¡œ ìë™ ìŠ¤ì¼€ì¼ë§

---

## 1ï¸âƒ£ ìŠ¤ì¼€ì¼ë§ ì˜ì‚¬ê²°ì •

### ìŠ¤ì¼€ì¼ ì•„ì›ƒ íŠ¸ë¦¬ê±°

| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì¡°ì¹˜ |
|--------|--------|------|
| **Remote Write Queue** | > 5000 (15ë¶„) | Agent ìƒ¤ë“œ ì¦ê°€ ë˜ëŠ” Receiver ì¦ì„¤ |
| **Receiver CPU** | > 80% (10ë¶„) | Receiver ìˆ˜í‰ í™•ì¥ |
| **Receiver Memory** | > 85% (10ë¶„) | Receiver ìˆ˜ì§ í™•ì¥ |
| **TSDB ìš©ëŸ‰** | > 70% | PVC í™•ì¥ ë˜ëŠ” Retention ë‹¨ì¶• |
| **ìƒ˜í”Œ ì²˜ë¦¬ ì§€ì—°** | > 2ì´ˆ (p99) | Receiver ì¦ì„¤ |

### ìŠ¤ì¼€ì¼ ì¸ íŠ¸ë¦¬ê±°

| ë©”íŠ¸ë¦­ | ì„ê³„ê°’ | ì¡°ì¹˜ |
|--------|--------|------|
| **Receiver CPU** | < 30% (1ì‹œê°„) | Receiver ì¶•ì†Œ (ìµœì†Œ 3ê°œ ìœ ì§€) |
| **Receiver Memory** | < 40% (1ì‹œê°„) | Receiver ë©”ëª¨ë¦¬ ì¶•ì†Œ |
| **Remote Write Queue** | = 0 (30ë¶„) | Agent ìƒ¤ë“œ ê°ì†Œ |

---

## 2ï¸âƒ£ Prometheus Agent ìŠ¤ì¼€ì¼ë§

### Remote Write Shards ìë™ ì¡°ì •

```yaml
# Agentê°€ ìë™ìœ¼ë¡œ Shards ì¡°ì • (ê¸°ë³¸ ë™ì‘)
prometheus:
  prometheusSpec:
    remoteWrite:
      - url: http://thanos-receive-lb:19291/api/v1/receive
        queueConfig:
          minShards: 10      # ìµœì†Œ Shards
          maxShards: 100     # ìµœëŒ€ Shards (ìë™ ì¡°ì •)
          capacity: 20000
```

### Shards ìˆ˜ë™ ì¡°ì • (ê¸´ê¸‰)

```promql
# í˜„ì¬ Shards í™•ì¸
prometheus_remote_storage_shards{cluster="cluster-03"}

# ì¶œë ¥: 50 (ë™ì  ì¡°ì • ì¤‘)
```

```bash
# Agent ì¬ì‹œì‘ìœ¼ë¡œ Shards ì¬ê³„ì‚°
kubectl rollout restart statefulset/prometheus-agent -n monitoring
```

### Agent Scrape ê°„ê²© ì¡°ì • (ë¶€í•˜ ê°ì†Œ)

```yaml
# Scrape Interval ì¦ê°€ (30s â†’ 60s)
prometheus:
  prometheusSpec:
    scrapeInterval: 60s     # ìƒ˜í”Œ ìˆ˜ 50% ê°ì†Œ
    scrapeTimeout: 15s
```

---

## 3ï¸âƒ£ Thanos Receiver ìˆ˜í‰ í™•ì¥

### Receiver Replicas ì¦ê°€

```yaml
# StatefulSet Replicas ë³€ê²½
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-receive
  namespace: monitoring
spec:
  replicas: 5  # 3 â†’ 5ë¡œ ì¦ê°€
```

```bash
# Kubectlë¡œ Scale Out
kubectl scale statefulset/thanos-receive --replicas=5 -n monitoring

# Scale Out ì§„í–‰ í™•ì¸
kubectl get pods -n monitoring -l app=thanos-receive -w

# ì¶œë ¥:
# thanos-receive-3   0/1   Pending
# thanos-receive-3   0/1   ContainerCreating
# thanos-receive-3   1/1   Running
# thanos-receive-4   0/1   Pending
# thanos-receive-4   1/1   Running
```

### Hashring ìë™ ì—…ë°ì´íŠ¸ (HeadlessService ì‚¬ìš©)

```yaml
# Receiverê°€ HeadlessService DNSë¡œ ìë™ ë°œê²¬
# ConfigMap ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš” (SRV ë ˆì½”ë“œ ì‚¬ìš©)

# StatefulSet + HeadlessService êµ¬ì„±
apiVersion: v1
kind: Service
metadata:
  name: thanos-receive
  namespace: monitoring
spec:
  clusterIP: None  # Headless
  ports:
  - name: grpc
    port: 10901
  - name: http
    port: 10902
  - name: remote-write
    port: 19291
  selector:
    app: thanos-receive
```

### Hashring ìˆ˜ë™ ì—…ë°ì´íŠ¸ (Explicit Endpoints)

```yaml
# ConfigMapì— ìƒˆ Endpoint ì¶”ê°€
apiVersion: v1
kind: ConfigMap
metadata:
  name: thanos-receive-hashring
  namespace: monitoring
data:
  hashrings.json: |
    [
      {
        "hashring": "default",
        "endpoints": [
          "thanos-receive-0.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-1.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-2.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-3.thanos-receive.monitoring.svc.cluster.local:10901",  # ì¶”ê°€
          "thanos-receive-4.thanos-receive.monitoring.svc.cluster.local:10901"   # ì¶”ê°€
        ]
      }
    ]
```

```bash
# ConfigMap ì ìš©
kubectl apply -f thanos-receive-hashring.yaml

# Receiver ìˆœì°¨ ì¬ì‹œì‘ (Hot Reload ë¯¸ì§€ì›)
kubectl rollout restart statefulset/thanos-receive -n monitoring

# ì¬ì‹œì‘ ì™„ë£Œ ëŒ€ê¸°
kubectl rollout status statefulset/thanos-receive -n monitoring

# Hashring ê²€ì¦
kubectl logs -n monitoring thanos-receive-0 | grep "hashring"

# ë¡œê·¸ ì˜ˆì‹œ:
# level=info msg="loaded hashring configuration" endpoints=5
```

---

## 4ï¸âƒ£ Thanos Receiver ìˆ˜ì§ í™•ì¥

### CPU/Memory ì¦ê°€

```yaml
# Resources ìˆ˜ì •
spec:
  template:
    spec:
      containers:
      - name: thanos-receive
        resources:
          requests:
            cpu: 2000m      # 1000m â†’ 2000m
            memory: 4Gi     # 2Gi â†’ 4Gi
          limits:
            cpu: 4000m
            memory: 8Gi
```

```bash
# ì ìš© (ìˆœì°¨ ì¬ì‹œì‘)
kubectl apply -f thanos-receiver.yaml

# Pod ì¬ì‹œì‘ í™•ì¸
kubectl get pods -n monitoring -l app=thanos-receive -w

# ì¶œë ¥:
# thanos-receive-2   1/1   Terminating
# thanos-receive-2   0/1   Pending
# thanos-receive-2   1/1   Running  (ìƒˆ ë¦¬ì†ŒìŠ¤)
# thanos-receive-1   1/1   Terminating
# ...
```

### PVC ìš©ëŸ‰ í™•ì¥

```bash
# PVC ìš©ëŸ‰ í™•ì¸
kubectl get pvc -n monitoring | grep thanos-receive

# ì¶œë ¥:
# data-thanos-receive-0   Bound   100Gi   longhorn

# PVC í™•ì¥ (Longhornì€ ì˜¨ë¼ì¸ í™•ì¥ ì§€ì›)
kubectl patch pvc data-thanos-receive-0 -n monitoring \
  -p '{"spec":{"resources":{"requests":{"storage":"200Gi"}}}}'

# í™•ì¥ í™•ì¸
kubectl get pvc -n monitoring data-thanos-receive-0

# ì¶œë ¥:
# CAPACITY   STATUS
# 200Gi      Bound    (í™•ì¥ë¨)

# Pod ë‚´ë¶€ í™•ì¸
kubectl exec -it -n monitoring thanos-receive-0 -- df -h /data

# ì¶œë ¥:
# Filesystem      Size  Used Avail Use% Mounted on
# /dev/longhorn   200G  65G  135G  33%  /data
```

---

## 5ï¸âƒ£ Prometheus HA Replicas ì¦ê°€

### Prometheus StatefulSet Replicas

```yaml
# kube-prometheus-stack values.yaml
prometheus:
  prometheusSpec:
    replicas: 3  # 2 â†’ 3ìœ¼ë¡œ ì¦ê°€

    # Replication Factor (Thanos Sidecar)
    thanos:
      objectStorageConfig:
        key: objstore.yml
        name: thanos-objstore-secret
```

```bash
# Helm Upgrade
helm upgrade kube-prometheus-stack prometheus-community/kube-prometheus-stack \
  -n monitoring \
  -f values.yaml

# ë˜ëŠ” Kustomize
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl apply -f -

# Replicas í™•ì¸
kubectl get statefulset -n monitoring prometheus-kube-prometheus-stack-prometheus

# ì¶œë ¥:
# NAME                                      READY   AGE
# prometheus-kube-prometheus-stack-prometheus   3/3     5d

# Prometheus Pod ëª©ë¡
kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus

# ì¶œë ¥:
# prometheus-kube-prometheus-stack-prometheus-0   3/3   Running
# prometheus-kube-prometheus-stack-prometheus-1   3/3   Running
# prometheus-kube-prometheus-stack-prometheus-2   3/3   Running  (ìƒˆ Pod)
```

### Thanos Query ì¤‘ë³µ ì œê±° í™•ì¸

```promql
# Replica ë ˆì´ë¸”ë¡œ ì¤‘ë³µ ì œê±°
up{job="prometheus", cluster="cluster-01"}

# ì¶œë ¥ (Thanos Queryì—ì„œ):
# up{job="prometheus", cluster="cluster-01"} 1  (ì¤‘ë³µ ì œê±°ë¨)

# ì‹¤ì œ ë©”íŠ¸ë¦­ (Prometheus ì§ì ‘ ì¿¼ë¦¬):
# up{job="prometheus", replica="prometheus-0"} 1
# up{job="prometheus", replica="prometheus-1"} 1
# up{job="prometheus", replica="prometheus-2"} 1  (ì¤‘ë³µ)
```

---

## 6ï¸âƒ£ HPA (Horizontal Pod Autoscaler)

### Receiver HPA ì„¤ì •

```yaml
# HPA: CPU ê¸°ë°˜ ìë™ ìŠ¤ì¼€ì¼ë§
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: thanos-receive-hpa
  namespace: monitoring
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: thanos-receive
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70  # 70% ì´ˆê³¼ ì‹œ Scale Out

  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 75

  # Custom Metric: Remote Write Queue
  - type: Pods
    pods:
      metric:
        name: prometheus_remote_storage_queue_length
      target:
        type: AverageValue
        averageValue: "3000"  # Queue > 3000 ì‹œ Scale Out

  behavior:
    scaleUp:
      stabilizationWindowSeconds: 300  # 5ë¶„ ì•ˆì •í™”
      policies:
      - type: Percent
        value: 50  # 50%ì”© ì¦ê°€
        periodSeconds: 60
    scaleDown:
      stabilizationWindowSeconds: 600  # 10ë¶„ ì•ˆì •í™”
      policies:
      - type: Pods
        value: 1  # 1ê°œì”© ê°ì†Œ
        periodSeconds: 300
```

```bash
# HPA ìƒì„±
kubectl apply -f thanos-receive-hpa.yaml

# HPA ìƒíƒœ í™•ì¸
kubectl get hpa -n monitoring thanos-receive-hpa

# ì¶œë ¥:
# NAME                  REFERENCE                 TARGETS              MINPODS   MAXPODS   REPLICAS
# thanos-receive-hpa    StatefulSet/thanos-receive   65%/70%, 60%/75%     3         10        3

# HPA ì´ë²¤íŠ¸ í™•ì¸
kubectl describe hpa -n monitoring thanos-receive-hpa

# ì¶œë ¥:
# Events:
#   Type    Reason             Message
#   ----    ------             -------
#   Normal  SuccessfulRescale  New size: 5; reason: cpu resource utilization above target
```

---

## 7ï¸âƒ£ VPA (Vertical Pod Autoscaler)

### VPA ì„¤ì¹˜

```bash
# VPA Controller ì„¤ì¹˜
git clone https://github.com/kubernetes/autoscaler.git
cd autoscaler/vertical-pod-autoscaler
./hack/vpa-up.sh
```

### Receiver VPA ì„¤ì •

```yaml
# VPA: ë¦¬ì†ŒìŠ¤ ìë™ ì¡°ì •
apiVersion: autoscaling.k8s.io/v1
kind: VerticalPodAutoscaler
metadata:
  name: thanos-receive-vpa
  namespace: monitoring
spec:
  targetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: thanos-receive

  updatePolicy:
    updateMode: "Auto"  # Auto, Recreate, Initial, Off

  resourcePolicy:
    containerPolicies:
    - containerName: thanos-receive
      minAllowed:
        cpu: 500m
        memory: 1Gi
      maxAllowed:
        cpu: 4000m
        memory: 8Gi
      controlledResources:
      - cpu
      - memory
```

```bash
# VPA ìƒì„±
kubectl apply -f thanos-receive-vpa.yaml

# VPA ê¶Œì¥ì‚¬í•­ í™•ì¸
kubectl describe vpa -n monitoring thanos-receive-vpa

# ì¶œë ¥:
# Recommendation:
#   Container Recommendations:
#     Container Name:  thanos-receive
#     Lower Bound:
#       Cpu:     1200m
#       Memory:  2.5Gi
#     Target:
#       Cpu:     1500m
#       Memory:  3Gi
#     Upper Bound:
#       Cpu:     2000m
#       Memory:  4Gi
```

---

## 8ï¸âƒ£ ìŠ¤ì¼€ì¼ë§ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: íŠ¸ë˜í”½ 2ë°° ì¦ê°€

**í˜„ì¬ ìƒíƒœ**:
- Agent 3ê°œ (cluster-02/03/04)
- ìƒ˜í”Œ: 8,000 samples/s
- Receiver 3 replicas

**ì˜ˆìƒ ë³€í™”**:
- Agent 3ê°œ (ë³€ê²½ ì—†ìŒ)
- ìƒ˜í”Œ: 16,000 samples/s
- Receiver í•„ìš”: 5-6 replicas

**ì‹¤í–‰ ê³„íš**:

```bash
# 1. Remote Write Queue ëª¨ë‹ˆí„°ë§
watch kubectl get pods -n monitoring -l app=thanos-receive \
  -o custom-columns=NAME:.metadata.name,CPU:.spec.containers[0].resources.requests.cpu,MEMORY:.spec.containers[0].resources.requests.memory

# 2. Receiver Scale Out (5 replicas)
kubectl scale statefulset/thanos-receive --replicas=5 -n monitoring

# 3. Hashring ì—…ë°ì´íŠ¸ (ìë™ ë˜ëŠ” ìˆ˜ë™)
kubectl apply -f thanos-receive-hashring.yaml
kubectl rollout restart statefulset/thanos-receive -n monitoring

# 4. ê²€ì¦
kubectl top pods -n monitoring -l app=thanos-receive
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìƒˆ í´ëŸ¬ìŠ¤í„° ì¶”ê°€

**í˜„ì¬ ìƒíƒœ**:
- 4ê°œ í´ëŸ¬ìŠ¤í„° (cluster-01/02/03/04)

**ëª©í‘œ**:
- 5ê°œ í´ëŸ¬ìŠ¤í„° (cluster-05 ì¶”ê°€)

**ì‹¤í–‰ ê³„íš**:

```bash
# 1. Receiver ìš©ëŸ‰ í™•ì¸
kubectl top pods -n monitoring -l app=thanos-receive

# 2. í•„ìš” ì‹œ Receiver Scale Out
kubectl scale statefulset/thanos-receive --replicas=4 -n monitoring

# 3. Cluster-05 Agent ë°°í¬
export KUBECONFIG=~/.kube/configs/cluster-05.conf
kustomize build deploy/overlays/cluster-05-edge/prometheus-agent --enable-helm \
  | kubectl apply -f -

# 4. Remote Write ì—°ê²° í™•ì¸
kubectl logs -n monitoring prometheus-agent-0 | grep "remote write"
```

---

## 9ï¸âƒ£ ë¹„ìš© ìµœì í™”

### ë¦¬ì†ŒìŠ¤ Right-Sizing

```promql
# Agent ì‹¤ì œ CPU ì‚¬ìš©ëŸ‰
avg_over_time(rate(container_cpu_usage_seconds_total{pod=~"prometheus-agent.*"}[5m])[7d:])

# ì¶œë ¥: 0.18 (180m) â†’ requestsë¥¼ 200mìœ¼ë¡œ ì¡°ì •

# Agent ì‹¤ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰
avg_over_time(container_memory_usage_bytes{pod=~"prometheus-agent.*"}[7d:]) / 1024 / 1024

# ì¶œë ¥: 280 (280Mi) â†’ requestsë¥¼ 300Mië¡œ ì¡°ì •
```

### ë¶ˆí•„ìš”í•œ Replicas ì¶•ì†Œ

```bash
# Receiver CPU ì‚¬ìš©ë¥  í™•ì¸ (7ì¼ í‰ê· )
# PromQL: avg_over_time(rate(container_cpu_usage_seconds_total{pod=~"thanos-receive.*"}[5m])[7d:])

# ì¶œë ¥: 0.35 (35%) â†’ Scale In ê°€ëŠ¥

# Receiver ì¶•ì†Œ (5 â†’ 3)
kubectl scale statefulset/thanos-receive --replicas=3 -n monitoring

# ë¹„ìš© ì ˆê°: 2 replicas * $0.05/hour * 730h = $73/month
```

### Spot Instance í™œìš© (Cloud)

```yaml
# Node Affinity: Spot Instance ì„ í˜¸
prometheus:
  prometheusSpec:
    affinity:
      nodeAffinity:
        preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
            - key: node.kubernetes.io/instance-type
              operator: In
              values:
              - spot  # Spot Instance ìš°ì„ 
```

---

## ğŸ¯ ìŠ¤ì¼€ì¼ë§ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Scale Out ì „
- [x] í˜„ì¬ ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥  í™•ì¸ (CPU, Memory)
- [x] Remote Write Queue ìƒíƒœ í™•ì¸
- [x] PVC ìš©ëŸ‰ í™•ì¸
- [x] ìŠ¤ì¼€ì¼ ì•„ì›ƒ í•„ìš”ì„± ê²€ì¦

### Scale Out ì¤‘
- [x] Replicas ì¦ê°€ (Kubectl ë˜ëŠ” Helm)
- [x] Hashring ConfigMap ì—…ë°ì´íŠ¸
- [x] Pod ì¬ì‹œì‘ ë° ìƒíƒœ í™•ì¸
- [x] ì„œë¹„ìŠ¤ ì—°ì†ì„± í™•ì¸

### Scale Out í›„
- [x] ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥  ì¬í™•ì¸ (70-80% ëª©í‘œ)
- [x] Remote Write ì„±ê³µë¥  í™•ì¸
- [x] ë©”íŠ¸ë¦­ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
- [x] Alert Rule ì—…ë°ì´íŠ¸ (ì„ê³„ê°’ ì¡°ì •)

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Receiver ê´€ë¦¬** â†’ [Receiver-ê´€ë¦¬.md](./Receiver-ê´€ë¦¬.md)
- **Agent ê´€ë¦¬** â†’ [Agent-ê´€ë¦¬.md](./Agent-ê´€ë¦¬.md)
- **ì„±ëŠ¥ ìµœì í™”** â†’ [../09-ì„±ëŠ¥-ìµœì í™”/README.md](../09-ì„±ëŠ¥-ìµœì í™”/README.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
