# ë¹ ë¥¸ ì°¸ì¡°

## ğŸ“‹ ê°œìš”

ì¼ìƒ ìš´ì˜ì—ì„œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ëª…ë ¹ì–´ì™€ PromQL ì¿¼ë¦¬ ëª¨ìŒì…ë‹ˆë‹¤.

---

## 1ï¸âƒ£ Kubectl ëª…ë ¹ì–´

### Pod ê´€ë¦¬

```bash
# ëª¨ë“  Monitoring Pod ì¡°íšŒ
kubectl get pods -n monitoring

# íŠ¹ì • App Podë§Œ
kubectl get pods -n monitoring -l app=thanos-receive
kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus

# Pod ìƒì„¸ ì •ë³´
kubectl describe pod -n monitoring thanos-receive-0

# Pod ë¡œê·¸ (ìµœê·¼ 100ì¤„)
kubectl logs -n monitoring thanos-receive-0 --tail=100

# ì‹¤ì‹œê°„ ë¡œê·¸
kubectl logs -n monitoring thanos-receive-0 -f

# ì´ì „ ì»¨í…Œì´ë„ˆ ë¡œê·¸ (Crash ì‹œ)
kubectl logs -n monitoring thanos-receive-0 --previous

# Pod ì¬ì‹œì‘
kubectl delete pod -n monitoring thanos-receive-0

# Deployment/StatefulSet ì¬ì‹œì‘
kubectl rollout restart statefulset/thanos-receive -n monitoring
kubectl rollout restart deployment/grafana -n monitoring

# ì¬ì‹œì‘ ìƒíƒœ í™•ì¸
kubectl rollout status statefulset/thanos-receive -n monitoring
```

### Service/Ingress

```bash
# Service ëª©ë¡
kubectl get svc -n monitoring

# Service Endpoint í™•ì¸
kubectl get endpoints -n monitoring thanos-receive

# Ingress ëª©ë¡
kubectl get ingress -n monitoring

# Ingress ìƒì„¸
kubectl describe ingress -n monitoring grafana
```

### ConfigMap/Secret

```bash
# ConfigMap ëª©ë¡
kubectl get cm -n monitoring

# ConfigMap ë‚´ìš© í™•ì¸
kubectl get cm -n monitoring thanos-receive-hashring -o yaml

# Secret ëª©ë¡
kubectl get secret -n monitoring

# Secret ë””ì½”ë”©
kubectl get secret -n monitoring thanos-objstore-secret \
  -o jsonpath='{.data.objstore\.yml}' | base64 -d

# ConfigMap í¸ì§‘
kubectl edit cm -n monitoring thanos-receive-hashring

# Secret ì¬ìƒì„±
kubectl delete secret -n monitoring thanos-objstore-secret
kubectl apply -f thanos-objstore-secret.yaml
```

### ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

```bash
# Pod ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰
kubectl top pods -n monitoring

# íŠ¹ì • Pod
kubectl top pod -n monitoring thanos-receive-0

# Node ë¦¬ì†ŒìŠ¤
kubectl top nodes

# PVC ìš©ëŸ‰
kubectl get pvc -n monitoring

# PVC ìƒì„¸ (ì‚¬ìš©ëŸ‰)
kubectl describe pvc -n monitoring data-thanos-receive-0
```

### Port-Forward

```bash
# Prometheus Agent
kubectl port-forward -n monitoring prometheus-agent-0 9090:9090

# Thanos Receiver
kubectl port-forward -n monitoring thanos-receive-0 10902:10902

# Thanos Query
kubectl port-forward -n monitoring svc/thanos-query 9090:9090

# Grafana
kubectl port-forward -n monitoring svc/grafana 3000:80
```

### Exec (Pod ì ‘ì†)

```bash
# Shell ì ‘ì†
kubectl exec -it -n monitoring thanos-receive-0 -- sh

# ëª…ë ¹ì–´ ì‹¤í–‰
kubectl exec -n monitoring thanos-receive-0 -- df -h /data

# Curl í…ŒìŠ¤íŠ¸
kubectl exec -n monitoring prometheus-agent-0 -- \
  curl http://thanos-receive-lb:19291/-/healthy
```

---

## 2ï¸âƒ£ ArgoCD ëª…ë ¹ì–´

### Application ê´€ë¦¬

```bash
# Application ëª©ë¡
argocd app list

# Application ìƒíƒœ
argocd app get cluster-01-central

# Application Sync
argocd app sync cluster-01-central

# ê°•ì œ Sync
argocd app sync cluster-01-central --force

# Sync ëŒ€ê¸°
argocd app wait cluster-01-central --health

# Application ë¡œê·¸
argocd app logs cluster-01-central

# Rollback
argocd app rollback cluster-01-central 123abc4
```

### Cluster ê´€ë¦¬

```bash
# Cluster ëª©ë¡
argocd cluster list

# Cluster ì¶”ê°€
argocd cluster add cluster-02 --name cluster-02-edge

# Cluster ì œê±°
argocd cluster rm cluster-02-edge
```

---

## 3ï¸âƒ£ Prometheus ì¿¼ë¦¬ (PromQL)

### ê¸°ë³¸ ì¿¼ë¦¬

```promql
# Up ìƒíƒœ
up

# íŠ¹ì • í´ëŸ¬ìŠ¤í„°
up{cluster="cluster-03"}

# íŠ¹ì • Job
up{job="node-exporter"}

# Down íƒ€ê²Ÿ
up == 0

# íƒ€ê²Ÿ ìˆ˜
count(up) by (cluster)

# í´ëŸ¬ìŠ¤í„°ë³„ íƒ€ê²Ÿ ìˆ˜
count(up == 1) by (cluster, job)
```

### Remote Write ëª¨ë‹ˆí„°ë§

```promql
# Remote Write Queue ê¸¸ì´
prometheus_remote_storage_queue_length

# Queue ìš©ëŸ‰
prometheus_remote_storage_queue_capacity

# Shards ìˆ˜
prometheus_remote_storage_shards

# ì„±ê³µ ìƒ˜í”Œ ì†ë„
rate(prometheus_remote_storage_succeeded_samples_total[5m])

# ì‹¤íŒ¨ ìƒ˜í”Œ ì†ë„
rate(prometheus_remote_storage_failed_samples_total[5m])

# ì„±ê³µë¥ 
rate(prometheus_remote_storage_succeeded_samples_total[5m])
/
(rate(prometheus_remote_storage_succeeded_samples_total[5m])
 + rate(prometheus_remote_storage_failed_samples_total[5m]))

# Remote Write ì§€ì—° (p99)
histogram_quantile(0.99,
  rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])
)

# í‰ê·  ì§€ì—°
rate(prometheus_remote_storage_send_duration_seconds_sum[5m])
/
rate(prometheus_remote_storage_send_duration_seconds_count[5m])

# Dropëœ ìƒ˜í”Œ
rate(prometheus_remote_storage_dropped_samples_total[5m])
```

### Thanos Receiver ëª¨ë‹ˆí„°ë§

```promql
# Receiver ìˆ˜ì‹  ìš”ì²­
rate(thanos_receive_write_requests_total[5m])

# Receiver ìˆ˜ì‹  ìƒ˜í”Œ
rate(thanos_receive_write_timeseries_total[5m])

# Replication ìš”ì²­
rate(thanos_receive_replication_requests_total[5m])

# Replication ì„±ê³µë¥ 
rate(thanos_receive_replication_requests_total{result="success"}[5m])
/
rate(thanos_receive_replication_requests_total[5m])

# TSDB Head Series
thanos_receive_head_series

# TSDB Head Chunks
thanos_receive_head_chunks
```

### ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§

```promql
# CPU ì‚¬ìš©ëŸ‰
rate(container_cpu_usage_seconds_total{pod=~"prometheus-agent.*"}[5m])
rate(container_cpu_usage_seconds_total{pod=~"thanos-receive.*"}[5m])

# ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (MiB)
container_memory_usage_bytes{pod=~"prometheus-agent.*"} / 1024 / 1024
container_memory_usage_bytes{pod=~"thanos-receive.*"} / 1024 / 1024 / 1024

# ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
container_memory_usage_bytes{pod=~"thanos-receive.*"}
/
container_spec_memory_limit_bytes{pod=~"thanos-receive.*"}

# ë””ìŠ¤í¬ ì‚¬ìš©ë¥ 
(node_filesystem_size_bytes{mountpoint="/data"}
 - node_filesystem_avail_bytes{mountpoint="/data"})
/
node_filesystem_size_bytes{mountpoint="/data"}

# ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  (MB/s)
rate(container_network_receive_bytes_total{pod=~"thanos-receive.*"}[5m]) / 1024 / 1024

# ë„¤íŠ¸ì›Œí¬ ì†¡ì‹ 
rate(container_network_transmit_bytes_total{pod=~"prometheus-agent.*"}[5m]) / 1024 / 1024
```

### Scrape ëª¨ë‹ˆí„°ë§

```promql
# Scrape Duration
scrape_duration_seconds

# Scrape ìƒ˜í”Œ ìˆ˜
scrape_samples_scraped

# Scrape ì†ë„
rate(scrape_samples_scraped[5m])

# Scrape ì‹¤íŒ¨
scrape_samples_post_metric_relabeling

# Scrape Timeout
scrape_duration_seconds > 10
```

---

## 4ï¸âƒ£ Thanos CLI

### thanos-receive

```bash
# Health Check
curl http://thanos-receive-0:10902/-/healthy

# Ready Check
curl http://thanos-receive-0:10902/-/ready

# TSDB Stats
curl http://thanos-receive-0:10902/api/v1/status/tsdb | jq .

# Hashring í™•ì¸
curl http://thanos-receive-0:10902/api/v1/receive/hashrings | jq .

# ë©”íŠ¸ë¦­
curl http://thanos-receive-0:10902/metrics | grep thanos_receive
```

### thanos-query

```bash
# Health Check
curl http://thanos-query:9090/-/healthy

# Store Endpoints
curl http://thanos-query:9090/api/v1/stores | jq .

# Query
curl "http://thanos-query:9090/api/v1/query?query=up" | jq .

# Query Range
curl "http://thanos-query:9090/api/v1/query_range?query=up[5m]&start=2025-10-20T10:00:00Z&end=2025-10-20T11:00:00Z&step=30s" | jq .

# Label Values
curl "http://thanos-query:9090/api/v1/label/cluster/values" | jq .
```

### thanos-store

```bash
# Health Check
curl http://thanos-store-0:10902/-/healthy

# Synced Blocks
curl http://thanos-store-0:10902/api/v1/status/tsdb | jq '.data.headStats'

# ë©”íŠ¸ë¦­
curl http://thanos-store-0:10902/metrics | grep thanos_bucket_store
```

---

## 5ï¸âƒ£ MinIO (S3) ëª…ë ¹ì–´

### mc (MinIO Client)

```bash
# Alias ì„¤ì •
mc alias set minio http://s3.minio.miribit.lab:9000 minio minio123

# ë²„í‚· ëª©ë¡
mc ls minio

# ë²„í‚· ë‚´ìš©
mc ls minio/thanos-cluster-01

# ì¬ê·€ ì¡°íšŒ
mc ls --recursive minio/thanos-cluster-01

# ë¸”ë¡ ìˆ˜ ì¹´ìš´íŠ¸
mc ls --recursive minio/thanos-cluster-01 | grep meta.json | wc -l

# ë²„í‚· ì‚¬ìš©ëŸ‰
mc du minio/thanos-cluster-01

# íŒŒì¼ ë³µì‚¬
mc cp minio/thanos-cluster-01/thanos/01HJXXX... /tmp/

# ë²„í‚· ë™ê¸°í™” (ë°±ì—…)
mc mirror minio/thanos-cluster-01 minio-backup/thanos-cluster-01-backup

# ë²„í‚· ì •ì±… í™•ì¸
mc admin policy list minio

# Replication ìƒíƒœ
mc replicate status minio/thanos-cluster-01
```

---

## 6ï¸âƒ£ Helm ëª…ë ¹ì–´

### Chart ê´€ë¦¬

```bash
# Repo ì¶”ê°€
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add argo https://argoproj.github.io/argo-helm

# Repo ì—…ë°ì´íŠ¸
helm repo update

# Chart ê²€ìƒ‰
helm search repo kube-prometheus-stack

# Chart ì •ë³´
helm show chart prometheus-community/kube-prometheus-stack
helm show values prometheus-community/kube-prometheus-stack
```

### Release ê´€ë¦¬

```bash
# Release ëª©ë¡
helm list -n monitoring

# Release ìƒíƒœ
helm status kube-prometheus-stack -n monitoring

# Release ê°’ í™•ì¸
helm get values kube-prometheus-stack -n monitoring

# Release íˆìŠ¤í† ë¦¬
helm history kube-prometheus-stack -n monitoring

# Upgrade
helm upgrade kube-prometheus-stack prometheus-community/kube-prometheus-stack \
  -n monitoring -f values.yaml

# Rollback
helm rollback kube-prometheus-stack 2 -n monitoring

# Uninstall
helm uninstall kube-prometheus-stack -n monitoring
```

---

## 7ï¸âƒ£ Kustomize ëª…ë ¹ì–´

```bash
# Kustomization ë¹Œë“œ
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack

# Helm í†µí•© ë¹Œë“œ
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm

# ì§ì ‘ ë°°í¬
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl apply -f -

# Dry-Run
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl apply -f - --dry-run=client

# Diff
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl diff -f -
```

---

## 8ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë””ë²„ê¹…

```bash
# DNS í™•ì¸
kubectl exec -it -n monitoring prometheus-agent-0 -- nslookup thanos-receive-lb

# Ping
kubectl exec -it -n monitoring prometheus-agent-0 -- ping -c 3 thanos-receive-lb

# Curl (HTTP)
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  curl -v http://thanos-receive-lb:19291/-/healthy

# Telnet (Port Check)
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  telnet thanos-receive-lb 19291

# Traceroute
kubectl exec -it -n monitoring prometheus-agent-0 -- traceroute thanos-receive-lb
```

---

## 9ï¸âƒ£ ë°±ì—…/ë³µêµ¬

```bash
# Longhorn Snapshot ìƒì„±
kubectl apply -f prometheus-snapshot.yaml

# Snapshot ëª©ë¡
kubectl get volumesnapshot -n monitoring

# Velero ë°±ì—…
velero backup create monitoring-backup-$(date +%Y%m%d) \
  --include-namespaces monitoring

# Velero ë°±ì—… ëª©ë¡
velero backup get

# Velero ë³µì›
velero restore create --from-backup monitoring-backup-20251020

# S3 ë°±ì—… (mc)
mc mirror minio/thanos-cluster-01 minio-backup/thanos-cluster-01-backup

# S3 ë³µì›
mc mirror minio-backup/thanos-cluster-01-backup minio/thanos-cluster-01
```

---

## ğŸ”Ÿ ìì£¼ ì‚¬ìš©í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸

### ì „ì²´ í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸

```bash
#!/bin/bash
for cluster in cluster-01 cluster-02 cluster-03 cluster-04; do
  echo "=== $cluster ==="
  export KUBECONFIG=~/.kube/configs/$cluster.conf
  kubectl get pods -n monitoring --no-headers | wc -l
  echo ""
done
```

### Remote Write ì„±ê³µë¥  í™•ì¸

```bash
#!/bin/bash
for cluster in cluster-03 cluster-04; do
  echo "=== $cluster Remote Write ==="
  export KUBECONFIG=~/.kube/configs/$cluster.conf
  POD=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o name | head -1)
  kubectl exec -n monitoring $POD -- wget -qO- http://localhost:9090/api/v1/query?query='rate(prometheus_remote_storage_succeeded_samples_total[5m])' \
    | jq -r '.data.result[0].value[1]'
done
```

### ë””ìŠ¤í¬ ìš©ëŸ‰ í™•ì¸

```bash
#!/bin/bash
for pod in $(kubectl get pods -n monitoring -l app=thanos-receive -o name); do
  echo "=== $pod ==="
  kubectl exec -n monitoring $pod -- df -h /data | tail -1
done
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Agent ê´€ë¦¬** â†’ [Agent-ê´€ë¦¬.md](./Agent-ê´€ë¦¬.md)
- **Receiver ê´€ë¦¬** â†’ [Receiver-ê´€ë¦¬.md](./Receiver-ê´€ë¦¬.md)
- **íŠ¸ëŸ¬ë¸”ìŠˆíŒ…** â†’ [ì¼ë°˜-íŠ¸ëŸ¬ë¸”ìŠˆíŒ….md](./ì¼ë°˜-íŠ¸ëŸ¬ë¸”ìŠˆíŒ….md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
