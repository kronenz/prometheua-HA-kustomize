# 빠른 참조

## 📋 개요

일상 운영에서 자주 사용하는 명령어와 PromQL 쿼리 모음입니다.

---

## 1️⃣ Kubectl 명령어

### Pod 관리

```bash
# 모든 Monitoring Pod 조회
kubectl get pods -n monitoring

# 특정 App Pod만
kubectl get pods -n monitoring -l app=thanos-receive
kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus

# Pod 상세 정보
kubectl describe pod -n monitoring thanos-receive-0

# Pod 로그 (최근 100줄)
kubectl logs -n monitoring thanos-receive-0 --tail=100

# 실시간 로그
kubectl logs -n monitoring thanos-receive-0 -f

# 이전 컨테이너 로그 (Crash 시)
kubectl logs -n monitoring thanos-receive-0 --previous

# Pod 재시작
kubectl delete pod -n monitoring thanos-receive-0

# Deployment/StatefulSet 재시작
kubectl rollout restart statefulset/thanos-receive -n monitoring
kubectl rollout restart deployment/grafana -n monitoring

# 재시작 상태 확인
kubectl rollout status statefulset/thanos-receive -n monitoring
```

### Service/Ingress

```bash
# Service 목록
kubectl get svc -n monitoring

# Service Endpoint 확인
kubectl get endpoints -n monitoring thanos-receive

# Ingress 목록
kubectl get ingress -n monitoring

# Ingress 상세
kubectl describe ingress -n monitoring grafana
```

### ConfigMap/Secret

```bash
# ConfigMap 목록
kubectl get cm -n monitoring

# ConfigMap 내용 확인
kubectl get cm -n monitoring thanos-receive-hashring -o yaml

# Secret 목록
kubectl get secret -n monitoring

# Secret 디코딩
kubectl get secret -n monitoring thanos-objstore-secret \
  -o jsonpath='{.data.objstore\.yml}' | base64 -d

# ConfigMap 편집
kubectl edit cm -n monitoring thanos-receive-hashring

# Secret 재생성
kubectl delete secret -n monitoring thanos-objstore-secret
kubectl apply -f thanos-objstore-secret.yaml
```

### 리소스 사용량

```bash
# Pod 리소스 사용량
kubectl top pods -n monitoring

# 특정 Pod
kubectl top pod -n monitoring thanos-receive-0

# Node 리소스
kubectl top nodes

# PVC 용량
kubectl get pvc -n monitoring

# PVC 상세 (사용량)
kubectl describe pvc -n monitoring data-thanos-receive-0
```

### Port-Forward

```bash
# Prometheus Agent
kubectl port-forward -n monitoring prometheus-agent-0 9090:9090

# Thanos Receiver
kubectl port-forward -n monitoring thanos-receive-0 10902:10902

# Thanos Query
kubectl port-forward -n monitoring svc/thanos-query 9090:9090

# Grafana
kubectl port-forward -n monitoring svc/grafana 3000:80
```

### Exec (Pod 접속)

```bash
# Shell 접속
kubectl exec -it -n monitoring thanos-receive-0 -- sh

# 명령어 실행
kubectl exec -n monitoring thanos-receive-0 -- df -h /data

# Curl 테스트
kubectl exec -n monitoring prometheus-agent-0 -- \
  curl http://thanos-receive-lb:19291/-/healthy
```

---

## 2️⃣ ArgoCD 명령어

### Application 관리

```bash
# Application 목록
argocd app list

# Application 상태
argocd app get cluster-01-central

# Application Sync
argocd app sync cluster-01-central

# 강제 Sync
argocd app sync cluster-01-central --force

# Sync 대기
argocd app wait cluster-01-central --health

# Application 로그
argocd app logs cluster-01-central

# Rollback
argocd app rollback cluster-01-central 123abc4
```

### Cluster 관리

```bash
# Cluster 목록
argocd cluster list

# Cluster 추가
argocd cluster add cluster-02 --name cluster-02-edge

# Cluster 제거
argocd cluster rm cluster-02-edge
```

---

## 3️⃣ Prometheus 쿼리 (PromQL)

### 기본 쿼리

```promql
# Up 상태
up

# 특정 클러스터
up{cluster="cluster-03"}

# 특정 Job
up{job="node-exporter"}

# Down 타겟
up == 0

# 타겟 수
count(up) by (cluster)

# 클러스터별 타겟 수
count(up == 1) by (cluster, job)
```

### Remote Write 모니터링

```promql
# Remote Write Queue 길이
prometheus_remote_storage_queue_length

# Queue 용량
prometheus_remote_storage_queue_capacity

# Shards 수
prometheus_remote_storage_shards

# 성공 샘플 속도
rate(prometheus_remote_storage_succeeded_samples_total[5m])

# 실패 샘플 속도
rate(prometheus_remote_storage_failed_samples_total[5m])

# 성공률
rate(prometheus_remote_storage_succeeded_samples_total[5m])
/
(rate(prometheus_remote_storage_succeeded_samples_total[5m])
 + rate(prometheus_remote_storage_failed_samples_total[5m]))

# Remote Write 지연 (p99)
histogram_quantile(0.99,
  rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])
)

# 평균 지연
rate(prometheus_remote_storage_send_duration_seconds_sum[5m])
/
rate(prometheus_remote_storage_send_duration_seconds_count[5m])

# Drop된 샘플
rate(prometheus_remote_storage_dropped_samples_total[5m])
```

### Thanos Receiver 모니터링

```promql
# Receiver 수신 요청
rate(thanos_receive_write_requests_total[5m])

# Receiver 수신 샘플
rate(thanos_receive_write_timeseries_total[5m])

# Replication 요청
rate(thanos_receive_replication_requests_total[5m])

# Replication 성공률
rate(thanos_receive_replication_requests_total{result="success"}[5m])
/
rate(thanos_receive_replication_requests_total[5m])

# TSDB Head Series
thanos_receive_head_series

# TSDB Head Chunks
thanos_receive_head_chunks
```

### 리소스 모니터링

```promql
# CPU 사용량
rate(container_cpu_usage_seconds_total{pod=~"prometheus-agent.*"}[5m])
rate(container_cpu_usage_seconds_total{pod=~"thanos-receive.*"}[5m])

# 메모리 사용량 (MiB)
container_memory_usage_bytes{pod=~"prometheus-agent.*"} / 1024 / 1024
container_memory_usage_bytes{pod=~"thanos-receive.*"} / 1024 / 1024 / 1024

# 메모리 사용률
container_memory_usage_bytes{pod=~"thanos-receive.*"}
/
container_spec_memory_limit_bytes{pod=~"thanos-receive.*"}

# 디스크 사용률
(node_filesystem_size_bytes{mountpoint="/data"}
 - node_filesystem_avail_bytes{mountpoint="/data"})
/
node_filesystem_size_bytes{mountpoint="/data"}

# 네트워크 수신 (MB/s)
rate(container_network_receive_bytes_total{pod=~"thanos-receive.*"}[5m]) / 1024 / 1024

# 네트워크 송신
rate(container_network_transmit_bytes_total{pod=~"prometheus-agent.*"}[5m]) / 1024 / 1024
```

### Scrape 모니터링

```promql
# Scrape Duration
scrape_duration_seconds

# Scrape 샘플 수
scrape_samples_scraped

# Scrape 속도
rate(scrape_samples_scraped[5m])

# Scrape 실패
scrape_samples_post_metric_relabeling

# Scrape Timeout
scrape_duration_seconds > 10
```

---

## 4️⃣ Thanos CLI

### thanos-receive

```bash
# Health Check
curl http://thanos-receive-0:10902/-/healthy

# Ready Check
curl http://thanos-receive-0:10902/-/ready

# TSDB Stats
curl http://thanos-receive-0:10902/api/v1/status/tsdb | jq .

# Hashring 확인
curl http://thanos-receive-0:10902/api/v1/receive/hashrings | jq .

# 메트릭
curl http://thanos-receive-0:10902/metrics | grep thanos_receive
```

### thanos-query

```bash
# Health Check
curl http://thanos-query:9090/-/healthy

# Store Endpoints
curl http://thanos-query:9090/api/v1/stores | jq .

# Query
curl "http://thanos-query:9090/api/v1/query?query=up" | jq .

# Query Range
curl "http://thanos-query:9090/api/v1/query_range?query=up[5m]&start=2025-10-20T10:00:00Z&end=2025-10-20T11:00:00Z&step=30s" | jq .

# Label Values
curl "http://thanos-query:9090/api/v1/label/cluster/values" | jq .
```

### thanos-store

```bash
# Health Check
curl http://thanos-store-0:10902/-/healthy

# Synced Blocks
curl http://thanos-store-0:10902/api/v1/status/tsdb | jq '.data.headStats'

# 메트릭
curl http://thanos-store-0:10902/metrics | grep thanos_bucket_store
```

---

## 5️⃣ MinIO (S3) 명령어

### mc (MinIO Client)

```bash
# Alias 설정
mc alias set minio http://s3.minio.miribit.lab:9000 minio minio123

# 버킷 목록
mc ls minio

# 버킷 내용
mc ls minio/thanos-cluster-01

# 재귀 조회
mc ls --recursive minio/thanos-cluster-01

# 블록 수 카운트
mc ls --recursive minio/thanos-cluster-01 | grep meta.json | wc -l

# 버킷 사용량
mc du minio/thanos-cluster-01

# 파일 복사
mc cp minio/thanos-cluster-01/thanos/01HJXXX... /tmp/

# 버킷 동기화 (백업)
mc mirror minio/thanos-cluster-01 minio-backup/thanos-cluster-01-backup

# 버킷 정책 확인
mc admin policy list minio

# Replication 상태
mc replicate status minio/thanos-cluster-01
```

---

## 6️⃣ Helm 명령어

### Chart 관리

```bash
# Repo 추가
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo add argo https://argoproj.github.io/argo-helm

# Repo 업데이트
helm repo update

# Chart 검색
helm search repo kube-prometheus-stack

# Chart 정보
helm show chart prometheus-community/kube-prometheus-stack
helm show values prometheus-community/kube-prometheus-stack
```

### Release 관리

```bash
# Release 목록
helm list -n monitoring

# Release 상태
helm status kube-prometheus-stack -n monitoring

# Release 값 확인
helm get values kube-prometheus-stack -n monitoring

# Release 히스토리
helm history kube-prometheus-stack -n monitoring

# Upgrade
helm upgrade kube-prometheus-stack prometheus-community/kube-prometheus-stack \
  -n monitoring -f values.yaml

# Rollback
helm rollback kube-prometheus-stack 2 -n monitoring

# Uninstall
helm uninstall kube-prometheus-stack -n monitoring
```

---

## 7️⃣ Kustomize 명령어

```bash
# Kustomization 빌드
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack

# Helm 통합 빌드
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm

# 직접 배포
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl apply -f -

# Dry-Run
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl apply -f - --dry-run=client

# Diff
kustomize build deploy/overlays/cluster-01-central/kube-prometheus-stack --enable-helm \
  | kubectl diff -f -
```

---

## 8️⃣ 네트워크 디버깅

```bash
# DNS 확인
kubectl exec -it -n monitoring prometheus-agent-0 -- nslookup thanos-receive-lb

# Ping
kubectl exec -it -n monitoring prometheus-agent-0 -- ping -c 3 thanos-receive-lb

# Curl (HTTP)
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  curl -v http://thanos-receive-lb:19291/-/healthy

# Telnet (Port Check)
kubectl exec -it -n monitoring prometheus-agent-0 -- \
  telnet thanos-receive-lb 19291

# Traceroute
kubectl exec -it -n monitoring prometheus-agent-0 -- traceroute thanos-receive-lb
```

---

## 9️⃣ 백업/복구

```bash
# Longhorn Snapshot 생성
kubectl apply -f prometheus-snapshot.yaml

# Snapshot 목록
kubectl get volumesnapshot -n monitoring

# Velero 백업
velero backup create monitoring-backup-$(date +%Y%m%d) \
  --include-namespaces monitoring

# Velero 백업 목록
velero backup get

# Velero 복원
velero restore create --from-backup monitoring-backup-20251020

# S3 백업 (mc)
mc mirror minio/thanos-cluster-01 minio-backup/thanos-cluster-01-backup

# S3 복원
mc mirror minio-backup/thanos-cluster-01-backup minio/thanos-cluster-01
```

---

## 🔟 자주 사용하는 스크립트

### 전체 클러스터 상태 확인

```bash
#!/bin/bash
for cluster in cluster-01 cluster-02 cluster-03 cluster-04; do
  echo "=== $cluster ==="
  export KUBECONFIG=~/.kube/configs/$cluster.conf
  kubectl get pods -n monitoring --no-headers | wc -l
  echo ""
done
```

### Remote Write 성공률 확인

```bash
#!/bin/bash
for cluster in cluster-03 cluster-04; do
  echo "=== $cluster Remote Write ==="
  export KUBECONFIG=~/.kube/configs/$cluster.conf
  POD=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o name | head -1)
  kubectl exec -n monitoring $POD -- wget -qO- http://localhost:9090/api/v1/query?query='rate(prometheus_remote_storage_succeeded_samples_total[5m])' \
    | jq -r '.data.result[0].value[1]'
done
```

### 디스크 용량 확인

```bash
#!/bin/bash
for pod in $(kubectl get pods -n monitoring -l app=thanos-receive -o name); do
  echo "=== $pod ==="
  kubectl exec -n monitoring $pod -- df -h /data | tail -1
done
```

---

## 🔗 관련 문서

- **Agent 관리** → [Agent-관리.md](./Agent-관리.md)
- **Receiver 관리** → [Receiver-관리.md](./Receiver-관리.md)
- **트러블슈팅** → [일반-트러블슈팅.md](./일반-트러블슈팅.md)

---

**최종 업데이트**: 2025-10-20
