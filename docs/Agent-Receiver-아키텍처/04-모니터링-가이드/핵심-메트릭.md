# í•µì‹¬ ë©”íŠ¸ë¦­

## ğŸ“‹ ê°œìš”

Prometheus Agent + Thanos Receiver í™˜ê²½ì—ì„œ ëª¨ë‹ˆí„°ë§í•´ì•¼ í•  í•„ìˆ˜ ë©”íŠ¸ë¦­ê³¼ ì„ê³„ê°’ì„ ì •ì˜í•©ë‹ˆë‹¤.

---

## ğŸ¯ ë©”íŠ¸ë¦­ ì¹´í…Œê³ ë¦¬

| ì¹´í…Œê³ ë¦¬ | ë©”íŠ¸ë¦­ ìˆ˜ | ìš°ì„ ìˆœìœ„ | ìˆ˜ì§‘ ê°„ê²© |
|---------|---------|---------|----------|
| **Remote Write** | 12ê°œ | P1 (Critical) | 30s |
| **Thanos Receiver** | 15ê°œ | P1 (Critical) | 30s |
| **Agent ë¦¬ì†ŒìŠ¤** | 8ê°œ | P2 (High) | 30s |
| **Receiver ë¦¬ì†ŒìŠ¤** | 10ê°œ | P2 (High) | 30s |
| **TSDB** | 8ê°œ | P2 (High) | 1m |
| **ë„¤íŠ¸ì›Œí¬** | 6ê°œ | P3 (Medium) | 1m |

---

## 1ï¸âƒ£ Remote Write ë©”íŠ¸ë¦­

### í•„ìˆ˜ ë©”íŠ¸ë¦­

```promql
# 1. Remote Write Queue ê¸¸ì´ (ì¤‘ìš”ë„: â˜…â˜…â˜…â˜…â˜…)
prometheus_remote_storage_queue_length

# ì„ê³„ê°’:
# - ì •ìƒ: 0-100
# - ì£¼ì˜: 100-1000
# - ê²½ê³ : 1000-5000
# - ìœ„í—˜: 5000+

# 2. Remote Write ì„±ê³µ ìƒ˜í”Œ (samples/s)
rate(prometheus_remote_storage_succeeded_samples_total[5m])

# ëª©í‘œ: > 8,000 samples/s (cluster-03)

# 3. Remote Write ì‹¤íŒ¨ ìƒ˜í”Œ
rate(prometheus_remote_storage_failed_samples_total[5m])

# ëª©í‘œ: 0 (100% ì„±ê³µ)

# 4. Remote Write ì„±ê³µë¥ 
rate(prometheus_remote_storage_succeeded_samples_total[5m])
/
(rate(prometheus_remote_storage_succeeded_samples_total[5m])
 + rate(prometheus_remote_storage_failed_samples_total[5m]))

# ëª©í‘œ: > 0.995 (99.5%)

# 5. Remote Write Shards ìˆ˜
prometheus_remote_storage_shards

# ë²”ìœ„: 10-100 (ìë™ ì¡°ì •)

# 6. Remote Write Queue ìš©ëŸ‰
prometheus_remote_storage_queue_capacity

# ì„¤ì •ê°’: 20,000

# 7. Remote Write ì „ì†¡ ì¤‘ ìƒ˜í”Œ
prometheus_remote_storage_pending_samples

# ëª©í‘œ: < 10,000

# 8. Remote Write ì§€ì—° ì‹œê°„ (ì´ˆ)
histogram_quantile(0.99,
  rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])
)

# ëª©í‘œ: < 1s (p99)

# 9. Remote Write ì¬ì‹œë„
rate(prometheus_remote_storage_retried_samples_total[5m])

# ëª©í‘œ: ìµœì†Œí™”

# 10. Remote Write Drop ìƒ˜í”Œ
rate(prometheus_remote_storage_dropped_samples_total[5m])

# ëª©í‘œ: 0

# 11. Remote Write ìµœê³  ìƒ˜í”Œ íƒ€ì„ìŠ¤íƒ¬í”„
prometheus_remote_storage_highest_timestamp_in_seconds

# ì§€ì—° í™•ì¸: time() - prometheus_remote_storage_highest_timestamp_in_seconds

# 12. Remote Write Enqueue ì§€ì—°
histogram_quantile(0.99,
  rate(prometheus_remote_storage_enqueue_duration_seconds_bucket[5m])
)

# ëª©í‘œ: < 100ms (p99)
```

---

## 2ï¸âƒ£ Thanos Receiver ë©”íŠ¸ë¦­

### ìˆ˜ì‹  ë©”íŠ¸ë¦­

```promql
# 1. Receiver Write ìš”ì²­ ì†ë„ (ì¤‘ìš”ë„: â˜…â˜…â˜…â˜…â˜…)
rate(thanos_receive_write_requests_total[5m])

# 2. Receiver ìˆ˜ì‹  ì‹œê³„ì—´ ì†ë„
rate(thanos_receive_write_timeseries_total[5m])

# ëª©í‘œ: > 8,000 timeseries/s

# 3. Receiver Write ì‹¤íŒ¨
rate(thanos_receive_write_requests_total{code!~"2.."}[5m])

# ëª©í‘œ: 0

# 4. Receiver Replication ìš”ì²­
rate(thanos_receive_replication_requests_total[5m])

# 5. Replication ì„±ê³µë¥ 
rate(thanos_receive_replication_requests_total{result="success"}[5m])
/
rate(thanos_receive_replication_requests_total[5m])

# ëª©í‘œ: > 0.999 (99.9%)

# 6. Receiver Replication ì§€ì—°
histogram_quantile(0.99,
  rate(thanos_receive_replication_duration_seconds_bucket[5m])
)

# ëª©í‘œ: < 500ms (p99)

# 7. Receiver Hashring Nodes (Active)
thanos_receive_hashring_nodes{state="active"}

# ì˜ˆìƒ: 3 (ë˜ëŠ” ì„¤ì •ëœ replicas)

# 8. Receiver TSDB Head Series
thanos_receive_head_series

# ëª¨ë‹ˆí„°ë§ (ì‹œê°„ë‹¹ ì¦ê°€ìœ¨)

# 9. Receiver TSDB Head Chunks
thanos_receive_head_chunks

# 10. Receiver Forward ìš”ì²­ (Hashring ë¼ìš°íŒ…)
rate(thanos_receive_forward_requests_total[5m])

# 11. Receiver Appender ë™ì‹œì„±
thanos_receive_head_appenders

# 12. Receiver Tenant ë³„ ìƒ˜í”Œ ìˆ˜
sum(rate(thanos_receive_write_timeseries_total[5m])) by (tenant)
```

### S3 ì—…ë¡œë“œ ë©”íŠ¸ë¦­

```promql
# 13. Shipper ì—…ë¡œë“œ ì„±ê³µ
thanos_shipper_uploads_total{instance=~"thanos-receive.*"}

# 14. Shipper ì—…ë¡œë“œ ì‹¤íŒ¨
thanos_shipper_upload_failures_total{instance=~"thanos-receive.*"}

# ëª©í‘œ: 0

# 15. Shipper ì—…ë¡œë“œ Duration
histogram_quantile(0.99,
  rate(thanos_shipper_upload_duration_seconds_bucket{instance=~"thanos-receive.*"}[1h])
)

# ëª©í‘œ: < 30s (p99)
```

---

## 3ï¸âƒ£ Agent ë¦¬ì†ŒìŠ¤ ë©”íŠ¸ë¦­

### CPU/Memory

```promql
# 1. Agent CPU ì‚¬ìš©ëŸ‰ (cores)
rate(container_cpu_usage_seconds_total{pod=~"prometheus-agent.*"}[5m])

# ëª©í‘œ: < 0.5 cores (limit: 0.5)

# 2. Agent ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (MiB)
container_memory_usage_bytes{pod=~"prometheus-agent.*"} / 1024 / 1024

# ëª©í‘œ: < 400Mi (limit: 512Mi)

# 3. Agent ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
container_memory_usage_bytes{pod=~"prometheus-agent.*"}
/
container_spec_memory_limit_bytes{pod=~"prometheus-agent.*"}

# ëª©í‘œ: < 0.8 (80%)

# 4. Agent ë©”ëª¨ë¦¬ Working Set
container_memory_working_set_bytes{pod=~"prometheus-agent.*"} / 1024 / 1024

# 5. Agent Process ë©”ëª¨ë¦¬
process_resident_memory_bytes{job="prometheus-agent"} / 1024 / 1024
```

### WAL ë° ìŠ¤í† ë¦¬ì§€

```promql
# 6. WAL Segment ìˆ˜
prometheus_tsdb_wal_segment_current{job="prometheus-agent"}

# 7. WAL Checkpoint Duration
prometheus_tsdb_checkpoint_duration_seconds{job="prometheus-agent"}

# 8. WAL Corruption
increase(prometheus_tsdb_wal_corruptions_total[1h])

# ëª©í‘œ: 0
```

---

## 4ï¸âƒ£ Receiver ë¦¬ì†ŒìŠ¤ ë©”íŠ¸ë¦­

### CPU/Memory

```promql
# 1. Receiver CPU ì‚¬ìš©ëŸ‰ (cores)
rate(container_cpu_usage_seconds_total{pod=~"thanos-receive.*"}[5m])

# ëª©í‘œ: < 3.5 cores (limit: 4 cores)

# 2. Receiver ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (GiB)
container_memory_usage_bytes{pod=~"thanos-receive.*"} / 1024 / 1024 / 1024

# ëª©í‘œ: < 7Gi (limit: 8Gi)

# 3. Receiver ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
container_memory_usage_bytes{pod=~"thanos-receive.*"}
/
container_spec_memory_limit_bytes{pod=~"thanos-receive.*"}

# ëª©í‘œ: < 0.85 (85%)
```

### TSDB

```promql
# 4. TSDB Storage Blocks
prometheus_tsdb_storage_blocks_bytes{job="thanos-receive"} / 1024 / 1024 / 1024

# 5. TSDB Compaction Duration
histogram_quantile(0.99,
  rate(prometheus_tsdb_compaction_duration_seconds_bucket{job="thanos-receive"}[1h])
)

# 6. TSDB Compaction ì‹¤íŒ¨
increase(prometheus_tsdb_compactions_failed_total{job="thanos-receive"}[1h])

# ëª©í‘œ: 0

# 7. TSDB ë¸”ë¡ ìˆ˜
prometheus_tsdb_blocks_loaded{job="thanos-receive"}

# 8. TSDB Symbol Table Size
prometheus_tsdb_symbol_table_size_bytes{job="thanos-receive"} / 1024 / 1024

# 9. TSDB Series ì‚­ì œ ì†ë„
rate(prometheus_tsdb_head_series_removed_total{job="thanos-receive"}[5m])

# 10. TSDB Out of Order ìƒ˜í”Œ
rate(prometheus_tsdb_out_of_order_samples_total{job="thanos-receive"}[5m])

# ëª©í‘œ: ìµœì†Œí™”
```

---

## 5ï¸âƒ£ Scrape ë©”íŠ¸ë¦­

```promql
# 1. Scrape Duration (ì´ˆ)
scrape_duration_seconds

# ëª©í‘œ: < 10s (timeout)

# 2. Scrape ìƒ˜í”Œ ìˆ˜
scrape_samples_scraped

# 3. Scrape ì†ë„
rate(scrape_samples_scraped[5m])

# 4. Scrape Series ì¶”ê°€
rate(scrape_series_added[5m])

# 5. Scrape Timeout
scrape_duration_seconds > scrape_timeout_seconds

# ëª©í‘œ: 0

# 6. Scrape Health
up

# ëª©í‘œ: 1 (ëª¨ë“  íƒ€ê²Ÿ)

# 7. Down íƒ€ê²Ÿ ìˆ˜
count(up == 0) by (cluster, job)

# ëª©í‘œ: 0

# 8. Scrape Sample Limit ì´ˆê³¼
scrape_samples_post_metric_relabeling
```

---

## 6ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë©”íŠ¸ë¦­

```promql
# 1. Remote Write ë„¤íŠ¸ì›Œí¬ ì†¡ì‹  (MB/s)
rate(container_network_transmit_bytes_total{pod=~"prometheus-agent.*"}[5m]) / 1024 / 1024

# 2. Receiver ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  (MB/s)
rate(container_network_receive_bytes_total{pod=~"thanos-receive.*"}[5m]) / 1024 / 1024

# 3. ë„¤íŠ¸ì›Œí¬ ì†¡ì‹  ì—ëŸ¬
rate(container_network_transmit_errors_total{pod=~"prometheus-agent.*"}[5m])

# ëª©í‘œ: 0

# 4. ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  ì—ëŸ¬
rate(container_network_receive_errors_total{pod=~"thanos-receive.*"}[5m])

# ëª©í‘œ: 0

# 5. ë„¤íŠ¸ì›Œí¬ íŒ¨í‚· Drop
rate(container_network_transmit_packets_dropped_total[5m])
rate(container_network_receive_packets_dropped_total[5m])

# ëª©í‘œ: 0

# 6. HTTP ìš”ì²­ Duration (Remote Write)
histogram_quantile(0.99,
  rate(prometheus_http_request_duration_seconds_bucket{handler="/api/v1/receive"}[5m])
)

# ëª©í‘œ: < 1s (p99)
```

---

## 7ï¸âƒ£ ë””ìŠ¤í¬ ë©”íŠ¸ë¦­

```promql
# 1. ë””ìŠ¤í¬ ì‚¬ìš©ë¥ 
(node_filesystem_size_bytes{mountpoint="/data"}
 - node_filesystem_avail_bytes{mountpoint="/data"})
/
node_filesystem_size_bytes{mountpoint="/data"}

# ì„ê³„ê°’:
# - ì •ìƒ: < 70%
# - ì£¼ì˜: 70-85%
# - ê²½ê³ : 85-95%
# - ìœ„í—˜: > 95%

# 2. ë””ìŠ¤í¬ ì‚¬ìš© ê°€ëŠ¥ ê³µê°„ (GiB)
node_filesystem_avail_bytes{mountpoint="/data"} / 1024 / 1024 / 1024

# 3. ë””ìŠ¤í¬ I/O ì½ê¸° ì†ë„ (MB/s)
rate(node_disk_read_bytes_total[5m]) / 1024 / 1024

# 4. ë””ìŠ¤í¬ I/O ì“°ê¸° ì†ë„ (MB/s)
rate(node_disk_written_bytes_total[5m]) / 1024 / 1024

# 5. ë””ìŠ¤í¬ I/O ëŒ€ê¸° ì‹œê°„
rate(node_disk_io_time_seconds_total[5m])
```

---

## 8ï¸âƒ£ Thanos Query ë©”íŠ¸ë¦­

```promql
# 1. Query ìš”ì²­ ì†ë„
rate(http_requests_total{handler="query"}[5m])

# 2. Query Duration (p99)
histogram_quantile(0.99,
  rate(http_request_duration_seconds_bucket{handler="query"}[5m])
)

# ëª©í‘œ: < 2s (p99)

# 3. Query ì—ëŸ¬
rate(http_requests_total{handler="query", code!~"2.."}[5m])

# ëª©í‘œ: 0

# 4. Store API í˜¸ì¶œ
rate(thanos_query_store_api_requests_total[5m])

# 5. Store API ì§€ì—°
histogram_quantile(0.99,
  rate(thanos_query_store_api_request_duration_seconds_bucket[5m])
)
```

---

## ğŸ“Š ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ê³„ì¸µ

```mermaid
graph TB
    subgraph "Edge Clusters (cluster-02/03/04)"
        AGENT[Prometheus Agent<br/>Scrape 30s]
        NODE[Node Exporter]
        KSM[Kube-State-Metrics]

        NODE --> AGENT
        KSM --> AGENT
    end

    subgraph "Central Cluster (cluster-01)"
        RECEIVER[Thanos Receiver<br/>Remote Write Endpoint]
        PROM_HA[Prometheus HA<br/>Central Scrape]
        QUERY[Thanos Query<br/>Global View]

        AGENT -.Remote Write.-> RECEIVER
        RECEIVER --> QUERY
        PROM_HA --> QUERY
    end

    subgraph "Visualization"
        GRAFANA[Grafana<br/>Dashboards]
        QUERY --> GRAFANA
    end

    style AGENT fill:#4fc3f7
    style RECEIVER fill:#ff9800
    style QUERY fill:#4caf50
```

---

## ğŸ¯ ë©”íŠ¸ë¦­ ì„ê³„ê°’ ìš”ì•½

| ë©”íŠ¸ë¦­ | ì •ìƒ | ì£¼ì˜ | ê²½ê³  | ìœ„í—˜ |
|--------|------|------|------|------|
| **Remote Write Queue** | 0-100 | 100-1000 | 1000-5000 | 5000+ |
| **Remote Write ì„±ê³µë¥ ** | > 99.5% | 95-99.5% | 90-95% | < 90% |
| **Receiver CPU** | < 70% | 70-80% | 80-90% | > 90% |
| **Receiver Memory** | < 75% | 75-85% | 85-95% | > 95% |
| **ë””ìŠ¤í¬ ì‚¬ìš©ë¥ ** | < 70% | 70-85% | 85-95% | > 95% |
| **Query Duration (p99)** | < 1s | 1-2s | 2-5s | > 5s |

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Grafana ëŒ€ì‹œë³´ë“œ** â†’ [Grafana-ëŒ€ì‹œë³´ë“œ.md](./Grafana-ëŒ€ì‹œë³´ë“œ.md)
- **ì•Œë¦¼ ê·œì¹™** â†’ [ì•Œë¦¼-ê·œì¹™.md](./ì•Œë¦¼-ê·œì¹™.md)
- **PromQL ì¿¼ë¦¬ ì˜ˆì œ** â†’ [PromQL-ì¿¼ë¦¬-ì˜ˆì œ.md](./PromQL-ì¿¼ë¦¬-ì˜ˆì œ.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
