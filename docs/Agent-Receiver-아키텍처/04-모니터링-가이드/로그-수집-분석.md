# ë¡œê·¸ ìˆ˜ì§‘ ë° ë¶„ì„

## ğŸ“‹ ê°œìš”

OpenSearch + Fluent-Bitì„ í™œìš©í•œ ë©€í‹°í´ëŸ¬ìŠ¤í„° ë¡œê·¸ ìˆ˜ì§‘, ì €ì¥, ë¶„ì„ ê°€ì´ë“œì…ë‹ˆë‹¤.

---

## ğŸ—ï¸ ë¡œê·¸ ì•„í‚¤í…ì²˜

### ë¡œê·¸ ìˆ˜ì§‘ íë¦„

```mermaid
graph LR
    subgraph Cluster-01[Cluster-01 Central]
        POD1[Pod Logs]
        FB1[Fluent-Bit DaemonSet]
        OS[OpenSearch Cluster]
        OSD[OpenSearch Dashboards]

        POD1 --> FB1
        FB1 --> OS
        OS --> OSD
    end

    subgraph Cluster-02[Cluster-02 Edge]
        POD2[Pod Logs]
        FB2[Fluent-Bit DaemonSet]

        POD2 --> FB2
    end

    subgraph Cluster-03[Cluster-03 Edge]
        POD3[Pod Logs]
        FB3[Fluent-Bit DaemonSet]

        POD3 --> FB3
    end

    subgraph Cluster-04[Cluster-04 Edge]
        POD4[Pod Logs]
        FB4[Fluent-Bit DaemonSet]

        POD4 --> FB4
    end

    FB2 --> OS
    FB3 --> OS
    FB4 --> OS

    style OS fill:#4caf50
    style OSD fill:#2196f3
```

### ë¡œê·¸ ì €ì¥ì†Œ ì „ëµ

```mermaid
graph TB
    subgraph Storage[OpenSearch Indices]
        HOT[Hot Indices<br/>0-7 days<br/>ë¹ ë¥¸ ê²€ìƒ‰]
        WARM[Warm Indices<br/>8-30 days<br/>ì••ì¶• ì €ì¥]
        COLD[Cold Indices<br/>31-90 days<br/>S3 ìŠ¤ëƒ…ìƒ·]
        DELETE[Delete<br/>90+ days]
    end

    HOT --> WARM
    WARM --> COLD
    COLD --> DELETE

    style HOT fill:#f44336
    style WARM fill:#ff9800
    style COLD fill:#2196f3
```

---

## 1ï¸âƒ£ OpenSearch Cluster ë°°í¬

### Base ì„¤ì •

```yaml
# deploy/base/opensearch-cluster/opensearch-cluster.yaml
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: opensearch-cluster
  namespace: logging
spec:
  general:
    serviceName: opensearch
    version: 2.11.0
    httpPort: 9200

  dashboards:
    enable: true
    version: 2.11.0
    replicas: 1
    resources:
      requests:
        memory: 512Mi
        cpu: 200m
      limits:
        memory: 1Gi
        cpu: 500m

  nodePools:
    - component: masters
      replicas: 3
      diskSize: 20Gi
      resources:
        requests:
          memory: 2Gi
          cpu: 500m
        limits:
          memory: 4Gi
          cpu: 1000m
      roles:
        - cluster_manager
        - data

    - component: data
      replicas: 2
      diskSize: 100Gi
      resources:
        requests:
          memory: 4Gi
          cpu: 1000m
        limits:
          memory: 8Gi
          cpu: 2000m
      roles:
        - data
        - ingest
```

### Cluster-01 Overlay (ì¤‘ì•™)

```yaml
# deploy/overlays/cluster-01-central/opensearch-cluster/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: logging

resources:
  - ../../../base/opensearch-cluster

patches:
  - path: opensearch-cluster-patch.yaml
```

```yaml
# deploy/overlays/cluster-01-central/opensearch-cluster/opensearch-cluster-patch.yaml
apiVersion: opensearch.opster.io/v1
kind: OpenSearchCluster
metadata:
  name: opensearch-cluster
  namespace: logging
spec:
  general:
    additionalConfig:
      cluster.name: central-logging

  bootstrap:
    resources:
      requests:
        memory: 512Mi
        cpu: 200m

  # S3 ìŠ¤ëƒ…ìƒ· ì €ì¥ì†Œ ì„¤ì •
  s3:
    enabled: true
    endpoint: s3.minio.miribit.lab:9000
    bucket: opensearch-snapshots
    region: us-east-1
```

### Ingress ì„¤ì •

```yaml
# deploy/overlays/cluster-01-central/opensearch-cluster/opensearch-ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: opensearch-dashboards
  namespace: logging
  annotations:
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
spec:
  ingressClassName: nginx
  rules:
    - host: opensearch.k8s-cluster-01.miribit.lab
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: opensearch-dashboards
                port:
                  number: 5601
```

---

## 2ï¸âƒ£ Fluent-Bit ë°°í¬

### Base ì„¤ì •

```yaml
# deploy/base/fluent-bit/values.yaml
fluent-bit:
  image:
    repository: fluent/fluent-bit
    tag: 2.2.0

  daemonSetVolumes:
    - name: varlog
      hostPath:
        path: /var/log
    - name: varlibdockercontainers
      hostPath:
        path: /var/lib/docker/containers

  daemonSetVolumeMounts:
    - name: varlog
      mountPath: /var/log
      readOnly: true
    - name: varlibdockercontainers
      mountPath: /var/lib/docker/containers
      readOnly: true

  config:
    service: |
      [SERVICE]
          Daemon Off
          Flush 5
          Log_Level info
          Parsers_File parsers.conf

    inputs: |
      [INPUT]
          Name tail
          Path /var/log/containers/*.log
          Parser docker
          Tag kube.*
          Mem_Buf_Limit 50MB
          Skip_Long_Lines On
          Refresh_Interval 10

    filters: |
      [FILTER]
          Name kubernetes
          Match kube.*
          Kube_URL https://kubernetes.default.svc:443
          Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
          Kube_Tag_Prefix kube.var.log.containers.
          Merge_Log On
          Keep_Log Off
          K8S-Logging.Parser On
          K8S-Logging.Exclude On

      [FILTER]
          Name modify
          Match kube.*
          Add cluster cluster-01

      [FILTER]
          Name nest
          Match kube.*
          Operation lift
          Nested_under kubernetes
          Add_prefix k8s_

    outputs: |
      [OUTPUT]
          Name opensearch
          Match kube.*
          Host opensearch-cluster.logging.svc.cluster-01.local
          Port 9200
          Index fluentbit
          Type _doc
          Logstash_Format On
          Logstash_Prefix logstash
          Logstash_DateFormat %Y.%m.%d
          Retry_Limit 5
          Suppress_Type_Name On

    parsers: |
      [PARSER]
          Name docker
          Format json
          Time_Key time
          Time_Format %Y-%m-%dT%H:%M:%S.%L%z
```

### Cluster-02/03/04 Edge Overlay

```yaml
# deploy/overlays/cluster-02-edge/fluent-bit/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: logging

helmCharts:
  - name: fluent-bit
    repo: https://fluent.github.io/helm-charts
    version: 0.43.0
    releaseName: fluent-bit
    namespace: logging
    valuesFile: values.yaml

patches:
  - patch: |-
      - op: replace
        path: /fluent-bit/config/filters
        value: |
          [FILTER]
              Name kubernetes
              Match kube.*
              Kube_URL https://kubernetes.default.svc:443
              Kube_CA_File /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
              Kube_Token_File /var/run/secrets/kubernetes.io/serviceaccount/token
              Merge_Log On

          [FILTER]
              Name modify
              Match kube.*
              Add cluster cluster-02
              Add role edge
              Add location datacenter-a
```

---

## 3ï¸âƒ£ Index Lifecycle Management (ILM)

### ISM Policy ìƒì„±

```json
{
  "policy": {
    "description": "Log retention policy",
    "default_state": "hot",
    "states": [
      {
        "name": "hot",
        "actions": [
          {
            "rollover": {
              "min_index_age": "1d",
              "min_primary_shard_size": "30gb"
            }
          }
        ],
        "transitions": [
          {
            "state_name": "warm",
            "conditions": {
              "min_index_age": "7d"
            }
          }
        ]
      },
      {
        "name": "warm",
        "actions": [
          {
            "replica_count": {
              "number_of_replicas": 1
            }
          },
          {
            "force_merge": {
              "max_num_segments": 1
            }
          }
        ],
        "transitions": [
          {
            "state_name": "cold",
            "conditions": {
              "min_index_age": "30d"
            }
          }
        ]
      },
      {
        "name": "cold",
        "actions": [
          {
            "snapshot": {
              "repository": "s3-snapshot-repo",
              "snapshot": "logstash-{{ctx.index}}"
            }
          },
          {
            "replica_count": {
              "number_of_replicas": 0
            }
          }
        ],
        "transitions": [
          {
            "state_name": "delete",
            "conditions": {
              "min_index_age": "90d"
            }
          }
        ]
      },
      {
        "name": "delete",
        "actions": [
          {
            "delete": {}
          }
        ]
      }
    ]
  }
}
```

### ISM Policy ì ìš©

```bash
# Policy ìƒì„±
curl -X PUT "http://opensearch.k8s-cluster-01.miribit.lab/_plugins/_ism/policies/log-retention-policy" \
  -H 'Content-Type: application/json' \
  -d @ism-policy.json

# Index Templateì— Policy ì ìš©
curl -X PUT "http://opensearch.k8s-cluster-01.miribit.lab/_index_template/logstash-template" \
  -H 'Content-Type: application/json' \
  -d '{
  "index_patterns": ["logstash-*"],
  "template": {
    "settings": {
      "number_of_shards": 3,
      "number_of_replicas": 1,
      "opendistro.index_state_management.policy_id": "log-retention-policy",
      "opendistro.index_state_management.rollover_alias": "logstash"
    }
  }
}'
```

---

## 4ï¸âƒ£ ë¡œê·¸ ê²€ìƒ‰ ì¿¼ë¦¬

### OpenSearch Query DSL

```json
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "cluster": "cluster-02"
          }
        },
        {
          "match": {
            "k8s_namespace_name": "monitoring"
          }
        },
        {
          "range": {
            "@timestamp": {
              "gte": "now-1h",
              "lte": "now"
            }
          }
        }
      ],
      "should": [
        {
          "match": {
            "log": "error"
          }
        },
        {
          "match": {
            "log": "failed"
          }
        }
      ],
      "minimum_should_match": 1
    }
  },
  "sort": [
    {
      "@timestamp": {
        "order": "desc"
      }
    }
  ],
  "size": 100
}
```

### í´ëŸ¬ìŠ¤í„°ë³„ ë¡œê·¸ ì§‘ê³„

```json
{
  "size": 0,
  "aggs": {
    "clusters": {
      "terms": {
        "field": "cluster.keyword",
        "size": 10
      },
      "aggs": {
        "log_levels": {
          "terms": {
            "field": "level.keyword"
          }
        }
      }
    }
  }
}
```

### Pod ì—ëŸ¬ ë¡œê·¸ ê²€ìƒ‰

```json
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "k8s_pod_name": "thanos-receive-*"
          }
        },
        {
          "regexp": {
            "log": ".*error.*|.*failed.*|.*exception.*"
          }
        }
      ],
      "filter": [
        {
          "range": {
            "@timestamp": {
              "gte": "now-15m"
            }
          }
        }
      ]
    }
  }
}
```

---

## 5ï¸âƒ£ OpenSearch Dashboards ëŒ€ì‹œë³´ë“œ

### í´ëŸ¬ìŠ¤í„° ë¡œê·¸ Overview

```yaml
visualizations:
  - type: metric
    title: "ì´ ë¡œê·¸ ìˆ˜ (last 24h)"
    query: |
      {
        "query": {
          "range": {
            "@timestamp": {
              "gte": "now-24h"
            }
          }
        }
      }

  - type: pie
    title: "í´ëŸ¬ìŠ¤í„°ë³„ ë¡œê·¸ ë¶„í¬"
    query: |
      {
        "aggs": {
          "clusters": {
            "terms": {
              "field": "cluster.keyword"
            }
          }
        }
      }

  - type: line
    title: "ì‹œê°„ëŒ€ë³„ ë¡œê·¸ ë°œìƒëŸ‰"
    query: |
      {
        "aggs": {
          "logs_over_time": {
            "date_histogram": {
              "field": "@timestamp",
              "fixed_interval": "5m"
            },
            "aggs": {
              "clusters": {
                "terms": {
                  "field": "cluster.keyword"
                }
              }
            }
          }
        }
      }
```

### ì—ëŸ¬ ë¡œê·¸ ëŒ€ì‹œë³´ë“œ

```yaml
visualizations:
  - type: data_table
    title: "ìµœê·¼ ì—ëŸ¬ ë¡œê·¸"
    columns:
      - "@timestamp"
      - "cluster"
      - "k8s_namespace_name"
      - "k8s_pod_name"
      - "log"
    query: |
      {
        "query": {
          "bool": {
            "should": [
              {"match": {"log": "error"}},
              {"match": {"log": "exception"}},
              {"match": {"log": "failed"}}
            ]
          }
        },
        "sort": [{"@timestamp": {"order": "desc"}}]
      }

  - type: horizontal_bar
    title: "Podë³„ ì—ëŸ¬ ë¹ˆë„"
    query: |
      {
        "query": {
          "match": {"log": "error"}
        },
        "aggs": {
          "pods": {
            "terms": {
              "field": "k8s_pod_name.keyword",
              "size": 20
            }
          }
        }
      }
```

---

## 6ï¸âƒ£ ì•Œë¦¼ ê·œì¹™

### OpenSearch Alerting

```json
{
  "name": "High Error Rate Alert",
  "type": "monitor",
  "monitor_type": "query_level_monitor",
  "enabled": true,
  "schedule": {
    "period": {
      "interval": 5,
      "unit": "MINUTES"
    }
  },
  "inputs": [
    {
      "search": {
        "indices": ["logstash-*"],
        "query": {
          "size": 0,
          "query": {
            "bool": {
              "must": [
                {
                  "match": {
                    "log": "error"
                  }
                },
                {
                  "range": {
                    "@timestamp": {
                      "gte": "now-5m"
                    }
                  }
                }
              ]
            }
          },
          "aggs": {
            "error_count": {
              "value_count": {
                "field": "_id"
              }
            }
          }
        }
      }
    }
  ],
  "triggers": [
    {
      "name": "Error threshold trigger",
      "severity": "1",
      "condition": {
        "script": {
          "source": "ctx.results[0].aggregations.error_count.value > 100",
          "lang": "painless"
        }
      },
      "actions": [
        {
          "name": "Slack notification",
          "destination_id": "slack-webhook-destination",
          "message_template": {
            "source": "Error count exceeded threshold: {{ctx.results.0.aggregations.error_count.value}} errors in last 5 minutes",
            "lang": "mustache"
          }
        }
      ]
    }
  ]
}
```

---

## 7ï¸âƒ£ ë¡œê·¸ ë³´ì¡´ ë° ë°±ì—…

### S3 ìŠ¤ëƒ…ìƒ· ì €ì¥ì†Œ ì„¤ì •

```bash
# S3 Snapshot Repository ë“±ë¡
curl -X PUT "http://opensearch.k8s-cluster-01.miribit.lab/_snapshot/s3-snapshot-repo" \
  -H 'Content-Type: application/json' \
  -d '{
  "type": "s3",
  "settings": {
    "bucket": "opensearch-snapshots",
    "endpoint": "s3.minio.miribit.lab:9000",
    "protocol": "http",
    "region": "us-east-1",
    "base_path": "snapshots"
  }
}'
```

### ìë™ ìŠ¤ëƒ…ìƒ· ì •ì±…

```json
{
  "policy": {
    "description": "Daily snapshot policy",
    "creation": {
      "schedule": {
        "cron": {
          "expression": "0 0 * * *",
          "timezone": "Asia/Seoul"
        }
      },
      "time_limit": "1h"
    },
    "deletion": {
      "schedule": {
        "cron": {
          "expression": "0 1 * * *",
          "timezone": "Asia/Seoul"
        }
      },
      "condition": {
        "max_age": "30d",
        "max_count": 30
      },
      "time_limit": "1h"
    },
    "snapshot_config": {
      "indices": "logstash-*",
      "repository": "s3-snapshot-repo",
      "ignore_unavailable": true,
      "include_global_state": false,
      "partial": true
    }
  }
}
```

### ìˆ˜ë™ ìŠ¤ëƒ…ìƒ· ìƒì„±

```bash
# Snapshot ìƒì„±
curl -X PUT "http://opensearch.k8s-cluster-01.miribit.lab/_snapshot/s3-snapshot-repo/snapshot-$(date +%Y%m%d-%H%M%S)" \
  -H 'Content-Type: application/json' \
  -d '{
  "indices": "logstash-*",
  "ignore_unavailable": true,
  "include_global_state": false
}'

# Snapshot ë³µì›
curl -X POST "http://opensearch.k8s-cluster-01.miribit.lab/_snapshot/s3-snapshot-repo/snapshot-20251020-120000/_restore" \
  -H 'Content-Type: application/json' \
  -d '{
  "indices": "logstash-2025.10.20",
  "ignore_unavailable": true,
  "include_global_state": false
}'
```

---

## 8ï¸âƒ£ ë¡œê·¸ ë¶„ì„ Best Practices

### íš¨ìœ¨ì ì¸ ê²€ìƒ‰

```yaml
ìµœì í™” íŒ:
  - ì‹œê°„ ë²”ìœ„ë¥¼ ìµœëŒ€í•œ ì¢íˆê¸° (1ì‹œê°„, 1ì¼ ë“±)
  - ì¸ë±ìŠ¤ íŒ¨í„´ ì‚¬ìš© (logstash-2025.10.*)
  - í•„í„° ìš°ì„  ì ìš© í›„ ê²€ìƒ‰
  - ë¶ˆí•„ìš”í•œ í•„ë“œ ì œì™¸ (_source í•„í„°ë§)
  - Aggregation í¬ê¸° ì œí•œ (size íŒŒë¼ë¯¸í„°)
```

### ë¡œê·¸ íŒŒì‹± íŒ¨í„´

```yaml
# Fluent-Bit Multiline Parser
parsers:
  - name: java_multiline
    type: multiline
    parser: java
    key_content: log

  - name: python_traceback
    type: multiline
    parser: python
    key_content: log
```

### ë¡œê·¸ í•„í„°ë§

```yaml
# ë¶ˆí•„ìš”í•œ ë¡œê·¸ ì œì™¸
filters:
  - name: grep
    match: kube.*
    exclude: log .*healthcheck.*

  - name: grep
    match: kube.*
    exclude: k8s_namespace_name kube-system
```

---

## 9ï¸âƒ£ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¡œê·¸ê°€ ìˆ˜ì§‘ë˜ì§€ ì•ŠëŠ” ê²½ìš°

```bash
# Fluent-Bit Pod ìƒíƒœ í™•ì¸
kubectl get pods -n logging -l app.kubernetes.io/name=fluent-bit

# Fluent-Bit ë¡œê·¸ í™•ì¸
kubectl logs -n logging -l app.kubernetes.io/name=fluent-bit --tail=100

# OpenSearch ì—°ê²° í…ŒìŠ¤íŠ¸
kubectl exec -n logging fluent-bit-xxxxx -- \
  curl -v http://opensearch-cluster.logging.svc.cluster.local:9200
```

### OpenSearch í´ëŸ¬ìŠ¤í„° ìƒíƒœ í™•ì¸

```bash
# í´ëŸ¬ìŠ¤í„° ìƒíƒœ
curl http://opensearch.k8s-cluster-01.miribit.lab/_cluster/health?pretty

# ë…¸ë“œ ìƒíƒœ
curl http://opensearch.k8s-cluster-01.miribit.lab/_cat/nodes?v

# ì¸ë±ìŠ¤ ìƒíƒœ
curl http://opensearch.k8s-cluster-01.miribit.lab/_cat/indices?v&s=index
```

### ë””ìŠ¤í¬ ê³µê°„ ë¶€ì¡±

```bash
# ì˜¤ë˜ëœ ì¸ë±ìŠ¤ ì‚­ì œ
curl -X DELETE "http://opensearch.k8s-cluster-01.miribit.lab/logstash-2025.09.*"

# Force Merge (ì••ì¶•)
curl -X POST "http://opensearch.k8s-cluster-01.miribit.lab/logstash-2025.10.*/_forcemerge?max_num_segments=1"
```

---

## ğŸ”Ÿ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

### OpenSearch ë©”íŠ¸ë¦­

```promql
# ì¸ë±ì‹± ì†ë„
rate(opensearch_index_indexing_index_total[5m])

# ê²€ìƒ‰ ì†ë„
rate(opensearch_index_search_query_total[5m])

# JVM Heap ì‚¬ìš©ë¥ 
opensearch_jvm_mem_heap_used_percent

# ë””ìŠ¤í¬ ì‚¬ìš©ë¥ 
opensearch_fs_total_available_bytes / opensearch_fs_total_total_bytes
```

### Fluent-Bit ë©”íŠ¸ë¦­

```promql
# ì…ë ¥ ë ˆì½”ë“œ ìˆ˜
rate(fluentbit_input_records_total[5m])

# ì¶œë ¥ ë ˆì½”ë“œ ìˆ˜
rate(fluentbit_output_records_total[5m])

# ì¬ì‹œë„ ì‹¤íŒ¨
rate(fluentbit_output_retries_failed_total[5m])
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ì•„í‚¤í…ì²˜** â†’ [01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md](../01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md)
- **ë°°í¬** â†’ [02-Kustomize-Helm-GitOps-ë°°í¬/ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md](../02-Kustomize-Helm-GitOps-ë°°í¬/ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md)
- **ëª¨ë‹ˆí„°ë§** â†’ [í•µì‹¬-ë©”íŠ¸ë¦­.md](./í•µì‹¬-ë©”íŠ¸ë¦­.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
