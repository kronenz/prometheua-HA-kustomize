# ë©€í‹°í´ëŸ¬ìŠ¤í„° ë·°

## ğŸ“‹ ê°œìš”

4ê°œ í´ëŸ¬ìŠ¤í„°ì˜ í†µí•© ëª¨ë‹ˆí„°ë§ ë° ê¸€ë¡œë²Œ ë·° êµ¬ì„± ë°©ë²•ì…ë‹ˆë‹¤.

---

## ğŸ¯ ë©€í‹°í´ëŸ¬ìŠ¤í„° ì•„í‚¤í…ì²˜

```mermaid
graph TB
    subgraph "Edge Clusters"
        C02[Cluster-02<br/>192.168.101.196<br/>Multi-Tenant]
        C03[Cluster-03<br/>192.168.101.197<br/>Edge]
        C04[Cluster-04<br/>192.168.101.198<br/>Edge]
    end

    subgraph "Central Cluster-01 (192.168.101.194)"
        RECEIVER[Thanos Receiver<br/>Remote Write Endpoint]
        PROM_HA[Prometheus HA<br/>Local Scrape]
        QUERY[Thanos Query<br/>Global View]
        STORE[Thanos Store<br/>S3 Gateway]

        RECEIVER --> QUERY
        PROM_HA --> QUERY
        STORE --> QUERY
    end

    subgraph "Storage"
        S3[MinIO S3<br/>Long-term Storage]
        STORE --> S3
        RECEIVER --> S3
        PROM_HA --> S3
    end

    C02 -.Remote Write.-> RECEIVER
    C03 -.Remote Write.-> RECEIVER
    C04 -.Remote Write.-> RECEIVER

    subgraph "Visualization"
        GRAFANA[Grafana<br/>Multi-Cluster Dashboards]
        QUERY --> GRAFANA
    end

    style QUERY fill:#4caf50
    style GRAFANA fill:#2196f3
```

---

## 1ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ë ˆì´ë¸” ì „ëµ

### ì™¸ë¶€ ë ˆì´ë¸” (externalLabels)

```yaml
# Cluster-01 (Central)
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-01
      role: central
      location: datacenter-a
      environment: production

# Cluster-02 (Multi-Tenant Edge)
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-02
      role: edge-multi-tenant
      location: edge-site-1

# Cluster-03 (Edge)
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-03
      role: edge
      location: edge-site-2

# Cluster-04 (Edge)
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-04
      role: edge
      location: edge-site-3
```

### Tenant ë ˆì´ë¸” (Cluster-02)

```yaml
# Tenant A
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-02
      tenant: tenant-a
      tenant_id: "1001"

# Tenant B
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-02
      tenant: tenant-b
      tenant_id: "1002"
```

---

## 2ï¸âƒ£ Thanos Query ê¸€ë¡œë²Œ ë·°

### Query Deployment

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-query
  namespace: monitoring
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: thanos-query
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - query
        - --http-address=0.0.0.0:9090
        - --grpc-address=0.0.0.0:10901
        - --query.replica-label=replica
        - --query.replica-label=prometheus_replica

        # Store Endpoints (ìë™ ë°œê²¬)
        - --store=dnssrv+_grpc._tcp.thanos-receive.monitoring.svc.cluster.local
        - --store=dnssrv+_grpc._tcp.thanos-store.monitoring.svc.cluster.local
        - --store=dnssrv+_grpc._tcp.prometheus-kube-prometheus-stack-prometheus.monitoring.svc.cluster.local

        # Deduplication
        - --query.auto-downsampling

        ports:
        - name: http
          containerPort: 9090
        - name: grpc
          containerPort: 10901
```

### Query Store API í™•ì¸

```bash
# Thanos Query Stores
curl http://thanos-query:9090/api/v1/stores | jq .

# ì¶œë ¥:
# {
#   "status": "success",
#   "data": [
#     {
#       "name": "thanos-receive-0:10901",
#       "lastCheck": "2025-10-20T...",
#       "lastError": null,
#       "labelSets": [{"cluster": "cluster-02"}, {"cluster": "cluster-03"}, {"cluster": "cluster-04"}]
#     },
#     {
#       "name": "thanos-store-0:10901",
#       "labelSets": [{"cluster": "cluster-01"}]
#     }
#   ]
# }
```

---

## 3ï¸âƒ£ ê¸€ë¡œë²Œ ì¿¼ë¦¬ ì˜ˆì œ

### ì „ì²´ í´ëŸ¬ìŠ¤í„° ë©”íŠ¸ë¦­

```promql
# ëª¨ë“  í´ëŸ¬ìŠ¤í„°ì˜ Up íƒ€ê²Ÿ
up

# í´ëŸ¬ìŠ¤í„°ë³„ íƒ€ê²Ÿ ìˆ˜
count(up) by (cluster)

# ì¶œë ¥:
# {cluster="cluster-01"} 50
# {cluster="cluster-02"} 60
# {cluster="cluster-03"} 45
# {cluster="cluster-04"} 40

# í´ëŸ¬ìŠ¤í„°ë³„ Up íƒ€ê²Ÿ
count(up == 1) by (cluster)

# ì´ íƒ€ê²Ÿ ìˆ˜ (ì „ì²´)
count(up)

# ì¶œë ¥: 195
```

### í´ëŸ¬ìŠ¤í„° ê°„ ë¹„êµ

```promql
# í´ëŸ¬ìŠ¤í„°ë³„ CPU ì‚¬ìš©ëŸ‰
sum(rate(container_cpu_usage_seconds_total{namespace="monitoring"}[5m])) by (cluster)

# ì¶œë ¥:
# {cluster="cluster-01"} 5.2
# {cluster="cluster-02"} 0.6
# {cluster="cluster-03"} 0.3
# {cluster="cluster-04"} 0.3

# í´ëŸ¬ìŠ¤í„°ë³„ ë©”ëª¨ë¦¬ (GiB)
sum(container_memory_usage_bytes{namespace="monitoring"}) by (cluster) / 1024 / 1024 / 1024

# í´ëŸ¬ìŠ¤í„°ë³„ Remote Write ì„±ê³µë¥ 
sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
/
(sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
 + sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster))
```

### Roleë³„ ì§‘ê³„

```promql
# Roleë³„ íƒ€ê²Ÿ ìˆ˜
count(up) by (role)

# ì¶œë ¥:
# {role="central"} 50
# {role="edge"} 85
# {role="edge-multi-tenant"} 60

# Central vs Edge ë¹„êµ
sum(rate(container_cpu_usage_seconds_total[5m])) by (role)
```

### Locationë³„ ì§‘ê³„

```promql
# Locationë³„ íƒ€ê²Ÿ ìˆ˜
count(up) by (location)

# Locationë³„ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½
sum(rate(container_network_transmit_bytes_total[5m])) by (location) / 1024 / 1024
```

---

## 4ï¸âƒ£ ë©€í‹°í…Œë„Œì‹œ ë·° (Cluster-02)

### Tenant ê²©ë¦¬ ì¿¼ë¦¬

```promql
# Tenant A ë©”íŠ¸ë¦­ë§Œ
up{cluster="cluster-02", tenant="tenant-a"}

# Tenant B ë©”íŠ¸ë¦­ë§Œ
up{cluster="cluster-02", tenant="tenant-b"}

# Tenantë³„ íƒ€ê²Ÿ ìˆ˜
count(up{cluster="cluster-02"}) by (tenant)

# ì¶œë ¥:
# {tenant="tenant-a"} 30
# {tenant="tenant-b"} 30

# Tenantë³„ ìƒ˜í”Œ ì²˜ë¦¬ëŸ‰
sum(rate(prometheus_tsdb_head_samples_appended_total{cluster="cluster-02"}[5m])) by (tenant)
```

### Tenant ë¹„êµ ëŒ€ì‹œë³´ë“œ

```promql
# Tenantë³„ CPU
sum(rate(container_cpu_usage_seconds_total{namespace=~"monitoring-tenant-.*"}[5m])) by (namespace)

# Tenantë³„ ë©”ëª¨ë¦¬
sum(container_memory_usage_bytes{pod=~"prometheus-agent-tenant-.*"}) by (pod) / 1024 / 1024

# Tenantë³„ Remote Write Queue
prometheus_remote_storage_queue_length{pod=~"prometheus-agent-tenant-.*"}
```

---

## 5ï¸âƒ£ ì „ì²´ í´ëŸ¬ìŠ¤í„° ìš”ì•½ ëŒ€ì‹œë³´ë“œ

### Overview íŒ¨ë„ êµ¬ì„±

```yaml
# Panel 1: í´ëŸ¬ìŠ¤í„° ìƒíƒœ (Table)
title: "í´ëŸ¬ìŠ¤í„° ìƒíƒœ"
query: |
  count(up) by (cluster)
format: table
columns:
  - cluster
  - total_targets
  - up_targets: count(up == 1) by (cluster)
  - down_targets: count(up == 0) by (cluster)

# Panel 2: í´ëŸ¬ìŠ¤í„°ë³„ ìƒ˜í”Œ ì²˜ë¦¬ëŸ‰ (Graph)
title: "ìƒ˜í”Œ ì²˜ë¦¬ëŸ‰ (samples/s)"
query: |
  sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
legend: "{{cluster}}"

# Panel 3: í´ëŸ¬ìŠ¤í„°ë³„ ë¦¬ì†ŒìŠ¤ (Heatmap)
title: "CPU ì‚¬ìš©ëŸ‰ ë¶„í¬"
query: |
  sum(rate(container_cpu_usage_seconds_total[5m])) by (cluster, pod)
format: heatmap

# Panel 4: Remote Write ì§€ì—° (Graph)
title: "Remote Write P99 ì§€ì—°"
query: |
  histogram_quantile(0.99,
    sum(rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])) by (cluster, le)
  )
```

---

## 6ï¸âƒ£ í´ëŸ¬ìŠ¤í„° ë“œë¦´ë‹¤ìš´

### ê³„ì¸µì  ëŒ€ì‹œë³´ë“œ ë§í¬

```yaml
# Overview â†’ Cluster Detail
panels:
  - title: "í´ëŸ¬ìŠ¤í„° ëª©ë¡"
    type: table
    links:
      - title: "Cluster-01 ìƒì„¸"
        url: "/d/cluster-01-detail?var-cluster=cluster-01"
      - title: "Cluster-02 ìƒì„¸"
        url: "/d/cluster-02-detail?var-cluster=cluster-02"

# Cluster Detail â†’ Pod Detail
panels:
  - title: "Pod ëª©ë¡"
    type: table
    links:
      - title: "Pod ìƒì„¸"
        url: "/d/pod-detail?var-cluster=$cluster&var-pod=$pod"
```

### ë³€ìˆ˜ ì „ë‹¬

```yaml
# Dashboard Variables
variables:
  - name: cluster
    type: query
    query: label_values(up, cluster)

  - name: namespace
    type: query
    query: label_values(up{cluster="$cluster"}, namespace)

  - name: pod
    type: query
    query: label_values(up{cluster="$cluster", namespace="$namespace"}, pod)
```

---

## 7ï¸âƒ£ ì‹œê³„ì—´ ë°ì´í„° í†µí•©

### ë‹¨ê¸° vs ì¥ê¸° ë°ì´í„°

```promql
# ìµœê·¼ 24ì‹œê°„ (Receiver/Prometheus HA)
up[24h]

# 7ì¼ ì „ ë°ì´í„° (Store Gateway â†’ S3)
up[7d] offset 7d

# 30ì¼ ì „ 5ë¶„ ë‹¤ìš´ìƒ˜í”Œë§ ë°ì´í„°
avg_over_time(up[5m] offset 30d)

# 180ì¼ ì „ 1ì‹œê°„ ë‹¤ìš´ìƒ˜í”Œë§ ë°ì´í„°
avg_over_time(up[1h] offset 180d)
```

### ì¥ê¸° ì¶”ì„¸ ë¶„ì„

```promql
# 7ì¼ í‰ê· 
avg_over_time(
  sum(rate(prometheus_remote_storage_succeeded_samples_total[5m]))[7d:]
)

# ì›”ë³„ ë¹„êµ
sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
offset 30d

# ì¦ê°€ìœ¨ (ì „ì›” ëŒ€ë¹„)
(sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
 - sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster) offset 30d)
/
sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster) offset 30d
* 100
```

---

## 8ï¸âƒ£ ê³ ê¸‰ ì§‘ê³„ ì¿¼ë¦¬

### Top N ë¶„ì„

```promql
# Top 5 CPU ì‚¬ìš© í´ëŸ¬ìŠ¤í„°
topk(5,
  sum(rate(container_cpu_usage_seconds_total[5m])) by (cluster)
)

# Top 10 ë©”ëª¨ë¦¬ ì‚¬ìš© Pod (ì „ì²´ í´ëŸ¬ìŠ¤í„°)
topk(10,
  sum(container_memory_usage_bytes{namespace="monitoring"}) by (cluster, pod)
)

# Bottom 3 Remote Write ì„±ê³µë¥ 
bottomk(3,
  sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
  /
  (sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
   + sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster))
)
```

### í¼ì„¼íƒ€ì¼ ë¶„ì„

```promql
# í´ëŸ¬ìŠ¤í„°ë³„ P50, P95, P99 Remote Write ì§€ì—°
quantile(0.50,
  histogram_quantile(0.99,
    sum(rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])) by (cluster, le)
  )
)

quantile(0.95, ...)
quantile(0.99, ...)
```

### ì´ìƒ íƒì§€

```promql
# Remote Write ì„±ê³µë¥ ì´ í‰ê· ë³´ë‹¤ 2 í‘œì¤€í¸ì°¨ ë‚®ì€ í´ëŸ¬ìŠ¤í„°
(
  sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
  / (sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
     + sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster))
)
<
(
  avg(
    sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
    / (sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
       + sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster))
  )
  - 2 * stddev(
    sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
    / (sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)
       + sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster))
  )
)
```

---

## 9ï¸âƒ£ Grafana ë©€í‹°í´ëŸ¬ìŠ¤í„° ëŒ€ì‹œë³´ë“œ

### JSON í…œí”Œë¦¿

```json
{
  "title": "Multi-Cluster Global View",
  "templating": {
    "list": [
      {
        "name": "cluster",
        "type": "query",
        "query": "label_values(up, cluster)",
        "multi": true,
        "includeAll": true
      }
    ]
  },
  "panels": [
    {
      "title": "í´ëŸ¬ìŠ¤í„° ë§µ",
      "type": "geomap",
      "targets": [{
        "expr": "count(up) by (cluster, location)"
      }],
      "options": {
        "view": {
          "lat": 37.5,
          "lon": 127.0,
          "zoom": 6
        }
      }
    },
    {
      "title": "í´ëŸ¬ìŠ¤í„°ë³„ ìƒíƒœ",
      "type": "stat",
      "targets": [{
        "expr": "count(up{cluster=~\"$cluster\"}) by (cluster)"
      }],
      "fieldConfig": {
        "defaults": {
          "mappings": [
            {"type": "value", "value": "null", "text": "Down"}
          ],
          "thresholds": {
            "steps": [
              {"value": 0, "color": "red"},
              {"value": 1, "color": "green"}
            ]
          }
        }
      }
    }
  ]
}
```

---

## ğŸ”Ÿ Federation (ì„ íƒì )

### Prometheus Federation ì„¤ì • (ëŒ€ì•ˆ)

```yaml
# Central Prometheusê°€ Edgeì—ì„œ Pull
prometheus:
  additionalScrapeConfigs:
    - job_name: 'federate-cluster-03'
      honor_labels: true
      metrics_path: '/federate'
      params:
        'match[]':
          - '{job="prometheus"}'
          - '{__name__=~"job:.*"}'
      static_configs:
        - targets:
          - 'prometheus.cluster-03.local:9090'
```

> **ì°¸ê³ **: Agent + Receiver íŒ¨í„´ì„ ì‚¬ìš©í•˜ë¯€ë¡œ Federationì€ ë¶ˆí•„ìš”í•©ë‹ˆë‹¤.

---

## ğŸ“Š ë©€í‹°í´ëŸ¬ìŠ¤í„° ë©”íŠ¸ë¦­ ìš”ì•½

| ë©”íŠ¸ë¦­ | Cluster-01 | Cluster-02 | Cluster-03 | Cluster-04 | ì´í•© |
|--------|-----------|-----------|-----------|-----------|------|
| **íƒ€ê²Ÿ ìˆ˜** | 50 | 60 | 45 | 40 | 195 |
| **ìƒ˜í”Œ/ì´ˆ** | 12,000 | 8,500 | 8,000 | 7,500 | 36,000 |
| **CPU (cores)** | 5.2 | 0.6 | 0.3 | 0.3 | 6.4 |
| **ë©”ëª¨ë¦¬ (GiB)** | 12 | 0.7 | 0.4 | 0.4 | 13.5 |
| **ìŠ¤í† ë¦¬ì§€ (GiB)** | 650 | 100 | 50 | 50 | 850 |

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **í•µì‹¬ ë©”íŠ¸ë¦­** â†’ [í•µì‹¬-ë©”íŠ¸ë¦­.md](./í•µì‹¬-ë©”íŠ¸ë¦­.md)
- **Grafana ëŒ€ì‹œë³´ë“œ** â†’ [Grafana-ëŒ€ì‹œë³´ë“œ.md](./Grafana-ëŒ€ì‹œë³´ë“œ.md)
- **PromQL ì¿¼ë¦¬** â†’ [PromQL-ì¿¼ë¦¬-ì˜ˆì œ.md](./PromQL-ì¿¼ë¦¬-ì˜ˆì œ.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
