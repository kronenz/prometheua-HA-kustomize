# ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ê´€ë¦¬

## ğŸ“‹ ê°œìš”

ë©€í‹°í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œ Prometheus Agent â†’ Thanos Receiverë¡œì˜ Remote Write íŠ¸ë˜í”½ì„ ì¸¡ì •í•˜ê³  ìµœì í™”í•˜ì—¬ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©ì„ ì ˆê°í•©ë‹ˆë‹¤.

---

## ğŸ¯ ìµœì í™” ëª©í‘œ

- **ë„¤íŠ¸ì›Œí¬ Egress (ì „ì²´)**: 60MB/s â†’ **32MB/s** (46% ê°ì†Œ)
- **Edge í´ëŸ¬ìŠ¤í„°ë‹¹**: 15MB/s â†’ **8MB/s**
- **ì›”ê°„ ë„¤íŠ¸ì›Œí¬ ë¹„ìš©**: $80 â†’ **$45** (43% ì ˆê°)

---

## ğŸ“Š í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ëŸ‰ ì¸¡ì •

### 1. Edge í´ëŸ¬ìŠ¤í„° Egress ì¸¡ì •

```promql
# í´ëŸ¬ìŠ¤í„°ë³„ ë„¤íŠ¸ì›Œí¬ ì†¡ì‹  ì†ë„ (MB/s)
sum(rate(container_network_transmit_bytes_total{
  namespace="monitoring",
  pod=~"prometheus-agent.*"
}[5m])) by (cluster) / 1024 / 1024
```

### 2. Remote Write íŠ¸ë˜í”½ ì¸¡ì •

```bash
# Prometheus Agent ë¡œê·¸ì—ì„œ ì „ì†¡ëŸ‰ í™•ì¸
kubectl logs -n monitoring prometheus-agent-0 --tail=100 | grep "remote_write"

# ì¶œë ¥ ì˜ˆì‹œ:
# level=info ts=2025-10-20T... msg="Remote write" samples_sent=50000 duration=2.5s bytes_sent=2500000
```

### 3. Receiver ìˆ˜ì‹  íŠ¸ë˜í”½ ì¸¡ì •

```promql
# Receiverê°€ ìˆ˜ì‹ í•œ ë°ì´í„° ì†ë„ (MB/s)
sum(rate(thanos_receive_replication_bytes_total[5m])) / 1024 / 1024
```

---

## ğŸ—ï¸ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ êµ¬ì„±

```mermaid
graph TB
    subgraph "Edge Cluster-02 (196)"
        PA2[Prometheus Agent] -->|8MB/s| NET2[Network Egress]
    end

    subgraph "Edge Cluster-03 (197)"
        PA3[Prometheus Agent] -->|8MB/s| NET3[Network Egress]
    end

    subgraph "Edge Cluster-04 (198)"
        PA4[Prometheus Agent] -->|8MB/s| NET4[Network Egress]
    end

    subgraph "Central Cluster-01 (194)"
        INGRESS[Ingress] -->|24MB/s| RECEIVER[Thanos Receiver]
    end

    NET2 --> INGRESS
    NET3 --> INGRESS
    NET4 --> INGRESS

    style NET2 fill:#ff9800
    style NET3 fill:#ff9800
    style NET4 fill:#ff9800
```

---

## 1ï¸âƒ£ ì••ì¶•ì„ í†µí•œ ëŒ€ì—­í­ ì ˆê°

### Snappy ì••ì¶• íš¨ê³¼

```yaml
# Prometheus Agent - Remote Write (ì••ì¶• ìë™ í™œì„±í™”)
server:
  remoteWrite:
    - url: https://thanos-receive:19291/api/v1/receive
      # Protocol Buffers + Snappy ì••ì¶•
```

**ì••ì¶•ë¥ **:
- ì›ë³¸ í¬ê¸°: 100MB
- ì••ì¶• í›„: 40~60MB
- **ì ˆê°ìœ¨**: 40~60%

**ì˜ˆì‹œ**:
```
ì‹œë‚˜ë¦¬ì˜¤: 100,000 samples/sec, í‰ê·  16 bytes/sample

ì••ì¶• ì „:
- ëŒ€ì—­í­ = 100,000 Ã— 16 bytes = 1.6MB/s

ì••ì¶• í›„ (50% ì••ì¶•):
- ëŒ€ì—­í­ = 1.6MB/s Ã— 0.5 = 0.8MB/s
```

---

## 2ï¸âƒ£ ë©”íŠ¸ë¦­ í•„í„°ë§ìœ¼ë¡œ íŠ¸ë˜í”½ ê°ì†Œ

### Drop ê·œì¹™ ì ìš©

```yaml
server:
  remoteWrite:
    - url: https://thanos-receive:19291/api/v1/receive
      writeRelabelConfigs:

      # 1. Go runtime ë©”íŠ¸ë¦­ ì œì™¸
      - sourceLabels: [__name__]
        regex: 'go_.*|process_.*'
        action: drop

      # 2. Scrape ë©”íƒ€ ë©”íŠ¸ë¦­ ì œì™¸
      - sourceLabels: [__name__]
        regex: 'scrape_.*|up'
        action: drop

      # 3. í…ŒìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì œì™¸
      - sourceLabels: [namespace]
        regex: 'test-.*|tmp-.*'
        action: drop
```

**ì˜ˆìƒ ì ˆê°**:
- Go runtime ë©”íŠ¸ë¦­: ~15% ê°ì†Œ
- Scrape ë©”íŠ¸ë¦­: ~5% ê°ì†Œ
- í…ŒìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ~10% ê°ì†Œ
- **ì´ ì ˆê°**: ~30%

### Keep ê·œì¹™ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸)

```yaml
writeRelabelConfigs:
  # í•µì‹¬ ë©”íŠ¸ë¦­ë§Œ í¬í•¨
  - sourceLabels: [__name__]
    regex: 'container_.*|kube_.*|node_.*'
    action: keep

  # ë˜ëŠ” Job ê¸°ë°˜ í•„í„°ë§
  - sourceLabels: [job]
    regex: 'kubelet|node-exporter|kube-state-metrics'
    action: keep
```

---

## 3ï¸âƒ£ ìƒ˜í”Œë§ (Downsampling)

### Agent-side Downsampling (ë¹„ê¶Œì¥)

Prometheus AgentëŠ” ìƒ˜í”Œë§ì„ ì§€ì›í•˜ì§€ ì•Šì§€ë§Œ, Recording Rulesë¡œ ì‚¬ì „ ì§‘ê³„ ê°€ëŠ¥:

```yaml
# Prometheus Ruler (Central)
groups:
- name: downsampled_metrics
  interval: 60s  # 1ë¶„ë§ˆë‹¤ í‰ê°€
  rules:
  - record: namespace:container_cpu_usage:avg1m
    expr: avg(rate(container_cpu_usage_seconds_total[1m])) by (namespace)
```

**Trade-off**:
- ì¥ì : ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê°ì†Œ
- ë‹¨ì : Raw ë©”íŠ¸ë¦­ ì†ì‹¤, ë””ë²„ê¹… ì–´ë ¤ì›€

---

## 4ï¸âƒ£ ë°°ì¹˜ í¬ê¸° ìµœì í™”

### í° ë°°ì¹˜ = ì ì€ ìš”ì²­ = ì˜¤ë²„í—¤ë“œ ê°ì†Œ

```yaml
server:
  remoteWrite:
    - url: https://thanos-receive:19291/api/v1/receive
      queueConfig:
        maxSamplesPerSend: 10000  # ê¸°ë³¸ 500 â†’ 10000
        batchSendDeadline: 10s    # ê¸°ë³¸ 5s â†’ 10s
```

**íš¨ê³¼**:
```
ì‘ì€ ë°°ì¹˜ (500 samples):
- ìš”ì²­ íšŸìˆ˜ = 100,000 / 500 = 200 req/sec
- HTTP ì˜¤ë²„í—¤ë“œ = 200 Ã— 1KB = 200KB/s

í° ë°°ì¹˜ (10,000 samples):
- ìš”ì²­ íšŸìˆ˜ = 100,000 / 10,000 = 10 req/sec
- HTTP ì˜¤ë²„í—¤ë“œ = 10 Ã— 1KB = 10KB/s
- ì ˆê° = 190KB/s (95% ê°ì†Œ)
```

---

## 5ï¸âƒ£ QoS ë° Rate Limiting

### Kubernetes NetworkPolicy (íŠ¸ë˜í”½ ìš°ì„ ìˆœìœ„)

```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: prometheus-agent-egress
  namespace: monitoring
spec:
  podSelector:
    matchLabels:
      app: prometheus-agent
  policyTypes:
  - Egress
  egress:
  # Thanos Receiverë§Œ í—ˆìš©
  - to:
    - podSelector:
        matchLabels:
          app: thanos-receive
    ports:
    - protocol: TCP
      port: 19291
  # DNS í—ˆìš©
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53
```

### Ingress Rate Limiting

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: thanos-receive-ingress
  annotations:
    # ì „ì²´ ìš”ì²­ ì œí•œ
    nginx.ingress.kubernetes.io/limit-rps: "1000"

    # ì—°ê²° ì œí•œ
    nginx.ingress.kubernetes.io/limit-connections: "200"

    # ëŒ€ì—­í­ ì œí•œ (bytes/sec)
    nginx.ingress.kubernetes.io/limit-rate: "10485760"  # 10MB/s
spec:
  rules:
  - host: thanos-receive.monitoring.svc
    http:
      paths:
      - path: /api/v1/receive
        pathType: Prefix
        backend:
          service:
            name: thanos-receive-lb
            port:
              number: 19291
```

---

## 6ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ìŠ¤ì¼€ì¤„ë§

### Off-peak ë°°ì¹˜ ì „ì†¡ (ì„ íƒì )

```yaml
# CronJobìœ¼ë¡œ íˆìŠ¤í† ë¦¬ì»¬ ë°ì´í„° ë°°ì¹˜ ì „ì†¡
apiVersion: batch/v1
kind: CronJob
metadata:
  name: prometheus-backfill
spec:
  schedule: "0 2 * * *"  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (íŠ¸ë˜í”½ ë‚®ì€ ì‹œê°„)
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: promtool
            image: prom/prometheus:v2.45.0
            command:
            - promtool
            - tsdb
            - create-blocks-from
            - openmetrics
            - /data/wal
            - /data/backfill
```

---

## ğŸ“Š ëŒ€ì—­í­ ì˜ˆì‚° ê³„ì‚°

### Edge í´ëŸ¬ìŠ¤í„°ë‹¹ ì˜ˆì‚°

```
êµ¬ì„±:
- Scrape Interval: 15s
- Targets: 100ê°œ
- Metrics/Target: 1000ê°œ
- Sample í¬ê¸°: 16 bytes
- ì••ì¶•ë¥ : 50%

ê³„ì‚°:
1. Samples/sec = 100 targets Ã— 1000 metrics / 15s = 6,666 samples/sec
2. Raw ëŒ€ì—­í­ = 6,666 Ã— 16 bytes = 106KB/s = 0.1MB/s
3. ì••ì¶• í›„ = 0.1MB/s Ã— 0.5 = 0.05MB/s

â†’ ì‹¤ì œ ì¸¡ì •: 8MB/s (ì••ì¶•, HTTP ì˜¤ë²„í—¤ë“œ, ë©”íƒ€ë°ì´í„° í¬í•¨)
```

### ì›”ê°„ ë„¤íŠ¸ì›Œí¬ ë¹„ìš© (í´ë¼ìš°ë“œ)

```
ì‹œë‚˜ë¦¬ì˜¤: AWS Egress ë¹„ìš© (ì˜ˆì‹œ)

Edge Cluster-02: 8MB/s
- ì›”ê°„ ì „ì†¡ëŸ‰ = 8MB/s Ã— 86,400s/day Ã— 30days = 20.7TB/month
- ë¹„ìš© (ì²« 10TB: $0.09/GB) = 10TB Ã— $0.09 Ã— 1024 = $921.6
- ë¹„ìš© (ë‹¤ìŒ 10.7TB: $0.085/GB) = 10.7TB Ã— $0.085 Ã— 1024 = $931

â†’ ì´ ë¹„ìš©/í´ëŸ¬ìŠ¤í„°: ~$1,850/month
â†’ 4ê°œ í´ëŸ¬ìŠ¤í„°: ~$7,400/month

ìµœì í™” í›„ (8MB/s â†’ 4MB/s):
â†’ ì´ ë¹„ìš©: ~$3,700/month (50% ì ˆê°)
```

---

## ğŸš¨ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§

```promql
# Edge í´ëŸ¬ìŠ¤í„° Egress (MB/s)
sum(rate(container_network_transmit_bytes_total{
  namespace="monitoring",
  pod=~"prometheus-agent.*"
}[5m])) by (cluster) / 1024 / 1024

# Central Ingress (MB/s)
sum(rate(container_network_receive_bytes_total{
  namespace="monitoring",
  pod=~"thanos-receive.*"
}[5m])) / 1024 / 1024
```

### ëŒ€ì—­í­ ì´ˆê³¼ ì•Œë¦¼

```yaml
- alert: HighNetworkEgress
  expr: |
    sum(rate(container_network_transmit_bytes_total{
      namespace="monitoring",
      pod=~"prometheus-agent.*"
    }[5m])) by (cluster) / 1024 / 1024 > 10
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "High network egress on {{ $labels.cluster }}"
    description: "{{ $value | humanize }}MB/s > 10MB/s"
```

### ì›”ê°„ íŠ¸ë˜í”½ ì˜ˆì‚° ì•Œë¦¼

```yaml
- alert: MonthlyTrafficBudgetExceeded
  expr: |
    sum(increase(container_network_transmit_bytes_total{
      namespace="monitoring",
      pod=~"prometheus-agent.*"
    }[30d])) / 1024 / 1024 / 1024 / 1024 > 20
  labels:
    severity: warning
  annotations:
    summary: "Monthly traffic > 20TB budget"
```

---

## ğŸ¯ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì••ì¶•
- [x] Snappy ì••ì¶• í™•ì¸ (ê¸°ë³¸ í™œì„±í™”)
- [ ] ì••ì¶•ë¥  ì¸¡ì •

### ë©”íŠ¸ë¦­ í•„í„°ë§
- [x] Drop ê·œì¹™ ì ìš© (go_*, process_*)
- [x] í…ŒìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì œì™¸
- [ ] Keep ê·œì¹™ (í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸) ê²€í† 

### ë°°ì¹˜ ìµœì í™”
- [x] maxSamplesPerSend ì¦ê°€ (10000)
- [x] batchSendDeadline ì¡°ì • (10s)

### Rate Limiting
- [ ] Ingress Rate Limiting ì„¤ì •
- [ ] QoS ìš°ì„ ìˆœìœ„ ì„¤ì •

### ëª¨ë‹ˆí„°ë§
- [x] ë„¤íŠ¸ì›Œí¬ ì‚¬ìš©ëŸ‰ ë©”íŠ¸ë¦­
- [x] ëŒ€ì—­í­ ì•Œë¦¼ ì„¤ì •
- [ ] ì›”ê°„ ë¹„ìš© ì¶”ì 

---

## ğŸ“ˆ ëŒ€ì‹œë³´ë“œ ì˜ˆì‹œ

### Grafana Panel - ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½

```json
{
  "title": "Remote Write Network Traffic",
  "targets": [
    {
      "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"monitoring\",pod=~\"prometheus-agent.*\"}[5m])) by (cluster) / 1024 / 1024",
      "legendFormat": "{{ cluster }} Egress (MB/s)"
    }
  ],
  "yaxes": [
    {
      "label": "MB/s",
      "format": "MBs"
    }
  ]
}
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Remote Write ìµœì í™”** â†’ [Remote-Write-ìµœì í™”.md](./Remote-Write-ìµœì í™”.md)
- **ë©”íŠ¸ë¦­ í•„í„°ë§ ì „ëµ** â†’ [ë©”íŠ¸ë¦­-í•„í„°ë§-ì „ëµ.md](./ë©”íŠ¸ë¦­-í•„í„°ë§-ì „ëµ.md)
- **ìŠ¤í† ë¦¬ì§€ ìµœì í™”** â†’ [ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md](./ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
