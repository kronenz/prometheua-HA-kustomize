# ë¹„ìš© ì ˆê° ë°©ì•ˆ

## ğŸ“‹ ê°œìš”

Prometheus Agent + Thanos Receiver ë©€í‹°í´ëŸ¬ìŠ¤í„° í™˜ê²½ì—ì„œ ì¸í”„ë¼ ë¹„ìš©ì„ ìµœì í™”í•˜ëŠ” ì „ëµê³¼ ì‹¤ì²œ ë°©ì•ˆì…ë‹ˆë‹¤.

---

## ğŸ’° ë¹„ìš© êµ¬ì¡° ë¶„ì„

### í˜„ì¬ ë¹„ìš© êµ¬ì„±

```mermaid
pie title ì›”ê°„ ì¸í”„ë¼ ë¹„ìš© êµ¬ì„±
    "Kubernetes Compute" : 40
    "Storage (PV)" : 25
    "S3 Storage" : 20
    "Network Traffic" : 10
    "ê¸°íƒ€" : 5
```

### í´ëŸ¬ìŠ¤í„°ë³„ ë¹„ìš© (ìµœì í™” ì „)

| í´ëŸ¬ìŠ¤í„° | Compute | Storage | S3 | ë„¤íŠ¸ì›Œí¬ | í•©ê³„ |
|---------|---------|---------|-----|---------|------|
| **Cluster-01** (Central) | $200 | $120 | $150 | $30 | **$500** |
| **Cluster-02** (Edge) | $80 | $40 | $20 | $15 | **$155** |
| **Cluster-03** (Edge) | $60 | $30 | $15 | $10 | **$115** |
| **Cluster-04** (Edge) | $60 | $30 | $15 | $10 | **$115** |
| **ì´í•©** | $400 | $220 | $200 | $65 | **$885** |

---

## 1ï¸âƒ£ Compute ë¦¬ì†ŒìŠ¤ ìµœì í™” (40% ë¹„ìš© ì ˆê°)

### Prometheus Agent Right-Sizing

#### Before (ê¸°ë³¸ ì„¤ì •)
```yaml
prometheus:
  prometheusSpec:
    resources:
      requests:
        cpu: 1000m
        memory: 2Gi
      limits:
        cpu: 2000m
        memory: 4Gi
    replicas: 2

# ì›”ê°„ ë¹„ìš©: $80/cluster (Edge)
```

#### After (Agent Mode ìµœì í™”)
```yaml
prometheus:
  prometheusSpec:
    enableAgentMode: true
    resources:
      requests:
        cpu: 200m      # â†“ 80%
        memory: 256Mi   # â†“ 87%
      limits:
        cpu: 500m
        memory: 512Mi
    replicas: 1        # â†“ 50% (HA ë¶ˆí•„ìš”)

# ì›”ê°„ ë¹„ìš©: $15/cluster (Edge) â†’ 81% ì ˆê°
```

### Thanos Receiver Horizontal Scaling

#### Before (Vertical Scaling)
```yaml
# ë‹¨ì¼ ê³ ì„±ëŠ¥ ì¸ìŠ¤í„´ìŠ¤
thanos:
  receive:
    replicas: 1
    resources:
      requests:
        cpu: 4000m
        memory: 8Gi
      limits:
        cpu: 8000m
        memory: 16Gi

# ì›”ê°„ ë¹„ìš©: $200 (Central)
```

#### After (Horizontal Scaling)
```yaml
# ì—¬ëŸ¬ ì‘ì€ ì¸ìŠ¤í„´ìŠ¤
thanos:
  receive:
    replicas: 3
    resources:
      requests:
        cpu: 1000m     # â†“ 75% per replica
        memory: 2Gi     # â†“ 75% per replica
      limits:
        cpu: 2000m
        memory: 4Gi

# ì´ ë¦¬ì†ŒìŠ¤: 3 cores, 6Gi (vs ê¸°ì¡´ 4 cores, 8Gi)
# ì›”ê°„ ë¹„ìš©: $120 (Central) â†’ 40% ì ˆê°
```

### HPAë¡œ ë™ì  ìŠ¤ì¼€ì¼ë§

```yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: thanos-receive-hpa
  namespace: monitoring
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: thanos-receive
  minReplicas: 2
  maxReplicas: 5
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80

# í”¼í¬ ì‹œê°„ëŒ€ ì™¸ ìë™ ìŠ¤ì¼€ì¼ ë‹¤ìš´
# ì˜ˆìƒ ë¹„ìš© ì ˆê°: 30% (í‰ê·  replica ìˆ˜ 2.5 â†’ ê¸°ì¡´ 3)
```

---

## 2ï¸âƒ£ Storage ë¹„ìš© ìµœì í™” (66% ë¹„ìš© ì ˆê°)

### Downsamplingìœ¼ë¡œ ì¥ê¸° ì €ì¥ ì••ì¶•

```yaml
# Thanos Compactor ì„¤ì •
thanos:
  compactor:
    enabled: true
    retentionResolutionRaw: 7d      # Raw: 7ì¼ë§Œ
    retentionResolution5m: 30d      # 5m: 30ì¼
    retentionResolution1h: 180d     # 1h: 180ì¼

# ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰:
# Before: 1TB/ì›” (ëª¨ë‘ Raw)
# After: 340GB/ì›” (66% ì ˆê°)
#   - Raw (7d): 100GB
#   - 5m (30d): 120GB
#   - 1h (180d): 120GB
```

### PV ìŠ¤í† ë¦¬ì§€ í´ë˜ìŠ¤ ìµœì í™”

#### Before (í”„ë¦¬ë¯¸ì—„ ìŠ¤í† ë¦¬ì§€)
```yaml
volumeClaimTemplate:
  spec:
    storageClassName: longhorn-fast
    resources:
      requests:
        storage: 100Gi

# ë¹„ìš©: $0.20/GB/ì›” = $20/PV
# ì´ PV ìˆ˜: 12ê°œ (Receiver 3, Query 2, Store 3, Compactor 1, etc.)
# ì›”ê°„ ë¹„ìš©: $240
```

#### After (ê³„ì¸µí˜• ìŠ¤í† ë¦¬ì§€)
```yaml
# Hot Data (Receiver TSDB)
volumeClaimTemplate:
  spec:
    storageClassName: longhorn-fast
    resources:
      requests:
        storage: 30Gi  # â†“ 70% (downsampling ë•ë¶„)

# Cold Data (Store, Compactor)
volumeClaimTemplate:
  spec:
    storageClassName: longhorn-standard  # $0.10/GB/ì›”
    resources:
      requests:
        storage: 50Gi

# ì›”ê°„ ë¹„ìš©: $102 (57% ì ˆê°)
```

---

## 3ï¸âƒ£ S3 ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ìµœì í™” (50% ë¹„ìš© ì ˆê°)

### S3 Lifecycle Policy

```yaml
# MinIO Lifecycle Policy
{
  "Rules": [
    {
      "ID": "downsampled-transition",
      "Status": "Enabled",
      "Filter": {
        "Prefix": "thanos/"
      },
      "Transitions": [
        {
          "Days": 7,
          "StorageClass": "STANDARD_IA"  # Infrequent Access
        },
        {
          "Days": 30,
          "StorageClass": "GLACIER"       # Cold Storage
        }
      ],
      "Expiration": {
        "Days": 180                       # 180ì¼ í›„ ì‚­ì œ
      }
    }
  ]
}

# ë¹„ìš© ì ˆê°:
# Before: $200/ì›” (ëª¨ë‘ Standard)
# After: $100/ì›” (50% ì ˆê°)
#   - Standard (7d): $20
#   - IA (30d): $50
#   - Glacier (180d): $30
```

### S3 ì••ì¶• ë° ìµœì í™”

```yaml
# Thanos Store/Compactor S3 ì••ì¶• ì„¤ì •
thanos:
  compact:
    args:
      - compact
      - --objstore.config-file=/etc/thanos/objstore.yml
      - --data-dir=/data
      - --wait
      - --compact.enable-vertical-compaction  # ë¸”ë¡ ì••ì¶•
      - --deduplication.replica-label=replica
      - --delete-delay=4h

# ì••ì¶• íš¨ê³¼:
# Before: 500GB (Raw blocks)
# After: 200GB (Compacted blocks) â†’ 60% ì ˆê°
```

---

## 4ï¸âƒ£ ë„¤íŠ¸ì›Œí¬ ë¹„ìš© ìµœì í™” (40% ë¹„ìš© ì ˆê°)

### Remote Write ì••ì¶•

```yaml
# Prometheus Agent Remote Write ì••ì¶• í™œì„±í™”
prometheus:
  prometheusSpec:
    remoteWrite:
      - url: http://thanos-receive:19291/api/v1/receive
        queueConfig:
          capacity: 20000
          maxShards: 100
          maxSamplesPerSend: 5000
        writeRelabelConfigs:
          - sourceLabels: [__name__]
            regex: 'node_.*|container_.*|kube_.*'
            action: keep
        # HTTP ì••ì¶• í™œì„±í™”
        tlsConfig:
          insecureSkipVerify: false
        headers:
          Content-Encoding: snappy  # Snappy ì••ì¶•

# ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ ê°ì†Œ:
# Before: 10GB/ì¼ (ì••ì¶• ì—†ìŒ)
# After: 6GB/ì¼ (40% ì ˆê°)
```

### ë©”íŠ¸ë¦­ í•„í„°ë§ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ ì „ì†¡ ì œê±°

```yaml
# ë¶ˆí•„ìš”í•œ ë©”íŠ¸ë¦­ ë“œë¡­
writeRelabelConfigs:
  # ê³ ë¹ˆë„ ì €ê°€ì¹˜ ë©”íŠ¸ë¦­ ì œê±°
  - sourceLabels: [__name__]
    regex: 'go_gc_.*|process_.*'
    action: drop

  # ì¤‘ë³µ ë ˆì´ë¸” ì œê±°
  - regex: 'pod_template_hash|controller_revision_hash'
    action: labeldrop

# ë©”íŠ¸ë¦­ ìˆ˜ ê°ì†Œ:
# Before: 50,000 series
# After: 35,000 series (30% ì ˆê°)
```

---

## 5ï¸âƒ£ ë©€í‹°í…Œë„Œì‹œ í™œìš© (ë¦¬ì†ŒìŠ¤ ê³µìœ )

### Shared Thanos Components

```yaml
# ë‹¨ì¼ Thanos Queryë¡œ ëª¨ë“  í´ëŸ¬ìŠ¤í„° ì¡°íšŒ
thanos:
  query:
    replicas: 2
    stores:
      - thanos-receive-0:10901
      - thanos-receive-1:10901
      - thanos-receive-2:10901
      - thanos-store-0:10901

# Tenant ë¶„ë¦¬ëŠ” ë ˆì´ë¸”ë¡œë§Œ ì²˜ë¦¬
# ë³„ë„ Query/Store ë¶ˆí•„ìš” â†’ ë¦¬ì†ŒìŠ¤ ê³µìœ 
# ë¹„ìš© ì ˆê°: Tenantë³„ ë³„ë„ ì»´í¬ë„ŒíŠ¸ ëŒ€ë¹„ 70%
```

### Resource Quotasë¡œ Tenant ë¦¬ì†ŒìŠ¤ ì œí•œ

```yaml
# Tenant A Namespace Quota
apiVersion: v1
kind: ResourceQuota
metadata:
  name: tenant-a-quota
  namespace: monitoring-tenant-a
spec:
  hard:
    requests.cpu: "2"
    requests.memory: 4Gi
    limits.cpu: "4"
    limits.memory: 8Gi
    persistentvolumeclaims: "5"

# Tenantë³„ ë¦¬ì†ŒìŠ¤ í•œë„ë¡œ ê³¼ë„í•œ ì‚¬ìš© ë°©ì§€
```

---

## 6ï¸âƒ£ ì¿¼ë¦¬ ìµœì í™” (ìºì‹±)

### Query Frontend Caching

```yaml
# Query Frontend + Memcached
thanos:
  queryFrontend:
    enabled: true
    replicas: 2
    config: |
      type: in-memory
      config:
        max_size: 500MB
        max_size_items: 500
        validity: 1h

# ìºì‹œ íˆíŠ¸ìœ¨: 70%
# Backend Query ìš”ì²­ ê°ì†Œ: 70%
# Query ì»´í¬ë„ŒíŠ¸ ë¦¬ì†ŒìŠ¤ ì ˆê°: 40%
```

### Store Index Cache

```yaml
thanos:
  store:
    indexCache:
      type: memcached
      config:
        addresses:
          - memcached:11211
        max_item_size: 5MB
        max_async_concurrency: 50

# Index ìºì‹±ìœ¼ë¡œ S3 GET ìš”ì²­ ê°ì†Œ: 80%
# S3 API ë¹„ìš© ì ˆê°: $10/ì›”
```

---

## 7ï¸âƒ£ Monitoring ìì²´ ë¹„ìš© ìµœì í™”

### ìì²´ ëª¨ë‹ˆí„°ë§ ìŠ¤í¬ë© ê°„ê²© ì¡°ì •

```yaml
# Prometheus Agent ìì²´ ë©”íŠ¸ë¦­
prometheus:
  prometheusSpec:
    # ì¤‘ìš”ë„ ë‚®ì€ íƒ€ê²Ÿì€ ê°„ê²© ì¦ê°€
    additionalScrapeConfigs:
      - job_name: 'kubernetes-service-endpoints'
        scrape_interval: 60s      # ê¸°ë³¸ 15s â†’ 60s

      - job_name: 'kube-state-metrics'
        scrape_interval: 30s      # ì¤‘ìš” ë©”íŠ¸ë¦­ë§Œ ìì£¼ ìˆ˜ì§‘

# ë©”íŠ¸ë¦­ ìˆ˜ ê°ì†Œ: 20%
# ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ì ˆê°: 15%
```

---

## 8ï¸âƒ£ ë¹„ìš© ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ

### Grafana ë¹„ìš© ì¶”ì  ëŒ€ì‹œë³´ë“œ

```yaml
panels:
  - title: "ì›”ê°„ ì˜ˆìƒ Compute ë¹„ìš©"
    expr: |
      sum(
        count(kube_pod_info) by (cluster, namespace)
        * on (cluster, namespace) group_left
        avg(kube_pod_container_resource_requests{resource="cpu"}) by (cluster, namespace)
      ) * 0.05  # $0.05/CPU/ì‹œê°„

  - title: "ì›”ê°„ ì˜ˆìƒ Storage ë¹„ìš©"
    expr: |
      sum(
        kube_persistentvolumeclaim_resource_requests_storage_bytes
      ) / 1024 / 1024 / 1024 * 0.20  # $0.20/GB/ì›”

  - title: "S3 ìŠ¤í† ë¦¬ì§€ ë¹„ìš©"
    expr: |
      sum(thanos_objstore_bucket_objects_total) * 100 / 1024 / 1024 / 1024 * 0.023  # $0.023/GB/ì›”
```

---

## 9ï¸âƒ£ ë¹„ìš© ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¼ì¼ ì²´í¬
- [ ] HPA ìŠ¤ì¼€ì¼ ë‹¤ìš´ í™•ì¸ (í”¼í¬ ì™¸ ì‹œê°„ëŒ€)
- [ ] ë©”íŠ¸ë¦­ ì¹´ë””ë„ë¦¬í‹° ëª¨ë‹ˆí„°ë§
- [ ] ë¯¸ì‚¬ìš© PVC ì •ë¦¬

### ì£¼ê°„ ì²´í¬
- [ ] S3 ë²„í‚· í¬ê¸° ì¶”ì´ í™•ì¸
- [ ] Query Frontend ìºì‹œ íˆíŠ¸ìœ¨
- [ ] Remote Write ëŒ€ê¸°ì—´ í¬ê¸°

### ì›”ê°„ ì²´í¬
- [ ] Downsampling íš¨ê³¼ ê²€ì¦
- [ ] ë¦¬ì†ŒìŠ¤ Right-Sizing ì¬í‰ê°€
- [ ] ë¹„ìš© ëŒ€ë¹„ íš¨ê³¼ ë¶„ì„

---

## ğŸ”Ÿ ë¹„ìš© ì ˆê° ê²°ê³¼ ìš”ì•½

### Before (ìµœì í™” ì „)

| í•­ëª© | ì›”ê°„ ë¹„ìš© |
|------|----------|
| Compute | $400 |
| Storage (PV) | $220 |
| S3 Storage | $200 |
| Network | $65 |
| **ì´í•©** | **$885** |

### After (ìµœì í™” í›„)

| í•­ëª© | ì›”ê°„ ë¹„ìš© | ì ˆê°ë¥  |
|------|----------|--------|
| Compute | $240 | **40%** â†“ |
| Storage (PV) | $102 | **54%** â†“ |
| S3 Storage | $100 | **50%** â†“ |
| Network | $39 | **40%** â†“ |
| **ì´í•©** | **$481** | **46%** â†“ |

### ì—°ê°„ ì ˆê°ì•¡

```
ì—°ê°„ ì ˆê°: ($885 - $481) Ã— 12 = $4,848
ROI: ìµœì í™” ì‘ì—… ë¹„ìš© ëŒ€ë¹„ ì²« í•´ 4ë°° ì´ìƒ íšŒìˆ˜
```

---

## 1ï¸âƒ£1ï¸âƒ£ ì¶”ê°€ ë¹„ìš© ì ˆê° ê¸°íšŒ

### Spot Instances í™œìš© (Kubernetes Nodes)

```yaml
# Edge í´ëŸ¬ìŠ¤í„° Spot Instances ì‚¬ìš©
nodeSelector:
  node.kubernetes.io/lifecycle: spot

tolerations:
  - key: "spot"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"

# ì˜ˆìƒ ë¹„ìš© ì ˆê°: 50-70% (Edge í´ëŸ¬ìŠ¤í„°)
```

### Reserved Instances (ì¥ê¸° ì•½ì •)

```
1ë…„ ì•½ì •: 20% í• ì¸
3ë…„ ì•½ì •: 40% í• ì¸

ì˜ˆìƒ ì¶”ê°€ ì ˆê°: $100/ì›”
```

---

## 1ï¸âƒ£2ï¸âƒ£ ë¹„ìš© ìµœì í™” ìë™í™”

### Cost Optimization Script

```bash
#!/bin/bash
# cost-optimization-check.sh

echo "=== ë¹„ìš© ìµœì í™” ì²´í¬ ==="

# 1. ë¯¸ì‚¬ìš© PVC ì°¾ê¸°
echo "ë¯¸ì‚¬ìš© PVC:"
kubectl get pvc -A -o json | jq -r '
  .items[] |
  select(.status.phase == "Bound") |
  select(.spec.volumeName as $pv |
    [kubectl get pods -A -o json | .items[].spec.volumes[]?.persistentVolumeClaim.claimName] |
    contains([$pv]) | not
  ) |
  "\(.metadata.namespace)/\(.metadata.name)"
'

# 2. ê³¼ë„í•œ ë¦¬ì†ŒìŠ¤ ìš”ì²­
echo "ê³¼ë„í•œ CPU ìš”ì²­ (ì‚¬ìš©ë¥  < 30%):"
kubectl top pods -A --containers | awk '$4 ~ /m$/ {
  gsub(/m/, "", $4)
  if ($4 < 300) print $1"/"$2
}'

# 3. S3 ë²„í‚· í¬ê¸°
echo "S3 ë²„í‚· í¬ê¸°:"
mc du s3/thanos-cluster-01 --human-readable

# 4. Downsampling ìƒíƒœ
echo "Downsampling ë¸”ë¡ ìˆ˜:"
curl -s http://thanos-compactor:10902/metrics | grep thanos_compact_group_compactions_total
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ì„±ëŠ¥ ìµœì í™”** â†’ [ì¿¼ë¦¬-ì„±ëŠ¥-ìµœì í™”.md](./ì¿¼ë¦¬-ì„±ëŠ¥-ìµœì í™”.md)
- **ìŠ¤í† ë¦¬ì§€ ìµœì í™”** â†’ [ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md](./ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md)
- **ë¦¬ì†ŒìŠ¤ Right-Sizing** â†’ [ë¦¬ì†ŒìŠ¤-Right-Sizing.md](./ë¦¬ì†ŒìŠ¤-Right-Sizing.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
