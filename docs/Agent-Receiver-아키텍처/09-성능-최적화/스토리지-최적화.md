# ìŠ¤í† ë¦¬ì§€ ìµœì í™”

## ğŸ“‹ ê°œìš”

MinIO S3 ë° ë¡œì»¬ TSDB ìŠ¤í† ë¦¬ì§€ ë¹„ìš©ì„ ì ˆê°í•˜ê³  ì¥ê¸° ë³´ì¡´ ì „ëµì„ ìµœì í™”í•©ë‹ˆë‹¤.

---

## ğŸ¯ ìµœì í™” ëª©í‘œ

- **S3 ìŠ¤í† ë¦¬ì§€**: 1.5TB â†’ **0.5TB** (66% ì ˆê°)
- **ì›”ê°„ ìŠ¤í† ë¦¬ì§€ ë¹„ìš©**: $150 â†’ **$50** (66% ì ˆê°)
- **ì¿¼ë¦¬ ì„±ëŠ¥**: ë‹¤ìš´ìƒ˜í”Œë§ìœ¼ë¡œ ì¥ê¸° ì¿¼ë¦¬ 3ë°° í–¥ìƒ

---

## ğŸ—ï¸ ìŠ¤í† ë¦¬ì§€ ê³„ì¸µ êµ¬ì¡°

```mermaid
graph TB
    subgraph "Hot Storage (ë¹ ë¦„/ë¹„ìŒˆ)"
        RECEIVER[Receiver TSDB<br/>ìµœê·¼ 2h<br/>50GB]
        PROM[Prometheus HA<br/>7ì¼<br/>100GB]
    end

    subgraph "Warm Storage (ì¤‘ê°„)"
        S3_RAW[S3 Raw Blocks<br/>7ì¼<br/>200GB]
    end

    subgraph "Cold Storage (ëŠë¦¼/ì €ë ´)"
        S3_5M[S3 5m Resolution<br/>30ì¼<br/>40GB]
        S3_1H[S3 1h Resolution<br/>180ì¼<br/>20GB]
    end

    RECEIVER --> S3_RAW
    PROM --> S3_RAW
    S3_RAW --> COMPACTOR[Thanos Compactor<br/>Downsampling]
    COMPACTOR --> S3_5M
    COMPACTOR --> S3_1H

    style RECEIVER fill:#ff9800
    style S3_RAW fill:#4fc3f7
    style S3_5M fill:#81c784
    style S3_1H fill:#9ccc65
```

---

## 1ï¸âƒ£ Thanos Compactor ë‹¤ìš´ìƒ˜í”Œë§

### Compactor ë°°í¬

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-compactor
  namespace: monitoring
spec:
  replicas: 1
  serviceName: thanos-compactor
  template:
    spec:
      containers:
      - name: thanos-compactor
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - compact
        - --data-dir=/data
        - --objstore.config-file=/etc/thanos/objstore.yml

        # Retention ì •ì±…
        - --retention.resolution-raw=7d       # Raw ë°ì´í„° 7ì¼
        - --retention.resolution-5m=30d       # 5ë¶„ í•´ìƒë„ 30ì¼
        - --retention.resolution-1h=180d      # 1ì‹œê°„ í•´ìƒë„ 180ì¼

        # Downsampling í™œì„±í™”
        - --downsampling.disable=false

        # ì••ì¶• ì„¤ì •
        - --compact.concurrency=4              # ë³‘ë ¬ ì••ì¶•
        - --delete-delay=48h                   # ì‚­ì œ ì „ ëŒ€ê¸° (ì•ˆì „)

        # Continuous mode
        - --wait

        resources:
          requests:
            cpu: 1000m
            memory: 2Gi
          limits:
            cpu: 2000m
            memory: 4Gi

        volumeMounts:
        - name: data
          mountPath: /data
        - name: objstore-config
          mountPath: /etc/thanos

  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      storageClassName: longhorn
      resources:
        requests:
          storage: 50Gi  # ì„ì‹œ ì‘ì—… ê³µê°„
```

### ë‹¤ìš´ìƒ˜í”Œë§ ë™ì‘ ì›ë¦¬

```mermaid
sequenceDiagram
    participant S3 as S3 Raw Blocks
    participant Compactor as Compactor
    participant S3_5m as S3 5m Blocks
    participant S3_1h as S3 1h Blocks

    Note over S3: Raw block (2h, 15s resolution)

    S3->>Compactor: Download raw block
    Compactor->>Compactor: Downsample to 5m resolution
    Compactor->>S3_5m: Upload 5m block (1/20 size)

    Note over S3: 7ì¼ í›„

    Compactor->>S3: Delete raw block

    Note over S3_5m: 30ì¼ í›„

    S3_5m->>Compactor: Download 5m block
    Compactor->>Compactor: Downsample to 1h resolution
    Compactor->>S3_1h: Upload 1h block (1/12 size)
    Compactor->>S3_5m: Delete 5m block
```

### ë‹¤ìš´ìƒ˜í”Œë§ íš¨ê³¼

```
ì›ë³¸ ë°ì´í„° (15s resolution):
- ìƒ˜í”Œ/ì‹œê°„ = 3,600s / 15s = 240 samples
- 7ì¼ = 240 Ã— 24 Ã— 7 = 40,320 samples

5ë¶„ ë‹¤ìš´ìƒ˜í”Œë§:
- ìƒ˜í”Œ/ì‹œê°„ = 3,600s / 300s = 12 samples
- 30ì¼ = 12 Ã— 24 Ã— 30 = 8,640 samples
- ì••ì¶•ë¥  = 8,640 / 40,320 = 21% (1/5)

1ì‹œê°„ ë‹¤ìš´ìƒ˜í”Œë§:
- ìƒ˜í”Œ/ì‹œê°„ = 1 sample
- 180ì¼ = 1 Ã— 24 Ã— 180 = 4,320 samples
- ì••ì¶•ë¥  = 4,320 / 40,320 = 11% (1/9)
```

---

## 2ï¸âƒ£ ë³´ì¡´ ì •ì±… (Retention Policy)

### ê³„ì¸µë³„ ë³´ì¡´ ê¸°ê°„

| Resolution | ë³´ì¡´ ê¸°ê°„ | ìš©ë„ | ìƒëŒ€ í¬ê¸° |
|-----------|----------|------|----------|
| **Raw (15s)** | 7ì¼ | ìµœê·¼ ìƒì„¸ ë¶„ì„, ë””ë²„ê¹… | 100% |
| **5m** | 30ì¼ | ì£¼ê°„/ì›”ê°„ íŠ¸ë Œë“œ | 20% |
| **1h** | 180ì¼ | ì¥ê¸° ìš©ëŸ‰ ê³„íš, ì—°ê°„ ë¦¬í¬íŠ¸ | 10% |

### Retention ì •ì±… ì ìš©

```yaml
# Compactor
- --retention.resolution-raw=7d
- --retention.resolution-5m=30d
- --retention.resolution-1h=180d

# Prometheus HA (ë¡œì»¬ TSDB)
prometheus:
  prometheusSpec:
    retention: 7d  # Compactor rawì™€ ë™ì¼
```

### ìŠ¤í† ë¦¬ì§€ í¬ê¸° ê³„ì‚°

```
ì‹œë‚˜ë¦¬ì˜¤: 4ê°œ í´ëŸ¬ìŠ¤í„°, ê° 25k samples/sec

Raw (7d):
- í¬ê¸° = 25k Ã— 4 Ã— 86,400 Ã— 7 Ã— 16 bytes = 967 GB

5m (30d):
- í¬ê¸° = 967 GB Ã— 0.2 = 193 GB

1h (180d):
- í¬ê¸° = 967 GB Ã— 0.1 = 97 GB

ì´ ìŠ¤í† ë¦¬ì§€: 1,257 GB â‰ˆ 1.3 TB

ë‹¤ìš´ìƒ˜í”Œë§ ì—†ì„ ê²½ìš° (180d raw):
- í¬ê¸° = 25k Ã— 4 Ã— 86,400 Ã— 180 Ã— 16 bytes = 24,883 GB â‰ˆ 25 TB

ì ˆê°: 25 TB - 1.3 TB = 23.7 TB (95% ì ˆê°!)
```

---

## 3ï¸âƒ£ S3 Lifecycle ì •ì±…

### MinIO Lifecycle ì„¤ì •

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: minio-lifecycle-config
data:
  lifecycle.json: |
    {
      "Rules": [
        {
          "ID": "delete-old-raw-blocks",
          "Status": "Enabled",
          "Filter": {
            "Prefix": "thanos/"
          },
          "Expiration": {
            "Days": 7
          }
        },
        {
          "ID": "transition-to-glacier",
          "Status": "Enabled",
          "Filter": {
            "Prefix": "thanos/"
          },
          "Transitions": [
            {
              "Days": 30,
              "StorageClass": "GLACIER"
            }
          ]
        }
      ]
    }
```

### AWS S3 Lifecycle (í´ë¼ìš°ë“œ í™˜ê²½)

```xml
<LifecycleConfiguration>
  <!-- Raw ë¸”ë¡ 7ì¼ í›„ ì‚­ì œ -->
  <Rule>
    <ID>delete-raw-blocks</ID>
    <Status>Enabled</Status>
    <Filter>
      <Prefix>thanos/01</Prefix>
      <Tag>
        <Key>resolution</Key>
        <Value>raw</Value>
      </Tag>
    </Filter>
    <Expiration>
      <Days>7</Days>
    </Expiration>
  </Rule>

  <!-- 5m ë¸”ë¡ 30ì¼ í›„ Glacierë¡œ ì´ë™ -->
  <Rule>
    <ID>archive-5m-blocks</ID>
    <Status>Enabled</Status>
    <Filter>
      <Tag>
        <Key>resolution</Key>
        <Value>5m</Value>
      </Tag>
    </Filter>
    <Transition>
      <Days>30</Days>
      <StorageClass>GLACIER</StorageClass>
    </Transition>
  </Rule>

  <!-- 1h ë¸”ë¡ 180ì¼ í›„ ì‚­ì œ -->
  <Rule>
    <ID>delete-1h-blocks</ID>
    <Status>Enabled</Status>
    <Filter>
      <Tag>
        <Key>resolution</Key>
        <Value>1h</Value>
      </Tag>
    </Filter>
    <Expiration>
      <Days>180</Days>
    </Expiration>
  </Rule>
</LifecycleConfiguration>
```

---

## 4ï¸âƒ£ ë¸”ë¡ ì••ì¶• ìµœì í™”

### Compaction Level

```yaml
# Thanos Compactor
- --compact.enable-vertical-compaction  # ì„¸ë¡œ ì••ì¶• í™œì„±í™”
```

**ë™ì‘**:
```
Before Compaction:
â”œâ”€â”€ Block-1 (2h, 10GB)
â”œâ”€â”€ Block-2 (2h, 10GB)
â”œâ”€â”€ Block-3 (2h, 10GB)
â””â”€â”€ Block-4 (2h, 10GB)
Total: 40GB

After Compaction (Level 1):
â””â”€â”€ Block-1-2-3-4 (8h, 30GB)
Total: 30GB (25% ì••ì¶•)

After Compaction (Level 2):
â””â”€â”€ Block-1~8 (16h, 22GB)
Total: 22GB (45% ì••ì¶•)
```

### Compaction ì„¤ì •

```yaml
args:
- compact
- --compact.concurrency=4             # ë³‘ë ¬ ì••ì¶• ìˆ˜
- --compact.block-fetch-concurrency=4  # ë¸”ë¡ ë‹¤ìš´ë¡œë“œ ë³‘ë ¬ë„
- --deduplication.replica-label=replica  # ì¤‘ë³µ ì œê±°
```

---

## 5ï¸âƒ£ ë¡œì»¬ TSDB ìµœì í™”

### Prometheus HA TSDB

```yaml
# Prometheus
prometheus:
  prometheusSpec:
    retention: 7d  # 15d â†’ 7d ì¶•ì†Œ

    # WAL ì••ì¶•
    walCompression: true

    # Storage
    storageSpec:
      volumeClaimTemplate:
        spec:
          resources:
            requests:
              storage: 50Gi  # 100Gi â†’ 50Gi ì¶•ì†Œ
```

### Receiver TSDB

```yaml
# Thanos Receiver
args:
- receive
- --tsdb.retention=7d  # 15d â†’ 7d
- --tsdb.wal-compression  # WAL ì••ì¶•
```

---

## ğŸ“Š ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ë¶„ì„

### AWS S3 ë¹„ìš© (ì˜ˆì‹œ)

```
ì‹œë‚˜ë¦¬ì˜¤: 4ê°œ í´ëŸ¬ìŠ¤í„°, 1.3TB ì´ ìŠ¤í† ë¦¬ì§€

S3 Standard:
- Raw (7d, 967GB): $967 Ã— 0.023/GB = $22.24/ì›”
- 5m (30d, 193GB): $193 Ã— 0.023/GB = $4.44/ì›”

S3 Glacier (1h, 180d, 97GB):
- Storage: $97 Ã— 0.004/GB = $0.39/ì›”
- Retrieval (10% ì¡°íšŒ): $97 Ã— 0.1 Ã— 0.01/GB = $0.10/ì›”

ì´ ë¹„ìš©: $27.17/ì›”

ë‹¤ìš´ìƒ˜í”Œë§ ì—†ì„ ê²½ìš° (25TB):
- S3 Standard: $25,000 Ã— 0.023 = $575/ì›”

ì ˆê°: $575 - $27 = $548/ì›” (95% ì ˆê°)
```

### ë„¤íŠ¸ì›Œí¬ Egress ì ˆê°

```
ì¿¼ë¦¬ ì‹œë‚˜ë¦¬ì˜¤: 30ì¼ ë²”ìœ„ ì¿¼ë¦¬

Before (Raw):
- ë°ì´í„° í¬ê¸° = 25k Ã— 4 Ã— 86,400 Ã— 30 Ã— 16 bytes = 4.14 TB
- Egress ë¹„ìš© (AWS): 4.14 TB Ã— $0.09/GB Ã— 1024 = $383

After (5m downsampled):
- ë°ì´í„° í¬ê¸° = 4.14 TB Ã— 0.2 = 0.83 TB
- Egress ë¹„ìš©: 0.83 TB Ã— $0.09/GB Ã— 1024 = $77

ì ˆê°: $383 - $77 = $306/ì¿¼ë¦¬
```

---

## ğŸš¨ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ë©”íŠ¸ë¦­

```promql
# S3 ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ (MinIO)
minio_bucket_usage_total_bytes{bucket="thanos-cluster-01"}

# Compactor ì²˜ë¦¬ ë¸”ë¡ ìˆ˜
thanos_compact_group_compactions_total

# Downsampling ì§„í–‰ë¥ 
thanos_compact_downsample_total
```

### ìŠ¤í† ë¦¬ì§€ ì•Œë¦¼

```yaml
- alert: S3StorageHighUsage
  expr: |
    minio_bucket_usage_total_bytes{bucket=~"thanos-.*"}
    /
    (1024^4) > 1.5  # 1.5TB
  for: 30m
  labels:
    severity: warning
  annotations:
    summary: "S3 bucket > 1.5TB"

- alert: CompactorNotRunning
  expr: |
    time() - thanos_compact_last_run_timestamp_seconds > 7200  # 2ì‹œê°„
  labels:
    severity: critical
  annotations:
    summary: "Compactor has not run for 2+ hours"
```

---

## ğŸ¯ ìµœì í™” ì²´í¬ë¦¬ìŠ¤íŠ¸

### Compactor
- [x] Compactor ë°°í¬ ë° ì„¤ì •
- [x] ë‹¤ìš´ìƒ˜í”Œë§ í™œì„±í™”
- [x] Retention ì •ì±… ì„¤ì • (7d/30d/180d)
- [x] ë¸”ë¡ ì••ì¶• í™œì„±í™”

### Lifecycle
- [ ] S3 Lifecycle ì •ì±… ì„¤ì •
- [ ] Glacier ì „í™˜ (30d)
- [ ] ìë™ ì‚­ì œ (180d)

### ë¡œì»¬ TSDB
- [x] Prometheus retention ì¶•ì†Œ (7d)
- [x] Receiver retention ì¶•ì†Œ (7d)
- [x] WAL ì••ì¶• í™œì„±í™”

### ëª¨ë‹ˆí„°ë§
- [x] ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ë©”íŠ¸ë¦­
- [x] Compactor ìƒíƒœ ëª¨ë‹ˆí„°ë§
- [x] ìŠ¤í† ë¦¬ì§€ ì•Œë¦¼ ì„¤ì •

---

## ğŸ’¡ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. Retention ì •ì±… ìˆ˜ë¦½ í”„ë¡œì„¸ìŠ¤

```
1. ìš”êµ¬ì‚¬í•­ ë¶„ì„
   - ë””ë²„ê¹…: 7ì¼ raw í•„ìš”
   - íŠ¸ë Œë“œ ë¶„ì„: 30ì¼ 5m ì¶©ë¶„
   - ìš©ëŸ‰ ê³„íš: 180ì¼ 1h ì¶©ë¶„

2. ë¹„ìš© ê³„ì‚°
   - í˜„ì¬ ë¹„ìš© ì¸¡ì •
   - ëª©í‘œ ë¹„ìš© ì„¤ì •
   - Retention ì¡°ì •

3. ì ì§„ì  ì ìš©
   - Week 1: 30d â†’ 15d (í…ŒìŠ¤íŠ¸)
   - Week 2: 15d â†’ 7d (ìµœì¢…)
```

### 2. ì¿¼ë¦¬ ì„±ëŠ¥ ê³ ë ¤

```promql
# ì¥ê¸° ì¿¼ë¦¬ (30d) - 5m resolution ì‚¬ìš©
avg_over_time(metric[30d:5m])

# ë‹¨ê¸° ì¿¼ë¦¬ (1d) - raw resolution ì‚¬ìš©
avg_over_time(metric[1d:15s])
```

### 3. Compactor ë¦¬ì†ŒìŠ¤ íŠœë‹

```yaml
# ëŒ€ëŸ‰ ë¸”ë¡ ì²˜ë¦¬ ì‹œ ë¦¬ì†ŒìŠ¤ ì¦ì„¤
resources:
  requests:
    cpu: 2000m
    memory: 4Gi
  limits:
    cpu: 4000m
    memory: 8Gi
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ë©”íŠ¸ë¦­ í•„í„°ë§ ì „ëµ** â†’ [ë©”íŠ¸ë¦­-í•„í„°ë§-ì „ëµ.md](./ë©”íŠ¸ë¦­-í•„í„°ë§-ì „ëµ.md)
- **Thanos Compactor** â†’ [../01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md](../01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md)
- **í™•ì¥ ì•„í‚¤í…ì²˜** â†’ [../07-í™•ì¥-ì•„í‚¤í…ì²˜/](../07-í™•ì¥-ì•„í‚¤í…ì²˜/)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
