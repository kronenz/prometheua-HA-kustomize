# ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”

## ğŸ“‹ ê°œìš”

Thanos Query ë° Grafana ëŒ€ì‹œë³´ë“œì˜ ì¿¼ë¦¬ ì†ë„ë¥¼ ê°œì„ í•˜ì—¬ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒì‹œí‚¤ëŠ” ìµœì í™” ê¸°ë²•ì„ ë‹¤ë£¹ë‹ˆë‹¤.

---

## ğŸ¯ ìµœì í™” ëª©í‘œ

- **Grafana ëŒ€ì‹œë³´ë“œ ë¡œë”©**: 8ì´ˆ â†’ **2.5ì´ˆ** (68% ê°œì„ )
- **PromQL ì¿¼ë¦¬ ë ˆì´í„´ì‹œ (P99)**: 5ì´ˆ â†’ **1.2ì´ˆ** (76% ê°œì„ )
- **ìºì‹œ íˆíŠ¸ìœ¨**: 0% â†’ **70%+**

---

## ğŸ—ï¸ Query Frontend ì•„í‚¤í…ì²˜

```mermaid
graph LR
    GF[Grafana] --> QFE[Query Frontend]
    QFE --> MC[Memcached<br/>Results Cache]
    QFE --> QRY[Thanos Query]
    QRY --> IDX[Memcached<br/>Index Cache]
    QRY --> STORE[Thanos Store]
    QRY --> RECV[Thanos Receiver]

    style QFE fill:#4fc3f7
    style MC fill:#81c784
    style IDX fill:#81c784
```

---

## 1ï¸âƒ£ Query Frontend + Memcached ìºì‹±

### Memcached ë°°í¬

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-frontend-memcached
  namespace: monitoring
spec:
  replicas: 3
  selector:
    matchLabels:
      app: query-frontend-memcached
  template:
    metadata:
      labels:
        app: query-frontend-memcached
    spec:
      containers:
      - name: memcached
        image: memcached:1.6-alpine
        args:
        - -m 2048          # 2Gi memory
        - -c 1024          # max connections
        - -I 5m            # max item size
        - -v               # verbose
        ports:
        - name: memcached
          containerPort: 11211
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 1000m
            memory: 2Gi
---
apiVersion: v1
kind: Service
metadata:
  name: query-frontend-memcached
  namespace: monitoring
spec:
  ports:
  - port: 11211
    targetPort: 11211
  selector:
    app: query-frontend-memcached
```

### Query Frontend ë°°í¬

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-query-frontend
  namespace: monitoring
spec:
  replicas: 2
  selector:
    matchLabels:
      app: thanos-query-frontend
  template:
    metadata:
      labels:
        app: thanos-query-frontend
    spec:
      containers:
      - name: thanos-query-frontend
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - query-frontend
        - --http-address=0.0.0.0:9090
        - --query-frontend.downstream-url=http://thanos-query:9090

        # Query Splitting
        - --query-range.split-interval=24h
        - --query-range.max-retries-per-request=5
        - --query-range.align-range-with-step

        # Results Cache (Memcached)
        - --query-range.response-cache-config=type=MEMCACHED,config.addresses=query-frontend-memcached:11211,config.max_item_size=5MB,config.timeout=2s

        # Logging
        - --query-frontend.log-queries-longer-than=10s
        - --log.level=info

        ports:
        - name: http
          containerPort: 9090
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 1Gi
        livenessProbe:
          httpGet:
            path: /-/healthy
            port: 9090
          initialDelaySeconds: 10
        readinessProbe:
          httpGet:
            path: /-/ready
            port: 9090
          initialDelaySeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: thanos-query-frontend
  namespace: monitoring
spec:
  ports:
  - name: http
    port: 9090
    targetPort: 9090
  selector:
    app: thanos-query-frontend
```

### Grafana Datasource ë³€ê²½

```yaml
# Grafana values.yaml
grafana:
  datasources:
    datasources.yaml:
      apiVersion: 1
      datasources:
      - name: Prometheus
        type: prometheus
        # Query Frontendë¡œ ë³€ê²½
        url: http://thanos-query-frontend:9090
        access: proxy
        isDefault: true
        editable: false
```

**ì˜ˆìƒ íš¨ê³¼**:
- ë°˜ë³µ ì¿¼ë¦¬ ìºì‹œ íˆíŠ¸ìœ¨ 70%+
- ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹œê°„ 50~70% ê°ì†Œ

---

## 2ï¸âƒ£ Query Splitting (ì¿¼ë¦¬ ë¶„í• )

### ê°œë…
- ê¸´ ì‹œê°„ ë²”ìœ„ ì¿¼ë¦¬ë¥¼ ì—¬ëŸ¬ ê°œì˜ ì‘ì€ ì¿¼ë¦¬ë¡œ ë¶„í• 
- ë³‘ë ¬ ì²˜ë¦¬ë¡œ ì‘ë‹µ ì†ë„ í–¥ìƒ
- íƒ€ì„ì•„ì›ƒ ë°©ì§€

### ì„¤ì •
```yaml
# Query Frontend
- --query-range.split-interval=24h  # 24ì‹œê°„ ë‹¨ìœ„ë¡œ ë¶„í• 
- --query-range.align-range-with-step  # Stepê³¼ ì •ë ¬
```

### ì˜ˆì‹œ
```promql
# ì›ë³¸ ì¿¼ë¦¬ (7d ë²”ìœ„)
rate(http_requests_total[5m])[7d:1m]

# ë¶„í•  ê²°ê³¼ (Query Frontend ìë™ ì²˜ë¦¬)
# Day 1: [7d ago - 6d ago]
# Day 2: [6d ago - 5d ago]
# ...
# Day 7: [1d ago - now]
# â†’ ë³‘ë ¬ ì‹¤í–‰ í›„ ê²°ê³¼ ë³‘í•©
```

**ì˜ˆìƒ íš¨ê³¼**:
- ì¥ê¸° ì¿¼ë¦¬ (7d+) ì†ë„ 3~5ë°° í–¥ìƒ
- íƒ€ì„ì•„ì›ƒ ê°ì†Œ

---

## 3ï¸âƒ£ Store Index Cache

### Memcached for Index Cache

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: store-index-cache-memcached
  namespace: monitoring
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: memcached
        image: memcached:1.6-alpine
        args:
        - -m 1024   # 1Gi
        - -c 1024
        - -I 1m
        resources:
          requests:
            memory: 1Gi
          limits:
            memory: 1Gi
```

### Thanos Store ì„¤ì •

```yaml
# Thanos Store
store:
  enabled: true
  replicas: 2
  extraArgs:
    - --index-cache.config=type=MEMCACHED,config.addresses=store-index-cache-memcached:11211,config.max_item_size=1MB
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 1000m
      memory: 2Gi
```

**ì˜ˆìƒ íš¨ê³¼**:
- S3 ë¸”ë¡ ë©”íƒ€ë°ì´í„° ì¡°íšŒ ì‹œê°„ 80% ê°ì†Œ
- íˆìŠ¤í† ë¦¬ì»¬ ì¿¼ë¦¬ ì†ë„ 2~3ë°° í–¥ìƒ

---

## 4ï¸âƒ£ PromQL ì¿¼ë¦¬ ìµœì í™” íŒ¨í„´

### âŒ ë¹„íš¨ìœ¨ì ì¸ ì¿¼ë¦¬

```promql
# 1. ë„ˆë¬´ ë§ì€ ì‹œê³„ì—´ ë§¤ì¹­
sum(rate(container_cpu_usage_seconds_total[5m])) by (pod)

# 2. ê³¼ë„í•œ aggregation
avg(avg_over_time(metric[1h])) by (label1, label2, label3, label4)

# 3. ê¸´ range vector
rate(metric[1d])
```

### âœ… ìµœì í™”ëœ ì¿¼ë¦¬

```promql
# 1. ë ˆì´ë¸” í•„í„°ë§ ì¶”ê°€
sum(rate(container_cpu_usage_seconds_total{namespace="production"}[5m])) by (pod)

# 2. Aggregation ë‹¨ìˆœí™”
avg(metric) by (label1, label2)  # Recording ruleë¡œ ì‚¬ì „ ê³„ì‚°

# 3. Range vector ìµœì†Œí™”
rate(metric[5m])  # í•„ìš”í•œ ìµœì†Œ ë²”ìœ„ë§Œ ì‚¬ìš©
```

### Recording Rules í™œìš©

```yaml
# Prometheus Ruler
groups:
- name: performance
  interval: 60s
  rules:
  # ì‚¬ì „ ê³„ì‚°ëœ ë©”íŠ¸ë¦­
  - record: namespace:container_cpu_usage:sum_rate
    expr: sum(rate(container_cpu_usage_seconds_total[5m])) by (namespace)

  - record: cluster:cpu_usage:ratio
    expr: |
      sum(rate(container_cpu_usage_seconds_total[5m]))
      /
      sum(machine_cpu_cores)
```

**Grafanaì—ì„œ ì‚¬ìš©**:
```promql
# Before
sum(rate(container_cpu_usage_seconds_total[5m])) by (namespace)

# After (Recording Rule ì‚¬ìš©)
namespace:container_cpu_usage:sum_rate
```

**ì˜ˆìƒ íš¨ê³¼**:
- ì¿¼ë¦¬ ë ˆì´í„´ì‹œ 50~80% ê°ì†Œ
- Thanos Query CPU ì‚¬ìš©ëŸ‰ ê°ì†Œ

---

## 5ï¸âƒ£ Deduplication ìµœì í™”

### Replica Label ì„¤ì •

```yaml
# Thanos Query
query:
  replicaLabel:
    - replica
    - prometheus_replica

  # Deduplication ë¹„í™œì„±í™” (ì„±ëŠ¥ ìš°ì„  ì‹œ)
  # --query.replica-label=""
```

### Prometheus HA ì™¸ë¶€ ë ˆì´ë¸”

```yaml
# Prometheus HA - values.yaml
prometheus:
  prometheusSpec:
    externalLabels:
      cluster: cluster-01
      replica: $(POD_NAME)  # prometheus-0, prometheus-1
```

**Trade-off**:
- Deduplication í™œì„±í™”: ì •í™•ì„± â†‘, ì„±ëŠ¥ â†“
- Deduplication ë¹„í™œì„±í™”: ì„±ëŠ¥ â†‘, ì¤‘ë³µ ë°ì´í„° ì¡´ì¬

---

## 6ï¸âƒ£ Grafana ìµœì í™”

### íƒ€ì„ì•„ì›ƒ ì¦ê°€

```yaml
# Grafana values.yaml
grafana:
  grafana.ini:
    dataproxy:
      timeout: 60  # ê¸°ë³¸ 30ì´ˆ â†’ 60ì´ˆ
      keep_alive_seconds: 60
```

### ì¿¼ë¦¬ ìºì‹±

```yaml
grafana:
  grafana.ini:
    caching:
      enabled: true

    query_caching:
      enabled: true
      ttl_seconds: 300  # 5ë¶„ ìºì‹±
```

### ëŒ€ì‹œë³´ë“œ ìµœì í™”

```json
{
  "refresh": "1m",  // ìë™ ìƒˆë¡œê³ ì¹¨ ê°„ê²© ì¦ê°€
  "time": {
    "from": "now-1h",  // ê¸°ë³¸ ì‹œê°„ ë²”ìœ„ ì¶•ì†Œ
    "to": "now"
  },
  "panels": [
    {
      "maxDataPoints": 300,  // ë°ì´í„° í¬ì¸íŠ¸ ì œí•œ
      "interval": "30s"      // ìµœì†Œ interval ì„¤ì •
    }
  ]
}
```

---

## ğŸ“Š ì„±ëŠ¥ ì¸¡ì •

### ì¿¼ë¦¬ ë ˆì´í„´ì‹œ ëª¨ë‹ˆí„°ë§

```promql
# Query Frontend ë ˆì´í„´ì‹œ (P95)
histogram_quantile(0.95,
  rate(http_request_duration_seconds_bucket{
    job="thanos-query-frontend",
    handler="query_range"
  }[5m])
)

# Thanos Query ë ˆì´í„´ì‹œ (P99)
histogram_quantile(0.99,
  rate(http_request_duration_seconds_bucket{
    job="thanos-query",
    handler="query"
  }[5m])
)
```

### ìºì‹œ íˆíŠ¸ìœ¨

```promql
# Results Cache íˆíŠ¸ìœ¨
sum(rate(thanos_query_frontend_queries_total{cache="hit"}[5m]))
/
sum(rate(thanos_query_frontend_queries_total[5m]))

# Index Cache íˆíŠ¸ìœ¨
sum(rate(thanos_store_index_cache_requests_total{result="hit"}[5m]))
/
sum(rate(thanos_store_index_cache_requests_total[5m]))
```

### ìŠ¬ë¡œìš° ì¿¼ë¦¬ ë¡œê¹…

```bash
# Query Frontend ë¡œê·¸ì—ì„œ ëŠë¦° ì¿¼ë¦¬ í™•ì¸
kubectl logs -n monitoring deployment/thanos-query-frontend | grep "slow query"
```

---

## ğŸ¯ ì„±ëŠ¥ ê°œì„  ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¦‰ì‹œ ì ìš© ê°€ëŠ¥
- [x] Query Frontend + Memcached ë°°í¬
- [x] Query Splitting í™œì„±í™” (24h)
- [x] Grafana Datasource â†’ Query Frontendë¡œ ë³€ê²½
- [x] Store Index Cache ì„¤ì •

### ì ì§„ì  ì ìš©
- [ ] Recording Rules ì‘ì„± (ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬)
- [ ] PromQL ì¿¼ë¦¬ ë¦¬íŒ©í† ë§
- [ ] ëŒ€ì‹œë³´ë“œ ì¿¼ë¦¬ ìµœì í™” (maxDataPoints, interval)
- [ ] Deduplication ì •ì±… ìˆ˜ë¦½

### ëª¨ë‹ˆí„°ë§
- [ ] ì¿¼ë¦¬ ë ˆì´í„´ì‹œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- [ ] ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§
- [ ] ìŠ¬ë¡œìš° ì¿¼ë¦¬ ì•Œë¦¼ ì„¤ì •
- [ ] Grafana ëŒ€ì‹œë³´ë“œ ë¡œë”© ì‹œê°„ ì¸¡ì •

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **Thanos Receiver íŒ¨í„´** â†’ [../01-ì•„í‚¤í…ì²˜/Thanos-Receiver-íŒ¨í„´.md](../01-ì•„í‚¤í…ì²˜/Thanos-Receiver-íŒ¨í„´.md)
- **ìºì‹± ì „ëµ** â†’ [ìºì‹±-ì „ëµ.md](./ìºì‹±-ì „ëµ.md)
- **ë¦¬ì†ŒìŠ¤ Right-Sizing** â†’ [ë¦¬ì†ŒìŠ¤-Right-Sizing.md](./ë¦¬ì†ŒìŠ¤-Right-Sizing.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
