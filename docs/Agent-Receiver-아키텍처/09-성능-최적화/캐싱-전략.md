# ìºì‹± ì „ëµ

## ğŸ“‹ ê°œìš”

Memcached ë° Redisë¥¼ í™œìš©í•˜ì—¬ **ì¿¼ë¦¬ ì‘ë‹µ ì†ë„ ê°œì„ **, **ë°±ì—”ë“œ ë¶€í•˜ ê°ì†Œ**, **ì‚¬ìš©ì ê²½í—˜ í–¥ìƒ**ì„ ë‹¬ì„±í•˜ëŠ” ìºì‹± ì „ëµì„ ì œê³µí•©ë‹ˆë‹¤.

---

## ğŸ¯ ìµœì í™” ëª©í‘œ

- **ì¿¼ë¦¬ ì‘ë‹µ ì†ë„**: 3ì´ˆ â†’ **0.5ì´ˆ** (83% ê°œì„ )
- **ìºì‹œ íˆíŠ¸ìœ¨**: 0% â†’ **70%+**
- **Thanos Query CPU**: 2 cores â†’ **1 core** (50% ì ˆê°)
- **Thanos Store S3 ìš”ì²­**: 1000 req/min â†’ **300 req/min** (70% ê°ì†Œ)

---

## ğŸ—ï¸ ìºì‹± ì•„í‚¤í…ì²˜

```mermaid
graph TB
    GRAFANA[Grafana] --> QFE[Query Frontend]

    QFE --> RC[Results Cache<br/>Memcached<br/>5ë¶„ TTL]
    RC -->|Cache Miss| QUERY[Thanos Query]

    QUERY --> IC[Index Cache<br/>Memcached<br/>24ì‹œê°„ TTL]
    IC -->|Cache Miss| STORE[Thanos Store]

    STORE --> S3[(MinIO S3)]

    QFE -.Cache Hit.-> GRAFANA
    QUERY -.Cache Hit.-> QFE

    style RC fill:#81c784
    style IC fill:#81c784
    style QFE fill:#4fc3f7
```

---

## 1ï¸âƒ£ Results Cache (Query Frontend)

### Memcached ë°°í¬

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: query-frontend-memcached
  namespace: monitoring
spec:
  replicas: 3
  selector:
    matchLabels:
      app: query-frontend-memcached
  template:
    metadata:
      labels:
        app: query-frontend-memcached
    spec:
      containers:
      - name: memcached
        image: memcached:1.6-alpine
        args:
        - -m 2048          # 2Gi ë©”ëª¨ë¦¬
        - -c 1024          # ìµœëŒ€ ì—°ê²° ìˆ˜
        - -I 5m            # ìµœëŒ€ ì•„ì´í…œ í¬ê¸° 5MB
        - -v               # Verbose ë¡œê¹…
        ports:
        - name: memcached
          containerPort: 11211
        resources:
          requests:
            cpu: 500m
            memory: 2Gi
          limits:
            cpu: 1000m
            memory: 2Gi
        livenessProbe:
          tcpSocket:
            port: 11211
          initialDelaySeconds: 5
          periodSeconds: 10
---
apiVersion: v1
kind: Service
metadata:
  name: query-frontend-memcached
  namespace: monitoring
spec:
  ports:
  - port: 11211
    targetPort: 11211
  selector:
    app: query-frontend-memcached
  clusterIP: None  # Headless for consistent hashing
```

### Query Frontend ì„¤ì •

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-query-frontend
  namespace: monitoring
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: thanos-query-frontend
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - query-frontend
        - --http-address=0.0.0.0:9090
        - --query-frontend.downstream-url=http://thanos-query:9090

        # Results Cache (Memcached)
        - --query-range.response-cache-config=type=MEMCACHED,config.addresses=query-frontend-memcached:11211,config.max_item_size=5MB,config.timeout=2s,config.max_async_concurrency=50

        # Cache TTL
        - --query-range.max-query-length=31d
        - --query-range.cache-unaligned-requests

        # Query Splitting
        - --query-range.split-interval=24h
```

### Results Cache êµ¬ì„± ìƒì„¸

```yaml
# ConfigMap (YAML í˜•ì‹)
apiVersion: v1
kind: ConfigMap
metadata:
  name: query-frontend-cache-config
data:
  cache.yaml: |
    type: MEMCACHED
    config:
      addresses:
        - query-frontend-memcached:11211
      timeout: 2s
      max_idle_connections: 100
      max_async_concurrency: 50
      max_async_buffer_size: 10000
      max_get_multi_concurrency: 100
      max_get_multi_batch_size: 0
      max_item_size: 5MB
      dns_provider_update_interval: 10s
```

**ìºì‹œ í‚¤ ìƒì„±**:
```
cache_key = hash(query + start + end + step)

ì˜ˆì‹œ:
query: sum(rate(http_requests_total[5m]))
start: 2025-10-20T00:00:00Z
end: 2025-10-20T23:59:59Z
step: 15s

â†’ cache_key: a3f9d8e7c2b1...
```

---

## 2ï¸âƒ£ Index Cache (Store Gateway)

### Memcached ë°°í¬

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: store-index-cache-memcached
  namespace: monitoring
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: memcached
        image: memcached:1.6-alpine
        args:
        - -m 1024     # 1Gi
        - -c 1024
        - -I 1m       # ë¸”ë¡ ì¸ë±ìŠ¤ í¬ê¸°
        resources:
          requests:
            cpu: 200m
            memory: 1Gi
          limits:
            cpu: 500m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: store-index-cache-memcached
  namespace: monitoring
spec:
  ports:
  - port: 11211
  selector:
    app: store-index-cache-memcached
  clusterIP: None
```

### Thanos Store ì„¤ì •

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-store
  namespace: monitoring
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: thanos-store
        image: quay.io/thanos/thanos:v0.31.0
        args:
        - store
        - --data-dir=/data
        - --objstore.config-file=/etc/thanos/objstore.yml

        # Index Cache
        - --index-cache.config=type=MEMCACHED,config.addresses=store-index-cache-memcached:11211,config.max_item_size=1MB,config.timeout=2s

        # Chunk Pool Size
        - --store.grpc.series-max-concurrency=20
        - --store.grpc.series-sample-limit=100000
```

**Index Cache ë™ì‘**:
```
1. Query: "node_cpu_seconds_total{cluster='cluster-02'}"

2. Store:
   - S3 ë¸”ë¡ ë©”íƒ€ë°ì´í„° í™•ì¸
   - ë¸”ë¡ ì¸ë±ìŠ¤ ë¡œë“œ (ìºì‹œ í™•ì¸)

3. Cache Hit:
   - Memcachedì—ì„œ ì¸ë±ìŠ¤ ë°˜í™˜
   - S3 ìš”ì²­ ì—†ìŒ (ë¹ ë¦„)

4. Cache Miss:
   - S3ì—ì„œ ë¸”ë¡ ì¸ë±ìŠ¤ ë‹¤ìš´ë¡œë“œ
   - Memcachedì— ì €ì¥ (TTL: 24ì‹œê°„)
   - ë‹¤ìŒ ì¿¼ë¦¬ëŠ” Cache Hit
```

---

## 3ï¸âƒ£ Redis ìºì‹± (Alternative)

### Redis ë°°í¬ (HA)

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: monitoring
spec:
  replicas: 3  # Master + 2 Replicas
  serviceName: redis
  template:
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --appendonly yes
        - --maxmemory 2gb
        - --maxmemory-policy allkeys-lru
        ports:
        - containerPort: 6379
        resources:
          requests:
            cpu: 200m
            memory: 2Gi
        volumeMounts:
        - name: data
          mountPath: /data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
```

### Query Frontend with Redis

```yaml
args:
- query-frontend
- --query-range.response-cache-config=type=REDIS,config.addr=redis:6379,config.db=0,config.max_item_size=5MB,config.expiration=5m
```

**Redis vs Memcached ë¹„êµ**:

| íŠ¹ì§• | Memcached | Redis |
|-----|----------|-------|
| **ì„±ëŠ¥** | ë§¤ìš° ë¹ ë¦„ | ë¹ ë¦„ |
| **ë°ì´í„° êµ¬ì¡°** | Key-Value | Key-Value + List/Set/Hash |
| **ì˜ì†ì„±** | ì—†ìŒ | AOF/RDB |
| **ë©”ëª¨ë¦¬ íš¨ìœ¨** | ë†’ìŒ | ë³´í†µ |
| **Cluster** | Consistent Hashing | Redis Cluster |
| **ì¶”ì²œ** | Stateless ìºì‹œ | ì˜ì†ì„± í•„ìš” ì‹œ |

---

## 4ï¸âƒ£ ìºì‹œ TTL ì „ëµ

### Results Cache TTL

```yaml
# Query Frontend
- --query-range.response-cache-config=...config.expiration=5m

# TTL ê²°ì • ê¸°ì¤€:
# - ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ: 1~5ë¶„
# - íŠ¸ë Œë“œ ë¶„ì„: 10~30ë¶„
# - ì •ì  ë¦¬í¬íŠ¸: 1ì‹œê°„
```

**ì˜ˆì‹œ**:
```
ì¿¼ë¦¬: last 1 hour (ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§)
â†’ TTL: 1ë¶„ (ë¹ ë¥¸ ì—…ë°ì´íŠ¸)

ì¿¼ë¦¬: last 7 days (íŠ¸ë Œë“œ ë¶„ì„)
â†’ TTL: 10ë¶„ (ëœ ì¤‘ìš”)

ì¿¼ë¦¬: last 30 days (ì›”ê°„ ë¦¬í¬íŠ¸)
â†’ TTL: 1ì‹œê°„ (ì •ì  ë°ì´í„°)
```

### Index Cache TTL

```yaml
# Store Gateway
- --index-cache.config=...

# ë¸”ë¡ ì¸ë±ìŠ¤ëŠ” ë¶ˆë³€ì´ë¯€ë¡œ ê¸´ TTL ì‚¬ìš©
# TTL: 24ì‹œê°„ (ë˜ëŠ” ë¬´ì œí•œ)
```

---

## 5ï¸âƒ£ Cache Warming

### Pre-warming Script

```bash
#!/bin/bash
# cache-warming.sh

GRAFANA_URL="http://grafana.monitoring.svc:3000"
QUERIES=(
  'sum(rate(container_cpu_usage_seconds_total[5m])) by (namespace)'
  'sum(container_memory_working_set_bytes) by (namespace)'
  'count(kube_pod_info) by (cluster)'
)

for query in "${QUERIES[@]}"; do
  echo "Warming cache for: $query"
  curl -G "$GRAFANA_URL/api/datasources/proxy/1/api/v1/query_range" \
    --data-urlencode "query=$query" \
    --data-urlencode "start=$(date -d '1 hour ago' +%s)" \
    --data-urlencode "end=$(date +%s)" \
    --data-urlencode "step=15s"
done
```

### CronJob for Cache Warming

```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cache-warming
  namespace: monitoring
spec:
  schedule: "*/30 * * * *"  # 30ë¶„ë§ˆë‹¤
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cache-warming
            image: curlimages/curl:latest
            command: ["/bin/sh", "-c"]
            args:
            - |
              curl -G "http://thanos-query-frontend:9090/api/v1/query_range" \
                --data-urlencode "query=sum(rate(container_cpu_usage_seconds_total[5m])) by (namespace)" \
                --data-urlencode "start=$(date -d '1 hour ago' +%s)" \
                --data-urlencode "end=$(date +%s)" \
                --data-urlencode "step=15s"
          restartPolicy: OnFailure
```

---

## ğŸ“Š ìºì‹œ ì„±ëŠ¥ ì¸¡ì •

### Results Cache íˆíŠ¸ìœ¨

```promql
# íˆíŠ¸ìœ¨
sum(rate(thanos_query_frontend_queries_total{cache="hit"}[5m]))
/
sum(rate(thanos_query_frontend_queries_total[5m]))

# íˆíŠ¸/ë¯¸ìŠ¤ ì¹´ìš´íŠ¸
sum(increase(thanos_query_frontend_queries_total{cache="hit"}[1h]))
sum(increase(thanos_query_frontend_queries_total{cache="miss"}[1h]))
```

### Index Cache íˆíŠ¸ìœ¨

```promql
# íˆíŠ¸ìœ¨
sum(rate(thanos_store_index_cache_requests_total{result="hit"}[5m]))
/
sum(rate(thanos_store_index_cache_requests_total[5m]))

# ì ˆê°ëœ S3 ìš”ì²­ ìˆ˜
sum(increase(thanos_store_index_cache_requests_total{result="hit"}[1h]))
```

### Memcached í†µê³„

```promql
# ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
memcached_current_bytes / memcached_limit_bytes

# Eviction ë¹„ìœ¨ (ìºì‹œ ìš©ëŸ‰ ë¶€ì¡±)
rate(memcached_items_evicted_total[5m])

# Hit rate
rate(memcached_commands_total{command="get",status="hit"}[5m])
/
rate(memcached_commands_total{command="get"}[5m])
```

---

## ğŸš¨ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼

### ë‚®ì€ ìºì‹œ íˆíŠ¸ìœ¨ ì•Œë¦¼

```yaml
- alert: LowCacheHitRate
  expr: |
    (
      sum(rate(thanos_query_frontend_queries_total{cache="hit"}[5m]))
      /
      sum(rate(thanos_query_frontend_queries_total[5m]))
    ) < 0.5
  for: 30m
  labels:
    severity: warning
  annotations:
    summary: "Query Frontend cache hit rate < 50%"
    description: "Current hit rate: {{ $value | humanizePercentage }}"
```

### Memcached Down ì•Œë¦¼

```yaml
- alert: MemcachedDown
  expr: up{job="memcached"} == 0
  for: 2m
  labels:
    severity: critical
  annotations:
    summary: "Memcached {{ $labels.instance }} is down"
```

### Cache Eviction ì•Œë¦¼

```yaml
- alert: HighCacheEviction
  expr: rate(memcached_items_evicted_total[5m]) > 100
  for: 10m
  labels:
    severity: warning
  annotations:
    summary: "High cache eviction rate (> 100/sec)"
    description: "Consider increasing Memcached memory"
```

---

## ğŸ¯ ìºì‹± ì „ëµ ì²´í¬ë¦¬ìŠ¤íŠ¸

### Results Cache
- [x] Memcached ë°°í¬ (3 replicas)
- [x] Query Frontend ì—°ë™
- [x] TTL ì„¤ì • (5ë¶„)
- [x] ìºì‹œ íˆíŠ¸ìœ¨ ëª¨ë‹ˆí„°ë§

### Index Cache
- [x] Memcached ë°°í¬ (3 replicas)
- [x] Store Gateway ì—°ë™
- [x] TTL ì„¤ì • (24ì‹œê°„)
- [x] S3 ìš”ì²­ ê°ì†Œ í™•ì¸

### ìµœì í™”
- [ ] Cache Warming CronJob
- [ ] ìºì‹œ í¬ê¸° íŠœë‹ (ë©”ëª¨ë¦¬)
- [ ] TTL ìµœì í™” (ì›Œí¬ë¡œë“œë³„)

### ëª¨ë‹ˆí„°ë§
- [x] ìºì‹œ íˆíŠ¸ìœ¨ ëŒ€ì‹œë³´ë“œ
- [x] Memcached ë©”íŠ¸ë¦­
- [x] ì•Œë¦¼ ê·œì¹™ ì„¤ì •

---

## ğŸ’¡ ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. Memcached í¬ê¸° ê³„ì‚°

```
Results Cache:
- í‰ê·  ì¿¼ë¦¬ ê²°ê³¼ í¬ê¸°: 100KB
- ìºì‹œ íˆíŠ¸ìœ¨ ëª©í‘œ: 70%
- ë¶„ë‹¹ ì¿¼ë¦¬ ìˆ˜: 100
- TTL: 5ë¶„

í•„ìš” ìºì‹œ í¬ê¸° = 100KB Ã— 100 Ã— 5 Ã— 0.7
                = 35MB

ì—¬ìœ ìœ¨ 50% ì¶”ê°€:
â†’ Memcached: 50MB (ìµœì†Œ)

ì‹¤ë¬´ì—ì„œëŠ” 2Gi ê¶Œì¥ (ì—¬ëŸ¬ ëŒ€ì‹œë³´ë“œ, spike ëŒ€ë¹„)
```

### 2. ìºì‹œ ë¬´íš¨í™” (Invalidation)

```yaml
# ë°°í¬ ì‹œ ìºì‹œ ë¬´íš¨í™”
apiVersion: batch/v1
kind: Job
metadata:
  name: cache-invalidation
spec:
  template:
    spec:
      containers:
      - name: flush-cache
        image: memcached:1.6-alpine
        command:
        - sh
        - -c
        - echo "flush_all" | nc query-frontend-memcached 11211
      restartPolicy: Never
```

### 3. ìºì‹œ ë ˆì´ì–´ ìš°ì„ ìˆœìœ„

```
1. Results Cache (Query Frontend)
   â†’ ê°€ì¥ íš¨ê³¼ì , ì¿¼ë¦¬ ê²°ê³¼ ìºì‹±

2. Index Cache (Store Gateway)
   â†’ S3 ìš”ì²­ ì ˆê°, ë ˆì´í„´ì‹œ ê°œì„ 

3. Application Cache (Grafana)
   â†’ ëŒ€ì‹œë³´ë“œ ë Œë”ë§ ìºì‹±
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ì¿¼ë¦¬ ì„±ëŠ¥ ìµœì í™”** â†’ [ì¿¼ë¦¬-ì„±ëŠ¥-ìµœì í™”.md](./ì¿¼ë¦¬-ì„±ëŠ¥-ìµœì í™”.md)
- **Thanos Query Frontend** â†’ [../01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md](../01-ì•„í‚¤í…ì²˜/ì „ì²´-ì‹œìŠ¤í…œ-ì•„í‚¤í…ì²˜.md)
- **ë¦¬ì†ŒìŠ¤ Right-Sizing** â†’ [ë¦¬ì†ŒìŠ¤-Right-Sizing.md](./ë¦¬ì†ŒìŠ¤-Right-Sizing.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
