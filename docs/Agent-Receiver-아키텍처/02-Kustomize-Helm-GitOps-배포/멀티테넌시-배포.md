# ë©€í‹°í…Œë„Œì‹œ ë°°í¬

## ğŸ“‹ ê°œìš”

Cluster-02ì—ì„œ **ë…¸ë“œ ë ˆë²¨ ë©€í‹°í…Œë„Œì‹œ**ë¥¼ êµ¬í˜„í•˜ì—¬ Tenant Aì™€ Tenant Bê°€ ë¬¼ë¦¬ì ìœ¼ë¡œ ê²©ë¦¬ëœ í™˜ê²½ì—ì„œ ë©”íŠ¸ë¦­ì„ ìˆ˜ì§‘í•˜ê³  Thanos Receiverë¥¼ í†µí•´ ì¤‘ì•™ ì €ì¥ì†Œë¡œ ì „ì†¡í•©ë‹ˆë‹¤.

---

## ğŸ¯ ë©€í‹°í…Œë„Œì‹œ ëª©í‘œ

- **ë¬¼ë¦¬ì  ê²©ë¦¬**: ë…¸ë“œ ë ˆë²¨ ë¶„ë¦¬ (50/50)
- **ë…¼ë¦¬ì  ê²©ë¦¬**: Namespace ë¶„ë¦¬
- **ë°ì´í„° ê²©ë¦¬**: Tenant ë ˆì´ë¸”/í—¤ë”ë¡œ ì‹ë³„
- **ë¦¬ì†ŒìŠ¤ í• ë‹¹**: Tenantë³„ ë…ë¦½ì ì¸ Prometheus Agent
- **ì¤‘ì•™ ì§‘ê³„**: Thanos Receiver Hashring + Tenant Routing

---

## ğŸ—ï¸ ë©€í‹°í…Œë„Œì‹œ ì•„í‚¤í…ì²˜

### ì „ì²´ êµ¬ì¡°

```mermaid
graph TB
    subgraph "Cluster-02 (192.168.101.196)"
        subgraph "Physical Node A"
            POD_A1[Workload Pods<br/>Tenant A]
            POD_A2[Workload Pods<br/>Tenant A]
            AGENT_A[Prometheus Agent A<br/>monitoring-tenant-a]
            NODE_EXP_A[Node Exporter A]

            POD_A1 --> AGENT_A
            POD_A2 --> AGENT_A
            NODE_EXP_A --> AGENT_A
        end

        subgraph "Physical Node B"
            POD_B1[Workload Pods<br/>Tenant B]
            POD_B2[Workload Pods<br/>Tenant B]
            AGENT_B[Prometheus Agent B<br/>monitoring-tenant-b]
            NODE_EXP_B[Node Exporter B]

            POD_B1 --> AGENT_B
            POD_B2 --> AGENT_B
            NODE_EXP_B --> AGENT_B
        end

        subgraph "Shared Components"
            KSM[Kube-State-Metrics<br/>monitoring namespace]
        end

        KSM -.Scrape by both.-> AGENT_A
        KSM -.Scrape by both.-> AGENT_B
    end

    subgraph "Central Cluster-01"
        subgraph "Thanos Receiver Hashring"
            RECEIVER[Receiver Router<br/>X-Scope-OrgID]
            HASHRING_A[Hashring: tenant-a<br/>Endpoints: receive-0,1,2]
            HASHRING_B[Hashring: tenant-b<br/>Endpoints: receive-0,1,2]

            RECEIVER --> HASHRING_A
            RECEIVER --> HASHRING_B
        end

        subgraph "S3 Storage"
            S3_A[s3://thanos-cluster-01/tenant-a/]
            S3_B[s3://thanos-cluster-01/tenant-b/]
        end

        HASHRING_A --> S3_A
        HASHRING_B --> S3_B
    end

    AGENT_A -.Remote Write<br/>X-Scope-OrgID: tenant-a.-> RECEIVER
    AGENT_B -.Remote Write<br/>X-Scope-OrgID: tenant-b.-> RECEIVER

    style AGENT_A fill:#4fc3f7
    style AGENT_B fill:#81c784
    style RECEIVER fill:#ff9800
```

---

## 1ï¸âƒ£ ë…¸ë“œ ë ˆë²¨ ê²©ë¦¬

### ë…¸ë“œ ë ˆì´ë¸”ë§

```bash
# Cluster-02 ì ‘ì†
export KUBECONFIG=~/.kube/configs/cluster-02.conf

# ë…¸ë“œ ëª©ë¡ í™•ì¸
kubectl get nodes

# ì¶œë ¥ ì˜ˆì‹œ:
# NAME                   STATUS   ROLES           AGE   VERSION
# cluster-02-control-01  Ready    control-plane   10d   v1.28.0

# ê°€ìƒ ë…¸ë“œ ìƒì„± (ë‹¨ì¼ ë…¸ë“œ í´ëŸ¬ìŠ¤í„°ì˜ ê²½ìš°, Taintsë¡œ ë¶„ë¦¬)
# ë˜ëŠ” ì‹¤ì œ ë©€í‹°ë…¸ë“œ í™˜ê²½ì—ì„œ:

# Node Aì— tenant-a ë ˆì´ë¸”
kubectl label node <node-a-name> tenant=tenant-a

# Node Bì— tenant-b ë ˆì´ë¸”
kubectl label node <node-b-name> tenant=tenant-b

# í™•ì¸
kubectl get nodes --show-labels | grep tenant

# ì¶œë ¥:
# node-a   Ready   ...   tenant=tenant-a
# node-b   Ready   ...   tenant=tenant-b
```

### ë‹¨ì¼ ë…¸ë“œ í™˜ê²½ì—ì„œ ê°€ìƒ ë¶„ë¦¬ (ê°œë°œ/í…ŒìŠ¤íŠ¸)

```bash
# ë‹¨ì¼ ë…¸ë“œë¥¼ Taintë¡œ ë…¼ë¦¬ì  ë¶„ë¦¬ (í”„ë¡œë•ì…˜ ë¹„ê¶Œì¥)
kubectl taint nodes cluster-02-control-01 tenant=tenant-a:NoSchedule
kubectl taint nodes cluster-02-control-01 tenant=tenant-b:NoSchedule

# Tenant A PodëŠ” tolerationìœ¼ë¡œ tenant-a Taint í—ˆìš©
# Tenant B PodëŠ” tolerationìœ¼ë¡œ tenant-b Taint í—ˆìš©
```

---

## 2ï¸âƒ£ Namespace ê²©ë¦¬

### Namespace ìƒì„±

```bash
# Tenant A Namespace
kubectl create namespace monitoring-tenant-a

# Tenant B Namespace
kubectl create namespace monitoring-tenant-b

# Shared ë¦¬ì†ŒìŠ¤ Namespace
kubectl create namespace monitoring

# í™•ì¸
kubectl get namespaces | grep monitoring

# ì¶œë ¥:
# monitoring               Active   1m
# monitoring-tenant-a      Active   1m
# monitoring-tenant-b      Active   1m
```

### RBAC ê²©ë¦¬

```yaml
# Tenant A ServiceAccount
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-agent-tenant-a
  namespace: monitoring-tenant-a
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: prometheus-agent-tenant-a
rules:
- apiGroups: [""]
  resources:
  - nodes
  - nodes/metrics
  - services
  - endpoints
  - pods
  verbs: ["get", "list", "watch"]
- apiGroups: [""]
  resources:
  - configmaps
  verbs: ["get"]
- apiGroups: ["networking.k8s.io"]
  resources:
  - ingresses
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: prometheus-agent-tenant-a
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: prometheus-agent-tenant-a
subjects:
- kind: ServiceAccount
  name: prometheus-agent-tenant-a
  namespace: monitoring-tenant-a
```

```yaml
# Tenant B ServiceAccount (ë™ì¼ êµ¬ì¡°)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: prometheus-agent-tenant-b
  namespace: monitoring-tenant-b
---
# ClusterRole, ClusterRoleBinding (tenant-b)
```

---

## 3ï¸âƒ£ Prometheus Agent ë©€í‹°í…Œë„ŒíŠ¸ ë°°í¬

### Tenant A Agent êµ¬ì„±

```yaml
# deploy/overlays/cluster-02-edge/prometheus-agent-tenant-a/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring-tenant-a

bases:
  - ../../../base/prometheus-agent

helmCharts:
- name: kube-prometheus-stack
  repo: https://prometheus-community.github.io/helm-charts
  version: 58.0.0
  releaseName: prometheus-agent-tenant-a
  namespace: monitoring-tenant-a
  valuesFile: values.yaml

resources:
  - rbac.yaml

patchesStrategicMerge:
  - values-patch.yaml
  - scrape-config-patch.yaml
```

```yaml
# deploy/overlays/cluster-02-edge/prometheus-agent-tenant-a/values-patch.yaml
nameOverride: prometheus-agent-tenant-a
fullnameOverride: prometheus-agent-tenant-a

prometheus:
  enabled: true

  prometheusSpec:
    # Agent Mode
    enableAgentMode: true
    replicas: 1

    # ServiceAccount
    serviceAccountName: prometheus-agent-tenant-a

    # ì™¸ë¶€ ë ˆì´ë¸”
    externalLabels:
      cluster: cluster-02
      role: edge-multi-tenant
      tenant: tenant-a
      tenant_id: "1001"

    # Remote Write with Tenant Header
    remoteWrite:
      - url: http://thanos-receive-lb.monitoring.svc.cluster-01.local:19291/api/v1/receive
        name: thanos-receiver

        # Tenant í—¤ë” (Thanos Receiver Routing)
        headers:
          X-Scope-OrgID: tenant-a

        # Queue ì„¤ì •
        queueConfig:
          capacity: 20000
          maxShards: 100
          minShards: 10
          maxSamplesPerSend: 10000
          batchSendDeadline: 10s
          minBackoff: 30ms
          maxBackoff: 5s

        # Write Relabeling
        writeRelabelConfigs:
          # tenant ë ˆì´ë¸” ê°•ì œ ì¶”ê°€
          - targetLabel: tenant
            replacement: tenant-a
          - targetLabel: tenant_id
            replacement: "1001"

          # ë¶ˆí•„ìš”í•œ ë©”íŠ¸ë¦­ í•„í„°ë§
          - sourceLabels: [__name__]
            regex: 'go_gc_.*|go_memstats_.*'
            action: drop

    # Node Affinity: tenant-a ë…¸ë“œë§Œ
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: tenant
              operator: In
              values:
              - tenant-a

    # ë¦¬ì†ŒìŠ¤
    resources:
      requests:
        cpu: 200m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # WAL ìŠ¤í† ë¦¬ì§€
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: longhorn
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 50Gi

# Node Exporter (tenant-a ë…¸ë“œë§Œ)
prometheus-node-exporter:
  enabled: true

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: tenant
            operator: In
            values:
            - tenant-a

  # ì¶”ê°€ ë ˆì´ë¸”
  extraArgs:
    - --collector.textfile.directory=/var/lib/node_exporter/textfile_collector

  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Kube-State-Metrics ë¹„í™œì„±í™” (Shared ì‚¬ìš©)
kube-state-metrics:
  enabled: false

# Grafana, Alertmanager ë¹„í™œì„±í™”
grafana:
  enabled: false

alertmanager:
  enabled: false
```

### Tenant A Scrape ì„¤ì •

```yaml
# deploy/overlays/cluster-02-edge/prometheus-agent-tenant-a/scrape-config-patch.yaml
prometheus:
  prometheusSpec:
    # ServiceMonitor Selector: tenant-aë§Œ
    serviceMonitorNamespaceSelector:
      matchLabels:
        tenant: tenant-a

    serviceMonitorSelector:
      matchLabels:
        tenant: tenant-a

    # PodMonitor Selector: tenant-aë§Œ
    podMonitorNamespaceSelector:
      matchLabels:
        tenant: tenant-a

    podMonitorSelector:
      matchLabels:
        tenant: tenant-a

    # ì¶”ê°€ Scrape Config
    additionalScrapeConfigs:
      # Shared Kube-State-Metrics ìˆ˜ì§‘
      - job_name: 'kube-state-metrics-shared'
        static_configs:
          - targets: ['kube-state-metrics.monitoring.svc.cluster.local:8080']
        relabel_configs:
          # tenant ë ˆì´ë¸” ì¶”ê°€
          - target_label: tenant
            replacement: tenant-a

      # Tenant A ì›Œí¬ë¡œë“œë§Œ í•„í„°ë§
      - job_name: 'kubernetes-pods-tenant-a'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names:
                - default
                - monitoring-tenant-a
        relabel_configs:
          # tenant-a ë…¸ë“œì˜ Podë§Œ
          - source_labels: [__meta_kubernetes_node_label_tenant]
            regex: tenant-a
            action: keep

          # tenant ë ˆì´ë¸” ì¶”ê°€
          - target_label: tenant
            replacement: tenant-a
```

### Tenant B Agent êµ¬ì„± (ë™ì¼ íŒ¨í„´)

```yaml
# deploy/overlays/cluster-02-edge/prometheus-agent-tenant-b/values-patch.yaml
nameOverride: prometheus-agent-tenant-b
fullnameOverride: prometheus-agent-tenant-b

prometheus:
  prometheusSpec:
    serviceAccountName: prometheus-agent-tenant-b

    externalLabels:
      cluster: cluster-02
      role: edge-multi-tenant
      tenant: tenant-b
      tenant_id: "1002"

    remoteWrite:
      - url: http://thanos-receive-lb.monitoring.svc.cluster-01.local:19291/api/v1/receive
        headers:
          X-Scope-OrgID: tenant-b

        writeRelabelConfigs:
          - targetLabel: tenant
            replacement: tenant-b
          - targetLabel: tenant_id
            replacement: "1002"

    # Node Affinity: tenant-b ë…¸ë“œë§Œ
    affinity:
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
          - matchExpressions:
            - key: tenant
              operator: In
              values:
              - tenant-b

prometheus-node-exporter:
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: tenant
            operator: In
            values:
            - tenant-b
```

---

## 4ï¸âƒ£ Shared Kube-State-Metrics

### Shared KSM ë°°í¬

```yaml
# deploy/overlays/cluster-02-edge/kube-state-metrics/kustomization.yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
  - kube-state-metrics-deployment.yaml
  - kube-state-metrics-service.yaml
  - rbac.yaml
```

```yaml
# deploy/overlays/cluster-02-edge/kube-state-metrics/kube-state-metrics-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kube-state-metrics
  namespace: monitoring
  labels:
    app: kube-state-metrics
spec:
  replicas: 1
  selector:
    matchLabels:
      app: kube-state-metrics
  template:
    metadata:
      labels:
        app: kube-state-metrics
    spec:
      serviceAccountName: kube-state-metrics
      containers:
      - name: kube-state-metrics
        image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.10.0
        args:
          # ëª¨ë“  Namespace ìˆ˜ì§‘
          - --namespaces=
          - --metric-labels-allowlist=pods=[*],deployments=[*],nodes=[*]

        ports:
        - name: http-metrics
          containerPort: 8080
        - name: telemetry
          containerPort: 8081

        livenessProbe:
          httpGet:
            path: /healthz
            port: 8080
          initialDelaySeconds: 5
          timeoutSeconds: 5

        readinessProbe:
          httpGet:
            path: /
            port: 8081
          initialDelaySeconds: 5
          timeoutSeconds: 5

        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 100m
            memory: 128Mi

        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 65534
```

```yaml
# deploy/overlays/cluster-02-edge/kube-state-metrics/kube-state-metrics-service.yaml
apiVersion: v1
kind: Service
metadata:
  name: kube-state-metrics
  namespace: monitoring
  labels:
    app: kube-state-metrics
spec:
  clusterIP: None
  ports:
  - name: http-metrics
    port: 8080
    targetPort: 8080
  - name: telemetry
    port: 8081
    targetPort: 8081
  selector:
    app: kube-state-metrics
```

---

## 5ï¸âƒ£ Thanos Receiver Hashring (Tenant Routing)

### Receiver Hashring ConfigMap

```yaml
# deploy/overlays/cluster-01-central/kube-prometheus-stack/thanos-receive-hashring-multi-tenant.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: thanos-receive-hashring
  namespace: monitoring
data:
  hashrings.json: |
    [
      {
        "hashring": "tenant-a",
        "tenants": ["tenant-a"],
        "endpoints": [
          "thanos-receive-0.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-1.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-2.thanos-receive.monitoring.svc.cluster.local:10901"
        ]
      },
      {
        "hashring": "tenant-b",
        "tenants": ["tenant-b"],
        "endpoints": [
          "thanos-receive-0.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-1.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-2.thanos-receive.monitoring.svc.cluster.local:10901"
        ]
      },
      {
        "hashring": "default",
        "tenants": [],
        "endpoints": [
          "thanos-receive-0.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-1.thanos-receive.monitoring.svc.cluster.local:10901",
          "thanos-receive-2.thanos-receive.monitoring.svc.cluster.local:10901"
        ]
      }
    ]
```

### Receiver Deployment ìˆ˜ì •

```yaml
# Thanos Receiver argsì— ì¶”ê°€
args:
  - receive
  - --receive.hashrings-file=/etc/thanos/hashrings.json
  - --receive.hashrings-algorithm=ketama  # Consistent Hashing
  - --receive.tenant-header=X-Scope-OrgID
  - --receive.tenant-label-name=tenant
  - --receive.replica-header=THANOS-REPLICA
```

---

## 6ï¸âƒ£ ë°°í¬ ìˆœì„œ

### 1ë‹¨ê³„: ë…¸ë“œ ì¤€ë¹„

```bash
# Cluster-02 ì ‘ì†
export KUBECONFIG=~/.kube/configs/cluster-02.conf

# ë…¸ë“œ ë ˆì´ë¸”ë§
kubectl label node <node-a> tenant=tenant-a
kubectl label node <node-b> tenant=tenant-b

# í™•ì¸
kubectl get nodes -L tenant
```

### 2ë‹¨ê³„: Namespace ìƒì„±

```bash
kubectl create namespace monitoring
kubectl create namespace monitoring-tenant-a
kubectl create namespace monitoring-tenant-b

# Namespaceì— ë ˆì´ë¸” ì¶”ê°€
kubectl label namespace monitoring-tenant-a tenant=tenant-a
kubectl label namespace monitoring-tenant-b tenant=tenant-b
```

### 3ë‹¨ê³„: RBAC ë°°í¬

```bash
# Tenant A RBAC
kubectl apply -f deploy/overlays/cluster-02-edge/prometheus-agent-tenant-a/rbac.yaml

# Tenant B RBAC
kubectl apply -f deploy/overlays/cluster-02-edge/prometheus-agent-tenant-b/rbac.yaml
```

### 4ë‹¨ê³„: Shared KSM ë°°í¬

```bash
kustomize build deploy/overlays/cluster-02-edge/kube-state-metrics \
  | kubectl apply -f -

# í™•ì¸
kubectl get pods -n monitoring
```

### 5ë‹¨ê³„: Tenant A Agent ë°°í¬

```bash
kustomize build deploy/overlays/cluster-02-edge/prometheus-agent-tenant-a --enable-helm \
  | kubectl apply -f -

# í™•ì¸
kubectl get pods -n monitoring-tenant-a

# Pod ë…¸ë“œ ë°°ì¹˜ í™•ì¸
kubectl get pods -n monitoring-tenant-a -o wide
# ì¶œë ¥: ëª¨ë‘ tenant-a ë…¸ë“œì— ë°°í¬ë¨
```

### 6ë‹¨ê³„: Tenant B Agent ë°°í¬

```bash
kustomize build deploy/overlays/cluster-02-edge/prometheus-agent-tenant-b --enable-helm \
  | kubectl apply -f -

# í™•ì¸
kubectl get pods -n monitoring-tenant-b -o wide
# ì¶œë ¥: ëª¨ë‘ tenant-b ë…¸ë“œì— ë°°í¬ë¨
```

### 7ë‹¨ê³„: Central Cluster Receiver Hashring ì—…ë°ì´íŠ¸

```bash
# Cluster-01 ì ‘ì†
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# Hashring ConfigMap ì—…ë°ì´íŠ¸
kubectl apply -f deploy/overlays/cluster-01-central/kube-prometheus-stack/thanos-receive-hashring-multi-tenant.yaml

# Receiver ì¬ì‹œì‘ (ConfigMap ë³€ê²½ ë°˜ì˜)
kubectl rollout restart statefulset/thanos-receive -n monitoring
```

---

## 7ï¸âƒ£ ê²€ì¦

### Tenant ê²©ë¦¬ í™•ì¸

```bash
# Cluster-02ì—ì„œ í™•ì¸

# Tenant A PodëŠ” tenant-a ë…¸ë“œì—ë§Œ
kubectl get pods -n monitoring-tenant-a -o wide | grep -v tenant-a
# ì¶œë ¥: (ì—†ìŒ)

# Tenant B PodëŠ” tenant-b ë…¸ë“œì—ë§Œ
kubectl get pods -n monitoring-tenant-b -o wide | grep -v tenant-b
# ì¶œë ¥: (ì—†ìŒ)
```

### Remote Write í—¤ë” í™•ì¸

```bash
# Tenant A Agent ë¡œê·¸
kubectl logs -n monitoring-tenant-a prometheus-agent-tenant-a-0 | grep "X-Scope-OrgID"

# Receiver ë¡œê·¸ (Cluster-01)
kubectl logs -n monitoring thanos-receive-0 | grep "tenant-a"

# ë¡œê·¸ ì˜ˆì‹œ:
# level=info tenant=tenant-a samples=1250 msg="handling remote write"
```

### ë©”íŠ¸ë¦­ ì¿¼ë¦¬ (Tenant í•„í„°ë§)

```promql
# Thanos Queryì—ì„œ í™•ì¸

# Tenant A ë©”íŠ¸ë¦­ë§Œ
up{tenant="tenant-a"}

# Tenant B ë©”íŠ¸ë¦­ë§Œ
up{tenant="tenant-b"}

# Tenantë³„ ë©”íŠ¸ë¦­ ìˆ˜
count(up) by (tenant)

# ì¶œë ¥:
# {tenant="tenant-a"} 45
# {tenant="tenant-b"} 38

# Tenantë³„ ìƒ˜í”Œ ìˆ˜
sum(scrape_samples_scraped) by (tenant)
```

### Grafanaì—ì„œ Tenant ë¶„ë¦¬ ëŒ€ì‹œë³´ë“œ

```json
{
  "dashboard": {
    "title": "Multi-Tenant Metrics",
    "panels": [
      {
        "title": "Tenant A Metrics",
        "targets": [
          {
            "expr": "rate(prometheus_tsdb_head_samples_appended_total{tenant=\"tenant-a\"}[5m])"
          }
        ]
      },
      {
        "title": "Tenant B Metrics",
        "targets": [
          {
            "expr": "rate(prometheus_tsdb_head_samples_appended_total{tenant=\"tenant-b\"}[5m])"
          }
        ]
      }
    ]
  }
}
```

---

## ğŸ“Š ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰

### Cluster-02 ì´ ë¦¬ì†ŒìŠ¤

| ì»´í¬ë„ŒíŠ¸ | CPU (requests) | Memory (requests) | ê°œìˆ˜ |
|----------|----------------|-------------------|------|
| Prometheus Agent A | 200m | 256Mi | 1 |
| Prometheus Agent B | 200m | 256Mi | 1 |
| Node Exporter A | 100m | 64Mi | 1 |
| Node Exporter B | 100m | 64Mi | 1 |
| Kube-State-Metrics | 50m | 64Mi | 1 |
| **ì´í•©** | **650m** | **704Mi** | **5** |

---

## ğŸ¯ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë…¸ë“œ ì¤€ë¹„
- [x] ë…¸ë“œ ë ˆì´ë¸”ë§ (tenant=tenant-a/b)
- [x] ë…¸ë“œ ë¦¬ì†ŒìŠ¤ í™•ì¸ (CPU, Memory)

### Namespace ë° RBAC
- [x] Namespace ìƒì„± (3ê°œ)
- [x] Namespace ë ˆì´ë¸” ì¶”ê°€
- [x] ServiceAccount ìƒì„± (tenant-a, tenant-b)
- [x] ClusterRole/Binding ìƒì„±

### Shared ì»´í¬ë„ŒíŠ¸
- [x] Kube-State-Metrics ë°°í¬
- [x] Service ìƒì„± ë° í™•ì¸

### Tenant A
- [x] Prometheus Agent ë°°í¬
- [x] Node Affinity í™•ì¸
- [x] Remote Write ì„¤ì • (X-Scope-OrgID: tenant-a)
- [x] Scrape Config (tenant-aë§Œ)
- [x] Node Exporter ë°°í¬

### Tenant B
- [x] Prometheus Agent ë°°í¬
- [x] Node Affinity í™•ì¸
- [x] Remote Write ì„¤ì • (X-Scope-OrgID: tenant-b)
- [x] Scrape Config (tenant-bë§Œ)
- [x] Node Exporter ë°°í¬

### Central Cluster
- [x] Receiver Hashring ConfigMap ì—…ë°ì´íŠ¸
- [x] Receiver ì¬ì‹œì‘
- [x] Tenant Routing í™•ì¸

### ê²€ì¦
- [x] Pod ë…¸ë“œ ë°°ì¹˜ í™•ì¸
- [x] Remote Write ì—°ê²° í™•ì¸
- [x] ë©”íŠ¸ë¦­ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸ (tenant í•„í„°)
- [x] Grafana ëŒ€ì‹œë³´ë“œ í™•ì¸

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ì—£ì§€ í´ëŸ¬ìŠ¤í„° ë°°í¬** â†’ [ì—£ì§€-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md](./ì—£ì§€-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md)
- **ì¤‘ì•™ í´ëŸ¬ìŠ¤í„° ë°°í¬** â†’ [ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md](./ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md)
- **ë°°í¬ ê²€ì¦** â†’ [ë°°í¬-ê²€ì¦.md](./ë°°í¬-ê²€ì¦.md)
- **ë©€í‹°í…Œë„Œì‹œ êµ¬ì„±** â†’ [../05-ë©€í‹°í…Œë„Œì‹œ-êµ¬ì„±/README.md](../05-ë©€í‹°í…Œë„Œì‹œ-êµ¬ì„±/README.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
