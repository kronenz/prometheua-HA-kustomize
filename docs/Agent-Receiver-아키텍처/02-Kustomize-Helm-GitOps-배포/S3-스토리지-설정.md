# S3 ìŠ¤í† ë¦¬ì§€ ì„¤ì •

## ğŸ“‹ ê°œìš”

MinIO S3ë¥¼ ì‚¬ìš©í•˜ì—¬ Thanos ì»´í¬ë„ŒíŠ¸(Sidecar, Receiver, Store, Compactor)ê°€ ì¥ê¸° ë©”íŠ¸ë¦­ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •í•©ë‹ˆë‹¤.

---

## ğŸ¯ S3 ì„¤ì • ëª©í‘œ

- **MinIO S3 ë²„í‚· ìƒì„±** (í´ëŸ¬ìŠ¤í„°ë³„ ë¶„ë¦¬)
- **objstore.yml Secret ìƒì„±** (Thanos ì¸ì¦)
- **Lifecycle Policy ì„¤ì •** (ìë™ ì‚­ì œ)
- **ë²„ì „ ê´€ë¦¬ ë° ì•”í˜¸í™”**
- **ì ‘ê·¼ ì œì–´ (IAM Policy)**

---

## ğŸ—ï¸ S3 ìŠ¤í† ë¦¬ì§€ êµ¬ì¡°

```mermaid
graph TB
    subgraph "MinIO S3 (s3.minio.miribit.lab:9000)"
        subgraph "Bucket: thanos-cluster-01"
            TENANT_A[tenant-a/<br/>TSDB Blocks]
            TENANT_B[tenant-b/<br/>TSDB Blocks]
            DEFAULT[default/<br/>TSDB Blocks]
        end

        subgraph "Bucket: thanos-cluster-02"
            EDGE_02[cluster-02/<br/>TSDB Blocks]
        end

        subgraph "Bucket: thanos-cluster-03"
            EDGE_03[cluster-03/<br/>TSDB Blocks]
        end

        subgraph "Bucket: thanos-cluster-04"
            EDGE_04[cluster-04/<br/>TSDB Blocks]
        end
    end

    subgraph "Thanos Components"
        SIDECAR[Thanos Sidecar<br/>Prometheus HA]
        RECEIVER[Thanos Receiver<br/>Remote Write]
        COMPACTOR[Thanos Compactor<br/>Downsampling]
        STORE[Thanos Store<br/>Query Gateway]
    end

    SIDECAR --> TENANT_A
    SIDECAR --> TENANT_B
    RECEIVER --> TENANT_A
    RECEIVER --> TENANT_B
    RECEIVER --> DEFAULT
    COMPACTOR --> TENANT_A
    COMPACTOR --> TENANT_B
    STORE --> TENANT_A
    STORE --> TENANT_B

    style SIDECAR fill:#e1bee7
    style RECEIVER fill:#4fc3f7
    style COMPACTOR fill:#ffd54f
    style STORE fill:#81c784
```

---

## 1ï¸âƒ£ MinIO ë²„í‚· ìƒì„±

### MinIO Client (mc) ì„¤ì¹˜

```bash
# mc ì„¤ì¹˜ (Linux)
wget https://dl.min.io/client/mc/release/linux-amd64/mc
chmod +x mc
sudo mv mc /usr/local/bin/

# mc ë²„ì „ í™•ì¸
mc --version
```

### MinIO ì ‘ì† ì„¤ì •

```bash
# MinIO Alias ì¶”ê°€
mc alias set minio http://s3.minio.miribit.lab:9000 minio minio123

# ì—°ê²° í™•ì¸
mc admin info minio

# ì¶œë ¥:
# â—  s3.minio.miribit.lab:9000
#    Uptime: 10 days
#    Version: 2024-01-01T00:00:00Z
#    Storage: 500 GiB Free, 1 TiB Total
```

### ë²„í‚· ìƒì„±

```bash
# Cluster-01 Central ë²„í‚·
mc mb minio/thanos-cluster-01

# Cluster-02 Edge ë²„í‚· (ì˜µì…˜, ì¤‘ì•™ ì§‘ì¤‘ ì‹œ ë¶ˆí•„ìš”)
mc mb minio/thanos-cluster-02

# Cluster-03 Edge ë²„í‚·
mc mb minio/thanos-cluster-03

# Cluster-04 Edge ë²„í‚·
mc mb minio/thanos-cluster-04

# ë²„í‚· ëª©ë¡ í™•ì¸
mc ls minio

# ì¶œë ¥:
# [2025-10-20 10:00:00 KST]     0B thanos-cluster-01/
# [2025-10-20 10:00:00 KST]     0B thanos-cluster-02/
# [2025-10-20 10:00:00 KST]     0B thanos-cluster-03/
# [2025-10-20 10:00:00 KST]     0B thanos-cluster-04/
```

### ë²„í‚· ë²„ì „ ê´€ë¦¬ í™œì„±í™”

```bash
# ë²„í‚· ë²„ì „ ê´€ë¦¬ (ê°ì²´ ë³µêµ¬ìš©)
mc version enable minio/thanos-cluster-01
mc version enable minio/thanos-cluster-02
mc version enable minio/thanos-cluster-03
mc version enable minio/thanos-cluster-04

# í™•ì¸
mc version info minio/thanos-cluster-01

# ì¶œë ¥:
# minio/thanos-cluster-01 versioning is enabled
```

---

## 2ï¸âƒ£ objstore.yml Secret ìƒì„±

### objstore.yml í…œí”Œë¦¿

```yaml
# S3 ê°ì²´ ì €ì¥ì†Œ ì„¤ì • (MinIO)
type: S3
config:
  bucket: thanos-cluster-01
  endpoint: s3.minio.minio.svc.cluster.local:9000  # ë‚´ë¶€ DNS
  access_key: minio
  secret_key: minio123
  insecure: false  # HTTPS ì‚¬ìš© ì‹œ false
  signature_version2: false
  http_config:
    idle_conn_timeout: 90s
    response_header_timeout: 2m
    insecure_skip_verify: false  # Self-signed ì¸ì¦ì„œ ì‹œ true
    tls_handshake_timeout: 10s
    expect_continue_timeout: 1s
    max_idle_conns: 100
    max_idle_conns_per_host: 100
    max_conns_per_host: 0
```

### Cluster-01 Secret ìƒì„±

```yaml
# deploy/overlays/cluster-01-central/kube-prometheus-stack/thanos-objstore-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: thanos-objstore-secret
  namespace: monitoring
type: Opaque
stringData:
  objstore.yml: |
    type: S3
    config:
      bucket: thanos-cluster-01
      endpoint: s3.minio.miribit.lab:9000
      access_key: minio
      secret_key: minio123
      insecure: false
      signature_version2: false
      http_config:
        idle_conn_timeout: 90s
        response_header_timeout: 2m
        insecure_skip_verify: true  # Self-signed ì¸ì¦ì„œ
```

```bash
# Secret ë°°í¬
kubectl apply -f deploy/overlays/cluster-01-central/kube-prometheus-stack/thanos-objstore-secret.yaml

# í™•ì¸
kubectl get secret -n monitoring thanos-objstore-secret

# Secret ë‚´ìš© í™•ì¸
kubectl get secret -n monitoring thanos-objstore-secret -o jsonpath='{.data.objstore\.yml}' | base64 -d
```

### ì—£ì§€ í´ëŸ¬ìŠ¤í„° Secret (ì˜µì…˜)

```yaml
# deploy/overlays/cluster-02-edge/prometheus-agent/thanos-objstore-secret.yaml
apiVersion: v1
kind: Secret
metadata:
  name: thanos-objstore-secret
  namespace: monitoring
type: Opaque
stringData:
  objstore.yml: |
    type: S3
    config:
      bucket: thanos-cluster-02
      endpoint: s3.minio.miribit.lab:9000
      access_key: minio
      secret_key: minio123
      insecure: false
```

---

## 3ï¸âƒ£ Thanos ì»´í¬ë„ŒíŠ¸ S3 ì—°ê²°

### Thanos Sidecar (Prometheus HA)

```yaml
# kube-prometheus-stack values.yaml
prometheus:
  prometheusSpec:
    # Thanos Sidecar
    thanos:
      image: quay.io/thanos/thanos:v0.31.0
      version: v0.31.0

      # S3 ì—°ê²°
      objectStorageConfig:
        key: objstore.yml
        name: thanos-objstore-secret

      # ì¶”ê°€ Args
      extraArgs:
        - --objstore.config-file=/etc/thanos/objstore.yml
```

### Thanos Receiver

```yaml
# thanos-receiver.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-receive
spec:
  template:
    spec:
      containers:
      - name: thanos-receive
        image: quay.io/thanos/thanos:v0.31.0
        args:
          - receive
          - --objstore.config-file=/etc/thanos/objstore.yml
          - --tsdb.path=/data
          - --tsdb.retention=7d
          - --receive.replication-factor=3

        volumeMounts:
          - name: objstore-config
            mountPath: /etc/thanos
            readOnly: true

      volumes:
        - name: objstore-config
          secret:
            secretName: thanos-objstore-secret
```

### Thanos Store Gateway

```yaml
# thanos-store.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: thanos-store
spec:
  replicas: 2
  template:
    spec:
      containers:
      - name: thanos-store
        image: quay.io/thanos/thanos:v0.31.0
        args:
          - store
          - --objstore.config-file=/etc/thanos/objstore.yml
          - --data-dir=/data
          - --index-cache-size=2GB
          - --chunk-pool-size=2GB

        volumeMounts:
          - name: objstore-config
            mountPath: /etc/thanos

      volumes:
        - name: objstore-config
          secret:
            secretName: thanos-objstore-secret
```

### Thanos Compactor

```yaml
# thanos-compactor.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: thanos-compactor
spec:
  replicas: 1
  template:
    spec:
      containers:
      - name: thanos-compactor
        image: quay.io/thanos/thanos:v0.31.0
        args:
          - compact
          - --objstore.config-file=/etc/thanos/objstore.yml
          - --data-dir=/data
          - --retention.resolution-raw=7d
          - --retention.resolution-5m=30d
          - --retention.resolution-1h=180d
          - --downsampling.disable=false
          - --delete-delay=48h
          - --compact.concurrency=1
          - --wait

        volumeMounts:
          - name: objstore-config
            mountPath: /etc/thanos

      volumes:
        - name: objstore-config
          secret:
            secretName: thanos-objstore-secret
```

---

## 4ï¸âƒ£ S3 Lifecycle Policy ì„¤ì •

### Lifecycle Policy (ìë™ ì‚­ì œ)

```xml
<!-- lifecycle-policy.xml -->
<LifecycleConfiguration>
  <!-- Raw ë©”íŠ¸ë¦­: 7ì¼ í›„ ì‚­ì œ -->
  <Rule>
    <ID>delete-raw-after-7d</ID>
    <Status>Enabled</Status>
    <Filter>
      <Prefix>thanos/</Prefix>
    </Filter>
    <Expiration>
      <Days>7</Days>
    </Expiration>
  </Rule>

  <!-- 5ë¶„ ë‹¤ìš´ìƒ˜í”Œë§: 30ì¼ í›„ ì‚­ì œ -->
  <Rule>
    <ID>delete-5m-after-30d</ID>
    <Status>Enabled</Status>
    <Filter>
      <Prefix>thanos-downsampled-5m/</Prefix>
    </Filter>
    <Expiration>
      <Days>30</Days>
    </Expiration>
  </Rule>

  <!-- 1ì‹œê°„ ë‹¤ìš´ìƒ˜í”Œë§: 180ì¼ í›„ ì‚­ì œ -->
  <Rule>
    <ID>delete-1h-after-180d</ID>
    <Status>Enabled</Status>
    <Filter>
      <Prefix>thanos-downsampled-1h/</Prefix>
    </Filter>
    <Expiration>
      <Days>180</Days>
    </Expiration>
  </Rule>

  <!-- Incomplete Multipart Uploads: 3ì¼ í›„ ì •ë¦¬ -->
  <Rule>
    <ID>abort-incomplete-multipart-upload</ID>
    <Status>Enabled</Status>
    <AbortIncompleteMultipartUpload>
      <DaysAfterInitiation>3</DaysAfterInitiation>
    </AbortIncompleteMultipartUpload>
  </Rule>
</LifecycleConfiguration>
```

### Lifecycle Policy ì ìš©

```bash
# MinIO CLIë¡œ Lifecycle ì„¤ì •
mc ilm import minio/thanos-cluster-01 < lifecycle-policy.xml

# í™•ì¸
mc ilm ls minio/thanos-cluster-01

# ì¶œë ¥:
# ID         | Status  | Prefix                    | Expiration
# -----------+---------+---------------------------+-----------
# delete-raw | Enabled | thanos/                   | 7 days
# delete-5m  | Enabled | thanos-downsampled-5m/    | 30 days
# delete-1h  | Enabled | thanos-downsampled-1h/    | 180 days
```

---

## 5ï¸âƒ£ IAM Policy ë° ì ‘ê·¼ ì œì–´

### MinIO User ìƒì„±

```bash
# Thanos ì „ìš© User ìƒì„±
mc admin user add minio thanos-user ThAn0sS3cr3t!

# User ëª©ë¡ í™•ì¸
mc admin user list minio

# ì¶œë ¥:
# enabled    thanos-user
```

### IAM Policy ìƒì„±

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:ListBucket",
        "s3:GetBucketLocation",
        "s3:ListBucketMultipartUploads"
      ],
      "Resource": [
        "arn:aws:s3:::thanos-cluster-01",
        "arn:aws:s3:::thanos-cluster-02",
        "arn:aws:s3:::thanos-cluster-03",
        "arn:aws:s3:::thanos-cluster-04"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject",
        "s3:PutObject",
        "s3:DeleteObject",
        "s3:ListMultipartUploadParts",
        "s3:AbortMultipartUpload"
      ],
      "Resource": [
        "arn:aws:s3:::thanos-cluster-01/*",
        "arn:aws:s3:::thanos-cluster-02/*",
        "arn:aws:s3:::thanos-cluster-03/*",
        "arn:aws:s3:::thanos-cluster-04/*"
      ]
    }
  ]
}
```

### Policy ì ìš©

```bash
# Policy íŒŒì¼ ìƒì„±
cat > thanos-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [...]
}
EOF

# Policy ì¶”ê°€
mc admin policy add minio thanos-policy thanos-policy.json

# Userì— Policy ì ìš©
mc admin policy set minio thanos-policy user=thanos-user

# í™•ì¸
mc admin user info minio thanos-user

# ì¶œë ¥:
# AccessKey: thanos-user
# Status: enabled
# PolicyName: thanos-policy
```

### objstore.yml ì—…ë°ì´íŠ¸ (ìƒˆ ìê²©ì¦ëª…)

```yaml
# ì—…ë°ì´íŠ¸ëœ objstore.yml
type: S3
config:
  bucket: thanos-cluster-01
  endpoint: s3.minio.miribit.lab:9000
  access_key: thanos-user       # ë³€ê²½
  secret_key: ThAn0sS3cr3t!     # ë³€ê²½
  insecure: false
```

```bash
# Secret ì¬ìƒì„±
kubectl delete secret -n monitoring thanos-objstore-secret
kubectl apply -f deploy/overlays/cluster-01-central/kube-prometheus-stack/thanos-objstore-secret.yaml

# Thanos ì»´í¬ë„ŒíŠ¸ ì¬ì‹œì‘
kubectl rollout restart statefulset/thanos-receive -n monitoring
kubectl rollout restart deployment/thanos-store -n monitoring
kubectl rollout restart statefulset/thanos-compactor -n monitoring
kubectl rollout restart statefulset/prometheus-kube-prometheus-stack-prometheus -n monitoring
```

---

## 6ï¸âƒ£ S3 ì—°ê²° ê²€ì¦

### MinIOì—ì„œ í™•ì¸

```bash
# ë²„í‚· ë‚´ìš© í™•ì¸
mc ls minio/thanos-cluster-01

# ì¶œë ¥:
# [2025-10-20 12:00:00 KST]  256MiB thanos/01HJXXX.../
# [2025-10-20 13:00:00 KST]  128MiB thanos/01HJYYY.../

# ì¬ê·€ì ìœ¼ë¡œ ëª¨ë“  ê°ì²´ í™•ì¸
mc ls --recursive minio/thanos-cluster-01

# ì¶œë ¥:
# [2025-10-20] 1.2MiB thanos/01HJXXX.../meta.json
# [2025-10-20] 64KiB  thanos/01HJXXX.../index
# [2025-10-20] 128MiB thanos/01HJXXX.../chunks/000001
```

### Thanos Sidecar ë¡œê·¸ í™•ì¸

```bash
# Prometheus Podì—ì„œ Sidecar ì»¨í…Œì´ë„ˆ ë¡œê·¸
kubectl logs -n monitoring prometheus-kube-prometheus-stack-prometheus-0 \
  -c thanos-sidecar --tail=50

# ë¡œê·¸ ì˜ˆì‹œ:
# level=info ts=2025-10-20T... msg="uploaded block" id=01HJXXX... duration=12.5s
# level=info ts=2025-10-20T... msg="successfully uploaded block" bucket=thanos-cluster-01
```

### Thanos Store ë¡œê·¸ í™•ì¸

```bash
# Store Gateway ë¡œê·¸
kubectl logs -n monitoring deployment/thanos-store --tail=50

# ë¡œê·¸ ì˜ˆì‹œ:
# level=info ts=2025-10-20T... msg="synced blocks" blocks=125 duration=3.2s
# level=info ts=2025-10-20T... msg="bucket store ready" blocks=125
```

### Thanos Compactor ë¡œê·¸ í™•ì¸

```bash
# Compactor ë¡œê·¸
kubectl logs -n monitoring statefulset/thanos-compactor --tail=50

# ë¡œê·¸ ì˜ˆì‹œ:
# level=info ts=2025-10-20T... msg="compaction iteration started"
# level=info ts=2025-10-20T... msg="compacted blocks" count=8 duration=45s
# level=info ts=2025-10-20T... msg="downsampled block" id=01HJXXX... resolution=5m
```

### PromQLë¡œ S3 ì—…ë¡œë“œ í™•ì¸

```promql
# Sidecar ì—…ë¡œë“œ ì„±ê³µ
thanos_shipper_uploads_total

# Compactor ì²˜ë¦¬ ë¸”ë¡ ìˆ˜
thanos_compact_group_compactions_total

# Store Gateway ë™ê¸°í™”ëœ ë¸”ë¡
thanos_bucket_store_blocks_loaded
```

---

## 7ï¸âƒ£ S3 ì•”í˜¸í™” ì„¤ì • (ì˜µì…˜)

### Server-Side Encryption (SSE-S3)

```bash
# ë²„í‚· ê¸°ë³¸ ì•”í˜¸í™” í™œì„±í™”
mc encrypt set sse-s3 minio/thanos-cluster-01

# í™•ì¸
mc encrypt info minio/thanos-cluster-01

# ì¶œë ¥:
# Auto encryption 'sse-s3' is enabled
```

### objstore.ymlì— ì•”í˜¸í™” ì¶”ê°€

```yaml
type: S3
config:
  bucket: thanos-cluster-01
  endpoint: s3.minio.miribit.lab:9000
  access_key: thanos-user
  secret_key: ThAn0sS3cr3t!
  insecure: false

  # Server-Side Encryption
  sse_config:
    type: SSE-S3
```

---

## ğŸ“Š S3 ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©ëŸ‰ ì¶”ì •

### ë©”íŠ¸ë¦­ ìˆ˜ì§‘ëŸ‰ ê¸°ì¤€

| í•­ëª© | ê°’ |
|------|-----|
| **í´ëŸ¬ìŠ¤í„° ìˆ˜** | 4ê°œ |
| **íƒ€ê²Ÿ ìˆ˜** | 200ê°œ (í´ëŸ¬ìŠ¤í„°ë‹¹ 50ê°œ) |
| **ë©”íŠ¸ë¦­ ìˆ˜** | 10,000ê°œ (íƒ€ê²Ÿë‹¹ 50ê°œ) |
| **Scrape ê°„ê²©** | 30ì´ˆ |
| **ìƒ˜í”Œ/ì´ˆ** | 10,000 * 200 / 30 = **66,666 samples/s** |
| **ì¼ì¼ ìƒ˜í”Œ** | 66,666 * 86,400 = **5.76ì–µ samples/day** |

### ì €ì¥ì†Œ ìš©ëŸ‰ (ì••ì¶• í›„)

| ë³´ì¡´ ê¸°ê°„ | í•´ìƒë„ | ì˜ˆìƒ ìš©ëŸ‰ |
|----------|--------|----------|
| **7ì¼** | Raw (30s) | 7d * 5.76ì–µ * 2B = **8GB** |
| **30ì¼** | 5ë¶„ | 30d * 5.76ì–µ/10 * 2B = **3.5GB** |
| **180ì¼** | 1ì‹œê°„ | 180d * 5.76ì–µ/120 * 2B = **1.7GB** |
| **ì´í•©** | | **13.2GB** |

### ì‹¤ì œ ì‚¬ìš©ëŸ‰ (ì••ì¶•ë¥  50%)

- **ì´ ìš©ëŸ‰**: 13.2GB * 2 = **ì•½ 26GB**
- **ì—¬ìœ ë¶„ í¬í•¨**: **50GB ê¶Œì¥**

---

## ğŸ¯ ë°°í¬ ì²´í¬ë¦¬ìŠ¤íŠ¸

### MinIO ì¤€ë¹„
- [x] MinIO ì ‘ì† í™•ì¸ (mc alias set)
- [x] ë²„í‚· ìƒì„± (4ê°œ í´ëŸ¬ìŠ¤í„°)
- [x] ë²„ì „ ê´€ë¦¬ í™œì„±í™”
- [x] Lifecycle Policy ì„¤ì •

### IAM ë° ì ‘ê·¼ ì œì–´
- [x] Thanos ì „ìš© User ìƒì„±
- [x] IAM Policy ì‘ì„±
- [x] Userì— Policy ì ìš©
- [x] ìê²©ì¦ëª… í™•ì¸

### Secret ìƒì„±
- [x] objstore.yml ì‘ì„±
- [x] Secret ë°°í¬ (ê° í´ëŸ¬ìŠ¤í„°)
- [x] Secret ë‚´ìš© í™•ì¸

### Thanos ì»´í¬ë„ŒíŠ¸ ì—°ê²°
- [x] Sidecar S3 ì—°ê²°
- [x] Receiver S3 ì—°ê²°
- [x] Store Gateway S3 ì—°ê²°
- [x] Compactor S3 ì—°ê²°

### ê²€ì¦
- [x] MinIO ë²„í‚· ë‚´ìš© í™•ì¸
- [x] Sidecar ì—…ë¡œë“œ ë¡œê·¸ í™•ì¸
- [x] Store ë™ê¸°í™” í™•ì¸
- [x] Compactor ë‹¤ìš´ìƒ˜í”Œë§ í™•ì¸
- [x] PromQL ë©”íŠ¸ë¦­ í™•ì¸

### ì•”í˜¸í™” (ì˜µì…˜)
- [x] SSE-S3 í™œì„±í™”
- [x] objstore.yml ì•”í˜¸í™” ì„¤ì •

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ì¤‘ì•™ í´ëŸ¬ìŠ¤í„° ë°°í¬** â†’ [ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md](./ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md)
- **ë°°í¬ ê²€ì¦** â†’ [ë°°í¬-ê²€ì¦.md](./ë°°í¬-ê²€ì¦.md)
- **ìŠ¤í† ë¦¬ì§€ ìµœì í™”** â†’ [../09-ì„±ëŠ¥-ìµœì í™”/ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md](../09-ì„±ëŠ¥-ìµœì í™”/ìŠ¤í† ë¦¬ì§€-ìµœì í™”.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
