# 배포 검증

## 📋 개요

4개 클러스터에 배포된 Prometheus Agent + Thanos Receiver 환경의 정상 동작을 체계적으로 검증합니다.

---

## 🎯 검증 목표

- **Pod 상태 확인** (Running, Ready)
- **PVC 바인딩 확인** (Bound)
- **Service/Endpoint 확인**
- **Remote Write 연결 확인**
- **S3 업로드 확인**
- **메트릭 쿼리 테스트**
- **고가용성 확인**
- **성능 메트릭 확인**

---

## 1️⃣ Pod 상태 확인

### Cluster-01 (Central)

```bash
# Cluster-01 접속
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# 모든 Pod 확인
kubectl get pods -n monitoring

# 출력 예시:
# NAME                                                   READY   STATUS    RESTARTS   AGE
# prometheus-kube-prometheus-stack-prometheus-0          3/3     Running   0          2h
# prometheus-kube-prometheus-stack-prometheus-1          3/3     Running   0          2h
# thanos-receive-0                                       1/1     Running   0          2h
# thanos-receive-1                                       1/1     Running   0          2h
# thanos-receive-2                                       1/1     Running   0          2h
# thanos-query-xxx                                       1/1     Running   0          2h
# thanos-store-xxx                                       1/1     Running   0          2h
# thanos-compactor-0                                     1/1     Running   0          2h
# grafana-xxx                                            1/1     Running   0          2h

# 상태 요약
kubectl get pods -n monitoring --no-headers | awk '{print $3}' | sort | uniq -c

# 출력:
# 12 Running
```

### Cluster-02 (Edge Multi-Tenant)

```bash
# Cluster-02 접속
export KUBECONFIG=~/.kube/configs/cluster-02.conf

# Tenant A Namespace
kubectl get pods -n monitoring-tenant-a

# 출력:
# prometheus-agent-tenant-a-0   2/2   Running   0   1h
# prometheus-node-exporter-xxx  1/1   Running   0   1h

# Tenant B Namespace
kubectl get pods -n monitoring-tenant-b

# Shared Namespace
kubectl get pods -n monitoring

# 출력:
# kube-state-metrics-xxx   1/1   Running   0   1h
```

### Cluster-03, Cluster-04 (Edge)

```bash
# Cluster-03
export KUBECONFIG=~/.kube/configs/cluster-03.conf
kubectl get pods -n monitoring

# 출력:
# prometheus-agent-prometheus-agent-0   2/2   Running   0   1h
# prometheus-node-exporter-xxx          1/1   Running   0   1h
# kube-state-metrics-xxx                1/1   Running   0   1h

# Cluster-04 (동일)
export KUBECONFIG=~/.kube/configs/cluster-04.conf
kubectl get pods -n monitoring
```

### 자동화 스크립트

```bash
#!/bin/bash
# check-all-pods.sh

for cluster in cluster-01 cluster-02 cluster-03 cluster-04; do
  echo "=== $cluster ==="
  export KUBECONFIG=~/.kube/configs/$cluster.conf

  if [[ "$cluster" == "cluster-02" ]]; then
    kubectl get pods -n monitoring-tenant-a --no-headers | wc -l
    kubectl get pods -n monitoring-tenant-b --no-headers | wc -l
    kubectl get pods -n monitoring --no-headers | wc -l
  else
    kubectl get pods -n monitoring --no-headers | wc -l
  fi

  echo ""
done
```

---

## 2️⃣ PVC 바인딩 확인

### Cluster-01 PVC

```bash
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# PVC 목록
kubectl get pvc -n monitoring

# 출력:
# NAME                                    STATUS   VOLUME              CAPACITY   STORAGECLASS
# prometheus-kube-...-prometheus-0        Bound    pvc-xxx             100Gi      longhorn
# prometheus-kube-...-prometheus-1        Bound    pvc-yyy             100Gi      longhorn
# data-thanos-receive-0                   Bound    pvc-zzz             100Gi      longhorn
# data-thanos-receive-1                   Bound    pvc-aaa             100Gi      longhorn
# data-thanos-receive-2                   Bound    pvc-bbb             100Gi      longhorn
# data-thanos-compactor-0                 Bound    pvc-ccc             50Gi       longhorn

# Bound 상태 확인
kubectl get pvc -n monitoring --no-headers | awk '{print $2}' | sort | uniq -c

# 출력:
# 6 Bound
```

### 엣지 클러스터 PVC

```bash
# Cluster-03
export KUBECONFIG=~/.kube/configs/cluster-03.conf
kubectl get pvc -n monitoring

# 출력:
# prometheus-agent-prometheus-agent-0   Bound   pvc-xxx   50Gi   longhorn

# Cluster-04 (동일)
```

---

## 3️⃣ Service/Endpoint 확인

### Thanos Receiver Service

```bash
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# Service 확인
kubectl get svc -n monitoring thanos-receive

# 출력:
# NAME             TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)
# thanos-receive   ClusterIP   None         <none>        10901/TCP,10902/TCP,19291/TCP

# Endpoint 확인
kubectl get endpoints -n monitoring thanos-receive

# 출력:
# NAME             ENDPOINTS
# thanos-receive   10.244.0.10:10901,10.244.0.11:10901,10.244.0.12:10901

# LoadBalancer Service
kubectl get svc -n monitoring thanos-receive-lb

# 출력:
# NAME                TYPE        CLUSTER-IP      PORT(S)
# thanos-receive-lb   ClusterIP   10.96.123.45    19291/TCP
```

### Thanos Query Service

```bash
kubectl get svc -n monitoring thanos-query

# 출력:
# NAME           TYPE        CLUSTER-IP      PORT(S)
# thanos-query   ClusterIP   10.96.234.56    9090/TCP

# Port-Forward 테스트
kubectl port-forward -n monitoring svc/thanos-query 9090:9090 &

# curl 테스트
curl -s http://localhost:9090/-/healthy

# 출력:
# Thanos is Healthy.
```

### Grafana Ingress

```bash
kubectl get ingress -n monitoring

# 출력:
# NAME      CLASS   HOSTS                                ADDRESS
# grafana   nginx   grafana.k8s-cluster-01.miribit.lab   192.168.101.210

# curl 테스트
curl -I http://grafana.k8s-cluster-01.miribit.lab

# 출력:
# HTTP/1.1 302 Found
# Location: /login
```

---

## 4️⃣ Remote Write 연결 확인

### Agent에서 확인 (Cluster-03)

```bash
export KUBECONFIG=~/.kube/configs/cluster-03.conf

# Agent Pod 접속
kubectl exec -it -n monitoring prometheus-agent-prometheus-agent-0 -- sh

# Remote Write 상태 확인 (Container 내부)
wget -qO- http://localhost:9090/api/v1/status/runtimeinfo | jq .

# 출력:
# {
#   "status": "success",
#   "data": {
#     "startTime": "2025-10-20T...",
#     "storageRetention": "7d",
#     "remoteWrite": [
#       {
#         "url": "http://thanos-receive-lb.../api/v1/receive",
#         "name": "thanos-receiver",
#         "queueLength": 0,
#         "samplesDropped": 0
#       }
#     ]
#   }
# }
```

### Receiver에서 확인 (Cluster-01)

```bash
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# Receiver 로그 확인
kubectl logs -n monitoring thanos-receive-0 --tail=50 | grep "remote write"

# 로그 예시:
# level=info ts=2025-10-20T... msg="handling remote write request"
#   cluster=cluster-03 samples=1250 tenant=default

# Receiver 메트릭 확인
kubectl port-forward -n monitoring thanos-receive-0 10902:10902 &
curl -s http://localhost:10902/metrics | grep thanos_receive_

# 출력:
# thanos_receive_write_requests_total{cluster="cluster-03"} 1250
# thanos_receive_write_timeseries_total{cluster="cluster-03"} 50000
```

### PromQL로 Remote Write 성공률

```promql
# Remote Write 성공 샘플
sum(rate(prometheus_remote_storage_succeeded_samples_total[5m])) by (cluster)

# 출력:
# {cluster="cluster-01"} 0       (Agent Mode, Remote Write 없음)
# {cluster="cluster-02"} 12500   (Tenant A + B)
# {cluster="cluster-03"} 8000
# {cluster="cluster-04"} 7500

# Remote Write 실패 샘플
sum(rate(prometheus_remote_storage_failed_samples_total[5m])) by (cluster)

# 출력:
# {cluster="cluster-03"} 0  (정상)
# {cluster="cluster-04"} 0

# 성공률
sum(rate(prometheus_remote_storage_succeeded_samples_total[5m]))
/
(sum(rate(prometheus_remote_storage_succeeded_samples_total[5m]))
 + sum(rate(prometheus_remote_storage_failed_samples_total[5m])))

# 출력: 1.0 (100%)
```

---

## 5️⃣ S3 업로드 확인

### MinIO에서 확인

```bash
# MinIO Client
mc ls minio/thanos-cluster-01/

# 출력:
# [2025-10-20 14:00:00 KST] 256MiB thanos/01HJXXX.../
# [2025-10-20 15:00:00 KST] 128MiB thanos/01HJYYY.../

# 재귀 확인
mc ls --recursive minio/thanos-cluster-01/ | head -20

# 출력:
# [2025-10-20] 1.2MiB thanos/01HJXXX.../meta.json
# [2025-10-20] 64KiB  thanos/01HJXXX.../index
# [2025-10-20] 128MiB thanos/01HJXXX.../chunks/000001

# 블록 수 카운트
mc ls --recursive minio/thanos-cluster-01/ | grep "meta.json" | wc -l

# 출력: 42 (블록 수)
```

### Thanos Sidecar 로그

```bash
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# Prometheus Pod의 Sidecar 컨테이너 로그
kubectl logs -n monitoring prometheus-kube-prometheus-stack-prometheus-0 \
  -c thanos-sidecar --tail=100 | grep "uploaded"

# 로그 예시:
# level=info ts=2025-10-20T14:05:23Z msg="uploaded block"
#   id=01HJXXX... duration=12.5s size=256MB
# level=info ts=2025-10-20T15:05:23Z msg="uploaded block"
#   id=01HJYYY... duration=10.2s size=128MB
```

### Thanos Store 동기화 확인

```bash
# Store Gateway 로그
kubectl logs -n monitoring deployment/thanos-store --tail=50 | grep "synced blocks"

# 로그 예시:
# level=info ts=2025-10-20T15:10:00Z msg="synced blocks" blocks=42 duration=3.2s
```

### PromQL로 S3 메트릭

```promql
# Sidecar 업로드 총 수
thanos_shipper_uploads_total

# 출력:
# {instance="prometheus-0"} 125
# {instance="prometheus-1"} 118

# Compactor 처리 블록
thanos_compact_group_compactions_total

# Store 동기화 블록
thanos_bucket_store_blocks_loaded

# 출력: 42
```

---

## 6️⃣ 메트릭 쿼리 테스트

### Thanos Query 접속

```bash
# Port-Forward
kubectl port-forward -n monitoring svc/thanos-query 9090:9090

# 브라우저: http://localhost:9090
```

### 기본 쿼리 테스트

```promql
# 1. 모든 클러스터 타겟 확인
up

# 출력:
# up{cluster="cluster-01", job="prometheus", ...} 1
# up{cluster="cluster-02", tenant="tenant-a", ...} 1
# up{cluster="cluster-03", job="node-exporter", ...} 1

# 2. 클러스터별 타겟 수
count(up == 1) by (cluster)

# 출력:
# {cluster="cluster-01"} 50
# {cluster="cluster-02"} 60  (Tenant A + B)
# {cluster="cluster-03"} 45
# {cluster="cluster-04"} 40

# 3. Tenant별 메트릭 (Cluster-02)
count(up == 1) by (tenant)

# 출력:
# {tenant="tenant-a"} 30
# {tenant="tenant-b"} 30
```

### 시계열 연속성 확인

```promql
# 최근 24시간 메트릭 존재 확인
count_over_time(up{cluster="cluster-03"}[24h])

# 출력: 2880 (24h * 60m / 30s scrape interval = 2880 samples)

# 데이터 갭 확인 (1분 이상 누락)
(time() - max(timestamp(up{cluster="cluster-03"}))) > 60

# 출력: (비어있으면 정상)
```

### 히스토리컬 쿼리 (S3 데이터)

```promql
# 7일 전 메트릭 확인 (Sidecar S3 업로드 데이터)
up{cluster="cluster-03"}[7d:30s] offset 7d

# 30일 전 메트릭 (5분 다운샘플링 데이터)
avg_over_time(up{cluster="cluster-03"}[5m] offset 30d)
```

---

## 7️⃣ 고가용성 확인

### Prometheus HA 중복 제거

```promql
# Prometheus 레플리카 메트릭 (중복 제거 전)
up{job="prometheus", cluster="cluster-01"}

# 출력:
# up{replica="prometheus-0", ...} 1
# up{replica="prometheus-1", ...} 1  (중복)

# Thanos Query 중복 제거 (replica 레이블로)
# Query UI에서 "Deduplication: Enabled" 확인
```

### Receiver Replication Factor 확인

```bash
# Receiver Hashring ConfigMap 확인
kubectl get cm -n monitoring thanos-receive-hashring -o yaml

# 출력:
# hashrings.json:
#   - hashring: "default"
#     endpoints: ["receive-0", "receive-1", "receive-2"]
#     replication-factor: 3

# Receiver 로그에서 복제 확인
kubectl logs -n monitoring thanos-receive-0 | grep "replication"

# 로그 예시:
# level=info msg="replication factor" factor=3
```

### Receiver 장애 시뮬레이션

```bash
# Receiver-0 삭제
kubectl delete pod -n monitoring thanos-receive-0

# Remote Write 연속성 확인 (다른 Receiver로 자동 라우팅)
kubectl logs -n monitoring thanos-receive-1 --tail=20 | grep "remote write"

# 출력:
# level=info msg="handling remote write" samples=1250 (정상)

# Receiver-0 재생성 확인
kubectl get pods -n monitoring thanos-receive-0

# 출력:
# thanos-receive-0   1/1   Running   0   30s  (자동 복구)
```

---

## 8️⃣ 성능 메트릭 확인

### Remote Write 지연 시간

```promql
# Remote Write 지연 (초)
histogram_quantile(0.99,
  rate(prometheus_remote_storage_send_duration_seconds_bucket[5m])
)

# 출력: 0.5 (500ms, p99)

# 평균 지연
rate(prometheus_remote_storage_send_duration_seconds_sum[5m])
/
rate(prometheus_remote_storage_send_duration_seconds_count[5m])

# 출력: 0.2 (200ms, avg)
```

### Thanos Query 응답 시간

```promql
# Query 응답 시간 (초)
histogram_quantile(0.99,
  rate(http_request_duration_seconds_bucket{handler="query"}[5m])
)

# 출력: 1.5 (1.5s, p99)
```

### 리소스 사용량

```promql
# Prometheus Agent 메모리
container_memory_usage_bytes{pod=~"prometheus-agent.*"} / 1024 / 1024

# 출력: 256 (256MB)

# Thanos Receiver 메모리
container_memory_usage_bytes{pod=~"thanos-receive.*"} / 1024 / 1024

# 출력: 1024 (1GB per replica)

# Thanos Query CPU
rate(container_cpu_usage_seconds_total{pod=~"thanos-query.*"}[5m])

# 출력: 0.5 (0.5 cores)
```

---

## 9️⃣ 자동 검증 스크립트

### 전체 검증 스크립트

```bash
#!/bin/bash
# validate-deployment.sh

set -e

CLUSTERS=("cluster-01" "cluster-02" "cluster-03" "cluster-04")

echo "=== Thanos Multi-Cluster Deployment Validation ==="
echo ""

for cluster in "${CLUSTERS[@]}"; do
  echo "--- Validating $cluster ---"
  export KUBECONFIG=~/.kube/configs/$cluster.conf

  # Pod 상태
  echo -n "Pods: "
  kubectl get pods -n monitoring --no-headers 2>/dev/null | wc -l

  # PVC 바인딩
  echo -n "PVCs (Bound): "
  kubectl get pvc -n monitoring --no-headers 2>/dev/null | grep Bound | wc -l

  # Service
  echo -n "Services: "
  kubectl get svc -n monitoring --no-headers 2>/dev/null | wc -l

  echo ""
done

# Central Cluster 추가 검증
export KUBECONFIG=~/.kube/configs/cluster-01.conf

echo "--- Thanos Components (cluster-01) ---"
echo -n "Receiver Pods: "
kubectl get pods -n monitoring -l app=thanos-receive --no-headers | wc -l

echo -n "Query Pods: "
kubectl get pods -n monitoring -l app=thanos-query --no-headers | wc -l

echo -n "Store Pods: "
kubectl get pods -n monitoring -l app=thanos-store --no-headers | wc -l

echo -n "Compactor Pods: "
kubectl get pods -n monitoring -l app=thanos-compactor --no-headers | wc -l

echo ""

# Remote Write 확인
echo "--- Remote Write Status ---"
for cluster in cluster-03 cluster-04; do
  export KUBECONFIG=~/.kube/configs/$cluster.conf
  POD=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o name | head -1)

  if [[ -n "$POD" ]]; then
    echo -n "$cluster: "
    kubectl exec -n monitoring $POD -- wget -qO- http://localhost:9090/api/v1/status/runtimeinfo \
      | jq -r '.data.remoteWrite[0].queueLength' 2>/dev/null || echo "FAILED"
  fi
done

echo ""
echo "=== Validation Complete ==="
```

### 사용법

```bash
# 스크립트 실행 권한
chmod +x validate-deployment.sh

# 실행
./validate-deployment.sh

# 출력 예시:
# === Thanos Multi-Cluster Deployment Validation ===
#
# --- Validating cluster-01 ---
# Pods: 12
# PVCs (Bound): 6
# Services: 8
#
# --- Validating cluster-02 ---
# Pods: 5
# PVCs (Bound): 2
# Services: 3
#
# --- Thanos Components (cluster-01) ---
# Receiver Pods: 3
# Query Pods: 2
# Store Pods: 2
# Compactor Pods: 1
#
# --- Remote Write Status ---
# cluster-03: 0  (Queue Length 0 = 정상)
# cluster-04: 0
#
# === Validation Complete ===
```

---

## 🎯 검증 체크리스트

### Pod 상태
- [x] Cluster-01: 12개 Pod Running
- [x] Cluster-02: 5개 Pod Running (Multi-Tenant)
- [x] Cluster-03: 3개 Pod Running
- [x] Cluster-04: 3개 Pod Running

### PVC 바인딩
- [x] Cluster-01: 6개 PVC Bound
- [x] Cluster-02: 2개 PVC Bound
- [x] Cluster-03: 1개 PVC Bound
- [x] Cluster-04: 1개 PVC Bound

### Service/Endpoint
- [x] Thanos Receiver Service (3 endpoints)
- [x] Thanos Query Service
- [x] Grafana Ingress 접속

### Remote Write
- [x] Cluster-03 → Receiver 연결
- [x] Cluster-04 → Receiver 연결
- [x] Cluster-02 Tenant A/B → Receiver 연결
- [x] Remote Write Queue Length = 0
- [x] Remote Write Success Rate = 100%

### S3 업로드
- [x] Sidecar 블록 업로드 (42개)
- [x] Store 블록 동기화 (42개)
- [x] MinIO 버킷 확인

### 메트릭 쿼리
- [x] up 쿼리 성공 (모든 클러스터)
- [x] Tenant 격리 확인 (cluster-02)
- [x] 시계열 연속성 확인 (24h)
- [x] 히스토리컬 쿼리 (7d, 30d)

### 고가용성
- [x] Prometheus HA 중복 제거
- [x] Receiver Replication Factor=3
- [x] Receiver 장애 복구 확인

### 성능
- [x] Remote Write 지연 < 500ms (p99)
- [x] Query 응답 시간 < 2s (p99)
- [x] Agent 메모리 < 512Mi
- [x] Receiver 메모리 < 2Gi

---

## 🔗 관련 문서

- **중앙 클러스터 배포** → [중앙-클러스터-배포.md](./중앙-클러스터-배포.md)
- **엣지 클러스터 배포** → [엣지-클러스터-배포.md](./엣지-클러스터-배포.md)
- **롤백 절차** → [롤백-절차.md](./롤백-절차.md)
- **운영 가이드** → [../03-운영-가이드/README.md](../03-운영-가이드/README.md)

---

**최종 업데이트**: 2025-10-20
