# ë¡¤ë°± ì ˆì°¨

## ğŸ“‹ ê°œìš”

ë°°í¬ ì¤‘ ë¬¸ì œ ë°œìƒ ì‹œ ì•ˆì „í•˜ê²Œ ì´ì „ ë²„ì „ìœ¼ë¡œ ë¡¤ë°±í•˜ëŠ” ì ˆì°¨ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

---

## ğŸ¯ ë¡¤ë°± ì‹œë‚˜ë¦¬ì˜¤

- **ë°°í¬ ì‹¤íŒ¨** (Pod CrashLoopBackOff)
- **ì„¤ì • ì˜¤ë¥˜** (ConfigMap, Secret ì˜ëª»ë¨)
- **ì„±ëŠ¥ ì €í•˜** (ë¦¬ì†ŒìŠ¤ ë¶€ì¡±, OOM)
- **ë°ì´í„° ì†ì‹¤** (S3 ì—…ë¡œë“œ ì‹¤íŒ¨)
- **ë„¤íŠ¸ì›Œí¬ ë¬¸ì œ** (Remote Write ì‹¤íŒ¨)

---

## ğŸ—ï¸ ë¡¤ë°± ì „ëµ

```mermaid
graph TB
    START[ë°°í¬ ë¬¸ì œ ë°œê²¬]
    CHECK{ë¬¸ì œ ìœ í˜•}

    POD_FAIL[Pod ì‹¤íŒ¨]
    CONFIG_ERR[ì„¤ì • ì˜¤ë¥˜]
    PERF_DEG[ì„±ëŠ¥ ì €í•˜]
    DATA_LOSS[ë°ì´í„° ì†ì‹¤]

    ROLLBACK_HELM[Helm Rollback]
    ROLLBACK_GIT[Git Revert]
    ROLLBACK_ARGO[ArgoCD Rollback]
    RESTORE_PVC[PVC ë³µì›]

    VERIFY[ê²€ì¦]
    COMPLETE[ë¡¤ë°± ì™„ë£Œ]

    START --> CHECK

    CHECK -->|Pod CrashLoop| POD_FAIL
    CHECK -->|ConfigMap/Secret| CONFIG_ERR
    CHECK -->|ë¦¬ì†ŒìŠ¤ ë¶€ì¡±| PERF_DEG
    CHECK -->|S3 ì—…ë¡œë“œ ì‹¤íŒ¨| DATA_LOSS

    POD_FAIL --> ROLLBACK_HELM
    CONFIG_ERR --> ROLLBACK_GIT
    PERF_DEG --> ROLLBACK_HELM
    DATA_LOSS --> RESTORE_PVC

    ROLLBACK_HELM --> VERIFY
    ROLLBACK_GIT --> ROLLBACK_ARGO
    ROLLBACK_ARGO --> VERIFY
    RESTORE_PVC --> VERIFY

    VERIFY --> COMPLETE

    style START fill:#ff9800
    style CHECK fill:#4fc3f7
    style COMPLETE fill:#81c784
```

---

## 1ï¸âƒ£ Helm Rollback (ìˆ˜ë™ ë°°í¬)

### Helm Release íˆìŠ¤í† ë¦¬ í™•ì¸

```bash
# Cluster-01 ì ‘ì†
export KUBECONFIG=~/.kube/configs/cluster-01.conf

# Helm Release ëª©ë¡
helm list -n monitoring

# ì¶œë ¥:
# NAME                          NAMESPACE   REVISION   STATUS     CHART
# kube-prometheus-stack         monitoring  3          deployed   kube-prometheus-stack-58.0.0

# Release íˆìŠ¤í† ë¦¬
helm history kube-prometheus-stack -n monitoring

# ì¶œë ¥:
# REVISION   UPDATED                   STATUS       CHART                          DESCRIPTION
# 1          2025-10-15 10:00:00 KST   superseded   kube-prometheus-stack-57.0.0   Install complete
# 2          2025-10-18 14:30:00 KST   superseded   kube-prometheus-stack-58.0.0   Upgrade complete
# 3          2025-10-20 09:00:00 KST   deployed     kube-prometheus-stack-58.0.0   Upgrade complete
```

### ì´ì „ Revisionìœ¼ë¡œ ë¡¤ë°±

```bash
# Revision 2ë¡œ ë¡¤ë°±
helm rollback kube-prometheus-stack 2 -n monitoring

# ì¶œë ¥:
# Rollback was a success! Happy Helming!

# ë¡¤ë°± í™•ì¸
helm history kube-prometheus-stack -n monitoring

# ì¶œë ¥:
# REVISION   STATUS       DESCRIPTION
# 1          superseded   Install complete
# 2          superseded   Upgrade complete
# 3          superseded   Upgrade complete (ì‹¤íŒ¨)
# 4          deployed     Rollback to 2

# Pod ì¬ì‹œì‘ í™•ì¸
kubectl get pods -n monitoring -w

# ì¶œë ¥:
# prometheus-kube-prometheus-stack-prometheus-0   0/3   Terminating
# prometheus-kube-prometheus-stack-prometheus-0   3/3   Running  (ìƒˆ Pod)
```

### Dry-Runìœ¼ë¡œ ë¡¤ë°± ë¯¸ë¦¬ë³´ê¸°

```bash
# ë¡¤ë°± ì‹œë®¬ë ˆì´ì…˜ (ì‹¤ì œ ë³€ê²½ ì—†ìŒ)
helm rollback kube-prometheus-stack 2 -n monitoring --dry-run --debug

# ì¶œë ¥:
# REVISION: 4
# RELEASED: ...
# CHART: kube-prometheus-stack-57.0.0
# USER-SUPPLIED VALUES:
# ...
```

---

## 2ï¸âƒ£ Kustomize Rollback (GitOps)

### Git Revert

```bash
# Git ë¡œê·¸ í™•ì¸
cd /path/to/thanos-multi-cluster
git log --oneline

# ì¶œë ¥:
# abc123d (HEAD -> main) feat: Update Receiver replicas to 5
# xyz789e feat: Add Thanos Ruler
# 123abc4 feat: Initial deployment

# ì˜ëª»ëœ ì»¤ë°‹ Revert
git revert abc123d

# Commit ë©”ì‹œì§€ ì‘ì„±
# "Revert: Update Receiver replicas to 5 (caused OOM)"

# Push
git push origin main
```

### ArgoCD Sync (ìë™ ë¡¤ë°±)

```bash
# ArgoCDê°€ Git Revertë¥¼ ê°ì§€í•˜ê³  ìë™ Sync
argocd app get cluster-01-central

# ì¶œë ¥:
# Name:               cluster-01-central
# Sync Status:        Synced
# Health Status:      Healthy
# Revision:           123abc4 (Reverted commit)

# ìˆ˜ë™ Sync (ê°•ì œ)
argocd app sync cluster-01-central --force

# Sync ìƒíƒœ í™•ì¸
argocd app wait cluster-01-central --health
```

### íŠ¹ì • Revisionìœ¼ë¡œ Rollback

```bash
# ArgoCDì—ì„œ ì´ì „ Revisionìœ¼ë¡œ ë¡¤ë°±
argocd app rollback cluster-01-central 123abc4

# ì¶œë ¥:
# Application 'cluster-01-central' rollback initiated to revision '123abc4'

# ë¡¤ë°± ìƒíƒœ í™•ì¸
argocd app get cluster-01-central

# ì¶œë ¥:
# Operation:          Rollback
# Sync Status:        Synced
# Revision:           123abc4
```

---

## 3ï¸âƒ£ ConfigMap/Secret ë¡¤ë°±

### ConfigMap íˆìŠ¤í† ë¦¬ í™•ì¸

```bash
# ConfigMap ë°±ì—… (ë°°í¬ ì „)
kubectl get cm -n monitoring thanos-receive-hashring -o yaml > hashring-backup.yaml

# ì˜ëª»ëœ ConfigMap í™•ì¸
kubectl get cm -n monitoring thanos-receive-hashring -o yaml

# ë°±ì—…ì—ì„œ ë³µì›
kubectl apply -f hashring-backup.yaml

# Pod ì¬ì‹œì‘ (ConfigMap ë³€ê²½ ë°˜ì˜)
kubectl rollout restart statefulset/thanos-receive -n monitoring
```

### Secret ë³µì›

```bash
# Secret ë°±ì—…
kubectl get secret -n monitoring thanos-objstore-secret -o yaml > objstore-secret-backup.yaml

# ë³µì›
kubectl apply -f objstore-secret-backup.yaml

# ê´€ë ¨ Pod ì¬ì‹œì‘
kubectl rollout restart statefulset/prometheus-kube-prometheus-stack-prometheus -n monitoring
kubectl rollout restart statefulset/thanos-receive -n monitoring
kubectl rollout restart deployment/thanos-store -n monitoring
```

---

## 4ï¸âƒ£ StatefulSet/Deployment ë¡¤ë°±

### Deployment Rollback

```bash
# Deployment íˆìŠ¤í† ë¦¬
kubectl rollout history deployment/thanos-query -n monitoring

# ì¶œë ¥:
# REVISION   CHANGE-CAUSE
# 1          Initial deployment
# 2          Update image to v0.31.0
# 3          Update replicas to 3

# Revision 2ë¡œ ë¡¤ë°±
kubectl rollout undo deployment/thanos-query -n monitoring --to-revision=2

# ë¡¤ë°± ìƒíƒœ í™•ì¸
kubectl rollout status deployment/thanos-query -n monitoring

# ì¶œë ¥:
# deployment "thanos-query" successfully rolled out
```

### StatefulSet Rollback

```bash
# StatefulSet íˆìŠ¤í† ë¦¬
kubectl rollout history statefulset/thanos-receive -n monitoring

# ì¶œë ¥:
# REVISION   CHANGE-CAUSE
# 1          Initial deployment
# 2          Update replicas to 5 (ì‹¤íŒ¨)

# ì´ì „ Revisionìœ¼ë¡œ ë¡¤ë°±
kubectl rollout undo statefulset/thanos-receive -n monitoring

# Pod ìˆœì°¨ì  ì¬ì‹œì‘ í™•ì¸
kubectl get pods -n monitoring -l app=thanos-receive -w

# ì¶œë ¥:
# thanos-receive-4   1/1   Terminating
# thanos-receive-3   1/1   Terminating
# thanos-receive-2   1/1   Running
# thanos-receive-1   1/1   Running
# thanos-receive-0   1/1   Running
```

---

## 5ï¸âƒ£ PVC/ë°ì´í„° ë³µì›

### Longhorn Snapshot ìƒì„± (ì‚¬ì „ ì¤€ë¹„)

```bash
# Longhorn UI ì ‘ì†
# http://longhorn.k8s-cluster-01.miribit.lab

# ë˜ëŠ” CLI
kubectl apply -f - <<EOF
apiVersion: longhorn.io/v1beta2
kind: VolumeSnapshot
metadata:
  name: prometheus-data-snapshot-$(date +%Y%m%d-%H%M%S)
  namespace: longhorn-system
spec:
  volumeName: pvc-xxx  # PVC ID
EOF

# Snapshot ëª©ë¡ í™•ì¸
kubectl get volumesnapshot -n longhorn-system
```

### Snapshotì—ì„œ PVC ë³µì›

```bash
# ìƒˆ PVC ìƒì„± (Snapshot ê¸°ë°˜)
kubectl apply -f - <<EOF
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: prometheus-data-restored
  namespace: monitoring
spec:
  storageClassName: longhorn
  dataSource:
    name: prometheus-data-snapshot-20251020-120000
    kind: VolumeSnapshot
    apiGroup: snapshot.storage.k8s.io
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 100Gi
EOF

# Prometheus StatefulSet ì—…ë°ì´íŠ¸ (ìƒˆ PVC ì‚¬ìš©)
kubectl edit statefulset prometheus-kube-prometheus-stack-prometheus -n monitoring

# volumeClaimTemplates ì„¹ì…˜ ìˆ˜ì •:
# volumeClaimTemplates:
#   - metadata:
#       name: prometheus-data-restored  # ë³€ê²½
```

### S3 ë°±ì—…ì—ì„œ ë³µì›

```bash
# MinIO mcë¡œ ë°±ì—… í™•ì¸
mc ls minio/thanos-cluster-01-backup/

# ë³µì› (íŠ¹ì • TSDB ë¸”ë¡)
mc cp --recursive \
  minio/thanos-cluster-01-backup/thanos/01HJXXX... \
  minio/thanos-cluster-01/thanos/

# Thanos Store ì¬ì‹œì‘ (ìƒˆ ë¸”ë¡ ì¸ì‹)
kubectl rollout restart deployment/thanos-store -n monitoring
```

---

## 6ï¸âƒ£ ë„¤íŠ¸ì›Œí¬/Service ë¡¤ë°±

### Service ì„¤ì • ë³µì›

```bash
# Service ë°±ì—…
kubectl get svc -n monitoring thanos-receive-lb -o yaml > thanos-receive-lb-backup.yaml

# ì˜ëª»ëœ ì„¤ì • í™•ì¸
kubectl describe svc -n monitoring thanos-receive-lb

# ë°±ì—…ì—ì„œ ë³µì›
kubectl apply -f thanos-receive-lb-backup.yaml

# Endpoint í™•ì¸
kubectl get endpoints -n monitoring thanos-receive-lb
```

### Ingress ë¡¤ë°±

```bash
# Ingress ë°±ì—…
kubectl get ingress -n monitoring grafana -o yaml > grafana-ingress-backup.yaml

# ë³µì›
kubectl apply -f grafana-ingress-backup.yaml

# Ingress ìƒíƒœ í™•ì¸
kubectl get ingress -n monitoring grafana

# curl í…ŒìŠ¤íŠ¸
curl -I http://grafana.k8s-cluster-01.miribit.lab
```

---

## 7ï¸âƒ£ ë©€í‹° í´ëŸ¬ìŠ¤í„° ë¡¤ë°±

### ì „ì²´ í´ëŸ¬ìŠ¤í„° ë¡¤ë°± ìŠ¤í¬ë¦½íŠ¸

```bash
#!/bin/bash
# rollback-all-clusters.sh

set -e

CLUSTERS=("cluster-01" "cluster-02" "cluster-03" "cluster-04")
TARGET_REVISION="123abc4"  # ë¡¤ë°±í•  Git Revision

echo "=== Multi-Cluster Rollback to $TARGET_REVISION ==="
echo ""

for cluster in "${CLUSTERS[@]}"; do
  echo "--- Rolling back $cluster ---"

  # ArgoCD Rollback
  argocd app rollback "$cluster" "$TARGET_REVISION"

  # ë¡¤ë°± ì™„ë£Œ ëŒ€ê¸°
  argocd app wait "$cluster" --health --timeout 300

  echo "$cluster rollback complete"
  echo ""
done

echo "=== Rollback Complete ==="
```

### ì‚¬ìš©ë²•

```bash
# ì‹¤í–‰ ê¶Œí•œ
chmod +x rollback-all-clusters.sh

# ì‹¤í–‰
./rollback-all-clusters.sh

# ì¶œë ¥:
# === Multi-Cluster Rollback to 123abc4 ===
#
# --- Rolling back cluster-01 ---
# Application 'cluster-01' rollback initiated
# cluster-01 rollback complete
#
# --- Rolling back cluster-02 ---
# Application 'cluster-02' rollback initiated
# cluster-02 rollback complete
#
# === Rollback Complete ===
```

---

## 8ï¸âƒ£ ë¡¤ë°± í›„ ê²€ì¦

### Pod ìƒíƒœ í™•ì¸

```bash
# ëª¨ë“  Pod Running í™•ì¸
kubectl get pods -n monitoring

# ì¶œë ¥:
# NAME                                      READY   STATUS    RESTARTS   AGE
# prometheus-kube-...-prometheus-0          3/3     Running   0          5m
# thanos-receive-0                          1/1     Running   0          5m
# ...
```

### Remote Write ì—°ê²° í™•ì¸

```bash
# Agentì—ì„œ Remote Write ìƒíƒœ
export KUBECONFIG=~/.kube/configs/cluster-03.conf
POD=$(kubectl get pods -n monitoring -l app.kubernetes.io/name=prometheus -o name | head -1)

kubectl exec -n monitoring $POD -- wget -qO- http://localhost:9090/api/v1/status/runtimeinfo \
  | jq '.data.remoteWrite[0].queueLength'

# ì¶œë ¥: 0 (ì •ìƒ)
```

### ë©”íŠ¸ë¦­ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸

```promql
# Thanos Queryì—ì„œ í™•ì¸
up{cluster="cluster-03"}

# ì‹œê³„ì—´ ì—°ì†ì„± í™•ì¸
count_over_time(up{cluster="cluster-03"}[1h])

# ì¶œë ¥: 120 (1h / 30s scrape = 120 samples, ì •ìƒ)
```

---

## 9ï¸âƒ£ ë¡¤ë°± Best Practices

### ì‚¬ì „ ì¤€ë¹„

1. **ë°°í¬ ì „ ë°±ì—…**
   ```bash
   # ConfigMap/Secret ë°±ì—…
   kubectl get cm,secret -n monitoring -o yaml > backup-$(date +%Y%m%d).yaml

   # PVC Snapshot ìƒì„±
   kubectl apply -f pvc-snapshot.yaml
   ```

2. **Git Tag ìƒì„±**
   ```bash
   # ì•ˆì • ë²„ì „ì— Tag
   git tag -a v1.0.0 -m "Stable release"
   git push origin v1.0.0

   # ë¡¤ë°± ì‹œ:
   git checkout v1.0.0
   ```

3. **Helm Revision ì œí•œ**
   ```bash
   # Helm íˆìŠ¤í† ë¦¬ ìµœëŒ€ 10ê°œ ìœ ì§€
   helm upgrade kube-prometheus-stack ... --history-max 10
   ```

### ë¡¤ë°± ì¤‘ ì£¼ì˜ì‚¬í•­

1. **StatefulSet ìˆœì„œ**
   - StatefulSetì€ ì—­ìˆœìœ¼ë¡œ Pod ì‚­ì œ (N â†’ 0)
   - PVCëŠ” ìë™ ì‚­ì œë˜ì§€ ì•ŠìŒ (ìˆ˜ë™ ì •ë¦¬ í•„ìš”)

2. **ë°ì´í„° ì¼ê´€ì„±**
   - Remote Write Queueê°€ ë¹„ì›Œì§ˆ ë•Œê¹Œì§€ ëŒ€ê¸°
   - S3 ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸ (Sidecar ë¡œê·¸)

3. **Downtime ìµœì†Œí™”**
   - Blue-Green Deployment ê³ ë ¤
   - Canary Rollout (ArgoCD Progressive Delivery)

### ë¡¤ë°± í›„ í›„ì† ì¡°ì¹˜

1. **Root Cause Analysis**
   - ë¡œê·¸ ìˆ˜ì§‘ (`kubectl logs`)
   - ì´ë²¤íŠ¸ í™•ì¸ (`kubectl get events`)
   - ë©”íŠ¸ë¦­ ë¶„ì„ (Grafana)

2. **ë¬¸ì„œí™”**
   - ë¡¤ë°± ì´ìœ  ê¸°ë¡
   - ì¬ë°œ ë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½

3. **ì¬ë°°í¬ ê³„íš**
   - í…ŒìŠ¤íŠ¸ í™˜ê²½ì—ì„œ ê²€ì¦
   - ë‹¨ê³„ì  ë°°í¬ (í´ëŸ¬ìŠ¤í„°ë³„ ìˆœì°¨ ì ìš©)

---

## ğŸ¯ ë¡¤ë°± ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì‚¬ì „ í™•ì¸
- [x] ë¬¸ì œ ìœ í˜• íŒŒì•… (Pod ì‹¤íŒ¨, ì„¤ì • ì˜¤ë¥˜, ì„±ëŠ¥ ì €í•˜, ë°ì´í„° ì†ì‹¤)
- [x] ë°±ì—… ì¡´ì¬ í™•ì¸ (ConfigMap, Secret, PVC Snapshot)
- [x] ë¡¤ë°± ëŒ€ìƒ Revision í™•ì¸ (Helm, Git, ArgoCD)

### ë¡¤ë°± ì‹¤í–‰
- [x] Helm Rollback ë˜ëŠ” Git Revert
- [x] ArgoCD Sync (GitOps)
- [x] ConfigMap/Secret ë³µì›
- [x] StatefulSet/Deployment Rollback
- [x] PVC/ë°ì´í„° ë³µì› (í•„ìš” ì‹œ)

### ê²€ì¦
- [x] Pod ìƒíƒœ í™•ì¸ (Running)
- [x] PVC ë°”ì¸ë”© í™•ì¸ (Bound)
- [x] Remote Write ì—°ê²° í™•ì¸
- [x] ë©”íŠ¸ë¦­ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
- [x] S3 ì—…ë¡œë“œ í™•ì¸

### í›„ì† ì¡°ì¹˜
- [x] ë¡œê·¸ ìˆ˜ì§‘ ë° ë¶„ì„
- [x] ë¡¤ë°± ì›ì¸ ë¬¸ì„œí™”
- [x] ì¬ë°œ ë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½
- [x] ì¬ë°°í¬ ê³„íš ìˆ˜ë¦½

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ë°°í¬ ê²€ì¦** â†’ [ë°°í¬-ê²€ì¦.md](./ë°°í¬-ê²€ì¦.md)
- **ì¤‘ì•™ í´ëŸ¬ìŠ¤í„° ë°°í¬** â†’ [ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md](./ì¤‘ì•™-í´ëŸ¬ìŠ¤í„°-ë°°í¬.md)
- **ìš´ì˜ ê°€ì´ë“œ** â†’ [../03-ìš´ì˜-ê°€ì´ë“œ/README.md](../03-ìš´ì˜-ê°€ì´ë“œ/README.md)
- **ì¥ì•  ëŒ€ì‘** â†’ [../03-ìš´ì˜-ê°€ì´ë“œ/ì¥ì• -ëŒ€ì‘.md](../03-ìš´ì˜-ê°€ì´ë“œ/ì¥ì• -ëŒ€ì‘.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
