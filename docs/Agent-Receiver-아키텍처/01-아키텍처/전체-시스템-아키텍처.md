# ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

## ğŸ“‹ ê°œìš”

Prometheus Agent + Thanos Receiver íŒ¨í„´ì„ ì‚¬ìš©í•œ 4ê°œ í´ëŸ¬ìŠ¤í„° ë©€í‹°í´ëŸ¬ìŠ¤í„° ê´€ì°°ì„± í”Œë«í¼ì˜ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ—ï¸ ì „ì²´ ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```mermaid
graph TB
    subgraph "Edge Cluster - ê°€ (cluster-02, 196)"
        subgraph "Tenant A"
            PA1[Prometheus Agent A] --> NE1[Node Exporter]
            PA1 --> KSM1[Kube-State-Metrics]
        end
        subgraph "Tenant B"
            PA2[Prometheus Agent B] --> NE2[Node Exporter]
            PA2 --> KSM2[Kube-State-Metrics]
        end
    end

    subgraph "Edge Cluster - ë‚˜ (cluster-03, 197)"
        PA3[Prometheus Agent] --> NE3[Node Exporter]
        PA3 --> KSM3[Kube-State-Metrics]
    end

    subgraph "Edge Cluster - ë‹¤ (cluster-04, 198)"
        PA4[Prometheus Agent] --> NE4[Node Exporter]
        PA4 --> KSM4[Kube-State-Metrics]
    end

    subgraph "Central Cluster (cluster-01, 194)"
        subgraph "Ingress Layer"
            LB[Cilium LB<br/>192.168.101.194] --> INGRESS[Nginx Ingress]
        end

        subgraph "Metrics Collection"
            INGRESS --> RECEIVER[Thanos Receiver<br/>StatefulSet x3]
            RECEIVER --> PROM_HA[Prometheus HA<br/>Replica x2]
        end

        subgraph "Thanos Components"
            QUERY[Thanos Query] --> PROM_HA
            QUERY --> STORE[Thanos Store]
            COMPACTOR[Thanos Compactor] --> S3
            RULER[Thanos Ruler] --> QUERY
            STORE --> S3[(MinIO S3)]
        end

        subgraph "Visualization & Logging"
            GRAFANA[Grafana] --> QUERY
            GRAFANA --> OPENSEARCH[OpenSearch Cluster]
            FLUENTBIT[Fluent-Bit<br/>DaemonSet] --> OPENSEARCH
        end

        subgraph "GitOps"
            ARGOCD[ArgoCD] --> GIT[Git Repository]
        end
    end

    PA1 -->|Remote Write<br/>HTTPS| INGRESS
    PA2 -->|Remote Write<br/>HTTPS| INGRESS
    PA3 -->|Remote Write<br/>HTTPS| INGRESS
    PA4 -->|Remote Write<br/>HTTPS| INGRESS

    RECEIVER --> S3
    PROM_HA --> S3

    style RECEIVER fill:#4fc3f7
    style QUERY fill:#4fc3f7
    style GRAFANA fill:#ff9800
    style PA1 fill:#e1f5fe
    style PA2 fill:#fff3e0
```

---

## ğŸ¯ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì›ì¹™

### 1. ì¤‘ì•™ì§‘ì¤‘ì‹ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- **Edge**: Prometheus Agentê°€ ë¡œì»¬ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í›„ Remote Write
- **Central**: Thanos Receiverê°€ ëª¨ë“  í´ëŸ¬ìŠ¤í„° ë©”íŠ¸ë¦­ ìˆ˜ì‹  ë° ì €ì¥
- **ì´ì **: ì—£ì§€ í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ëŸ‰ ìµœì†Œí™” (~80% ê°ì†Œ)

### 2. ê³ ê°€ìš©ì„± (HA)
- **Thanos Receiver**: StatefulSet 3 replicas (Hashring)
- **Prometheus HA**: 2 replicas (ì¤‘ë³µ ìˆ˜ì§‘ ë°©ì§€)
- **OpenSearch**: 3 nodes cluster
- **MinIO**: ë¶„ì‚° ëª¨ë“œ (4 nodes, erasure coding)

### 3. í™•ì¥ì„±
- **ìˆ˜í‰ í™•ì¥**: Thanos Receiver Hashringìœ¼ë¡œ ì—£ì§€ í´ëŸ¬ìŠ¤í„° ë¬´ì œí•œ í™•ì¥
- **ìˆ˜ì§ í™•ì¥**: Prometheus HA ìŠ¤í† ë¦¬ì§€ ì¦ì„¤
- **ë‹¤ìš´ìƒ˜í”Œë§**: ì¥ê¸° ë©”íŠ¸ë¦­ ì••ì¶• (raw â†’ 5m â†’ 1h)

### 4. ê²©ë¦¬ ë° ë³´ì•ˆ
- **ë©€í‹°í…Œë„Œì‹œ**: ê°€ í´ëŸ¬ìŠ¤í„° ë…¸ë“œ ë°˜ë°˜ ë¶„í•  (Tenant A/B)
- **ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬**: NetworkPolicyë¡œ í…Œë„ŒíŠ¸ ê°„ íŠ¸ë˜í”½ ì°¨ë‹¨
- **TLS ì•”í˜¸í™”**: Remote Write, Ingress ëª¨ë‘ HTTPS

---

## ğŸ“Š í´ëŸ¬ìŠ¤í„° êµ¬ì„±

| í´ëŸ¬ìŠ¤í„° | IP | ì—­í•  | CPU | Memory | Storage | ì£¼ìš” ì»´í¬ë„ŒíŠ¸ |
|---------|-----|------|-----|--------|---------|-------------|
| **cluster-01<br/>(ì¤‘ì•™)** | 192.168.101.194 | ëª¨ë‹ˆí„°ë§ í—ˆë¸Œ | 16 cores | 32Gi | 500Gi | Thanos Receiver/Query/Store/Compactor/Ruler<br/>Prometheus HA, Grafana, OpenSearch, ArgoCD |
| **cluster-02<br/>(ê°€)** | 192.168.101.196 | ì—£ì§€ + ë©€í‹°í…Œë„Œì‹œ | 8 cores | 16Gi | 100Gi | Prometheus Agent x2 (Tenant A/B)<br/>Node Exporter, Kube-State-Metrics |
| **cluster-03<br/>(ë‚˜)** | 192.168.101.197 | ì—£ì§€ | 4 cores | 8Gi | 50Gi | Prometheus Agent<br/>Node Exporter, Kube-State-Metrics |
| **cluster-04<br/>(ë‹¤)** | 192.168.101.198 | ì—£ì§€ | 4 cores | 8Gi | 50Gi | Prometheus Agent<br/>Node Exporter, Kube-State-Metrics |

---

## ğŸ”„ ë°ì´í„° íë¦„

### ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant Agent as Prometheus Agent<br/>(Edge)
    participant Ingress as Nginx Ingress<br/>(Central)
    participant Receiver as Thanos Receiver<br/>(Central)
    participant TSDB as Local TSDB<br/>(Receiver)
    participant S3 as MinIO S3
    participant Query as Thanos Query

    Agent->>Agent: Scrape metrics (15s)
    Agent->>Agent: Store in WAL
    Agent->>Ingress: Remote Write (30s batch)
    Ingress->>Receiver: Forward to Receiver
    Receiver->>TSDB: Write to TSDB
    Receiver->>S3: Upload 2h blocks
    Query->>TSDB: Query recent data (<2h)
    Query->>S3: Query historical data (>2h)
```

### ë¡œê·¸ ìˆ˜ì§‘ í”Œë¡œìš°

```mermaid
sequenceDiagram
    participant Pod as Application Pod
    participant FB as Fluent-Bit<br/>(DaemonSet)
    participant OS as OpenSearch
    participant Grafana as Grafana

    Pod->>Pod: Write logs to stdout
    FB->>Pod: Tail container logs
    FB->>FB: Parse & Filter
    FB->>OS: Forward logs (HTTP)
    OS->>OS: Index & Store
    Grafana->>OS: Query logs
```

---

## ğŸ§© ì»´í¬ë„ŒíŠ¸ ì—­í• 

### Central Cluster (cluster-01)

#### Thanos Receiver
- **ì—­í• **: Remote Write ì—”ë“œí¬ì¸íŠ¸, ë©”íŠ¸ë¦­ ìˆ˜ì‹  ë° TSDB ì €ì¥
- **Replicas**: 3 (StatefulSet)
- **Replication Factor**: 3 (ê³ ê°€ìš©ì„±)
- **í¬íŠ¸**:
  - 19291 (Remote Write)
  - 10901 (gRPC - Query ì—°ë™)
  - 10902 (HTTP - ìƒíƒœ í™•ì¸)

#### Thanos Query
- **ì—­í• **: í†µí•© ì¿¼ë¦¬ ì¸í„°í˜ì´ìŠ¤ (Prometheus HA + Store í†µí•©)
- **Replicas**: 2
- **í¬íŠ¸**: 9090 (HTTP - Grafana ì—°ë™)
- **ê¸°ëŠ¥**: PromQL ì¿¼ë¦¬, Deduplication

#### Thanos Store
- **ì—­í• **: S3ì—ì„œ íˆìŠ¤í† ë¦¬ì»¬ ë©”íŠ¸ë¦­ ì¡°íšŒ
- **Replicas**: 2
- **Cache**: Index Cache (Memcached)

#### Thanos Compactor
- **ì—­í• **: S3 ë¸”ë¡ ì••ì¶• ë° ë‹¤ìš´ìƒ˜í”Œë§
- **Replicas**: 1 (StatefulSet)
- **ê¸°ëŠ¥**:
  - 2h ë¸”ë¡ â†’ 1d ë¸”ë¡ ì••ì¶•
  - Downsampling (5m, 1h resolution)

#### Thanos Ruler
- **ì—­í• **: Recording Rules ë° Alert Rules í‰ê°€
- **Replicas**: 2
- **Query Backend**: Thanos Query

#### Prometheus HA
- **ì—­í• **: ì¤‘ì•™ í´ëŸ¬ìŠ¤í„° ìì²´ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
- **Replicas**: 2
- **Storage**: 100Gi (per replica)
- **Sidecar**: Thanos Sidecar (S3 ì—…ë¡œë“œ)

#### Grafana
- **ì—­í• **: ì‹œê°í™” ë° ëŒ€ì‹œë³´ë“œ
- **Datasource**:
  - Prometheus (Thanos Query)
  - OpenSearch (ë¡œê·¸)
- **ì¸ì¦**: Admin / OAuth (Optional)

#### OpenSearch
- **ì—­í• **: ë¡œê·¸ ì €ì¥ ë° ê²€ìƒ‰
- **Nodes**: 3 (cluster)
- **Storage**: 200Gi (per node)
- **Retention**: 30d

#### ArgoCD
- **ì—­í• **: GitOps ë°°í¬ ìë™í™”
- **Applications**: 4ê°œ í´ëŸ¬ìŠ¤í„° ê°ê° ê´€ë¦¬
- **Sync Policy**: Auto (Optional)

### Edge Clusters (cluster-02, 03, 04)

#### Prometheus Agent
- **ì—­í• **: ê²½ëŸ‰ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° Remote Write
- **ë©”ëª¨ë¦¬**: ~200MB (vs Full Prometheus ~2GB)
- **ê¸°ëŠ¥**:
  - Scrape targets
  - Remote Write to Central
  - WAL ê´€ë¦¬ (ì¬ì „ì†¡)
- **ë¹„í™œì„±í™”**:
  - Local Query API
  - Alert Rules
  - Recording Rules

#### Node Exporter
- **ì—­í• **: ë…¸ë“œ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (CPU, Memory, Disk, Network)
- **DaemonSet**: ëª¨ë“  ë…¸ë“œì— ë°°í¬

#### Kube-State-Metrics
- **ì—­í• **: Kubernetes ë¦¬ì†ŒìŠ¤ ë©”íŠ¸ë¦­ (Pods, Deployments, Services ë“±)
- **Replicas**: 1

---

## ğŸ” ë³´ì•ˆ ì•„í‚¤í…ì²˜

### TLS/ì•”í˜¸í™”
```mermaid
graph LR
    A[Prometheus Agent] -->|HTTPS<br/>TLS 1.3| B[Nginx Ingress]
    B -->|HTTP<br/>(ë‚´ë¶€)| C[Thanos Receiver]
    C -->|HTTPS<br/>TLS| D[MinIO S3]
    E[User] -->|HTTPS<br/>TLS| B
    B -->|HTTP<br/>(ë‚´ë¶€)| F[Grafana]
```

### ì ‘ê·¼ ì œì–´
- **RBAC**: Kubernetes ë„¤ì´í‹°ë¸Œ ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´
- **NetworkPolicy**: Pod ê°„ íŠ¸ë˜í”½ ì œì–´
- **Grafana Auth**: Admin ê³„ì • + LDAP/OAuth
- **ArgoCD RBAC**: Application ë³„ ê¶Œí•œ ë¶„ë¦¬

---

## ğŸ“ˆ ë©”íŠ¸ë¦­ ë³´ì¡´ ì •ì±…

| Resolution | ì €ì¥ ìœ„ì¹˜ | ë³´ì¡´ ê¸°ê°„ | ì˜ˆìƒ í¬ê¸° (4 clusters) |
|-----------|----------|----------|---------------------|
| **Raw (15s)** | Receiver TSDB + S3 | 7ì¼ | ~350GB |
| **5m** | S3 (Downsampled) | 30ì¼ | ~75GB |
| **1h** | S3 (Downsampled) | 180ì¼ | ~36GB |
| **ì´ê³„** | - | - | **~461GB** |

---

## ğŸš€ ìŠ¤ì¼€ì¼ë§ ì „ëµ

### ì—£ì§€ í´ëŸ¬ìŠ¤í„° ì¶”ê°€ (4 â†’ 10ê°œ)
1. ArgoCD Application ìƒì„±
2. Git ì €ì¥ì†Œì— overlay ì¶”ê°€
3. Remote Write URL ì„¤ì • â†’ Thanos Receiver
4. ìë™ Sync

### Thanos Receiver í™•ì¥ (3 â†’ 5 replicas)
```bash
kubectl scale statefulset thanos-receive -n monitoring --replicas=5
```
- Hashring ìë™ ì¬ë¶„ë°°
- ê¸°ì¡´ ë°ì´í„° ìœ ì§€

### Prometheus HA Storage í™•ì¥
```bash
kubectl edit pvc prometheus-kube-prometheus-stack-prometheus-db-prometheus-kube-prometheus-stack-prometheus-0 -n monitoring
# spec.resources.requests.storage: 100Gi â†’ 200Gi
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **ë°ì´í„° íë¦„ ìƒì„¸** â†’ [ë°ì´í„°-íë¦„.md](./ë°ì´í„°-íë¦„.md)
- **ê³ ê°€ìš©ì„± ì„¤ê³„** â†’ [ê³ ê°€ìš©ì„±-ì„¤ê³„.md](./ê³ ê°€ìš©ì„±-ì„¤ê³„.md)
- **Agent vs Full Prometheus** â†’ [Agent-vs-Full-Prometheus.md](./Agent-vs-Full-Prometheus.md)

---

**ìµœì¢… ì—…ë°ì´íŠ¸**: 2025-10-20
