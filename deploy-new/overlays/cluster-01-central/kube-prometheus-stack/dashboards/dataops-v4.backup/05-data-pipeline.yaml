apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-dataops-data-pipeline-v4
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  dataops-data-pipeline-v4.json: |
    {
      "uid": "dataops-data-pipeline-v4",
      "title": "DataOps - 5. Data Pipeline",
      "tags": ["dataops", "pipeline", "kafka", "iceberg", "s3"],
      "timezone": "Asia/Seoul",
      "schemaVersion": 39,
      "version": 5,
      "refresh": "30s",
      "graphTooltip": 1,
      "editable": true,
      "style": "dark",
      "panels": [
        {
          "type": "text",
          "id": 1,
          "title": "",
          "gridPos": {"h": 4, "w": 24, "x": 0, "y": 0},
          "options": {
            "mode": "markdown",
            "content": "# ğŸŒŠ Data Pipeline Dashboard\n\n**ëª©ì **: ë°ì´í„° íŒŒì´í”„ë¼ì¸ íë¦„ ë° ë°ì´í„° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§\n\n**ë°ì´í„° íë¦„**: Kafka (Ingestion) â†’ Spark (Processing) â†’ Iceberg (Table Format) â†’ S3 (Storage) â†’ Trino (Query)\n\n[â—€ í¬í„¸ë¡œ ëŒì•„ê°€ê¸°](/d/dataops-portal-e2e-v4)"
          },
          "options": {
            "code": {
              "language": "plaintext",
              "showLineNumbers": false,
              "showMiniMap": false
            },
            "content": "# ğŸŒŠ Data Pipeline Dashboard\n\n**ëª©ì **: ë°ì´í„° íŒŒì´í”„ë¼ì¸ íë¦„ ë° ë°ì´í„° í’ˆì§ˆ ëª¨ë‹ˆí„°ë§\n\n**ë°ì´í„° íë¦„**: Kafka (Ingestion) â†’ Spark (Processing) â†’ Iceberg (Table Format) â†’ S3 (Storage) â†’ Trino (Query)\n\n[â—€ í¬í„¸ë¡œ ëŒì•„ê°€ê¸°](/d/dataops-portal-e2e-v4)",
            "mode": "markdown"
          }
        },
        {
          "type": "stat",
          "id": 10,
          "title": "Kafka Message Ingest Rate",
          "description": "**Kafkaë¡œ ìœ ì…ë˜ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬ìœ¨ (msg/sec)**\n\n**ê³„ì‚°ì‹**:\nsum(rate(kafka_server_brokertopicmetrics_messagesin_total[5m]))\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Kafka ë¸Œë¡œì»¤ê°€ ìˆ˜ì‹ í•˜ëŠ” ì´ˆë‹¹ ë©”ì‹œì§€ ê°œìˆ˜\n- ì „ì²´ Topicì˜ í•©ì‚° ì²˜ë¦¬ëŸ‰\n- ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ ì…êµ¬ ì§€í‘œ\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ í‰ê· : 10K-50K msg/sec (ì—…ë¬´ ì‹œê°„ëŒ€)\n- ğŸŸ¡ í”¼í¬: 50K-100K msg/sec (ë°°ì¹˜ ì ì¬)\n- ğŸ”´ >100K msg/sec: ë¸Œë¡œì»¤ ë¶€í•˜ ì£¼ì˜\n\n**íŒ¨í„´ ë¶„ì„**:\n- **ì‹¤ì‹œê°„ ìˆ˜ì§‘**: ì¼ì •í•œ ì²˜ë¦¬ìœ¨ ìœ ì§€\n- **ë°°ì¹˜ ìˆ˜ì§‘**: íŠ¹ì • ì‹œê°„ëŒ€ Spike (ì˜ˆ: ìƒˆë²½ 2ì‹œ ë¡œê·¸ ì ì¬)\n- **ì´ìƒ ì§•í›„**: ê°‘ì‘ìŠ¤ëŸ¬ìš´ ì¦ê°€ (ë°ì´í„° í­ì£¼) ë˜ëŠ” 0 (Producer ì¥ì• )\n\n**ë³‘ëª© í˜„ìƒ**:\n- ì²˜ë¦¬ìœ¨ ê¸‰ê°: Consumer Lag ì¦ê°€ â†’ Spark Streaming Job ì ê²€\n- ì²˜ë¦¬ìœ¨ 0: Producer ì¥ì• , ë„¤íŠ¸ì›Œí¬ ë‹¨ì ˆ, ì¸ì¦ ì˜¤ë¥˜\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Consumer Lagì´ ì¦ê°€í•˜ë©´ Spark Executor ì¦ì„¤\n- Broker CPU/Network ì‚¬ìš©ë¥  í™•ì¸\n- Topicë³„ ì²˜ë¦¬ìœ¨ ë¶„í•´ ë¶„ì„ (kafka_server_brokertopicmetrics_messagesin_total{topic=\"...\"}\n\n**SLO**: í‰ê·  ì²˜ë¦¬ìœ¨ ë³€ë™ ê³„ìˆ˜ < 30% (ì•ˆì •ì  ìˆ˜ì§‘)\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Consumer Lag, Spark Streaming Batch Duration",
          "gridPos": {"h": 6, "w": 6, "x": 0, "y": 4},
          "targets": [
            {
              "expr": "sum(rate(kafka_server_brokertopicmetrics_messagesin_total[5m]))",
              "refId": "A",
              "legendFormat": "Message Rate"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "msg/s",
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(111, 184, 184, 0.3)"},
                  {"value": 50000, "color": "rgba(111, 184, 184, 0.4)"},
                  {"value": 100000, "color": "rgba(255, 217, 125, 0.3)"}
                ]
              },
              "color": {"mode": "thresholds"}
            }
          },
          "options": {
            "graphMode": "area",
            "orientation": "auto",
            "textMode": "value_and_name",
            "colorMode": "background"
          }
        },
        {
          "type": "stat",
          "id": 11,
          "title": "Kafka Consumer Lag (Total)",
          "description": "**Kafka Consumerì˜ ì „ì²´ Lag (ì²˜ë¦¬ ì§€ì—°)**\n\n**ê³„ì‚°ì‹**:\nsum(kafka_consumer_group_lag)\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Producerê°€ ì ì¬í•œ ë©”ì‹œì§€ Offsetê³¼ Consumerê°€ ì²˜ë¦¬í•œ Offsetì˜ ì°¨ì´\n- ëˆ„ì ëœ ë¯¸ì²˜ë¦¬ ë©”ì‹œì§€ ê°œìˆ˜\n- ë°ì´í„° ì§€ì—° ì‹œê°„ì˜ í•µì‹¬ ì§€í‘œ\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ 0-10K: ìš°ìˆ˜ (ê±°ì˜ ì‹¤ì‹œê°„ ì²˜ë¦¬)\n- ğŸŸ¡ 10K-100K: ì–‘í˜¸ (ìˆ˜ ì´ˆ~ìˆ˜ ë¶„ ì§€ì—°)\n- ğŸ”´ >100K: ìœ„í—˜ (ìˆ˜ì‹­ ë¶„ ì´ìƒ ì§€ì—°, Consumer ì²˜ë¦¬ ëŠ¥ë ¥ ë¶€ì¡±)\n\n**Lag ë°œìƒ ì›ì¸**:\n1. **Consumer ì²˜ë¦¬ ì†ë„ ë¶€ì¡±**: Spark Streaming Jobì˜ Batch Duration ì´ˆê³¼\n2. **ì¼ì‹œì  ë¶€í•˜ ì¦ê°€**: ë°ì´í„° ìœ ì… Spike\n3. **Consumer ì¥ì• **: Job ì¤‘ë‹¨, Exception ë°œìƒ\n4. **ë¦¬ì†ŒìŠ¤ ë¶€ì¡±**: Executor ë©”ëª¨ë¦¬/CPU ë¶€ì¡±\n\n**ì˜í–¥**:\n- ë°ì´í„° ì‹ ì„ ë„ ì €í•˜ (ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ ì§€ì—°)\n- SLA ìœ„ë°˜ (ì˜ˆ: 5ë¶„ ì´ë‚´ ì²˜ë¦¬ ìš”êµ¬ì‚¬í•­)\n- Consumer ì¬ì‹œì‘ ì‹œ ê¸´ ë³µêµ¬ ì‹œê°„\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Lag 100K ì´ˆê³¼ ì‹œ Spark Streaming Job ìŠ¤ì¼€ì¼ ì•„ì›ƒ\n- Consumer Groupë³„ Lag ë¶„í•´: kafka_consumer_group_lag{group=\"...\"}\n- Spark Streaming UIì—ì„œ Batch Processing Time í™•ì¸\n- Kafka Partition ì¦ê°€ë¡œ ë³‘ë ¬ ì²˜ë¦¬ í–¥ìƒ\n\n**SLO**: í‰ê·  Lag < 10K, p95 Lag < 50K\n**Alert**: Lag > 100Kê°€ 10ë¶„ ì´ìƒ ì§€ì† ì‹œ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Message Ingest Rate, Spark Streaming Processing Rate",
          "gridPos": {"h": 6, "w": 6, "x": 6, "y": 4},
          "targets": [
            {
              "expr": "sum(kafka_consumer_group_lag)",
              "refId": "A",
              "legendFormat": "Total Lag"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(111, 184, 184, 0.3)"},
                  {"value": 10000, "color": "rgba(255, 217, 125, 0.3)"},
                  {"value": 100000, "color": "rgba(244, 139, 139, 0.3)"}
                ]
              },
              "color": {"mode": "thresholds"}
            }
          },
          "options": {
            "graphMode": "area",
            "orientation": "auto",
            "textMode": "value_and_name",
            "colorMode": "background"
          }
        },
        {
          "type": "stat",
          "id": 12,
          "title": "Iceberg Table Write Rate",
          "description": "**Iceberg í…Œì´ë¸”ë¡œ ë°ì´í„° ì“°ê¸° ë¹„ìœ¨ (rows/sec)**\n\n**ê³„ì‚°ì‹**:\nsum(rate(iceberg_commit_records_total[5m]))\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Iceberg í…Œì´ë¸”ì— Commitëœ ë ˆì½”ë“œ ê°œìˆ˜ (ì´ˆë‹¹)\n- Sparkì—ì„œ Iceberg Table Formatìœ¼ë¡œ ë°ì´í„° ì ì¬ ì™„ë£Œìœ¨\n- ë°ì´í„° íŒŒì´í”„ë¼ì¸ ì¶œêµ¬ì˜ í•µì‹¬ ì§€í‘œ\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ í‰ê· : 5K-30K rows/sec (ì‹¤ì‹œê°„ ì ì¬)\n- ğŸŸ¡ í”¼í¬: 30K-100K rows/sec (ë°°ì¹˜ ì ì¬)\n- ğŸ”´ 0 rows/sec: íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨\n\n**Write ì„±ëŠ¥ ìš”ì¸**:\n1. **íŒŒí‹°ì…˜ ì „ëµ**: ì ì ˆí•œ íŒŒí‹°ì…˜ í‚¤ë¡œ ì“°ê¸° ë¶„ì‚°\n2. **íŒŒì¼ í¬ê¸°**: ë„ˆë¬´ ë§ì€ ì‘ì€ íŒŒì¼ ë°©ì§€ (Small Files Problem)\n3. **Merge-on-Read vs Copy-on-Write**: Icebergì˜ Write ëª¨ë“œ\n4. **S3 I/O ì„±ëŠ¥**: ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­, S3 API Rate Limit\n\n**Small Files Problem**:\n- íŒŒì¼ ê°œìˆ˜ê°€ ê³¼ë‹¤í•˜ë©´ Trino ì¿¼ë¦¬ ì„±ëŠ¥ ì €í•˜\n- Icebergì˜ ìë™ Compactionìœ¼ë¡œ í•´ê²°\n- iceberg_files_count ë©”íŠ¸ë¦­ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Write Rate 0 ì‹œ Spark Job ìƒíƒœ í™•ì¸\n- Hive Metastore ì—°ê²° ìƒíƒœ ì ê²€ (Iceberg ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ)\n- S3 Bucketì˜ Write IOPS ë° ì—ëŸ¬ìœ¨ í™•ì¸\n- Sparkì˜ iceberg.commit.threads íŒŒë¼ë¯¸í„° ì¡°ì •\n\n**SLO**: í‰ê·  Write Rate > 10K rows/sec\n**Alert**: Write Rate 0ì´ 5ë¶„ ì´ìƒ ì§€ì† ì‹œ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Iceberg Commit Latency, S3 Write Throughput",
          "gridPos": {"h": 6, "w": 6, "x": 12, "y": 4},
          "targets": [
            {
              "expr": "sum(rate(iceberg_commit_records_total[5m]))",
              "refId": "A",
              "legendFormat": "Write Rate"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "rows/s",
              "decimals": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(244, 139, 139, 0.3)"},
                  {"value": 5000, "color": "rgba(111, 184, 184, 0.3)"},
                  {"value": 30000, "color": "rgba(111, 184, 184, 0.5)"}
                ]
              },
              "color": {"mode": "thresholds"}
            }
          },
          "options": {
            "graphMode": "area",
            "orientation": "auto",
            "textMode": "value_and_name",
            "colorMode": "background"
          }
        },
        {
          "type": "stat",
          "id": 13,
          "title": "S3 Data Volume (TB)",
          "description": "**S3ì— ì €ì¥ëœ ì „ì²´ ë°ì´í„° ìš©ëŸ‰**\n\n**ê³„ì‚°ì‹**:\nsum(s3_bucket_size_bytes{bucket=~\".*iceberg.*|.*datalake.*\"}) / 1024 / 1024 / 1024 / 1024\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Iceberg ë° ë°ì´í„° ë ˆì´í¬ìš© S3 Bucketì˜ ì´ ìš©ëŸ‰\n- ë°ì´í„° ëˆ„ì  ì¶”ì´ ë° ìŠ¤í† ë¦¬ì§€ ìš©ëŸ‰ ê³„íš\n- ë¹„ìš© ê´€ë¦¬ì˜ í•µì‹¬ ì§€í‘œ (S3 ìš”ê¸ˆì€ ì €ì¥ ìš©ëŸ‰ ê¸°ë°˜)\n\n**ìš©ëŸ‰ ì¦ê°€ íŒ¨í„´**:\n- **ì„ í˜• ì¦ê°€**: ì¼ì •í•œ ë°ì´í„° ìˆ˜ì§‘ë¥  (ì •ìƒ)\n- **ê¸‰ê²©í•œ ì¦ê°€**: ëŒ€ìš©ëŸ‰ ë°°ì¹˜ ì ì¬ ë˜ëŠ” ë°ì´í„° ë³µì œ\n- **ì •ì²´**: íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ ë˜ëŠ” ë°ì´í„° ì†ŒìŠ¤ ë¬¸ì œ\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ < 80TB: ì—¬ìœ  ìˆìŒ (100TB ìŠ¤í† ë¦¬ì§€ ê¸°ì¤€)\n- ğŸŸ¡ 80-90TB: ìš©ëŸ‰ ê³„íš í•„ìš”\n- ğŸ”´ > 90TB: ê¸´ê¸‰ í™•ì¥ ë˜ëŠ” ë°ì´í„° ì •ë¦¬\n\n**ìš©ëŸ‰ ìµœì í™”**:\n1. **íŒŒí‹°ì…˜ í”„ë£¨ë‹**: ì˜¤ë˜ëœ íŒŒí‹°ì…˜ ì‚­ì œ (Retention Policy)\n2. **ë°ì´í„° ì••ì¶•**: Parquet Snappy/Zstd ì••ì¶• ì ìš©\n3. **Iceberg Compaction**: Small Files ë³‘í•©ìœ¼ë¡œ ë©”íƒ€ë°ì´í„° ê°ì†Œ\n4. **S3 Lifecycle**: ì˜¤ë˜ëœ ë°ì´í„°ë¥¼ Glacierë¡œ ì´ë™\n\n**ë¹„ìš© ê´€ë¦¬**:\n- S3 Standard: $0.023/GB/month\n- 90TB = ì•½ $2,070/month\n- Intelligent-Tieringìœ¼ë¡œ ë¹„ìš© ì ˆê° ê°€ëŠ¥\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- 80TB ì´ˆê³¼ ì‹œ ë°ì´í„° ë³´ê´€ ì •ì±… ê²€í† \n- ë¶ˆí•„ìš”í•œ ë°ì´í„° ì‚­ì œ (DROP TABLE, EXPIRE SNAPSHOTS)\n- S3 Storage Class ì „í™˜ (Glacier, Deep Archive)\n\n**SLO**: ì›”ê°„ ì¦ê°€ìœ¨ < 10%\n**Alert**: 90TB ì´ˆê³¼ ì‹œ ì•Œë¦¼\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Iceberg Table Count, S3 Request Rate",
          "gridPos": {"h": 6, "w": 6, "x": 18, "y": 4},
          "targets": [
            {
              "expr": "sum(s3_bucket_size_bytes{bucket=~\".*iceberg.*|.*datalake.*\"}) / 1024 / 1024 / 1024 / 1024",
              "refId": "A",
              "legendFormat": "Data Volume"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "deckbytes",
              "decimals": 2,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(111, 184, 184, 0.3)"},
                  {"value": 80, "color": "rgba(255, 217, 125, 0.3)"},
                  {"value": 90, "color": "rgba(244, 139, 139, 0.3)"}
                ]
              },
              "color": {"mode": "thresholds"}
            }
          },
          "options": {
            "graphMode": "none",
            "orientation": "auto",
            "textMode": "value_and_name",
            "colorMode": "background"
          }
        },
        {
          "type": "timeseries",
          "id": 20,
          "title": "Kafka Topic Message Rate (Top 10)",
          "description": "**Kafka Topicë³„ ë©”ì‹œì§€ ìœ ì…ìœ¨ Top 10 (msg/sec)**\n\n**ê³„ì‚°ì‹**:\ntopk(10, sum(rate(kafka_server_brokertopicmetrics_messagesin_total[5m])) by (topic))\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Topicë³„ë¡œ ë¶„í•´í•œ ë©”ì‹œì§€ ì²˜ë¦¬ìœ¨\n- ì–´ëŠ Topicì´ ê°€ì¥ ë§ì€ íŠ¸ë˜í”½ì„ ìƒì„±í•˜ëŠ”ì§€ íŒŒì•…\n- ë°ì´í„° ì†ŒìŠ¤ë³„ ìˆ˜ì§‘ í˜„í™© ëª¨ë‹ˆí„°ë§\n\n**Topic ë¶„ë¥˜**:\n- **ì‹¤ì‹œê°„ ì´ë²¤íŠ¸**: user_events, clickstream (ë†’ì€ ì²˜ë¦¬ìœ¨)\n- **ë¡œê·¸ ìˆ˜ì§‘**: application_logs, access_logs (ì¤‘ê°„ ì²˜ë¦¬ìœ¨)\n- **CDC (Change Data Capture)**: db_changes (DB íŠ¸ëœì­ì…˜ì— ë¹„ë¡€)\n\n**íŒ¨í„´ ë¶„ì„**:\n- **ì—…ë¬´ ì‹œê°„ ì—°ë™**: ì‚¬ìš©ì í™œë™ì— ë”°ë¼ ì¦ê°\n- **ë°°ì¹˜ ì ì¬**: íŠ¹ì • ì‹œê°„ëŒ€ Spike\n- **ì´ìƒ ì§•í›„**: í‰ì†Œë³´ë‹¤ 10ë°° ì´ìƒ ì¦ê°€ (ë°ì´í„° í­ì£¼, Producer ì˜¤ë¥˜)\n\n**ìš©ëŸ‰ ê³„íš**:\n- Topicë³„ Partition ê°œìˆ˜ ì¡°ì • (ë³‘ë ¬ ì²˜ë¦¬ í–¥ìƒ)\n- Retention ì •ì±… (ì‹œê°„ ë˜ëŠ” ìš©ëŸ‰ ê¸°ë°˜)\n- Replication Factor (ê³ ê°€ìš©ì„±)\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- íŠ¹ì • Topicì˜ ê¸‰ì¦ ì‹œ Consumer í™•ì¸\n- DLQ (Dead Letter Queue) Topic ëª¨ë‹ˆí„°ë§ (ì²˜ë¦¬ ì‹¤íŒ¨ ë©”ì‹œì§€)\n- Topicë³„ Consumer Group ë§¤í•‘ í™•ì¸\n\n**ì°¸ê³ **:\n- ë²”ë¡€ì— Topicëª… í‘œì‹œ\n- Top 10 ì´ì™¸ Topicì€ \"Others\"ë¡œ ì§‘ê³„ ê°€ëŠ¥",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 10},
          "targets": [
            {
              "expr": "topk(10, sum(rate(kafka_server_brokertopicmetrics_messagesin_total[5m])) by (topic))",
              "refId": "A",
              "legendFormat": "{{topic}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "msg/s",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 15,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic"}
            }
          },
          "options": {
            "tooltip": {"mode": "multi", "sort": "desc"},
            "legend": {"displayMode": "table", "placement": "right", "calcs": ["mean", "max", "last"]}
          }
        },
        {
          "type": "timeseries",
          "id": 21,
          "title": "Kafka Consumer Lag by Group (Top 10)",
          "description": "**Consumer Groupë³„ Lag Top 10**\n\n**ê³„ì‚°ì‹**:\ntopk(10, sum(kafka_consumer_group_lag) by (group))\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Consumer Groupë³„ë¡œ ëˆ„ì ëœ ì²˜ë¦¬ ì§€ì—°\n- ì–´ëŠ Consumerê°€ ë¬¸ì œì¸ì§€ ì‹ë³„\n- Spark Streaming, Flink ë“± ë‹¤ì–‘í•œ Consumer êµ¬ë¶„\n\n**Consumer Group êµ¬ì„±**:\n- **spark-streaming-events**: ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì²˜ë¦¬\n- **spark-batch-logs**: ë°°ì¹˜ ë¡œê·¸ ì²˜ë¦¬\n- **flink-analytics**: ì‹¤ì‹œê°„ ë¶„ì„\n\n**Lag ë¶„ì„**:\n- **ì¼ì‹œì  Lag**: Producer Spike í›„ ìì—° í•´ì†Œ\n- **ì§€ì†ì  Lag**: Consumer ì²˜ë¦¬ ëŠ¥ë ¥ ë¶€ì¡± (í™•ì¥ í•„ìš”)\n- **íŠ¹ì • Groupë§Œ Lag**: í•´ë‹¹ Application ë¬¸ì œ\n\n**Consumer ìµœì í™”**:\n1. **Partition ì¦ê°€**: Kafka Topicì˜ Partition ì¶”ê°€\n2. **Parallelism ì¦ê°€**: Sparkì˜ spark.executor.instances ì¦ê°€\n3. **Batch Size ì¡°ì •**: Spark Streamingì˜ Batch Interval\n4. **ë©”ëª¨ë¦¬ ì¦ì„¤**: Consumer Applicationì˜ ë¦¬ì†ŒìŠ¤\n\n**ì¥ì•  ëŒ€ì‘**:\n- Lagì´ ê³„ì† ì¦ê°€: Consumer ì¬ì‹œì‘ ë˜ëŠ” ìŠ¤ì¼€ì¼ ì•„ì›ƒ\n- íŠ¹ì • Partitionë§Œ Lag: ë°ì´í„° ìŠ¤í, Consumer Rebalancing\n- Consumer Group ì „ì²´ ì¤‘ë‹¨: Application ë¡œê·¸ í™•ì¸\n\n**SLO**: ê° Groupì˜ Lag < 50K\n**Alert**: íŠ¹ì • Group Lag > 100Kê°€ 10ë¶„ ì´ìƒ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Spark Streaming Batch Duration",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 10},
          "targets": [
            {
              "expr": "topk(10, sum(kafka_consumer_group_lag) by (group))",
              "refId": "A",
              "legendFormat": "{{group}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 15,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic"}
            }
          },
          "options": {
            "tooltip": {"mode": "multi", "sort": "desc"},
            "legend": {"displayMode": "table", "placement": "right", "calcs": ["mean", "max", "last"]}
          }
        },
        {
          "type": "timeseries",
          "id": 30,
          "title": "Iceberg Commit Latency (seconds)",
          "description": "**Iceberg Table Commit ì†Œìš” ì‹œê°„**\n\n**ê³„ì‚°ì‹**:\nrate(iceberg_commit_duration_seconds_sum[5m]) / \nrate(iceberg_commit_duration_seconds_count[5m])\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Sparkì—ì„œ Iceberg í…Œì´ë¸”ë¡œ ë°ì´í„°ë¥¼ Commití•˜ëŠ” ì‹œê°„\n- ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (Manifest, Snapshot ìƒì„±) í¬í•¨\n- ACID íŠ¸ëœì­ì…˜ ì™„ë£Œê¹Œì§€ì˜ Latency\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ 0-5ì´ˆ: ìš°ìˆ˜ (ì†ŒëŸ‰ ë°ì´í„° ë˜ëŠ” ìµœì í™”ëœ íŒŒí‹°ì…˜)\n- ğŸŸ¡ 5-15ì´ˆ: ì–‘í˜¸ (ì¤‘ê°„ ê·œëª¨ ë°ì´í„°)\n- ğŸ”´ 15ì´ˆ ì´ìƒ: ì£¼ì˜ (ëŒ€ìš©ëŸ‰ Commit, ë©”íƒ€ë°ì´í„° ë³‘ëª©)\n\n**Latency ì˜í–¥ ìš”ì¸**:\n1. **íŒŒì¼ ê°œìˆ˜**: Manifestì— ê¸°ë¡í•  íŒŒì¼ì´ ë§ì„ìˆ˜ë¡ ëŠë¦¼\n2. **íŒŒí‹°ì…˜ ê°œìˆ˜**: ì—…ë°ì´íŠ¸í•  íŒŒí‹°ì…˜ì´ ë§ì„ìˆ˜ë¡ ëŠë¦¼\n3. **Hive Metastore ì„±ëŠ¥**: ë©”íƒ€ë°ì´í„° DBì˜ ì¿¼ë¦¬ ì„±ëŠ¥\n4. **S3 Consistency**: Manifest íŒŒì¼ ì“°ê¸° ë° ì½ê¸°\n\n**ìµœì í™” ë°©ë²•**:\n- **íŒŒì¼ í¬ê¸° ì¡°ì •**: spark.sql.files.maxRecordsPerFile ì„¤ì •\n- **Commit ë³‘ë ¬í™”**: iceberg.commit.threads ì¦ê°€\n- **Metastore íŠœë‹**: Connection Pool, ì¸ë±ìŠ¤ ì¶”ê°€\n- **íŒŒí‹°ì…˜ ì „ëµ**: ê³¼ë„í•œ íŒŒí‹°ì…˜ ì„¸ë¶„í™” ì§€ì–‘\n\n**íŠ¸ëœì­ì…˜ ê²©ë¦¬**:\n- Icebergì˜ Optimistic Concurrencyë¡œ ë‹¤ì¤‘ Writer ì§€ì›\n- Commit ì¶©ëŒ ì‹œ ìë™ ì¬ì‹œë„\n- iceberg_commit_retry_total ë©”íŠ¸ë¦­ìœ¼ë¡œ ì¬ì‹œë„ íšŸìˆ˜ í™•ì¸\n\n**SLO**: í‰ê·  Commit Latency < 10ì´ˆ, p95 < 20ì´ˆ\n**Alert**: Commit Latency > 30ì´ˆê°€ 10ë¶„ ì´ìƒ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Iceberg Table Write Rate, Manifest File Count",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 18},
          "targets": [
            {
              "expr": "rate(iceberg_commit_duration_seconds_sum[5m]) / rate(iceberg_commit_duration_seconds_count[5m])",
              "refId": "A",
              "legendFormat": "Commit Latency"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "decimals": 1,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 20,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic", "fixedColor": "rgba(111, 184, 184, 0.8)"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(129, 201, 149, 0.2)"},
                  {"value": 5, "color": "rgba(255, 217, 125, 0.2)"},
                  {"value": 15, "color": "rgba(244, 139, 139, 0.2)"}
                ]
              }
            }
          },
          "options": {
            "tooltip": {"mode": "single"},
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["mean", "max"]}
          }
        },
        {
          "type": "timeseries",
          "id": 31,
          "title": "Iceberg Files Count (Total)",
          "description": "**Iceberg í…Œì´ë¸”ì˜ ì „ì²´ ë°ì´í„° íŒŒì¼ ê°œìˆ˜**\n\n**ê³„ì‚°ì‹**:\nsum(iceberg_table_files_count)\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Iceberg í…Œì´ë¸”ì„ êµ¬ì„±í•˜ëŠ” Parquet íŒŒì¼ì˜ ì´ ê°œìˆ˜\n- Small Files Problem ëª¨ë‹ˆí„°ë§ì˜ í•µì‹¬ ì§€í‘œ\n- íŒŒì¼ ê°œìˆ˜ê°€ ë§ì„ìˆ˜ë¡ ì¿¼ë¦¬ í”Œë˜ë‹ ë° ë©”íƒ€ë°ì´í„° ì¡°íšŒ ëŠë¦¼\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ < 10K íŒŒì¼: ìš°ìˆ˜ (ì¿¼ë¦¬ ì„±ëŠ¥ ì–‘í˜¸)\n- ğŸŸ¡ 10K-50K íŒŒì¼: ì–‘í˜¸ (Compaction ê¶Œì¥)\n- ğŸ”´ > 50K íŒŒì¼: ìœ„í—˜ (ì‹¬ê°í•œ Small Files Problem)\n\n**Small Files Problem**:\n- **ì›ì¸**: ì‹¤ì‹œê°„ Streamingìœ¼ë¡œ ì‘ì€ íŒŒì¼ ì§€ì† ìƒì„±\n- **ì˜í–¥**: Trino ì¿¼ë¦¬ ì‹œ ë§ì€ íŒŒì¼ Open/Closeë¡œ ì„±ëŠ¥ ì €í•˜\n- **í•´ê²°**: Iceberg Compactionìœ¼ë¡œ íŒŒì¼ ë³‘í•©\n\n**Iceberg Compaction**:\n```sql\n-- Spark SQL\nCALL catalog.system.rewrite_data_files(\n  table => 'db.table',\n  strategy => 'binpack',\n  options => map('target-file-size-bytes', '536870912') -- 512MB\n)\n```\n\n**íŒŒì¼ í¬ê¸° ìµœì í™”**:\n- **ëª©í‘œ íŒŒì¼ í¬ê¸°**: 256MB - 1GB (Parquet)\n- spark.sql.files.maxRecordsPerFile ì¡°ì •\n- Streaming: ì§§ì€ Checkpoint Intervalë¡œ íŒŒì¼ ê°œìˆ˜ ì¦ê°€ â†’ ì£¼ê¸°ì  Compaction\n\n**ë©”íƒ€ë°ì´í„° ì˜í–¥**:\n- íŒŒì¼ ê°œìˆ˜ê°€ ë§ìœ¼ë©´ Manifest í¬ê¸° ì¦ê°€\n- Snapshot Planning ì‹œê°„ ì¦ê°€ (Trino Query ì§€ì—°)\n\n**SLO**: íŒŒì¼ ê°œìˆ˜ < 30K\n**Alert**: íŒŒì¼ ê°œìˆ˜ > 50K ì‹œ Compaction ì‘ì—… ì˜ˆì•½\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Trino Query Planning Time",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 18},
          "targets": [
            {
              "expr": "sum(iceberg_table_files_count)",
              "refId": "A",
              "legendFormat": "Total Files"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "short",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 20,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic", "fixedColor": "rgba(111, 184, 184, 0.8)"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(129, 201, 149, 0.2)"},
                  {"value": 10000, "color": "rgba(255, 217, 125, 0.2)"},
                  {"value": 50000, "color": "rgba(244, 139, 139, 0.2)"}
                ]
              }
            }
          },
          "options": {
            "tooltip": {"mode": "single"},
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["last"]}
          }
        },
        {
          "type": "timeseries",
          "id": 40,
          "title": "S3 Write Throughput (MB/s)",
          "description": "**S3ë¡œì˜ ë°ì´í„° ì“°ê¸° ì²˜ë¦¬ëŸ‰**\n\n**ê³„ì‚°ì‹**:\nsum(rate(s3_bytes_uploaded_total[5m])) / 1024 / 1024\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Iceberg ë°ì´í„° íŒŒì¼ (Parquet)ê³¼ ë©”íƒ€ë°ì´í„° (Manifest, Snapshot)ë¥¼ S3ì— ì—…ë¡œë“œí•˜ëŠ” ì†ë„\n- ë°ì´í„° íŒŒì´í”„ë¼ì¸ ìµœì¢… ë‹¨ê³„ì˜ ì²˜ë¦¬ëŸ‰\n- S3 I/O ì„±ëŠ¥ ë° ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ëª¨ë‹ˆí„°ë§\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ í‰ê· : 100-500 MB/s (ì‹¤ì‹œê°„ ì²˜ë¦¬)\n- ğŸŸ¡ í”¼í¬: 500-2000 MB/s (ë°°ì¹˜ ì ì¬)\n- ğŸ”´ > 2000 MB/s: ë„¤íŠ¸ì›Œí¬ í¬í™” ìœ„í—˜ (10GbE ê¸°ì¤€ ~1250 MB/s)\n\n**ì²˜ë¦¬ëŸ‰ ì˜í–¥ ìš”ì¸**:\n1. **ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­**: 10GbE = ì´ë¡ ìƒ 1250 MB/s\n2. **S3 API Rate Limit**: ì´ˆë‹¹ 3,500 PUT/COPY/POST/DELETE, 5,500 GET/HEAD\n3. **Spark ë³‘ë ¬ë„**: Executor ê°œìˆ˜ ë° Task ë³‘ë ¬ ì‹¤í–‰\n4. **ì••ì¶•ë¥ **: Parquet Snappy ì••ì¶• ì‹œ ì••ì¶• ì „í›„ ë¹„ìœ¨\n\n**S3 ìµœì í™”**:\n- **Multipart Upload**: í° íŒŒì¼ì„ ë¶€ë¶„ìœ¼ë¡œ ë‚˜ëˆ  ë³‘ë ¬ ì—…ë¡œë“œ\n- **S3 Transfer Acceleration**: ì¥ê±°ë¦¬ ì—…ë¡œë“œ ê°€ì†\n- **Endpoint ì„ íƒ**: S3 VPC Endpoint ì‚¬ìš©ìœ¼ë¡œ ë¹„ìš© ì ˆê°\n\n**ë³‘ëª© íƒì§€**:\n- Write Throughput 0: íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨\n- Write Throughput ì €í•˜: S3 API ì—ëŸ¬ìœ¨ í™•ì¸ (s3_request_errors_total)\n- ë„¤íŠ¸ì›Œí¬ ëŒ€ì—­í­ ì´ˆê³¼: ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì™€ ê²½ìŸ\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- S3 ì—ëŸ¬ìœ¨ í™•ì¸ (ThrottlingException, SlowDown)\n- ë„¤íŠ¸ì›Œí¬ ëª¨ë‹ˆí„°ë§ (node_network_transmit_bytes_total)\n- Sparkì˜ s3a.connection.maximum íŒŒë¼ë¯¸í„° ì¡°ì •\n\n**SLO**: í‰ê·  Write Throughput > 200 MB/s\n**Alert**: Write Throughput < 50 MB/sê°€ 10ë¶„ ì´ìƒ (ì •ìƒ ì—…ë¬´ ì‹œê°„ëŒ€)\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: S3 Request Rate, Network TX Bandwidth",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 26},
          "targets": [
            {
              "expr": "sum(rate(s3_bytes_uploaded_total[5m])) / 1024 / 1024",
              "refId": "A",
              "legendFormat": "S3 Write"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "MBs",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 25,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic", "fixedColor": "rgba(111, 184, 184, 0.8)"}
            }
          },
          "options": {
            "tooltip": {"mode": "single"},
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["mean", "max"]}
          }
        },
        {
          "type": "timeseries",
          "id": 41,
          "title": "S3 Read Throughput (MB/s)",
          "description": "**S3ë¡œë¶€í„°ì˜ ë°ì´í„° ì½ê¸° ì²˜ë¦¬ëŸ‰**\n\n**ê³„ì‚°ì‹**:\nsum(rate(s3_bytes_downloaded_total[5m])) / 1024 / 1024\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Trino, Spark ë“±ì—ì„œ Iceberg í…Œì´ë¸”ì„ ì¿¼ë¦¬í•  ë•Œ S3ì—ì„œ ì½ëŠ” ì†ë„\n- ì¿¼ë¦¬ ì„±ëŠ¥ ë° ë°ì´í„° ì•¡ì„¸ìŠ¤ íŒ¨í„´ ëª¨ë‹ˆí„°ë§\n- ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  ëŒ€ì—­í­ ì‚¬ìš©ë¥ \n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ í‰ê· : 100-500 MB/s (ëŒ€ì‹œë³´ë“œ, Ad-hoc ì¿¼ë¦¬)\n- ğŸŸ¡ í”¼í¬: 500-2000 MB/s (ëŒ€ìš©ëŸ‰ ë¶„ì„ ì¿¼ë¦¬)\n- ğŸ”´ > 2000 MB/s: ë„¤íŠ¸ì›Œí¬ ìˆ˜ì‹  í¬í™”\n\n**ì²˜ë¦¬ëŸ‰ íŒ¨í„´**:\n- **ì—…ë¬´ ì‹œê°„**: ëŒ€ì‹œë³´ë“œ ìë™ ê°±ì‹ , ì‚¬ìš©ì ì¿¼ë¦¬ë¡œ ì¼ì •í•œ Read\n- **ë°°ì¹˜ ìœˆë„ìš°**: ETL Jobì´ ëŒ€ëŸ‰ ë°ì´í„° ìŠ¤ìº”\n- **0 ì²˜ë¦¬ëŸ‰**: ì¿¼ë¦¬ ë¯¸ì‹¤í–‰ (ì•¼ê°„ ì‹œê°„ëŒ€)\n\n**Read ìµœì í™”**:\n1. **íŒŒí‹°ì…˜ í”„ë£¨ë‹**: WHERE ì ˆë¡œ ë¶ˆí•„ìš”í•œ íŒŒí‹°ì…˜ ìŠ¤í‚µ\n2. **ì»¬ëŸ¼ í”„ë¡œì ì…˜**: SELECT í•„ìš” ì»¬ëŸ¼ë§Œ (Parquetì˜ ì»¬ëŸ¼ ì§€í–¥)\n3. **Predicate Pushdown**: Connectorì—ì„œ í•„í„°ë§\n4. **ë¡œì»¬ ìºì‹±**: Trinoì˜ Hive Connector ìºì‹œ í™œì„±í™”\n\n**S3 ë¹„ìš©**:\n- S3 GET ìš”ì²­: $0.0004 per 1,000 requests\n- Data Transfer Out: $0.09/GB (ì¸í„°ë„·ìœ¼ë¡œ ë‚˜ê°€ëŠ” ê²½ìš°)\n- VPC Endpoint ì‚¬ìš© ì‹œ Transfer ë¹„ìš© 0ì›\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Read Throughput ê¸‰ì¦: ë¹„ì •ìƒ ì¿¼ë¦¬ í™•ì¸ (Full Table Scan)\n- S3 GET ìš”ì²­ ê¸‰ì¦: Small Files Problem (íŒŒì¼ ê°œìˆ˜ ê³¼ë‹¤)\n- Trino UIì—ì„œ ì¿¼ë¦¬ë³„ ìŠ¤ìº” ë°ì´í„°ëŸ‰ í™•ì¸\n\n**SLO**: p95 Read Throughput < 1500 MB/s (ë„¤íŠ¸ì›Œí¬ ì—¬ìœ  í™•ë³´)\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Trino Query Execution Time, Iceberg Files Count",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 26},
          "targets": [
            {
              "expr": "sum(rate(s3_bytes_downloaded_total[5m])) / 1024 / 1024",
              "refId": "A",
              "legendFormat": "S3 Read"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "MBs",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 25,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic", "fixedColor": "rgba(111, 184, 184, 0.8)"}
            }
          },
          "options": {
            "tooltip": {"mode": "single"},
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["mean", "max"]}
          }
        },
        {
          "type": "timeseries",
          "id": 50,
          "title": "Hive Metastore Query Latency (ms)",
          "description": "**Hive Metastore ì¿¼ë¦¬ ì‘ë‹µ ì‹œê°„**\n\n**ê³„ì‚°ì‹**:\nrate(hive_metastore_query_duration_seconds_sum[5m]) / \nrate(hive_metastore_query_duration_seconds_count[5m]) * 1000\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Icebergì˜ ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œì¸ Hive Metastoreì˜ ì¿¼ë¦¬ Latency\n- í…Œì´ë¸” ìŠ¤í‚¤ë§ˆ, íŒŒí‹°ì…˜ ì •ë³´, Snapshot ì¡°íšŒ ì‹œê°„\n- ì¿¼ë¦¬ í”Œë˜ë‹ ì„±ëŠ¥ì— ì§ì ‘ ì˜í–¥\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ 0-50ms: ìš°ìˆ˜ (ë¹ ë¥¸ ë©”íƒ€ë°ì´í„° ì¡°íšŒ)\n- ğŸŸ¡ 50-200ms: ì–‘í˜¸ (í—ˆìš© ê°€ëŠ¥í•œ Latency)\n- ğŸ”´ > 200ms: ìœ„í—˜ (ì¿¼ë¦¬ í”Œë˜ë‹ ì§€ì—°)\n\n**Latency ì¦ê°€ ì›ì¸**:\n1. **DB ë¶€í•˜**: Metastore DB (MySQL/Postgres)ì˜ CPU/Memory ë¶€ì¡±\n2. **ì¸ë±ìŠ¤ ë¶€ì¬**: Metastore í…Œì´ë¸”ì˜ ì¸ë±ìŠ¤ ë¯¸ìµœì í™”\n3. **í…Œì´ë¸” ê°œìˆ˜**: ìˆ˜ì²œ ê°œ ì´ìƒì˜ í…Œì´ë¸”ë¡œ ë©”íƒ€ë°ì´í„° ê³¼ë‹¤\n4. **ë™ì‹œ ì ‘ì†**: Spark, Trino ë“± ë‹¤ìˆ˜ í´ë¼ì´ì–¸íŠ¸ì˜ ë™ì‹œ ì¿¼ë¦¬\n\n**Metastore ìµœì í™”**:\n- **DB íŠœë‹**: Connection Pool í¬ê¸°, Query Cache\n- **ì¸ë±ìŠ¤ ì¶”ê°€**: TBLS, PARTITIONS, SDS í…Œì´ë¸”\n- **HA êµ¬ì„±**: Metastore ì„œë²„ ë‹¤ì¤‘í™”\n- **ìºì‹±**: Client-side ë©”íƒ€ë°ì´í„° ìºì‹±\n\n**Metastore í…Œì´ë¸” ì˜ˆì‹œ**:\n- TBLS: í…Œì´ë¸” ëª©ë¡\n- PARTITIONS: íŒŒí‹°ì…˜ ì •ë³´\n- SDS (Storage Descriptors): íŒŒì¼ ê²½ë¡œ, í¬ë§·\n\n**ì˜í–¥**:\n- Trino Query Planning Time ì¦ê°€\n- Spark Job ì‹œì‘ ì§€ì—°\n- SHOW TABLES, DESCRIBE TABLE ëŠë¦¼\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Metastore DBì˜ Slow Query ë¶„ì„\n- Connection Pool ì„¤ì • í™•ì¸ (hive.metastore.client.connect.retry.delay)\n- ë¶ˆí•„ìš”í•œ í…Œì´ë¸”/íŒŒí‹°ì…˜ ì •ë¦¬ (DROP TABLE)\n\n**SLO**: í‰ê·  Latency < 100ms, p95 < 200ms\n**Alert**: Latency > 500msê°€ 10ë¶„ ì´ìƒ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Trino Query Planning Time, Iceberg Commit Latency",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 34},
          "targets": [
            {
              "expr": "rate(hive_metastore_query_duration_seconds_sum[5m]) / rate(hive_metastore_query_duration_seconds_count[5m]) * 1000",
              "refId": "A",
              "legendFormat": "Query Latency"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "ms",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 20,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic", "fixedColor": "rgba(111, 184, 184, 0.8)"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(129, 201, 149, 0.2)"},
                  {"value": 50, "color": "rgba(255, 217, 125, 0.2)"},
                  {"value": 200, "color": "rgba(244, 139, 139, 0.2)"}
                ]
              }
            }
          },
          "options": {
            "tooltip": {"mode": "single"},
            "legend": {"displayMode": "list", "placement": "bottom", "calcs": ["mean", "max"]}
          }
        },
        {
          "type": "timeseries",
          "id": 51,
          "title": "Data Pipeline End-to-End Latency (seconds)",
          "description": "**ë°ì´í„° íŒŒì´í”„ë¼ì¸ End-to-End ì§€ì—° ì‹œê°„**\n\n**ê³„ì‚°ì‹**:\navg(\n  (iceberg_record_timestamp - kafka_record_timestamp)\n) by (pipeline)\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Kafka ë©”ì‹œì§€ ìƒì„± ì‹œì ë¶€í„° Iceberg í…Œì´ë¸” Commitê¹Œì§€ì˜ ì „ì²´ ì†Œìš” ì‹œê°„\n- ë°ì´í„° ì‹ ì„ ë„ (Freshness)ì˜ í•µì‹¬ ì§€í‘œ\n- SLA ì¤€ìˆ˜ ëª¨ë‹ˆí„°ë§ (ì˜ˆ: ë°ì´í„°ëŠ” ìƒì„± í›„ 5ë¶„ ì´ë‚´ ì¿¼ë¦¬ ê°€ëŠ¥)\n\n**ì •ìƒ ë²”ìœ„**:\n- ğŸŸ¢ 0-300ì´ˆ (5ë¶„): ìš°ìˆ˜ (ì‹¤ì‹œê°„ì— ê°€ê¹Œì›€)\n- ğŸŸ¡ 300-600ì´ˆ (5-10ë¶„): ì–‘í˜¸\n- ğŸ”´ > 600ì´ˆ (10ë¶„): ìœ„í—˜ (SLA ìœ„ë°˜ ê°€ëŠ¥)\n\n**Latency êµ¬ì„± ìš”ì†Œ**:\n1. **Kafka Lag**: Consumerê°€ ë©”ì‹œì§€ë¥¼ ì½ê¸°ê¹Œì§€ (ì´ˆ-ë¶„)\n2. **Processing Time**: Sparkì—ì„œ ë³€í™˜ ì²˜ë¦¬ (ì´ˆ-ë¶„)\n3. **Iceberg Commit**: ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ ë° S3 ì“°ê¸° (ì´ˆ)\n4. **Metadata Refresh**: Trinoê°€ ìƒˆ Snapshot ì¸ì‹ (ì´ˆ)\n\n**E2E Latency ì¸¡ì •**:\n- Kafka ë©”ì‹œì§€ì— timestamp í•„ë“œ í¬í•¨\n- Iceberg í…Œì´ë¸”ì˜ _ingestion_time ì»¬ëŸ¼ì— ê¸°ë¡\n- ì°¨ì´ ê³„ì‚°ìœ¼ë¡œ ì‹¤ì œ ì§€ì—° ì‹œê°„ ì‚°ì¶œ\n\n**SLA ì˜ˆì‹œ**:\n- **Tier 1 (Critical)**: E2E < 5ë¶„ (ì‹¤ì‹œê°„ ëŒ€ì‹œë³´ë“œ)\n- **Tier 2 (Important)**: E2E < 15ë¶„ (ì •ê¸° ë¦¬í¬íŠ¸)\n- **Tier 3 (Batch)**: E2E < 1ì‹œê°„ (ë°°ì¹˜ ë¶„ì„)\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- Latency ì¦ê°€ ì‹œ ê° ë‹¨ê³„ë³„ ë¶„í•´ ë¶„ì„\n- Kafka Consumer Lag í™•ì¸\n- Spark Streaming Batch Duration í™•ì¸\n- Iceberg Commit Latency í™•ì¸\n\n**SLO**: p95 E2E Latency < 600ì´ˆ (10ë¶„)\n**Alert**: Latency > 900ì´ˆ (15ë¶„)ê°€ 10ë¶„ ì´ìƒ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Kafka Consumer Lag, Iceberg Commit Latency",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 34},
          "targets": [
            {
              "expr": "avg((iceberg_record_timestamp - kafka_record_timestamp)) by (pipeline)",
              "refId": "A",
              "legendFormat": "{{pipeline}}"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "decimals": 0,
              "custom": {
                "lineWidth": 2,
                "fillOpacity": 20,
                "drawStyle": "line",
                "lineInterpolation": "smooth",
                "showPoints": "never",
                "axisPlacement": "auto"
              },
              "color": {"mode": "palette-classic"},
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "rgba(129, 201, 149, 0.2)"},
                  {"value": 300, "color": "rgba(255, 217, 125, 0.2)"},
                  {"value": 600, "color": "rgba(244, 139, 139, 0.2)"}
                ]
              }
            }
          },
          "options": {
            "tooltip": {"mode": "multi", "sort": "desc"},
            "legend": {"displayMode": "table", "placement": "bottom", "calcs": ["mean", "max", "last"]}
          }
        },
        {
          "type": "table",
          "id": 60,
          "title": "Top 10 Iceberg Tables by Size",
          "description": "**í¬ê¸°ê°€ í° Iceberg í…Œì´ë¸” Top 10**\n\n**ê³„ì‚°ì‹**:\ntopk(10, \n  sum(iceberg_table_size_bytes) by (namespace, table) / 1024 / 1024 / 1024\n)\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- Iceberg í…Œì´ë¸”ë³„ S3 ì €ì¥ ìš©ëŸ‰ (GB ë‹¨ìœ„)\n- ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ê´€ë¦¬ ë° ë°ì´í„° ì •ë¦¬ ìš°ì„ ìˆœìœ„ ê²°ì •\n- í…Œì´ë¸” ì¦ê°€ ì¶”ì„¸ ëª¨ë‹ˆí„°ë§\n\n**ë¶„ì„ í¬ì¸íŠ¸**:\n- **ëŒ€ìš©ëŸ‰ í…Œì´ë¸”**: ìˆ˜ë°± GB ~ TB ê·œëª¨ (ë¡œê·¸, ì´ë²¤íŠ¸)\n- **ì¦ê°€ìœ¨**: ì¼ì¼ ì¦ê°€ëŸ‰ ì¶”ì \n- **Retention**: ë³´ê´€ ì •ì±… ì ìš© ì—¬ë¶€\n\n**ë°ì´í„° ì •ë¦¬ ë°©ë²•**:\n1. **íŒŒí‹°ì…˜ ì‚­ì œ**: ALTER TABLE DROP PARTITION\n2. **Snapshot Expiration**: EXPIRE SNAPSHOTS older_than '2024-01-01'\n3. **Orphan Files**: REMOVE ORPHAN FILES (ë©”íƒ€ë°ì´í„° ì—†ëŠ” íŒŒì¼)\n4. **Compaction**: ì‘ì€ íŒŒì¼ ë³‘í•©ìœ¼ë¡œ ê³µê°„ ìµœì í™”\n\n**ë¹„ìš© ìµœì í™”**:\n- ì˜¤ë˜ëœ ë°ì´í„° â†’ S3 Glacier ì´ë™\n- ì ‘ê·¼ ë¹ˆë„ ë‚®ì€ í…Œì´ë¸” â†’ Intelligent-Tiering\n- ì¤‘ë³µ í…Œì´ë¸” ì‚­ì œ (dev/test í™˜ê²½)\n\n**Iceberg ìš´ì˜ ëª…ë ¹**:\n```sql\n-- Snapshot ì •ë¦¬ (30ì¼ ì´ì „)\nCALL catalog.system.expire_snapshots(\n  table => 'db.table',\n  older_than => DATE '2024-01-01'\n)\n\n-- Orphan Files ì‚­ì œ\nCALL catalog.system.remove_orphan_files(\n  table => 'db.table'\n)\n```\n\n**ì°¸ê³ **:\n- NamespaceëŠ” Databaseëª…\n- Tableì€ í…Œì´ë¸”ëª…\n- í¬ê¸°ëŠ” ì••ì¶•ëœ Parquet ê¸°ì¤€",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 42},
          "targets": [
            {
              "expr": "topk(10, sum(iceberg_table_size_bytes) by (namespace, table) / 1024 / 1024 / 1024)",
              "refId": "A",
              "format": "table",
              "instant": true
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"namespace": 0, "table": 1, "Value": 2},
                "renameByName": {"namespace": "Namespace", "table": "Table", "Value": "Size (GB)"}
              }
            }
          ],
          "fieldConfig": {
            "defaults": {
              "custom": {"align": "left", "filterable": true}
            },
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Size (GB)"},
                "properties": [
                  {"id": "unit", "value": "decgbytes"},
                  {"id": "decimals", "value": 2},
                  {"id": "custom.align", "value": "right"},
                  {"id": "custom.cellOptions", "value": {"type": "color-background"}},
                  {"id": "thresholds", "value": {
                    "mode": "absolute",
                    "steps": [
                      {"value": 0, "color": "rgba(129, 201, 149, 0.2)"},
                      {"value": 500, "color": "rgba(255, 217, 125, 0.3)"},
                      {"value": 1000, "color": "rgba(244, 139, 139, 0.3)"}
                    ]
                  }}
                ]
              }
            ]
          }
        },
        {
          "type": "table",
          "id": 61,
          "title": "Data Quality Check Results (Last 1h)",
          "description": "**ë°ì´í„° í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ (ìµœê·¼ 1ì‹œê°„)**\n\n**ê³„ì‚°ì‹**:\nsum(increase(data_quality_check_total[1h])) by (table, check_type, status)\n\n**ë©”íŠ¸ë¦­ ì„¤ëª…**:\n- ë°ì´í„° íŒŒì´í”„ë¼ì¸ì— ë‚´ì¥ëœ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼\n- í…Œì´ë¸”ë³„, ê²€ì‚¬ ìœ í˜•ë³„ ì„±ê³µ/ì‹¤íŒ¨ ì§‘ê³„\n- ë°ì´í„° ì‹ ë¢°ì„± ëª¨ë‹ˆí„°ë§\n\n**í’ˆì§ˆ ê²€ì‚¬ ìœ í˜•**:\n1. **Schema Validation**: ìŠ¤í‚¤ë§ˆ ì¼ì¹˜ ì—¬ë¶€\n2. **Null Check**: í•„ìˆ˜ ì»¬ëŸ¼ì˜ NULL ê²€ì‚¬\n3. **Range Check**: ìˆ«ì ë²”ìœ„, ë‚ ì§œ ë²”ìœ„ ê²€ì¦\n4. **Uniqueness**: ì¤‘ë³µ ë ˆì½”ë“œ ê²€ì‚¬\n5. **Referential Integrity**: ì™¸ë˜ í‚¤ ê´€ê³„ ê²€ì¦\n\n**í’ˆì§ˆ ì €í•˜ ì›ì¸**:\n- **Schema Evolution**: ì†ŒìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½\n- **ë°ì´í„° ì˜¤ì—¼**: ì˜ëª»ëœ í˜•ì‹, ê°’ ë²”ìœ„ ì´ˆê³¼\n- **upstream ì˜¤ë¥˜**: ì†ŒìŠ¤ ì‹œìŠ¤í…œì˜ ë°ì´í„° ìƒì„± ì˜¤ë¥˜\n\n**ìë™ ì¡°ì¹˜**:\n- ì‹¤íŒ¨í•œ ë ˆì½”ë“œ â†’ DLQ (Dead Letter Queue) ì´ë™\n- Alert ë°œì†¡ (Critical Check ì‹¤íŒ¨ ì‹œ)\n- íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ (Fail-Fast ì •ì±…)\n\n**Great Expectations í™œìš©**:\n```python\n# Sparkì—ì„œ Great Expectations í†µí•©\nfrom great_expectations.dataset import SparkDFDataset\n\ndf_ge = SparkDFDataset(df)\nresult = df_ge.expect_column_values_to_be_between(\n    column=\"age\", min_value=0, max_value=120\n)\n```\n\n**ì¡°ì¹˜ ì‚¬í•­**:\n- ì‹¤íŒ¨ Checkì˜ ìƒì„¸ ë¡œê·¸ í™•ì¸\n- ì†ŒìŠ¤ ë°ì´í„° ê²€ì¦\n- ìŠ¤í‚¤ë§ˆ ë²„ì „ ê´€ë¦¬ (Schema Registry)\n\n**SLO**: í’ˆì§ˆ ê²€ì‚¬ ì„±ê³µë¥  > 99.5%\n**Alert**: íŠ¹ì • í…Œì´ë¸”ì˜ Check ì‹¤íŒ¨ê°€ 10íšŒ ì´ìƒ\n**ê´€ë ¨ ë©”íŠ¸ë¦­**: Pipeline Success Rate",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 42},
          "targets": [
            {
              "expr": "sum(increase(data_quality_check_total[1h])) by (table, check_type, status)",
              "refId": "A",
              "format": "table",
              "instant": true
            }
          ],
          "transformations": [
            {
              "id": "organize",
              "options": {
                "excludeByName": {"Time": true, "__name__": true, "job": true, "instance": true},
                "indexByName": {"table": 0, "check_type": 1, "status": 2, "Value": 3},
                "renameByName": {"table": "Table", "check_type": "Check Type", "status": "Status", "Value": "Count"}
              }
            }
          ],
          "fieldConfig": {
            "defaults": {
              "custom": {"align": "left", "filterable": true}
            },
            "overrides": [
              {
                "matcher": {"id": "byName", "options": "Count"},
                "properties": [
                  {"id": "unit", "value": "short"},
                  {"id": "decimals", "value": 0},
                  {"id": "custom.align", "value": "right"}
                ]
              },
              {
                "matcher": {"id": "byName", "options": "Status"},
                "properties": [
                  {"id": "custom.cellOptions", "value": {"type": "color-text"}},
                  {"id": "mappings", "value": [
                    {"type": "value", "value": "success", "text": "âœ… Success", "color": "green"},
                    {"type": "value", "value": "failure", "text": "âŒ Failure", "color": "red"}
                  ]}
                ]
              }
            ]
          }
        }
      ]
    }
