apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-dataops-optimization
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  dataops-optimization.json: |
    {
      "uid": "dataops-optimization",
      "title": "ğŸ”§ DataOps - ìµœì í™” & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…",
      "tags": ["dataops", "optimization", "troubleshooting"],
      "timezone": "browser",
      "schemaVersion": 16,
      "version": 1,
      "refresh": "1m",
      "editable": true,
      "panels": [
        {
          "type": "text",
          "title": "ğŸ“Š ìµœì í™” & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…",
          "gridPos": {"h": 4, "w": 24, "x": 0, "y": 0},
          "options": {
            "mode": "html",
            "content": "<div style='padding: 20px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; border-radius: 8px;'><h2 style='margin:0'>ğŸ”§ ìµœì í™” & íŠ¸ëŸ¬ë¸”ìŠˆíŒ…</h2><p style='margin-top:10px; font-size:16px'>ì„±ëŠ¥ ìµœì í™”, ë¹„ìš© ë¶„ì„, ì—ëŸ¬ ëª¨ë‹ˆí„°ë§</p></div>"
          }
        },
        {
          "type": "table",
          "title": "âš ï¸ ìµœê·¼ ì—ëŸ¬ ë¡œê·¸ (Top 20)",
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 4},
          "targets": [{
            "expr": "topk(20, sum(rate(log_messages{level=\"error\"}[5m])) by (service, message))",
            "format": "table",
            "instant": true,
            "refId": "A"
          }],
          "transformations": [
            {"id": "organize", "options": {"renameByName": {"service": "ì„œë¹„ìŠ¤", "message": "ì—ëŸ¬ ë©”ì‹œì§€", "Value": "ë°œìƒ ë¹ˆë„"}}}
          ]
        },
        {
          "type": "timeseries",
          "title": "Spark GC Time Ratio (ëª©í‘œ: <10%)",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 14},
          "targets": [{
            "expr": "sum(rate(jvm_gc_collection_seconds_sum{job=\"spark\"}[5m])) / sum(rate(jvm_gc_collection_seconds_count{job=\"spark\"}[5m])) * 100",
            "refId": "A"
          }],
          "fieldConfig": {
            "defaults": {
              "custom": {"drawStyle": "line", "lineInterpolation": "smooth"},
              "unit": "percent",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "green"},
                  {"value": 5, "color": "yellow"},
                  {"value": 10, "color": "red"}
                ]
              }
            }
          }
        },
        {
          "type": "bargauge",
          "title": "Slow Query Top 10 (>10ì´ˆ)",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 14},
          "targets": [{
            "expr": "topk(10, max(query_duration_seconds{duration_seconds>10}) by (query_id))",
            "refId": "A"
          }],
          "options": {
            "orientation": "horizontal",
            "displayMode": "gradient"
          },
          "fieldConfig": {
            "defaults": {
              "unit": "s",
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {"value": 0, "color": "yellow"},
                  {"value": 30, "color": "red"}
                ]
              }
            }
          }
        },
        {
          "type": "table",
          "title": "ğŸ’° ë¦¬ì†ŒìŠ¤ ë¹„ìš© ë¶„ì„ (ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë³„)",
          "gridPos": {"h": 10, "w": 24, "x": 0, "y": 22},
          "targets": [{
            "expr": "sum(kube_pod_container_resource_requests{resource=\"cpu\"} * 0.031 + kube_pod_container_resource_requests{resource=\"memory\"} / 1024 / 1024 / 1024 * 0.004) by (namespace)",
            "format": "table",
            "instant": true,
            "refId": "A"
          }],
          "transformations": [
            {"id": "organize", "options": {"renameByName": {"namespace": "ë„¤ì„ìŠ¤í˜ì´ìŠ¤", "Value": "ì›”ê°„ ì˜ˆìƒ ë¹„ìš© ($)"}}}
          ]
        },
        {
          "type": "timeseries",
          "title": "Iceberg Small Files ì¶”ì´",
          "gridPos": {"h": 8, "w": 12, "x": 0, "y": 32},
          "targets": [{
            "expr": "iceberg_table_small_files_count",
            "legendFormat": "{{table_name}}",
            "refId": "A"
          }],
          "fieldConfig": {
            "defaults": {
              "custom": {"drawStyle": "line", "lineInterpolation": "smooth"}
            }
          }
        },
        {
          "type": "piechart",
          "title": "ì—ëŸ¬ íƒ€ì… ë¶„í¬",
          "gridPos": {"h": 8, "w": 12, "x": 12, "y": 32},
          "targets": [{
            "expr": "sum(rate(log_messages{level=\"error\"}[1h])) by (error_type)",
            "refId": "A"
          }],
          "options": {
            "legend": {"displayMode": "list", "placement": "right"},
            "pieType": "donut"
          }
        },
        {
          "type": "text",
          "title": "ğŸ”— ê´€ë ¨ ë§í¬",
          "gridPos": {"h": 4, "w": 24, "x": 0, "y": 40},
          "options": {
            "mode": "html",
            "content": "<div style='padding: 15px; background: #f5f5f5; border-radius: 8px;'><div style='display: flex; justify-content: space-around;'><a href='/d/dataops-data-pipeline/dataops-data-pipeline' style='padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;'>â† ë°ì´í„° íŒŒì´í”„ë¼ì¸</a><a href='/d/dataops-main-nav/dataops-platform-main-navigation' style='padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;'>ë©”ì¸ìœ¼ë¡œ</a><a href='/d/dataops-e2e-analytics/dataops-e2e-analytics' style='padding: 10px 20px; background: #667eea; color: white; text-decoration: none; border-radius: 5px;'>E2E Analytics â†’</a></div></div>"
          }
        }
      ]
    }
