apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: monitoring
spec:
  values:
    # Cluster-01 Central: Enable Thanos Sidecar + all Grafana datasources
    prometheus:
      prometheusSpec:
        # External labels for Thanos
        externalLabels:
          cluster: cluster-01
          replica: "$(POD_NAME)"

        # Enable Thanos sidecar
        thanos:
          image: quay.io/thanos/thanos:v0.37.2
          version: v0.37.2
          objectStorageConfig:
            name: thanos-s3-config
            key: objstore.yml

    # Grafana with Thanos Query datasource
    grafana:
      ingress:
        enabled: true
        ingressClassName: nginx
        hosts:
          - grafana.k8s-cluster-01.miribit.lab
        tls: []

      # Add Thanos Query as datasource
      datasources:
        datasources.yaml:
          apiVersion: 1
          datasources:
            - name: Prometheus-Local
              type: prometheus
              url: http://kube-prometheus-stack-prometheus.monitoring:9090
              access: proxy
              isDefault: false

            - name: Thanos-Query
              type: prometheus
              url: http://thanos-query.monitoring:9090
              access: proxy
              isDefault: true
              jsonData:
                timeInterval: 30s
